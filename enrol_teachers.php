<?php

include "includes/db.php";

if(!isset($_SESSION['user_role_id']) || $_SESSION['user_role_id'] != 1) {
    header('HTTP/1.0 403 Forbidden');
    exit("Доступ закрыт");
}

$query_teachers = "SELECT moodle_enrolid AS enrolid,
                          teacher_moodle_id AS userid,
                          teacher_id,
                          teacher_surname,
                          teacher_name,
                          discipline_moodle_id,
                          fullname
                   FROM v_required_teachers_enrollments";
$select_teachers = mysqli_query( $connection, $query_teachers );
$teachers = mysqli_fetch_all( $select_teachers , MYSQLI_ASSOC );
$insert = mysqli_num_rows( $select_teachers );
mysqli_free_result( $select_teachers );
$fn = 'enrol_teachers_'.date('Y-m-d_h-i-s');
file_put_contents( "admin/file/enrol/$fn.json", json_encode( $teachers ) );

$delim = ";";
$bom =( chr(0xEF) . chr(0xBB) . chr(0xBF) );
$errors = [];

if ( $insert > 0 ) {
    $roles = "INSERT IGNORE INTO clg_role_assignments (roleid, contextid, userid, timemodified)
              SELECT DISTINCT
                     3 as roleid,
                     clg_context.id AS contextid,
                     teacher_moodle_id AS userid,
                     UNIX_TIMESTAMP() as timemodified
              FROM v_required_teachers_enrollments
              LEFT JOIN clg_context ON clg_context.instanceid = v_required_teachers_enrollments.discipline_moodle_id AND clg_context.contextlevel = 50";
    $insert_roles = mysqli_query( $connection, $roles );
    if( !$insert_roles ) {
        $errors[] = 'QUERY FAILED' . mysqli_error( $connection );
    }

    $enrol = "INSERT IGNORE INTO clg_user_enrolments (enrolid, userid, timecreated, timemodified)
              SELECT DISTINCT
                     moodle_enrolid AS enrolid,
                     teacher_moodle_id AS userid,
                     UNIX_TIMESTAMP() as timecreated,
                     UNIX_TIMESTAMP() as timemodified
              FROM v_required_teachers_enrollments";
    $insert_enrol = mysqli_query( $connection, $enrol );
    if( !$insert_enrol ) {
        $errors[] = 'QUERY FAILED' . mysqli_error( $connection );
    }

    header( 'Content-Type: text/csv; charset=utf-8' );
    header( "Content-Disposition: attachment;filename=$fn.csv");
    $fp = fopen('php://output', 'w');
    fputs( $fp, $bom );
    fputcsv( $fp, array_keys( $teachers[0] ), $delim );
    foreach( $teachers as $teacher ) {
        fputcsv( $fp, $teacher, $delim );
    }
    fputs( $fp, "\n\n".implode( "\n", $errors ) ) . "\n";

    fclose( $fp );
}
else {
    echo "ALL IS GOOD";
}