<?php
require 'config.php';

// ini_set('display_errors', 1);
// ini_set('display_startup_errors', 1);
// error_reporting(E_ALL);

ob_start();

if (!is_writable(session_save_path())) {
    echo 'Session path "'.session_save_path().'" is not writable for PHP!'; 
}

session_set_cookie_params([
    // 'lifetime' => $maxlifetime,
    'path' => $cookieConfig['path'],
    'domain' => $cookieConfig['domain'],
    'secure' => false,
    'httponly' => $cookieConfig['httponly'],
    'samesite' => $cookieConfig['samesite']
]);

session_start();


if($_SERVER['REQUEST_METHOD'] == 'GET')
{
    $token = bin2hex(random_bytes(35));
    $_SESSION['token'] = $token;
    unset($_COOKIE['token']);
    setcookie('token', $token, 0,
        $cookieConfig['path'],
        $cookieConfig['domain'],
        $cookieConfig['secure'],
        $cookieConfig['httponly']
    );
}



if($_SERVER['REQUEST_METHOD'] === 'POST')
{
    $sessionPost = hash_equals($_SESSION['token'], $_POST['token']);
    $sessionCookie = hash_equals($_SESSION['token'], $_COOKIE['token']);
    $postCookie = hash_equals($_COOKIE['token'], $_POST['token']);


    if (empty($_POST['token']) || !$sessionPost || !$sessionCookie || !$postCookie) {
        header($_SERVER['SERVER_PROTOCOL'] . ' 405 Method Not Allowed');
        exit;
    }
}   
