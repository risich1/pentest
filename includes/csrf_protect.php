<?php
require 'config.php';


ob_start();


session_set_cookie_params([
    // 'lifetime' => $maxlifetime,
    'path' => $cookieConfig['path'],
    'domain' => $cookieConfig['domain'],
    'secure' => false,
    'httponly' => $cookieConfig['httponly'],
    'samesite' => $cookieConfig['samesite']
]);

session_start();


if($_SERVER['REQUEST_METHOD'] == 'GET')
{
    $token = bin2hex(random_bytes(35));
    $_SESSION['token'] = $token;
    unset($_COOKIE['token']);
    setcookie('token', $token, [
        'path' => $cookieConfig['path'],
        'domain' => $cookieConfig['domain'],
        'secure' => $cookieConfig['secure'],
        'httponly' => $cookieConfig['httponly'],
        'samesite' => $cookieConfig['samesite']
    ]);
}



if($_SERVER['REQUEST_METHOD'] === 'POST')
{
    $sessionPost = hash_equals($_SESSION['token'], $_POST['token']);
    $sessionCookie = hash_equals($_SESSION['token'], $_COOKIE['token']);
    $postCookie = hash_equals($_COOKIE['token'], $_POST['token']);


    if (empty($_POST['token']) || !$sessionPost || !$sessionCookie || !$postCookie) {
        header($_SERVER['SERVER_PROTOCOL'] . ' 405 Method Not Allowed');
        exit;
    }
}   
