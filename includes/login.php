<?php 
require_once('db.php'); 
session_start();

if(isset($_POST['login'])) {
    $user_login = $_POST['user_login'];
    $user_password = $_POST['user_password'];
    $user_login = mysqli_real_escape_string($connection, $user_login);
    $user_password = mysqli_real_escape_string($connection, $user_password);
        
    $query = "
        SELECT
            user_id,
            user_login,
            user_password,
            user_surname,
            user_name,
            user_role_id,
            user_region_id
        FROM
            asu_users
        WHERE
            user_login = '{$user_login}'
    ";
    $select_user_query = mysqli_query($connection, $query);
        
    if(!$select_user_query) {
        die("QUERY FAILED" . mysqli_error($connection));
    }
    else {
        $select_user_query = mysqli_fetch_assoc($select_user_query);
    }
        
    $user_password = crypt($user_password, $select_user_query['user_password']);
        
    if($user_login === $select_user_query['user_login'] && $user_password === $select_user_query['user_password']) {
        $_SESSION['user_id'] = $select_user_query['user_id'];
        $_SESSION['user_login'] = $select_user_query['user_login'];
        $_SESSION['user_surname'] = $select_user_query['user_surname'];
        $_SESSION['user_name'] = $select_user_query['user_name'];
        $_SESSION['user_role_id'] = $select_user_query['user_role_id'];
        $_SESSION['user_region_id'] = $select_user_query['user_region_id'];
        header($linkin);
    }
    else {
        header($linkout);
    }  
}