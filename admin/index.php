<?php
    require_once('../includes/db.php'); 
    require_once('includes/header.php');
    if($_SESSION['user_role_id'] == 2) {
        header("Location: enrollee.php");
    } 
?>

<div id="wrapper">
	<?php require_once('includes/navigation.php'); ?>
	<div id="page-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">
                        <i class="fa fa-area-chart fa-fw text-muted" aria-hidden="true"></i>
                            &nbsp;Статистика
                    </h1>
                </div>
            </div>
                
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-users fa-5x"></i>
                                </div>

                                <div class="col-xs-9 text-right">
                                    <?php
                                        $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'Абитуриент' ";
                                        $select_all_enrollee = mysqli_query($connection,$query);
                                        $enrollee_count = mysqli_num_rows($select_all_enrollee);
                                        echo "<div class='huge'>{$enrollee_count}</div>";  
                                    ?>

                                    <div>Абитуриенты</div>
                                </div>
                            </div>
                        </div>
                    
                        <a href="enrollee.php">
                            <div class="panel-footer">
                                <span class="pull-left">Подробнее</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-green">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-address-book fa-5x"></i>
                                </div>

                                <div class="col-xs-9 text-right">
                                    <?php
                                        $query = "SELECT * FROM asu_enrollee WHERE enrollee_status != 'Архив' ";
                                        $select_all_enrollee = mysqli_query($connection,$query);
                                        $enrollee_count = mysqli_num_rows($select_all_enrollee);
                                        echo "<div class='huge'>{$enrollee_count}</div>";
                                    ?>

                                    <div>Личные дела</div>
                                </div>
                            </div>
                        </div>

                        <a href="personal_things.php">
                            <div class="panel-footer">
                                <span class="pull-left">Подробнее</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-yellow">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-handshake-o fa-5x"></i>
                                </div>

                                <div class="col-xs-9 text-right">
                                    <?php
                                        $query = "SELECT * FROM asu_treaty WHERE treaty_status != 'Архив' ";
                                        $select_all_treaty = mysqli_query($connection, $query);
                                        $treaty_count = mysqli_num_rows($select_all_treaty);
                                        echo "<div class='huge'>{$treaty_count}</div>";
                                    ?>

                                    <div>Договора</div>
                                </div>
                            </div>
                        </div>

                        <a href="treaty.php">
                            <div class="panel-footer">
                                <span class="pull-left">Подробнее</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="panel panel-red">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-university fa-5x"></i>
                                </div>

                                <div class="col-xs-9 text-right">
                                    <?php
                                        $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'Студент' ";
                                        $select_all_enrollee = mysqli_query($connection,$query);
                                        $enrollee_count = mysqli_num_rows($select_all_enrollee);
                                        echo "<div class='huge'>{$enrollee_count}</div>";
                                    ?>

                                    <div>Студенты</div>
                                </div>
                            </div>
                        </div>

                        <a href="students.php">
                            <div class="panel-footer">
                                <span class="pull-left">Подробнее</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <h3 class="page-header">
                        <i class="fa fa-address-book text-muted" aria-hidden="true"></i> 
                            &nbsp;Распределение личных дел по статусам 
                    </h3>
                    <br>
                </div>
            </div>

            <div class="row">
                <?php
                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'Абитуриент' ";
                    $select_all_enrollee = mysqli_query($connection,$query);
                    $enrollee_count = mysqli_num_rows($select_all_enrollee);
                        
                    $query = "SELECT * FROM asu_treaty WHERE treaty_status != 'Архив' ";
                    $select_all_treaty = mysqli_query($connection,$query);
                    $enrollee_treaty_count = mysqli_num_rows($select_all_treaty);
                    
                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'В приказ' ";
                    $select_all_enrollee_order = mysqli_query($connection,$query);
                    $enrollee_order_count = mysqli_num_rows($select_all_enrollee_order);
                    
                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'Студент' ";
                    $select_all_enrollee_student = mysqli_query($connection, $query);
                    $enrollee_student_count = mysqli_num_rows($select_all_enrollee_student);
                ?>
            
                <script type="text/javascript">
                    google.charts.load('current', {'packages':['bar']});
                    google.charts.setOnLoadCallback(drawChart);

                    function drawChart() {
                        var data = google.visualization.arrayToDataTable([
                            ['Статус личного дела', 'Количество'],
                          
                            <?php
                                $element_text = ['Абитуриентов', 'Заключёно договоров', 'В приказ', 'Студентов'];
                                $element_count = [$enrollee_count, $enrollee_treaty_count, $enrollee_order_count, $enrollee_student_count];
                            
                                for($i = 0; $i < 4; $i++) {
                                    echo "['{$element_text[$i]}'" . ", " . "{$element_count[$i]}],";
                                }
                            ?>
                        ]);

                        var options = {
                            chart: {
                                title: '',
                                subtitle: '',
                            }
                        };

                        var chart = new google.charts.Bar(document.getElementById('columnchart_material'));

                        chart.draw(data, options);
                    }
                </script>
                    
                <div id="columnchart_material" style="width: 'auto'; height: 500px;"></div> 
            </div>

            <br>
            <br>

            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <h3 class="page-header"><i class="fa fa-map-marker text-muted" aria-hidden="true"></i> 
                        &nbsp;Распределение личных дел по регионам 
                    </h3>
                    <br>
                </div>
            </div>
                
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <table class="table table-hover table-bordered">
                        <thead>
                            <tr class="active">
                                <th>№</th>
                                <th>Регион</th>
                                <th>Количество личных дел</th>
                            </tr>
                        </thead>

                        <tbody>
                            <?php
                                $element_text = array();
                                $element_count = array();
                                $query = "SELECT * FROM asu_region";
                                $select_all_region = mysqli_query($connection,$query);
                                $region_count = mysqli_num_rows($select_all_region);
								$i = 0;
								$j =0;
								$sum_count = 0;
								
                                for ($i = 0; $i < $region_count; $i++) {
                                    $row = mysqli_fetch_assoc($select_all_region);
                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_region_id = {$region_id} AND enrollee_status != 'Архив' ";

                                    $region_query_st = mysqli_query($connection,$query);
                                    $region_count_st = mysqli_num_rows($region_query_st);

                                    if($region_count_st == 0) {

                                    }
                                    else {
                                        $j++;
                                        $sum_count = $sum_count + $region_count_st;
                                                    
                                        echo "<tr>";
                                        echo "<td>$j</td>";
										echo "<td>$region_title</td>";
                                        echo "<td>$region_count_st</td>";
                                        echo "</tr>";
                                    }
                                }

                                echo "<tr>";
                                echo "<td><strong>Сумма:</strong></td>";
                                echo '<td><strong>'.$j.'</strong></td>';
                                echo "<td><strong>$sum_count</strong></td>";
                                echo "</tr>";
                            ?>
                        </tbody>
                    </table>
                </div>
            </div>
            <br>
            <br>
        </div>
    </div>
</div>

<?php
    require_once('includes/footer.php');
?>