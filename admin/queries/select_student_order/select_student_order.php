
<?php

    include "../../../includes/db.php"; 

    if(isset($_POST['filter_name']) || isset($_POST['filter_semester']) || isset($_POST['filter_period']) || isset($_POST['filter_region']) || isset($_POST['filter_group']) || isset($_POST['filter_year']) || isset($_POST['order_id'])) {

        $filter_name = mysqli_real_escape_string($connection, $_POST['filter_name']); 
        $filter_semester = mysqli_real_escape_string($connection, $_POST['filter_semester']); 
        $filter_period = mysqli_real_escape_string($connection, $_POST['filter_period']);
        $filter_region = mysqli_real_escape_string($connection, $_POST['filter_region']);
        $filter_group = mysqli_real_escape_string($connection, $_POST['filter_group']);
        $filter_year = mysqli_real_escape_string($connection, $_POST['filter_year']);
        $order_id = mysqli_real_escape_string($connection, $_POST['order_id']);
        
        $date = new DateTime($filter_year);
        $date->modify("-1 year");
        $date = $date->format("Y-m-d");
        
        $query = "
                    SELECT

                        CONCAT(enrollee_surname,' ',enrollee_name,' ',enrollee_patronymic) enrollee,
                        asu_enrollee.enrollee_id AS enrollee_id,

                        asu_enrollee.enrollee_status AS enrollee_status,

                        asu_semesters.semester_title AS semester,

                        asu_region.region_title AS region,

                        asu_groups.group_number AS group_number


                        FROM asu_enrollee

                        LEFT JOIN asu_session
                            ON asu_enrollee.enrollee_session_id = asu_session.session_id
                        LEFT JOIN asu_region
                            ON asu_enrollee.enrollee_region_id = asu_region.region_id
                        LEFT JOIN asu_groups
                            ON asu_enrollee.enrollee_group_id = asu_groups.group_id
                        LEFT JOIN asu_semesters
                            ON  asu_enrollee.current_sem = asu_semesters.semester_id

                        WHERE asu_enrollee.enrollee_status = 'Студент'

                ";
                
        if ($filter_name) {
            $query .= " AND asu_enrollee.enrollee_surname LIKE '$filter_name%'";
        }

        if ($filter_semester) {
            $query .= " AND asu_enrollee.current_sem = {$filter_semester}";
        }

        if ($filter_period) {
            $query .= " AND asu_enrollee.enrollee_session_id = {$filter_period}";
        }

        if ($filter_region) {
            $query .= " AND asu_enrollee.enrollee_region_id = {$filter_region}";
        }

        if ($filter_group) {
            $query .= " AND asu_enrollee.enrollee_group_id = {$filter_group}";
        }
        
        if ($filter_year) {
            $query .= " AND asu_enrollee.enrollee_date <= '{$filter_year}' AND asu_enrollee.enrollee_date >= '{$date}'";
        }
       
        $query .= " ORDER BY asu_enrollee.enrollee_surname";
        
        $select_all_students = mysqli_query($connection, $query);
        
        $count = mysqli_num_rows($select_all_students);
        
        $message = "<div class='alert alert-info'><b>Результат: {$count}</b><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button></div>";
   
}

if(isset($_POST['add'])) {
    
    $enrollee_id_order = mysqli_real_escape_string($connection, $_POST['id_student']);
    $order_id_order = mysqli_real_escape_string($connection, $_POST['id_order']);
    
    $query_select_types_order = "SELECT order_types_id FROM asu_orders WHERE order_id = {$order_id_order}";
    $select_types_order = mysqli_query($connection, $query_select_types_order);
    
    $row = mysqli_fetch_assoc($select_types_order);
    $types_order_id = $row['order_types_id'];
    
    
    $query_enrolee =    "   SELECT 
    
                                asu_enrollee.moodle_id AS moodle_id,
                                asu_treaty.treaty_id AS treaty_id
                                
                                FROM asu_enrollee 
                                INNER JOIN asu_treaty
                                    ON asu_enrollee.enrollee_id = asu_treaty.treaty_enrollee_id
                                WHERE enrollee_id = {$enrollee_id_order}
                        ";
    
    $select_by_id = mysqli_query($connection, $query_enrolee);
    
    $row_moodle_id = mysqli_fetch_assoc($select_by_id);
    $moodle_id = $row_moodle_id['moodle_id'];
    $treaty_id = $row_moodle_id['treaty_id'];
    
    
    if($types_order_id == 2) {
        
        $query = "UPDATE asu_enrollee SET ";
        $query .= "enrollee_status = 'Архив' ";
        $query .= "WHERE enrollee_id = {$enrollee_id_order} ";
        
        $update_status = mysqli_query($connection,$query);
        
        if($moodle_id) {
            
            $query_status_update = "UPDATE clg_user SET clg_user.suspended = 1 WHERE clg_user.id = {$moodle_id}";
            $update_status_moodle = mysqli_query($connection,$query_status_update);
            
        }
        
        $query_status_treaty = "UPDATE asu_treaty SET treaty_status = 'Архив' WHERE treaty_id = {$treaty_id}";
        $update_status_treaty = mysqli_query($connection,$query_status_treaty);
 
    }
    
    
    $query = "INSERT INTO asu_content_orders(order_id, enrollee_id) ";
    $query .= "VALUES({$order_id_order}, {$enrollee_id_order}) ";

    $result_set = mysqli_query($connection, $query);

    if(!$result_set) {

        die("QUERY FAILED" . mysqli_error($connection));

    }
}


    
if(isset($_POST['update_group_add_student'])) {

    $update_group_add_student = mysqli_real_escape_string($connection, $_POST['update_group_add_student']);
    $id_group_add_students = mysqli_real_escape_string($connection, $_POST['id_group_add_students']);

    $id_group_old_add_students = mysqli_real_escape_string($connection, $_POST['id_group_old_add_students']);

    $id_enrollee_add_students = mysqli_real_escape_string($connection, $_POST['id_enrollee_add_students']);

    $id_content_order_add_students = mysqli_real_escape_string($connection, $_POST['id_content_order_add_students']);


    $query = "UPDATE asu_enrollee SET ";
    $query .= "enrollee_group_id =  {$id_group_add_students} ";
    $query .= "WHERE enrollee_id = {$id_enrollee_add_students} ";

    $update_group = mysqli_query($connection,$query);

    $query = "UPDATE asu_content_orders SET ";
    $query .= "group_id =  {$id_group_old_add_students} ";
    $query .= "WHERE content_orders_id = {$id_content_order_add_students} ";

    $update_content_order = mysqli_query($connection,$query);
    
    $query = "SELECT moodle_id FROM asu_enrollee WHERE enrollee_id = {$id_enrollee_add_students}";
    $select_enrollee_by_id = mysqli_query($connection, $query);
    $row = mysqli_fetch_assoc($select_enrollee_by_id);
    
    $moodle_id = $row['moodle_id'];
    
    file_get_contents($prefixsdo."/my/student_regroup.php?student_id={$moodle_id}&group_id={$id_group_add_students}");

}

if(isset($_POST['deletethis'])) {
    
    $content_orders_id = mysqli_real_escape_string($connection, $_POST['id']);
    
    $query = "DELETE FROM asu_content_orders WHERE content_orders_id = {$content_orders_id} ";

    $delete_query = mysqli_query($connection, $query);
  
}

if(isset($_POST['update_surname_add_student'])) {
    
    $id_enrollee_add_students = mysqli_real_escape_string($connection, $_POST['id_enrollee_add_students']);
    $new_surname = mysqli_real_escape_string($connection, $_POST['new_surname']);
    
    $query = "UPDATE asu_enrollee SET enrollee_surname = '{$new_surname}' WHERE enrollee_id = {$id_enrollee_add_students} ";
    $update_surname = mysqli_query($connection, $query);
    
}

?>
<?php echo $message; ?>

                    
<table class="table table-hover table-bordered table-filter">
    <thead>
        <tr class="active">
            <th>№</th>
            <th>Ф.И.О.</th>
            <th>Семестр</th>
            <th>Группа</th>
            <th>Регион</th>
            <th>Статус</th>
            <th class="text-center">ID</th>
            <th class="text-center">Добавить</th>
        </tr>
    </thead>
    <tbody>
        
        <?php

            if(!$select_all_students) {

                die("QUERY FAILED ." . mysqli_error($connection));

            }
            // current date
            $date = date('d.m.Y');

            while($row = mysqli_fetch_assoc($select_all_students)) {

                $number++;
                $enrollee = $row['enrollee'];
                $enrollee_id = $row['enrollee_id'];
                $enrollee_status = $row['enrollee_status'];
                $semester = $row['semester'];
                $group = $row['group_number'];
                $region = $row['region'];                


                echo "<tr>";
                echo "<td>{$number}</td>";
                echo "<td>{$enrollee}</td>";
                echo "<td>{$semester}</td>";
                echo "<td>{$group}</td>";                 
                echo "<td>{$region}</td>";
                echo "<td>{$enrollee_status}</td>";

                echo "<td class='text-center'>{$enrollee_id}</td>";

                echo "<td class='text-center'><a href='javascript:void(0)' class='add_student_order' rel='$enrollee_id-$order_id-'><i class='fa fa-plus-circle' aria-hidden='true'></i> Добавить</a></td>";
                echo "</tr>";

            }

        ?>


    </tbody>
</table>

<script>
// table sorter
$(document).ready(function() { 
    $(".table-filter").tablesorter({
        widthFixed: true, 
        widgets: ['zebra']
    }); // end table sorter

    
    
    $(function(){
        $('[rel="popover"]').popover({
            container: 'body',
            html: true,
            content: function () {
                var clone = $($(this).data('popover-content')).clone(true).removeClass('hide');
                return clone;
            }
            }).click(function(e) {
                e.preventDefault();
        });
    });
    
    $('.add_student_order').on('click', function(){
        
        var add = 'add_student';
        var str = $(this).attr("rel");
        
        
        var firstIndex = str.indexOf("-");
        var lastIndex = str.lastIndexOf("-");
        
        var id_student = str.substring(0,firstIndex);
        var id_order = str.substring(firstIndex+1,lastIndex);
        
		var site = <?php echo "'$siteprefix/admin/queries/select_student_order/select_student_order.php'"; ?>;
        
        $.post(site, {id_student: id_student, id_order: id_order, add: add}, function(data){
            alert("Студент добавлен в приказ!");
//          $("#feedback").text("Record updated sucessfully");
                
        });
        
    });
});
    
</script>


