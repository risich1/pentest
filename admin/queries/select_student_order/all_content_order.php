
<?php

    include "../../../includes/db.php"; 
    
    if (isset($_POST['id_add_students_order'])) {
        
        $the_order_id = mysqli_real_escape_string($connection, $_POST['id_add_students_order']);
    

        $query =    "   
                        SELECT

                            asu_content_orders.content_orders_id AS content_orders_id,
                            asu_content_orders.group_id AS content_orders_group_id,

                            asu_enrollee.enrollee_id AS enrollee_id,
                            asu_enrollee.enrollee_status AS enrollee_status,
                            CONCAT(enrollee_surname,' ',enrollee_name,' ',enrollee_patronymic) AS enrollee,

                            asu_orders.order_types_id AS order_types_id,

                            asu_groups.group_number AS group_number,
                            asu_groups.group_id AS group_id,

                            asu_region.region_title AS region_title

                            FROM asu_content_orders
                            INNER JOIN asu_orders
                                ON asu_content_orders.order_id = asu_orders.order_id
                            INNER JOIN asu_enrollee
                                ON asu_content_orders.enrollee_id = asu_enrollee.enrollee_id 
                            INNER JOIN asu_groups
                                ON asu_enrollee.enrollee_group_id = asu_groups.group_id 
                            INNER JOIN asu_region
                                ON asu_enrollee.enrollee_region_id = asu_region.region_id
                            WHERE asu_content_orders.order_id = {$the_order_id} 
                            ORDER BY asu_enrollee.enrollee_surname


                    ";

    $query_car_info = mysqli_query($connection, $query);

    if(!$query_car_info) {
        die("QUERY FAILED" . mysqli_error($connection));
    }

    while($row = mysqli_fetch_array($query_car_info)) {
        
        $number++;
        $enrollee_id = $row['enrollee_id'];
        $enrollee_status = $row['enrollee_status'];
        $enrollee = $row['enrollee'];
        $group_number = $row['group_number'];
        $region_title = $row['region_title'];
        $content_orders_id = $row['content_orders_id'];
        $content_orders_group_id = $row['content_orders_group_id'];
        $types_orders_id = $row['order_types_id'];
        $group_id = $row['group_id'];
        

        echo "<tr>";
        echo "<td>{$number}</td>";
        
        if ($types_orders_id == 4) {
            
            echo " <td>
                    <div class ='pull-left'>
                        {$enrollee}
                    </div>
                    
                    <div class='pull-right'>
                        <i class='fa fa-pencil-square-o text-primary select_enrollee_order' rel='$enrollee_id,$content_orders_id' aria-hidden='true' title='Редактировать группу'></i>
                    </div>
                ";
            
        } else {
            echo "<td>{$enrollee}</td>";
        }

        echo "<td>{$enrollee_status}</td>";
        echo "<td>
                    <div class ='pull-left'>
                        {$group_number}
                    </div>";
        echo "<div class='pull-right'>";
        
        if ($types_orders_id == 3) {
            echo "<i class='fa fa-pencil-square-o text-primary select_group_order' rel='$enrollee_id,$group_id,$content_orders_id' aria-hidden='true' title='Редактировать группу'></i>";
        }
        
        echo "</div></td>";
     
                
        if ($types_orders_id == 3) {
            
            $query = "SELECT group_number FROM asu_groups WHERE group_id =  {$content_orders_group_id} ";
            $select_group_by_id = mysqli_query($connection, $query);
            
            $row = mysqli_fetch_assoc($select_group_by_id);
            
            $group_number = $row['group_number'];
            
            if($group_number) {
                echo "<td>{$group_number}</td>";
            } else {
                echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
            }
            
        } 
        
        echo "<td>{$region_title}</td>";
        echo "<td>{$enrollee_id}</td>";
        echo "<td class='text-center'><i class='fa fa-trash text-danger delete-student-order' aria-hidden='true' rel='{$content_orders_id}'></i></td>";

        echo "</tr>";

    }

}
    
?>

<script>
    
    $(".delete-student-order").on('click', function(){

        var deletethis = "delete";
        var content_orders_id = $(this).attr('rel'); 
        var site = <?php echo "'$siteprefix/admin/queries/select_student_order/select_student_order.php'"; ?>;
		
        alert("delete");

        $.post(site, {id: content_orders_id, deletethis: deletethis});

    });
    
    $('.select_group_order').on('click', function(){
        
        var data = $(this).attr('rel');
        var arr = data.split(',');
        var div = document.getElementById('select_group_order');
        
        $('#wanning_add_students_order').show();
        
        $('.form-select-group').show();
        
        div.innerHTML = '<input type="hidden" name="id_enrollee_add_students" id="id_enrollee_add_students" value="'+arr[0]+'"><input type="hidden" name="id_group_old_add_students" id="id_group_old_add_students" value="'+arr[1]+'"><input type="hidden" name="id_content_order_add_students" id="id_content_order_add_students" value="'+arr[2]+'">';

        
    });
    
    $('.select_enrollee_order').on('click', function() {
        
        var data = $(this).attr('rel');
        var arr = data.split(',');
        var div = document.getElementById('select_surname_order');
        
        $('#wanning_add_students_order').show();
        
        $('#select_surname_order').show();
        
        div.innerHTML = '<input type="hidden" name="id_enrollee_add_students" id="id_enrollee_add_students" value="'+arr[0]+'">';

        
    });
    
</script>
