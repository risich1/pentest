<?php
    include "../../../includes/db.php"; 

    if(isset($_POST['filter_name']) || isset($_POST['filter_semester']) || isset($_POST['filter_period']) || isset($_POST['filter_region']) || isset($_POST['filter_group']) || isset($_POST['filter_year'])) {

        $filter_name = mysqli_real_escape_string($connection, $_POST['filter_name']); 
        $filter_semester = mysqli_real_escape_string($connection, $_POST['filter_semester']); 
        $filter_period = mysqli_real_escape_string($connection, $_POST['filter_period']);
        $filter_region = mysqli_real_escape_string($connection, $_POST['filter_region']);
        $filter_group = mysqli_real_escape_string($connection, $_POST['filter_group']);
        $filter_year = mysqli_real_escape_string($connection, $_POST['filter_year']);
        
        $date = new DateTime($filter_year);
        $date->modify("-1 year");
        $date = $date->format("Y-m-d");

        
        
        $query = "
                    SELECT DISTINCT
                        clg_user.id AS user_id,
                        asu_enrollee.enrollee_surname AS enrollee_surname,
                        asu_enrollee.enrollee_name AS enrollee_name,
                        asu_enrollee.enrollee_patronymic AS enrollee_patronymic,
                        asu_enrollee.enrollee_id AS enrollee_id,
                        asu_enrollee.enrollee_status AS enrollee_status,
                        asu_enrollee.current_sem AS current_sem,
                        asu_enrollee.moodle_id AS moodle_id,
                        asu_region.region_title AS region,
                        clg_user.username AS username,
                        asu_enrollee.enrollee_phone AS phone,
                        asu_semesters.semester_title AS semester,
                        CONCAT(asu_session.session_period,' ',asu_session.session_time) session,
                        DATE_FORMAT(asu_session.session_open, '%d.%m.%Y') session_open,
                        DATE_FORMAT(asu_session.session_end, '%d.%m.%Y') session_end,
                        FROM_UNIXTIME(clg_user.lastaccess, '%d.%m.%Y %H:%i:%s') lastaccess,
                        clg_user.email AS email,
                        asu_groups.group_number AS group_number,
                        asu_payment.payment_status AS payment_status,
                        asu_payment.payment_number AS payment_number,
                        DATE_FORMAT(asu_payment.payment_create_date, '%d.%m.%Y') payment_create_date,
                        asu_payment.payment_cost AS payment_cost

                    FROM
						asu_enrollee
						
                    LEFT JOIN clg_user
                        ON asu_enrollee.moodle_id = clg_user.id
                    LEFT JOIN asu_session
                        ON asu_enrollee.enrollee_session_id = asu_session.session_id
                    LEFT JOIN asu_treaty 
                        ON asu_enrollee.enrollee_id = asu_treaty.treaty_enrollee_id
                    LEFT JOIN asu_region
                        ON asu_enrollee.enrollee_region_id = asu_region.region_id
                    LEFT JOIN asu_groups
                        ON asu_enrollee.enrollee_group_id = asu_groups.group_id
                    LEFT JOIN asu_semesters
                        ON  asu_enrollee.current_sem = asu_semesters.semester_id
                    LEFT JOIN asu_payment
                        ON  (asu_enrollee.current_sem = asu_payment.payment_semester_id 
                            AND asu_enrollee.enrollee_id = asu_payment.payment_enrollee_id
							AND asu_treaty.treaty_id = asu_payment.payment_treaty_id)

                    WHERE
						(asu_enrollee.enrollee_status = 'Студент'

                ";

        if ($filter_year) {
            $query .= "|| asu_enrollee.enrollee_status != 'Студент') AND (asu_enrollee.enrollee_date <= '{$filter_year}' AND asu_enrollee.enrollee_date >= '{$date}') AND (asu_enrollee.enrollee_status != 'Архив')";
        }
        else {
            $query .= ")"; 
        } 

        if ($filter_name) {
            $query .= " AND asu_enrollee.enrollee_surname LIKE '$filter_name%'";
        }

        if ($filter_semester) {
            $query .= " AND asu_enrollee.current_sem = {$filter_semester}";
        }

        if ($filter_period) {
            $query .= " AND asu_enrollee.enrollee_session_id = {$filter_period}";
        }

        if ($filter_region) {
            $query .= " AND asu_enrollee.enrollee_region_id = {$filter_region}";
        }

        if ($filter_group) {
            $query .= " AND asu_enrollee.enrollee_group_id = {$filter_group}";
        }
        
        
       
        $query .= " ORDER BY asu_enrollee.enrollee_surname";
        
        $select_all_students = mysqli_query($connection, $query);
        
        $count = mysqli_num_rows($select_all_students);
        
        $message = "<div class='alert alert-info'><b>Результат: {$count}</b><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button></div>";
        
    }

?>
<?php echo $message; ?>

<table class="table table-hover table-bordered table-filter">
    <thead>
        <tr class="active">
            <th>№</th>
            <th>Фамилия</th>
            <th>Имя</th>
            <th>Отчество</th>
            <th>Статус</th>
            <th>Семестр</th>
            <th>Регион</th>
            <th>Логин в СДО</th>
            <?php if($_SESSION['user_role_id'] == 1) {
                echo "<th>Статус в СДО</th>";
            }?>
            <th class="text-center">ID</th>
            <th class="text-center">Личное дело</th>
            <th class="text-center">Редактировать</th>
        </tr>
    </thead>
    <tbody>

        <?php
        
            

            if(!$select_all_students) {

                die("QUERY FAILED ." . mysqli_error($connection));

            }
            // current date
            $date = date('d.m.Y');

            while($row = mysqli_fetch_assoc($select_all_students)) {

                $number++;
                $enrollee_surname = $row['enrollee_surname'];
                $enrollee_name = $row['enrollee_name'];
                $enrollee_patronymic = $row['enrollee_patronymic'];
                $enrollee_status = $row['enrollee_status'];
                $enrollee_id = $row['enrollee_id'];
                $current_sem = $row['current_sem'];
                $region = $row['region'];
                $username = $row['username'];
                $moodle_id = $row['moodle_id'];
                
                
                echo "<tr>";
                
                echo "<td>{$number}</td>";
                echo "<td>{$enrollee_surname}</td>";
                echo "<td>{$enrollee_name}</td>";
                echo "<td>{$enrollee_patronymic}</td>";
                echo "<td>{$enrollee_status}</td>";
                echo "<td>{$current_sem}</td>";
                echo "<td>{$region}</td>";
                echo "<td>{$username}</td>";
                
                
                if($_SESSION['user_role_id'] == 1) {
                    if($enrollee_status == 'Студент' && !isset($moodle_id)) {
                        echo "<td class='text-center'><a class='text-primary' href='personal_things.php?add_enrollee_inSDO={$enrollee_id}'><i class='fa fa-plus-circle' aria-hidden='true' title='Добавить пользователя в СДО'></i></a></td>";  
                    } elseif(isset($moodle_id)) {
                        echo "<td class='text-center'><i class='text-success fa fa-check-circle text-muted' aria-hidden='true' title='Пользователь создан в СДО'></i></td>";
                    } else {
                        echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                    }
                }
                
                echo "<td>{$enrollee_id}</td>";
                echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=edit_enrollee&e_id={$enrollee_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";
                
                echo "</tr>";


            }

        ?>

    </tbody>
</table>


<script>
// table sorter
    
    $(".table-filter").tablesorter({
        widthFixed: true, 
        widgets: ['zebra']
    }); // end table sorter

    
    
    $(function(){
        $('[rel="popover"]').popover({
            container: 'body',
            html: true,
            content: function () {
                var clone = $($(this).data('popover-content')).clone(true).removeClass('hide');
                return clone;
            }
            }).click(function(e) {
                e.preventDefault();
        });
    });
</script>


