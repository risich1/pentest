<?php

    include "../../../includes/db.php"; 

    ob_start(); // Эта функция включает буферизацию вывода. Если буферизация вывода активна, вывод скрипта не высылается (кроме заголовков), а сохраняется во внутреннем буфере. 
    session_start(); // создает сессию, либо возобновляет существующую, основываясь на идентификаторе сессии, переданном через GET или POST запрос, либо переданный через cookie.

    if(!isset($_SESSION['user_role_id'])) {
             header($linkout); 
    }


    if(isset($_POST['enrollee_group_id'])) {
        
        $enrollee_id = mysqli_real_escape_string($connection, $_POST['enrollee_id']);
        $moodle_id = mysqli_real_escape_string($connection, $_POST['moodle_id']);
        $enrollee_group_id = mysqli_real_escape_string($connection, $_POST['enrollee_group_id']);
        $current_sem = mysqli_real_escape_string($connection, $_POST['current_sem']);
        
    }
    
    $query = "SELECT * FROM asu_groups WHERE group_id = {$enrollee_group_id} ";
    $select_group_by_id = mysqli_query($connection, $query);

    $row = mysqli_fetch_assoc($select_group_by_id);

    $group_number = $row['group_number'];
    $group_ac_plan_id = $row['group_ac_plan_id'];

    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$group_ac_plan_id} ";
    $select_academic_plan_id = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_academic_plan_id)) {

        $academic_plan_direction_id = $row['academic_plan_direction_id'];
        $academic_plan_period = $row['academic_plan_period'];
        $academic_plan_organization_id = $row['academic_plan_organization_id'];
        $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
        $academic_plan_name = $row['academic_plan_name'];
        $academic_count_semesters = $row['academic_count_semesters'];
        $academic_plan_direction_id = $row['academic_plan_direction_id'];

    }

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-graduation-cap text-muted" aria-hidden="true"></i> 
            &nbsp;Зачетная книжка:&nbsp;<?php echo $academic_plan_name; ?>
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <?php 
            $query = "SELECT * FROM asu_directions WHERE direction_id = {$academic_plan_direction_id}";
            $select_directions_id = mysqli_query($connection,$query);

            while($row = mysqli_fetch_assoc($select_directions_id)) {

                $direction_code = $row['direction_code'];
                $direction_title = $row['direction_title'];

                echo "<p><b>Направление:</b>&nbsp;{$direction_code}&nbsp;{$direction_title}</p>";

            }
        
        
            $query = "SELECT * FROM asu_basic_education WHERE basic_education_id = {$academic_plan_basic_education_id}";
            $select_basic_education_id = mysqli_query($connection,$query);

            while($row = mysqli_fetch_assoc($select_basic_education_id)) {

                $basic_education_title = $row['basic_education_title'];

                echo "<p><b>Базовое образование:</b>&nbsp;{$basic_education_title}</p>";
            }
        
            echo "<p><b>Срок обучения:</b>&nbsp;{$academic_plan_period}";
        ?>
        
    </div>
</div>
<br>
<div class="row" id="action-container">
    
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <ul class="nav nav-tabs">
            <?php 

                for($i=1; $i <= $academic_plan_period; $i++) {
                    
                    if($i == $current_sem) {
                        echo "  <li class='active'>
                                    <a href='#ssemester{$i}' data-toggle='tab'>
                                        <i class='fa fa-check-circle text-success' aria-hidden='true'></i>
                                        Семестр № {$i}
                                    </a>
                                </li>";
                    } else {
                        echo "<li><a href='#ssemester{$i}' data-toggle='tab'>Семестр № {$i}</a></li>";
                    }
                    
                } 

            ?>
        </ul>
    </div>
</div>
<br>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

        <!-- Tab panes -->
        <div class="tab-content">
            <?php 
                for($i=1; $i <= $academic_plan_period; $i++) { 
                    $number = 0;
                    if($i == $current_sem) {
                        echo "<div class='tab-pane active' id='ssemester{$i}'>";
                    } else {
                        echo "<div class='tab-pane' id='ssemester{$i}'>";                        
                    }
            
            
            ?>

                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr class="active">
                                    <th>№</th>
                                    <th>Дисциплина</th>
                                    <th>Часы</th>
                                    <th>
                                        <div class ="pull-left">Оценка</div>
                                        <div class="pull-right">
                                            <i class='fa fa-info-circle text-primary' aria-hidden='true' title = 'Вид контроля'></i>
                                        </div>
                                    </th>
                                    <th>
                                        <div class ="pull-left">Дата</div> 
                                        <div class="pull-right">
                                            <i class="fa fa-calendar-check-o text-danger" aria-hidden="true" title="Дата последнего редактирования"></i>
                                        </div>
                                    </th>
                                    <th>Примечание</th>
                                    <th class="text-center">ID</th>
                                    <?php 
                                        if($_SESSION['user_role_id'] == 1) {
                                            echo "<th class='text-center'></th>";
                                        } 
                                    ?>
                                </tr>
                            </thead>
                            <tbody>

                               <?php
                    
                                    $query = "SELECT asu_content_discipline.content_discipline_id, asu_content_discipline.content_discipline_d_id, asu_content_discipline.content_discipline_course_work, asu_content_discipline.content_discipline_control, asu_content_discipline.moodle_id,
                                    asu_content_discipline.content_discipline_control,
                                    asu_content_discipline.content_discipline_hour,
                                    asu_content_discipline.content_discipline_course_work, clg_course.fullname
                                    FROM asu_content_discipline
                                    LEFT JOIN clg_course
                                    ON asu_content_discipline.moodle_id = clg_course.id
                                    WHERE content_discipline_ac_plan_id = {$group_ac_plan_id} AND content_discipline_semester = {$i} 
                                    ORDER BY clg_course.fullname";
                    
                                    $select_content_discipline_by_id = mysqli_query($connection, $query);

                                    while($row = mysqli_fetch_assoc($select_content_discipline_by_id)) {
                                        $number++;
                                        
                                        // This data from table asu_content_discipline
                                        $content_discipline_id = $row['content_discipline_id'];
                                        $content_discipline_d_id = $row['content_discipline_d_id'];
                                        $content_discipline_course_work = $row['content_discipline_course_work'];
                                        $content_discipline_control = $row['content_discipline_control'];
                                        $content_discipline_moodle_id = $row['moodle_id'];
                                        $content_discipline_control = $row['content_discipline_control'];
                                        $content_discipline_course_work = $row['content_discipline_course_work'];
                                        $content_discipline_hour = $row['content_discipline_hour'];
                                        
                                        // This data table clg_course
                                        $fullname = $row['fullname'];
                                        
                                        echo "<tr>";
                                        echo "<td>{$number}</td>";
                                        
                                        if(isset($fullname)) {
                                            echo "<td id='fullname'>{$fullname}</td>";
                                        } else {

                                            $query = "SELECT * FROM  asu_disciplines WHERE discipline_id = {$content_discipline_d_id} ";
                                            $select_discipline_by_id = mysqli_query($connection, $query);

                                            $row = mysqli_fetch_assoc($select_discipline_by_id);

                                            $discipline_title = $row['discipline_title'];

                                            echo "<td class='text-warning'>{$discipline_title}</td>";
                                        
                                        }
                                        
                                        echo "<td>{$content_discipline_hour}</td>";
                                        
                                        
                                        $query = "SELECT grade_id, grade, grade_note_name, DATE_FORMAT(grade_date, '%d.%m.%Y' ) grade_date_format, DATE_FORMAT(grate_edit_date, '%d.%m.%Y') grate_edit_date_format,
                                        DATE_FORMAT(coursework_date, '%d.%m.%Y') coursework_date_format, coursework_grade, DATE_FORMAT(coursework_edit_date, '%d.%m.%Y') coursework_edit_date_format
                                        FROM asu_grades WHERE moodle_student_id = {$moodle_id} AND moodle_course_id = {$content_discipline_moodle_id}";
                                        $select_studen_by_moodle_id = mysqli_query($connection, $query);
                                        $row = mysqli_fetch_assoc($select_studen_by_moodle_id);
                                        $grade_id = $row['grade_id'];
                                        $grade = $row['grade'];
                                        $grade_date = $row['grade_date_format'];
                                        $grate_edit_date = $row['grate_edit_date_format'];
                                        $grade_note_name = $row['grade_note_name'];
                                        $coursework_grade = $row['coursework_grade'];
                                        $coursework_date = $row['coursework_date_format'];
                                        $coursework_edit_date = $row['coursework_edit_date_format'];
                                        
                                        if(isset($fullname)) {                                        
                                            if(isset($grade)) {
                                                echo "<td>
                                                        <div class='pull-left'>{$grade}</div>
                                                        <div class='pull-right'>
                                                            <i class='fa fa-info-circle text-primary' aria-hidden='true' title = '{$content_discipline_control}'></i>
                                                        </div>
                                                </td>";
                                            } else {
                                                echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";     
                                            }
                                            
                                        } else {
                                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                        }
                                       
                                        
                                        if(isset($grade_date)) {
                                            if(isset($grate_edit_date)) {
                                                echo "<td>
                                                        <div class='pull-left'>{$grade_date}</div>
                                                        <div class='pull-right'>
                                                            <i class='fa fa-calendar-check-o text-danger' aria-hidden='true' title='{$grate_edit_date}'></i>
                                                        </div>";
                                            } else {
                                                echo "<td>{$grade_date}</td>";  
                                            }

                                        } else {
                                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                        }
                                        
                                        if(isset($grade_note_name)) {
                                            echo "<td>{$grade_note_name}</td>";
                                        } else {
                                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                        }
                                        
                                        // This cell id discipline
                                        echo "<td class='text-center'>{$content_discipline_id}</td>";
                                        
                                        
                                        if($_SESSION['user_role_id'] == 1) {
                                            // This cell function add or edit grade 
                                            if(isset($fullname)) {
                                                if(isset($grade)) {
                                                    echo "<td class='text-center'>
                                                            <a class='edit-grade' rel='$grade_id' href='javascript:void(0)'>
                                                                <i class='fa fa-pencil-square-o' aria-hidden='true'></i>
                                                            </a>
                                                        </td>";
                                                } else {
                                                    echo "<td class='text-center'>
                                                                <a class='add-grade' rel='$content_discipline_moodle_id-$enrollee_id-' href='javascript:void(0)'>
                                                                <i class='fa fa-plus-circle' aria-hidden='true'></i>
                                                            </a>
                                                        </td>";
                                                }
                                            } else {
                                                echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                            }
                                        }
                                        echo "</tr>";
                                        
                                        
                                        // This string  course work
                                        if($content_discipline_course_work == 'Есть') {
                                            
                                            echo "<tr>";
                                            // This cell number
                                            echo "<td class='text-center text-muted'>$number.1</td>";
                                            
                                            // This cell name discipline
                                            if(isset($fullname)) {
                                                
                                                echo "<td class='text-muted'>{$fullname} (Курсовая работа)</td>";
                                            
                                            } else {

                                                echo "<td class='text-muted'>{$discipline_title} (Курсовая работа)</td>";

                                            }
                                            
                                             echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                            
                                            // This cell grade
                                            if(isset($coursework_grade)) {
                                                echo "<td class='text-center'>{$coursework_grade}</td>"; 
                                            } else {
                                                echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                            }
                                            
                                            
                                            // This cell date
                                            
                                            if(isset($coursework_date)) {
                                                if(isset($coursework_edit_date)) {
                                                    echo "<td>
                                                            <div class='pull-left'>{$coursework_date}</div>
                                                            <div class='pull-right'>
                                                                <i class='fa fa-calendar-check-o text-danger' aria-hidden='true' title='{$coursework_edit_date}'></i>
                                                            </div>";
                                                } else {
                                                    echo "<td>{$coursework_date}</td>";  
                                                }
    
                                            } else {
                                                echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                            }
                                            
                                            // This cell note
                                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                            
                                            // This cell id discpline
                                            echo "<td class='text-center'>{$content_discipline_id}</td>";
                                            
                                            if($_SESSION['user_role_id'] == 1) {
                                                // This cell function add or edit grade 
                                                if(isset($fullname)) {
                                                    if(isset($coursework_grade)) {
                                                        echo "<td class='text-center'>
                                                                <a class='edit-grade' rel='$grade_id' href='javascript:void(0)'>
                                                                    <i class='fa fa-pencil-square-o' aria-hidden='true'></i>
                                                                </a>
                                                            </td>";
                                                    } else {
                                                        echo "<td class='text-center'>
                                                                    <a class='add-grade' rel='$content_discipline_moodle_id-$enrollee_id-' href='javascript:void(0)'>
                                                                    <i class='fa fa-plus-circle' aria-hidden='true'></i>
                                                                </a>
                                                            </td>";
                                                    }
                                                } else {
                                                    echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                                }
                                            }
                                            echo "</tr>";
                                            
                                        }

                                    } 

                                ?>
                            </tbody>
                        </table>
                           
            <?php echo "</div>"; } ?>

        </div>
    </div>
    
</div>
<br>

<!-- My JavaScript -->
<script>

 // This code add grade to database table asu_grade
		
		var site1 = <?php echo "'$siteprefix/admin/queries/grades/add_grade_student.php'"; ?>;
		var site2 = <?php echo "'$siteprefix/admin/queries/grades/process_grade_student.php'"; ?>;
    
    $("#action-container").hide(); /* hides div with id=action-container*/
    $(".add-grade").on('click', function() {
        var str = $(this).attr("rel");

        var firstIndex = str.indexOf("-");
        var lastIndex = str.lastIndexOf("-");
        
        var firstChar = str.substring(0,firstIndex);
        var secondChar = str.substring(firstIndex+1,lastIndex);
        
        $("#action-container").show();

        $.post(site1, {firstChar: firstChar, secondChar: secondChar}, function(data){

            $("#action-container").html(data);

        });
        

    });
    
    // Add grade code function ends
    
    // This code edit grade
    
    $("#action-container").hide(); /* hides div with id=action-container*/
    $(".edit-grade").on('click', function() {
        var grade_id = $(this).attr("rel");
 
//        var firstIndex = str.indexOf("-");
//        var midleIndex = str.indexOf(".");
//        var lastIndex = str.lastIndexOf("-");
//        var lastIndexDot = str.lastIndexOf(".");
//        
//        var firstChar = str.substring(0,firstIndex);
//        var secondChar = str.substring(firstIndex+1,midleIndex);
//        var thirdChar = str.substring(midleIndex+1,lastIndexDot);
//        var fourChar = str.substring(lastIndexDot+1,lastIndex);
          
        $("#action-container").show();

        $.post(site2, {grade_id: grade_id}, function(data){

            $("#action-container").html(data);

        });

    });

    // Edit grade code function ends

</script>  