
<?php

    include "../../../includes/db.php"; 

    if(isset($_POST['filter_name']) || isset($_POST['filter_number'])) {

        $filter_name = mysqli_real_escape_string($connection, $_POST['filter_name']);
        $filter_number = mysqli_real_escape_string($connection, $_POST['filter_number']);
        
        
        $query =    "
                        SELECT
                            asu_treaty.treaty_id AS treaty_id,
                            asu_treaty.treaty_enrollee_id AS treaty_enrollee_id,
                            asu_treaty.treaty_number AS treaty_number,
                            asu_treaty.treaty_date_conclusion AS treaty_date_conclusion,
                            asu_treaty.treaty_cost AS treaty_cost,

                            CONCAT(asu_enrollee.enrollee_surname,' ',asu_enrollee.enrollee_name,' ',asu_enrollee.enrollee_patronymic) AS enrollee,

                            asu_academic_plan.academic_plan_name AS academic_plan_name

                        FROM asu_treaty 
                        INNER JOIN asu_enrollee
                            ON asu_treaty.treaty_enrollee_id = asu_enrollee.enrollee_id
                        INNER JOIN asu_academic_plan
                            ON asu_treaty.treaty_plan_id = asu_academic_plan.academic_plan_id
         
                    ";
        
        $wheres = array();
        
        $wheres[] = "asu_treaty.treaty_status = 'Заключен'";
        
        if ($filter_number) {
             $wheres[] = "asu_treaty.treaty_number LIKE '$filter_number%'";
        }
        
        if ($filter_name) {
             $wheres[] = "asu_enrollee.enrollee_surname LIKE '$filter_name%'";
        }
        
        if (!empty($wheres)) {
            $query .= " WHERE " . implode(' AND ', $wheres);
        }
        
        $query .= " ORDER BY asu_treaty.treaty_cost";
        
        $select_all_payments = mysqli_query($connection, $query);
        
        $count = mysqli_num_rows($select_all_payments);
        
        $message = "<div class='alert alert-info'><b>Результат: {$count}</b><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button></div>";
        
        if(!$select_all_payments) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }
        
    }

?>

<?php echo $message; ?>

    
<table class="table table-hover table-bordered table-filter">
    <thead>
        <tr class="active">
            <th>Номер</th>
            <th>Дата заключения	</th>
            <th>Ф.И.О.</th>
            <th>План</th>
            <th>Стоимость, руб.</th>
            <th class="text-center">ID</th>
            <th class="text-center">Данные об оплате</th>
        </tr>
    </thead>
    <tbody>

            <?php                
        
                    while($row = mysqli_fetch_assoc($select_all_payments)) {
                        
                        $treaty_id = $row['treaty_id'];
                        $treaty_enrollee_id = $row['treaty_enrollee_id'];
                        $treaty_number = $row['treaty_number'];
                        $treaty_date_conclusion = $row['treaty_date_conclusion'];
                        $treaty_plan_id = $row{'treaty_plan_id'};
                        $treaty_cost = $row['treaty_cost'];
                        $treaty_date_dissolution = $row['treaty_date_dissolution'];
                        $treaty_status = $row['treaty_status'];
                        
                        $enrollee = $row['enrollee'];
                        
                        $academic_plan_name = $row['academic_plan_name'];
                        
                        echo "<tr>";
                            echo "<td>{$treaty_number}</td>";
                            echo "<td>{$treaty_date_conclusion}</td>";
                            echo "<td><a href='enrollee.php?source=view_enrollee&e_id={$treaty_enrollee_id}'>{$enrollee}</a></td>";
                            echo "<td>{$academic_plan_name}</td>";
                            echo "<td>{$treaty_cost}</td>";
                            echo "<td class='text-center'>{$treaty_id}</td>";
                            echo "<td class='text-center'><a href='payment.php?source=add_payment&pay_id={$treaty_id}''><i class='fa fa-plus-circle' aria-hidden='true'></i> Добавить</a></td>";
                        echo "</tr>";
 
                        
                    }
        
            ?>


    </tbody>
</table>
    
    
    

<script>
// table sorter
    
    $(".table-filter").tablesorter({
        widthFixed: true, 
        widgets: ['zebra']
    }); // end table sorter

    
    
    $(function(){
        $('[rel="popover"]').popover({
            container: 'body',
            html: true,
            content: function () {
                var clone = $($(this).data('popover-content')).clone(true).removeClass('hide');
                return clone;
            }
            }).click(function(e) {
                e.preventDefault();
        });
    });
</script>


