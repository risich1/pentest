
<?php

    include "../../../includes/db.php"; 
//$_POST['filter_name']) ||
    if(isset($_POST['filter_period']) || isset($_POST['filter_group']) || isset($_POST['filter_discipline']) || isset($_POST['filter_name'])) {

        $filter_period = mysqli_real_escape_string($connection, $_POST['filter_period']);
        $filter_group = mysqli_real_escape_string($connection, $_POST['filter_group']);
        $filter_discipline = mysqli_real_escape_string($connection, $_POST['filter_discipline']);
        $filter_name = mysqli_real_escape_string($connection, $_POST['filter_name']);
        
        
        $query =    "

                        SELECT
                            asu_session.session_id AS session_id,
                            CONCAT(asu_session.session_period,' ',asu_session.session_time) session_period,
                            
                            asu_groups.group_id AS group_id,
                            asu_groups.group_number AS group_number,

                            asu_academic_plan.academic_plan_id AS academic_plan_id,
                            asu_academic_plan.academic_plan_name AS academic_plan_name,
                            
                            clg_course.id AS fullname_id,
                            clg_course.fullname AS fullname,
                            
                            CONCAT(teacher_surname,' ',teacher_name,' ',teacher_patronymic) teacher                         
                            
                        
                        FROM clg_course
                        INNER JOIN asu_content_discipline
                            ON clg_course.id = asu_content_discipline.moodle_id
                        INNER JOIN asu_session
                            ON asu_content_discipline.content_discipline_session = asu_session.session_id
                        INNER JOIN asu_academic_plan
                            ON asu_academic_plan.academic_plan_id=asu_content_discipline.content_discipline_ac_plan_id
                        INNER JOIN asu_groups
                            ON asu_groups.group_ac_plan_id = asu_academic_plan.academic_plan_id
                        INNER JOIN asu_load_teacher
                            ON asu_load_teacher.discipline_moodle_id = clg_course.id
                        INNER JOIN asu_teacher
                            ON asu_teacher.teacher_id = asu_load_teacher.teacher_id
                        

                    ";
        $wheres = array();
        
//        if ($filter_name) {
//            $query .= " WHERE asu_enrollee.enrollee_surname LIKE '$filter_name%'";
//        } else {
//            $query .= " WHERE";
//        }


        if ($filter_period) {
             $wheres[] = "asu_session.session_id = {$filter_period}";
        }


        if ($filter_group) {
             $wheres[] = "asu_groups.group_id = {$filter_group}";
        }
        
        if ($filter_discipline) {
             $wheres[] = "clg_course.id = {$filter_discipline}";
        }
        
        if ($filter_name) {
             $wheres[] = "asu_teacher.teacher_surname LIKE '$filter_name%'";
        }
        
        
        if (!empty($wheres)) {
            $query .= " WHERE " . implode(' AND ', $wheres);
        }
        $query .= " ORDER BY clg_course.fullname";
        
        $select_all_statements = mysqli_query($connection, $query);
        
        $count = mysqli_num_rows($select_all_statements);
        
        $message = "<div class='alert alert-info'><b>Результат: {$count}</b><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button></div>";
        
        if(!$select_all_statements) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }
        
    }

?>

<?php echo $message; ?>

    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
            <table class="table table-hover table-bordered table-filter">
                <thead>
                    <tr class="active">
                        <th>№</th>
                        <th>Сессия</th>
                        <th>Группа</th>
                        <th>Учебный план</th>
                        <th>Дисциплина</th>
                        <th>Преподаватель</th>
                        <th>Ведомости</th>
                        <th class="text-center"></th>
                    </tr>
                </thead>
                <tbody>
                
                    <?php

                        while($row = mysqli_fetch_assoc($select_all_statements)) {
                            $number++;

                            $session_id = $row['session_id'];
                            $session = $row['session_period'];

                            $group_id = $row['group_id'];
                            $group_number = $row['group_number'];
                            
                            $discipline_title = $row['discipline_title'];

                            $academic_plan_id = $row['academic_plan_id'];
                            $academic_plan_name = $row['academic_plan_name'];

                            $fullname_id = $row['fullname_id'];
                            $fullname = $row['fullname'];
                            
                            $teacher = $row['teacher'];


                            echo "<tr>";
                            echo "<td>$number</td>";
                            echo "<td>$session</td>";
                            echo "<td>$group_number</td>";
                            echo "<td>$academic_plan_name</td>";
                            echo "<td>$fullname</td>";
                            echo "<td>$teacher</td>";

                            $query = "SELECT * FROM asu_statements 

                                        WHERE statements_session = {$session_id}
                                        AND statements_academic_plan = {$academic_plan_id}
                                        AND statements_group = {$group_id}
                                        AND statements_fullname = {$fullname_id}

                                    ";

                            echo "<td>";
                            $select_statements_by_data = mysqli_query($connection,$query);
                            
                            
                            if(!$select_statements_by_data) {

                                die("QUERY FAILED ." . mysqli_error($connection));

                            }

                            while($row = mysqli_fetch_assoc($select_statements_by_data)) {
                                $statements_id = $row['statements_id'];
                                $statements_date = $row['statements_date'];

                                echo "<a target='_blank' href='statements.php?source=view_statement&s_id={$statements_id}'>№{$statements_id} от {$statements_date}</a>";
                                echo "<br>";
                            }

                            echo "</td>";


                            echo "<td class='text-center'>
                                    <a target='_blank' href='statements.php?source=add_statement&f_id={$fullname_id}&s_id={$session_id}&g_id={$group_id}&ap_id={$academic_plan_id}'>
                                        <i class='fa fa-plus-circle text-primary' aria-hidden='true'></i>
                                    </a>
                                </td>";
                            echo "</tr>";

                        }
                    ?>

                </tbody>
            </table>
        </div>
    </div>

<script>
// table sorter
    
    $(".table-filter").tablesorter({
        widthFixed: true, 
        widgets: ['zebra']
    }); // end table sorter

    
    
    $(function(){
        $('[rel="popover"]').popover({
            container: 'body',
            html: true,
            content: function () {
                var clone = $($(this).data('popover-content')).clone(true).removeClass('hide');
                return clone;
            }
            }).click(function(e) {
                e.preventDefault();
        });
    });
</script>


