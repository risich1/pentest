
<table class="table table-hover table-bordered table-filter">
    <thead>
        <tr class="active">
            <th>№</th>
            <th>Учебный план</th>
            <th>Дисциплина  <span class='text-danger' title=' Дисциплины нет в Moodle'>*</span></th>
            <th>Сессия<br> <small>(семестр, срок обучения)</small></th>
            <th>Семестр</th>
            <th>Курс</th>
            <th>Преподаватель</th>  
            <th class="text-center">Добавить</th>
            <th class="text-center">Удалить</th>
        </tr>
    </thead>
    <tbody >

    <?php

    include "../../../includes/db.php"; 

    if(isset($_POST['select_session'])) {

    $search = $_POST['select_session']; 
    
        
    $query = "SELECT asu_content_discipline.content_discipline_id, asu_content_discipline.content_discipline_d_id, asu_content_discipline.moodle_id, asu_content_discipline.content_discipline_ac_plan_id, asu_content_discipline.content_discipline_semester, asu_content_discipline.content_discipline_courses, asu_content_discipline.content_discipline_session, asu_academic_plan.academic_plan_name, clg_course.fullname      
    FROM asu_content_discipline
    INNER JOIN asu_academic_plan 
    ON asu_content_discipline.content_discipline_ac_plan_id = asu_academic_plan.academic_plan_id
    LEFT OUTER JOIN clg_course
    ON clg_course.id = asu_content_discipline.moodle_id
    WHERE asu_content_discipline.content_discipline_session = {$search}
    ORDER BY clg_course.fullname ";

    $select_all_content_discipline = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_all_content_discipline)) {

        $numbers++;

        $content_discipline_id = $row['content_discipline_id'];
        $content_discipline_d_id = $row['content_discipline_d_id'];
        $moodle_id = $row['moodle_id'];
        $academic_plan_name = $row['academic_plan_name'];
        $fullname_course = $row['fullname'];
        $content_discipline_session = $row['content_discipline_session'];
        $content_discipline_semester = $row['content_discipline_semester'];
        $content_discipline_courses = $row['content_discipline_courses'];        

        echo "<tr>";
        echo "<td>{$numbers}</td>";
        echo "<td>{$academic_plan_name}</td>";
        
        if($fullname_course) {
            echo "<td>{$fullname_course}</td>";
        } else {
            
            $query = "SELECT discipline_title FROM asu_disciplines WHERE discipline_id = {$content_discipline_d_id} ";
            $select_discipline_by_id = mysqli_query($connection, $query);
            
            $row = mysqli_fetch_assoc($select_discipline_by_id);
            $discipline_title = $row['discipline_title'];
            
            echo "<td class='text-warning'>{$discipline_title}*</td>";
        }
        

        $query = "SELECT session_id, session_period, session_time FROM asu_session WHERE session_id = {$content_discipline_session} ";

        $select_session_by_id = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_session_by_id);
        
        $session_id = $row['session_id'];
        $session_period = $row['session_period'];
        $session_time = $row['session_time'];
        $session = $session_period;
        $session .= ", ";
        $session .= $session_time;

        if(isset($session_period)) {
            echo "<td>{$session}</td>";
        } else {
            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
        }

        echo "<td>{$content_discipline_semester}</td>";
        echo "<td>{$content_discipline_courses}</td>";

        $query = "
        SELECT asu_load_teacher.teacher_id, asu_teacher.teacher_id, asu_teacher.teacher_surname, asu_teacher.teacher_name, asu_teacher.teacher_patronymic 
        FROM asu_load_teacher 
        INNER JOIN asu_teacher 
        ON asu_teacher.teacher_id = asu_load_teacher.teacher_id
        WHERE asu_load_teacher.discipline_moodle_id = {$moodle_id}";

        $select_discipline_teacher_by_id = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_discipline_teacher_by_id);

        $teacher_id = $row['teacher_id'];
        $teacher_surname = $row['teacher_surname'];
        $teacher_name = $row['teacher_name'];
        $teacher_patronymic = $row['teacher_patronymic'];
        $teacher = $teacher_surname . " " . $teacher_name . " " . $teacher_patronymic;

        if (isset($teacher_id)) {
            echo "<td><a href='teachers.php?source=view_teacher&t_id={$teacher_id}'>{$teacher}</a></td>";
        } else {
            echo "<td>-</td>";
        }

        if (isset($teacher_id)) {
            echo "<td class='text-center'><i class='text-success fa fa-check-circle text-muted' aria-hidden='true' title='Преподаватель по дисциплине установлен'></i></td>";
        } else {
            if($fullname_course) {
                 echo "<td class='text-center'><a class='text-primary' href='teachers.php?source=add_load&moodle_id={$moodle_id}&session_id={$session_id}'><i class='fa fa-plus-circle' aria-hidden='true'></i></a></td>";
            } else {
               echo "<td class='text-center'><i class='fa fa-plus-circle text-muted' aria-hidden='true'></i></td>"; 
            }
            
        }

        if(isset($teacher_id)) {
           echo "<td class='text-center'><a class='text-danger' href='teachers.php?delete_discipline={$moodle_id}&t_id={$teacher_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>"; 
        } else {
            echo "<td class='text-center'><i class='fa fa-trash text-muted' aria-hidden='true'></i></td>"; 
        }


        echo "</tr>";
}

    }

?>

        
    </tbody>
</table>

<script>
// table sorter
    
    $(".table-filter").tablesorter({
        widthFixed: true, 
        widgets: ['zebra']
    }); // end table sorter

</script>


