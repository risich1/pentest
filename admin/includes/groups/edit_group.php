<?php

if(isset($_GET['g_id'])) {
    
    $the_group_id = $_GET['g_id'];
    
}




$query = "SELECT * FROM asu_groups WHERE group_id = {$the_group_id} ";
$select_group_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_group_id)) {

    $group_id = $row['group_id']; 
    $group_number = $row['group_number'];
    $group_ac_plan_id = $row['group_ac_plan_id'];
    
 
    if(isset($_POST['update_group'])) {
       
        $group_number = $_POST['group_number'];
        $group_ac_plan_id = $_POST['group_ac_plan_id'];
        
        
        $query = "UPDATE asu_groups SET ";
        $query .= "group_number = '{$group_number}', ";
        $query .= "group_ac_plan_id = {$group_ac_plan_id} ";
        $query .= "WHERE group_id = {$the_group_id} ";
        
        $update_group = mysqli_query($connection,$query);
        
        if(!$update_group) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }
        
        $message = "<div class='alert alert-success'>Данные обновлены.</div>";
        
        
       
    }
    
    
}


?>


<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-id-card-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Редактировать данные группы
        </h1>
    </div>
</div>  
<?php echo $message; ?>
<div class="row">   
    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="text-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> Добавить группу</h4>
            </div>
            <div class="panel-body">
                <form action="" method="post" enctype="multipart/form-data"> 
                    <div class="form-group">
                        <label for="group_number">Номер группы</label>
                        <input type="text" class="form-control" name="group_number" value="<?php echo $group_number; ?>">
                    </div>
                    
                    <div class="form-group">  
                        <label for="group_ac_plan_id">Учебный план</label>
                        <select name="group_ac_plan_id" class="form-control" required>
                            <?php
                                if(isset($_GET['choose'])) {
                                
                                    $the_direction_id = $_GET['choose'];
                                    
                                    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_direction_id = {$the_direction_id} ";
                                    $select_all_academic_plan = mysqli_query($connection,$query);

                                    while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                                        $academic_plan_id = $row['academic_plan_id'];
                                        $academic_plan_name = $row['academic_plan_name'];
                                        $academic_plan_period = $row['academic_plan_period'];
                                        $academic_plan_organization_id = $row['academic_plan_organization_id'];
                                        $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];


                                        $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";

                                        $select_organization_id = mysqli_query($connection,$query);

                                        while($row = mysqli_fetch_assoc($select_organization_id)) {

                                            $organization_title = $row['organization_title'];
                                        }

                                        echo "<option value='$academic_plan_id'>{$academic_plan_name} {$organization_title} {$academic_plan_period}</option>";
                                    }
                                
                                } else {

                                    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_direction_id = {$group_ac_plan_id} ";
                                    $select_all_academic_plan = mysqli_query($connection,$query);

                                    while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                                        $academic_plan_id = $row['academic_plan_id'];
                                        $academic_plan_name = $row['academic_plan_name'];
                                        $academic_plan_period = $row['academic_plan_period'];
                                        $academic_plan_organization_id = $row['academic_plan_organization_id'];
                                        $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];


                                        $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";

                                        $select_organization_id = mysqli_query($connection,$query);

                                        while($row = mysqli_fetch_assoc($select_organization_id)) {

                                            $organization_title = $row['organization_title'];
                                        }

                                        echo "<option value='$academic_plan_id'>{$academic_plan_name} {$organization_title} {$academic_plan_period}</option>";

                                    }
                                }
                                
                                

                            ?>
                        </select>
                    </div>
                    <div class="form-group">
                        <input class="btn btn-primary" type="submit" name="update_group" value="Сохранить">
                    </div>    
                </form>
            </div>
        </div>
    </div>

    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
        <div class="form-group">
            <h4 class="text-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> Выбрать направление</h4>
        </div>
        <div class="form-group">
            
        </div>
        
        <div class="form-group">
            <table class="table table-hover table-bordered">
                <thead>
                    <tr class="active">
                        <th class="text-center">ID</th>
                        <th>Код</th>
                        <th>Название</th>
                        <th class="text-center">Выбрать</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                            $query = "SELECT * FROM asu_directions";
                            $select_all_directions = mysqli_query($connection, $query);
                            while($row = mysqli_fetch_assoc($select_all_directions)) {

                                $direction_id = $row['direction_id']; 
                                $direction_code = $row['direction_code'];
                                $direction_title = $row['direction_title'];
                                $direction_date = $row['direction_date'];

                                echo "<tr>";
                                echo "<td class='text-center'>{$direction_id}</td>";
                                echo "<td>{$direction_code}</td>";
                                echo "<td>{$direction_title}</td>";
                                echo "<td class='text-center'>
                                    <a class='text-muted' href='groups.php?source=edit_group&choose={$direction_id}&g_id={$group_id}'>
                                        <i class='fa fa-flag' aria-hidden='true'>
                                        </i>
                                    </a>
                                </td>";
                                echo "</tr>";
                            }
                        ?>
                        
                </tbody>
            </table>
            
        </div>
    </div>
</div>


   
   
