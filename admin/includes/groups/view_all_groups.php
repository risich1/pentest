<?php
    if($_SESSION['user_role_id'] != 3) {
            include "includes/menu_deanery.php"; 
    }
?> 
<?php

if(isset($_GET['choose'])) {
                                
    $the_direction_id = $_GET['choose'];
                                
}

if(isset($_POST['add_group'])) {

    $group_number = $_POST['group_number'];
    $group_ac_plan_id = $_POST['group_ac_plan_id'];
    
    $group_date = date('d-m-y');

    if($group_number == "" || empty($group_number)) { // empty - определяет, установлена ли переменная

        $message = "Это поле не должно быть пустым!";

    } else {

        $query = "INSERT INTO asu_groups(group_number, group_ac_plan_id, group_date) ";
        $query .= "VALUE('{$group_number}', {$group_ac_plan_id}, now()) ";

        $create_group = mysqli_query($connection, $query);

        if(!$create_group) {

            die('QUERY FAILED' . mysqli_error($connection));

        }

    }

}
?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-users fa-fw text-muted" aria-hidden="true"></i>&nbsp;Группы
        </h1>
    </div>
</div>
<div class="row">   
    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="text-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> Добавить группу</h4>
            </div>
            <div class="panel-body">
                <form action="" method="post" enctype="multipart/form-data"> 
                <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

                    <div class="form-group">
                        <label for="group_number">Номер группы</label>
                        <p class="text-danger"><?php echo $message; ?></p>
                        <input type="text" class="form-control" name="group_number">
                    </div>
                    
                    <div class="form-group">  
                        <label for="group_ac_plan_id">Учебный план</label>
                        <select name="group_ac_plan_id" class="form-control" required>
                            <?php

                                $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_direction_id = {$the_direction_id} ";
                                $select_all_academic_plan = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                                    $academic_plan_id = $row['academic_plan_id'];
                                    $academic_plan_name = $row['academic_plan_name'];
                                    $academic_plan_period = $row['academic_plan_period'];
                                    $academic_plan_organization_id = $row['academic_plan_organization_id'];
                                    $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
                                    
                                    
                                    $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";
                                    
                                    $select_organization_id = mysqli_query($connection,$query);

                                    while($row = mysqli_fetch_assoc($select_organization_id)) {
                                        
                                        $organization_title = $row['organization_title'];
                                    }

                                    echo "<option value='$academic_plan_id'>{$academic_plan_name} {$organization_title} {$academic_plan_period}</option>";

                                }
                                
                                

                            ?>
                        </select>
                    </div>
                    <div class="form-group">
                        <input class="btn btn-primary" type="submit" name="add_group" value="Добавить">
                    </div>    
                </form>
            </div>
        </div>

            <?php 

                if(isset($_GET['edit'])) {

                    include ("../admin/includes/groups/update_group.php");

                }

            ?>

    </div>

    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
        <div class="form-group">
            <h4 class="text-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> Выбрать направление</h4>
        </div>
        <div class="form-group">
            
        </div>
        
        <div class="form-group">
            <table class="table table-hover table-bordered">
                <thead>
                    <tr class="active">
                        <th class="text-center">ID</th>
                        <th>Код</th>
                        <th>Название</th>
                        <th class="text-center">Выбрать</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                            $query = "SELECT * FROM asu_directions";
                            $select_all_directions = mysqli_query($connection, $query);
                            while($row = mysqli_fetch_assoc($select_all_directions)) {

                                $direction_id = $row['direction_id']; 
                                $direction_code = $row['direction_code'];
                                $direction_title = $row['direction_title'];

                                echo "<tr>";
                                echo "<td class='text-center'>{$direction_id}</td>";
                                echo "<td>{$direction_code}</td>";
                                echo "<td>{$direction_title}</td>";
                                echo "<td class='text-center'>
                                    <a class='text-muted' href='groups.php?choose={$direction_id}'>
                                        <i class='fa fa-flag' aria-hidden='true'>
                                        </i>
                                    </a>
                                </td>";
                                echo "</tr>";
                            }
                        ?>
                        
                </tbody>
            </table>
            
        </div>
    </div>
</div>




<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <table class="table table-hover table-bordered">
            <thead>
                <tr class="active">
                    <th class="text-center">ID</th>
                    <th>Номер группы</th>
                    <th>Название УП</th>
                    <th>Учебный план</th>
                    <th>Срок обучения</th>
                    <th class="text-center">Количество студентов</th>
                    <th>Подробнее</th>
                    <th class="text-center">Редактировать</th>
                    <th class="text-center">Удалить</th>
                </tr>
            </thead>

            <tbody>
                <?php
                    $query = "SELECT * FROM asu_groups";
                    $select_all_groups = mysqli_query($connection, $query);
                    while($row = mysqli_fetch_assoc($select_all_groups)) {				
                        $group_id = $row['group_id']; 
                        $group_number = $row['group_number'];
                        $group_ac_plan_id = $row['group_ac_plan_id'];

                        echo "<tr>";
                            echo "<td class='text-center'>{$group_id}</td>";
                            echo "<td>{$group_number}</td>";
                            
                        $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$group_ac_plan_id} ";
                        $select_academic_plan_id = mysqli_query($connection, $query);
                        while($row = mysqli_fetch_assoc($select_academic_plan_id)) {
                            
                            
                            $academic_plan_name = $row['academic_plan_name'];
                            $academic_plan_period = $row['academic_plan_period'];
                            $academic_plan_direction_id = $row['academic_plan_direction_id'];
                            
                            echo "<td>{$academic_plan_name}</td>";
                            
                            $query = "SELECT * FROM asu_directions WHERE direction_id = {$academic_plan_direction_id} ";
                            $select_direction_id = mysqli_query($connection, $query);
                            while($row = mysqli_fetch_assoc($select_direction_id)) {
                                
                                $direction_code = $row['direction_code'];
                                $direction_title = $row['direction_title'];
                                
                                echo "<td>{$direction_code} {$direction_title}</td>";
                            }
                            
                            echo "<td>{$academic_plan_period}</td>";                        
                            
                        }
                            
                            $query = "SELECT * FROM asu_enrollee WHERE enrollee_group_id = {$group_id} AND enrollee_status != 'Архив'";
                            $select_all_enrollee = mysqli_query($connection,$query);
                            $enrollee_count = mysqli_num_rows($select_all_enrollee);
                                        
                            echo "<td class='text-center'>{$enrollee_count}</td>";
                        
                            echo "<td class='text-center'>
                                <a class='text-muted' href='groups.php?source=view_group&g_id={$group_id}'>
                                    <i class='fa fa-search' aria-hidden='true'>
                                    </i>
                                </a>
                            </td>";
                        
                            echo "<td class='text-center'>
                                <a class='text-muted' href='groups.php?source=edit_group&g_id={$group_id}'>
                                    <i class='fa fa-pencil-square-o' aria-hidden='true'>
                                    </i>
                                </a>
                            </td>";
                        
                            echo "<td class='text-center'>
                                <a class='text-danger' href='groups.php?delete={$group_id}'>
                                    <i class='fa fa-trash' aria-hidden='true'>
                                    </i>
                                </a>
                            </td>";
                        echo "</tr>";
                    }	
                ?>
            </tbody>
        </table>
    </div>
</div>
<?php
	if(isset($_GET['delete'])) {
		$the_group_id = $_GET['delete'];
        $query = "DELETE FROM asu_groups WHERE group_id = {$the_group_id} ";
        $delete_query = mysqli_query($connection, $query);
        header("Location: groups.php");
    }
?>