<?php

    if(isset($_GET['f_id']) && isset($_GET['s_id']) && isset($_GET['g_id']) && isset($_GET['ap_id'])) {
    
        $the_fullname_id = $_GET['f_id'];
        $the_session_id = $_GET['s_id'];
        $the_group_id = $_GET['g_id'];
        $the_academic_plan_id = $_GET['ap_id'];
        
        $query ="
                SELECT 
                    
                    clg_course.id,
                    clg_course.fullname,
                    asu_session.session_id,
                    CONCAT(asu_session.session_period,' ',asu_session.session_time) AS session,
                    asu_academic_plan.academic_plan_id,
                    asu_academic_plan.academic_plan_name,
                    asu_groups.group_id,
                    asu_groups.group_number

                    FROM 
                        clg_course
                
                    INNER JOIN asu_content_discipline
                        ON clg_course.id = asu_content_discipline.moodle_id
                    
                    INNER JOIN asu_session
                        ON asu_content_discipline.content_discipline_session = asu_session.session_id
                    
                    INNER JOIN asu_academic_plan
                        ON asu_academic_plan.academic_plan_id=asu_content_discipline.content_discipline_ac_plan_id
                    
                    INNER JOIN asu_groups
                        ON asu_groups.group_ac_plan_id = asu_academic_plan.academic_plan_id
                    
                    WHERE clg_course.id = {$the_fullname_id} 
                        AND asu_session.session_id = {$the_session_id}
                        AND asu_groups.group_id = {$the_group_id}
                        AND asu_academic_plan.academic_plan_id = {$the_academic_plan_id}
                ";
        $select_data_by_id = mysqli_query($connection,$query);
        $row = mysqli_fetch_assoc($select_data_by_id);
        
        $fullname_id = $row['id'];
        $fullname = $row['fullname'];
        
        $session_id = $row['session_id'];
        $session = $row['session'];
        
        $group_id = $row['group_id'];
        $group_number = $row['group_number'];
        
        $academic_plan_id = $row['academic_plan_id'];
        $academic_plan_name = $row['academic_plan_name'];
    
   }

    if(isset($_POST['create_statement'])) {
        
        $session_id = $_POST['session_id'];

        $academic_plan_id = $_POST['academic_plan_id'];

        $group_id = $_POST['group_id'];

        $fullname_id = $_POST['fullname_id'];


        
        
        $query = "INSERT INTO asu_statements(statements_session, statements_academic_plan, statements_group, statements_fullname, statements_date) ";
    
        $query .= "VALUES({$session_id}, {$academic_plan_id}, {$group_id}, {$fullname_id}, now()) ";
    
        $create_statements = mysqli_query($connection,$query);
        
        if(!$create_statements) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }
        
        $query = "SELECT max(statements_id) AS max_id FROM asu_statements";
        $select_all_statements = mysqli_query($connection,$query);
        $get_max_id = mysqli_fetch_assoc($select_all_statements);
        $max_id = $get_max_id['max_id'];
        
        
        header("refresh: 1; url=statements.php?source=view_statement&s_id={$max_id}");
        
    }


    
//        $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";
//        
        
        


?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-id-card-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Создать ведомость
        </h1>
    </div>
</div>  
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="statements.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<?php echo $message; ?>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">  
        <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
        <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="enrollee_name">Сессия</label>
                    <input type="hidden" class="form-control" name="session_id" value="<?php echo $session_id; ?>">
                    <input type="text" class="form-control" value="<?php echo $session; ?>" disabled>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="enrollee_name">Учебный план</label>
                    <input type="hidden" class="form-control" name="academic_plan_id" value="<?php echo $academic_plan_id; ?>">
                    <input type="text" class="form-control" value="<?php echo $academic_plan_name; ?>" disabled>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="discipline_name">Группа</label>
                    <input type="hidden" class="form-control" name="group_id" value="<?php echo $group_id; ?>">
                    <input type="text" class="form-control" value="<?php echo $group_number; ?>" disabled>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="grade_name">Дисциплина</label>
                    <input type="hidden" class="form-control" name="fullname_id" value="<?php echo $fullname_id; ?>">
                    <input type="text" name="grade_name" class="form-control" value="<?php echo $fullname; ?>" disabled>
                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-12">
                    <input class="btn btn-primary" type="submit" name="create_statement" value="Создать">
                </div>
            </div>

        </form>
    </div>
</div>