<?php
if(isset($_POST['select_academic_plan'])) {
    
    $academic_plan = $_POST['academic_plan'];
    
}

if(isset($_GET['t_id']) || isset($_GET['m_id']) || isset($_GET['ac_p'])) {
    
    $the_teacher_id = $_GET['t_id'];
    $the_moodle_id = $_GET['m_id'];
    $the_academic_plan_id = $_GET['ac_p'];
    
    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$the_academic_plan_id}";

    
    $select_discipline = mysqli_query($connection, $query);
    

}

if(isset($_GET['t_id'])) {
    
    $the_teacher_id = $_GET['t_id'];
    
    $query = "SELECT teacher_surname, teacher_name, teacher_patronymic
    FROM asu_teacher WHERE teacher_id = {$the_teacher_id}";
    $select_teacher_by_id = mysqli_query($connection, $query);
    
    $row = mysqli_fetch_assoc($select_teacher_by_id);
    
    $teacher_surname = $row['teacher_surname'];
    $teacher_name = $row['teacher_name'];
    $teacher_patronymic = $row['teacher_patronymic'];
    

}



?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-download text-muted" aria-hidden="true"></i> 
            &nbsp;Выбрать учебный план
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
       <div class="btn-group">
        <a href="teachers.php?source=load_teacher&t_id=<?php echo $the_teacher_id; ?>" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
        </div>
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="well">
            <p><b>Преподаватель:</b> <?php echo $teacher_surname . ' ' . $teacher_name . ' ' . $teacher_patronymic; ?> </p>
        </div>
    </div>
</div>




<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header">
            <i class="fa fa-bookmark text-muted" aria-hidden="true"></i> 
            &nbsp;Перечень дисциплин
        </h3>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

        <form action="" class="form-inline well" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

                <h4><i class="fa fa-filter text-muted" aria-hidden="true"></i> Выбрать учебный план</h4>

                <div class="form-group">

                    <div class="col-sm-6"> 
                        <label class="sr-only" for="academic_plan">Учебный план</label> 
                        <select name="academic_plan" id="" class="form-control">
                            
                                <?php
                                    if($academic_plan) {
                                        $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$academic_plan} ";
                                        $select_ap_by_id = mysqli_query($connection, $query);
                                        $row = mysqli_fetch_assoc($select_ap_by_id);
                                        
                                        $academic_plan_id = $row['academic_plan_id'];
                                        $academic_plan_name = $row['academic_plan_name'];
                                        
                                        echo "<option value='$academic_plan_id'>{$academic_plan_name}</option>";
                                        
                                    } else {
                                        echo "<option value = ''>Выбрать . . . </option>";
                                    }
                                    $query = "SELECT * FROM asu_academic_plan ORDER BY academic_plan_name ";
                                    $select_all_academic_plan = mysqli_query($connection, $query);

                                    while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                                        $academic_plan_id = $row['academic_plan_id'];
                                        $academic_plan_name = $row['academic_plan_name'];

                                        echo "<option value='$academic_plan_id'>$academic_plan_name</option>";

                                    }   
                                ?>
                        </select>                                         
                    </div>
                    
                    	
                </div>				

                <div class="form-group">
                    <div class="col-sm-3">
                        <input class="btn btn-primary" type="submit" name="select_academic_plan" value="Выбрать">
                       
                    </div>
                </div> 
                <div class="form-group">
                    <div class="col-sm-3">
                        
                        <a href="teachers.php?source=add_load&t_id=<?php echo $the_teacher_id; ?>" class="btn btn-primary">Сбросить</a>
                    </div>
                </div>      
            </form>
    </div>
</div>

<?php echo $message; ?>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                          
        <table class="table table-hover table-bordered">
        <thead>
            <tr class="active">
                <th>№</th>
                <th>Дисциплина</th>
                <th>Учебный план</th>
                <th class="text-center">ID</th>
                <th class="text-center">Добавить</th>
            </tr>
        </thead>
        <tbody>


                <?php
                    if($academic_plan) {
                        $query = "SELECT * FROM asu_content_discipline WHERE content_discipline_ac_plan_id = {$academic_plan} ";
                    } else {
                        $query = "SELECT * FROM asu_content_discipline ";
                    }
                    
                    
                    $select_all_content_discipline = mysqli_query($connection, $query);

                    while($row = mysqli_fetch_assoc($select_all_content_discipline)) {
                        
                        
                        $moodle_id = $row['moodle_id'];
                        $content_discipline_id = $row['content_discipline_id'];
                        $content_discipline_ac_plan_id = $row['content_discipline_ac_plan_id'];
                        
                        if($moodle_id != 0) {
                            
                            $number++;
                            
                            $query = "SELECT * FROM clg_course WHERE id = {$moodle_id} ";
                            $select_discipline = mysqli_query($connection, $query);

                            $row = mysqli_fetch_assoc($select_discipline);
                            $fullname = $row['fullname'];


                            echo "<tr>";
                            echo "<td>{$number}</td>";
                            echo "<td>{$fullname}</td>";
                            
                            
                            $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$content_discipline_ac_plan_id} ";
                            
                            
                            
                            $select_academic_plan = mysqli_query($connection, $query);
                            
                            $row = mysqli_fetch_assoc($select_academic_plan);
                            
                            $academic_plan_name = $row['academic_plan_name'];
                            
                            echo "<td>{$academic_plan_name}</td>";
                            echo "<td>{$moodle_id}</td>";
                            echo "<td class='text-center'><a class='text-primary' href='teachers.php?source=add_load&t_id={$the_teacher_id}&content_d={$content_discipline_id}&ac_p={$content_discipline_ac_plan_id}'><i class='fa fa-plus-circle' aria-hidden='true'></i></a></td>";
            
                            echo "</tr>";
                        }
                        
                        

                    }
            
                     if(isset($_GET['add_enrollee'])) {
                         
                        $the_enrollee_id = $_GET['add_enrollee'];
                        $the_order_id = $_GET['o_id'];
    
                        $query = "UPDATE asu_enrollee SET enrollee_order_id = '{$the_order_id}' WHERE enrollee_id = {$the_enrollee_id} ";

                        $update_query = mysqli_query($connection, $query);
                         
                        $query = "UPDATE asu_enrollee SET enrollee_status = 'Студент' WHERE enrollee_id = {$the_enrollee_id} ";

                        $update_query = mysqli_query($connection, $query);
                         
                        
    
                        header("Location: order.php?source=paid_students&o_id={$the_order_id}");
    
                     }
                ?>


        </tbody>
        </table>
    </div>
</div>








