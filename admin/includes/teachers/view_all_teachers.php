<?php
require_once("../includes/db.php");
?>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-group">
            <a class="btn btn-primary" href="./teachers.php?source=add_teacher"><i class="fa fa-user-plus fa-fw" aria-hidden="true"></i>&nbsp; Добавить преподавателя </a>
        </div>
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
        <table class="table table-hover table-bordered table-filter">
        <thead>
            <tr class="active">
                <th >Фамилия</th>
                <th>Имя</th>
                <th>Отчество</th>
                <th>Статус</th>
                
                <?php selectSessionPeriodForTeachers(); ?>

                <th style="padding-right: 20px;">Годовая нагрузка</th>
                <th style="padding-right: 20px; width: 80px;">Логин в СДО</th>
                <th style="padding-right: 20px;">Статус в СДО</th>
                <th class="text-center">ID</th>
                <th class="text-center">Карточка</th>
                <th class="text-center">Редактировать</th>
                <th class="text-center">Удалить</th>
            </tr>
        </thead>
        <tbody>
            <?php

                $query = "SELECT * FROM asu_teacher ORDER BY teacher_id ";
                $select_all_teacher = mysqli_query($connection, $query);

                while($row = mysqli_fetch_assoc($select_all_teacher)) {

                    $teacher_id = $row['teacher_id'];
                    $teacher_surname = $row['teacher_surname'];
                    $teacher_name = $row['teacher_name'];
                    $teacher_patronymic = $row['teacher_patronymic'];
                    $teacher_status = $row['teacher_status'];
                    $teacher_rate = $row['teacher_rate'];
                    $teacher_moodle_id = $row['teacher_moodle_id'];


                    echo "<tr>";
                    echo "<td>{$teacher_surname}</td>";
                    echo "<td>{$teacher_name}</td>";
                    echo "<td>{$teacher_patronymic}</td>";
                    echo "<td>{$teacher_status}</td>";
                    
                    getWorkloadTeaherForTable($teacher_id);
                    
                    if(!isset($teacher_moodle_id)) {
                        echo "<td class='text-center'>-</td>";
                    } else {
                        $query = "SELECT * FROM clg_user WHERE id = {$teacher_moodle_id}";
                        $select_users_by_moodleid = mysqli_query($connection,$query);
                        
                        while($row = mysqli_fetch_assoc($select_users_by_moodleid)) {

                        $username = $row['username'];

                        echo "<td class='text-center'>{$username}</td>";
                        }
                        
                    }
                    
                    
                    
                    if(!isset($teacher_moodle_id)) {
                        echo "<td class='text-center'><a class='text-primary' href='teachers.php?add_teacher_inSDO={$teacher_id}'><i class='fa fa-plus-circle' aria-hidden='true' title='Добавить пользователя в СДО'></i></a></td>";  
                    } elseif(isset($teacher_moodle_id)) {
                        echo "<td class='text-center'><i class='text-success fa fa-check-circle text-muted' aria-hidden='true' title='Пользователь создан в СДО'></i></td>";
                    } else {
                        echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                    }
                    
                    
                    echo "<td class='text-center'>{$teacher_id}</td>";
                    echo "<td class='text-center'><a class='text-muted' href='teachers.php?source=view_teacher&t_id={$teacher_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                    echo "<td class='text-center'><a class='text-muted' href='teachers.php?source=edit_teacher&t_id={$teacher_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";
                    echo "<td class='text-center'><a class='text-danger' href='teachers.php?delete={$teacher_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
                    echo "</tr>";

                }

            ?>

        </tbody>
        </table>
    </div>
</div>

<?php

    if(isset($_GET['delete'])) {

        $the_teacher_id = $_GET['delete'];

        $query = "DELETE FROM asu_teacher WHERE teacher_id = {$the_teacher_id} ";

        $delete_query = mysqli_query($connection, $query);

        header("Location: teachers.php");

    }

    if(isset($_GET['add_teacher_inSDO'])) {

        $the_teacher_id = $_GET['add_teacher_inSDO'];


        file_get_contents($prefixsdo."/webservice/enrol_teacher.php?id={$the_teacher_id}");

        header("Location: teachers.php");

     }


?>

