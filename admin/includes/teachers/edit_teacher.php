<?php

if(isset($_GET['t_id'])) {
    
    $the_teacher_id = $_GET['t_id'];
    
}

$query = "SELECT * FROM asu_teacher WHERE teacher_id = {$the_teacher_id} ";
$select_teacher_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_teacher_by_id)) {

    $teacher_image = $row['teacher_image'];
    
    $teacher_surname = $row['teacher_surname'];
    $teacher_name = $row['teacher_name'];
    $teacher_patronymic = $row['teacher_patronymic'];
    $teacher_date_birth = $row['teacher_date_birth'];
    $teacher_sex = $row['teacher_sex'];
    $teacher_status = $row['teacher_status'];
    $teacher_snils = $row['teacher_snils'];
    $teacher_inn = $row['teacher_inn'];
    $teacher_position = $row['teacher_position'];
    $teacher_rate = $row['teacher_rate'];
    $teacher_phone = $row['teacher_phone'];
    $teacher_email = $row['teacher_email'];
    $teacher_location = $row['teacher_location'];
    $teacher_education = $row['teacher_education'];
    $teacher_category = $row['teacher_category'];
    $teacher_identification = $row['teacher_identification'];
    $teacher_series = $row['teacher_series'];
    $teacher_number_identification = $row['teacher_number_identification'];
    $teacher_issued_by = $row['teacher_issued_by'];
    $teacher_date_issue = $row['teacher_date_issue'];
    $teacher_place_registration = $row['teacher_place_registration'];
    $teacher_discipline = $row['teacher_discipline'];
    $teacher_discipline = unserialize($teacher_discipline);
    
    $teacher_date = $row['teacher_date'];
}

if(isset($_POST['update_teacher'])) {


    $teacher_image = $_FILES['image']['name'];
    $teacher_image_temp = $_FILES['image']['tmp_name'];

    $teacher_surname = $_POST['teacher_surname'];
    $teacher_name = $_POST['teacher_name'];
    $teacher_patronymic = $_POST['teacher_patronymic'];
    $teacher_date_birth = $_POST['teacher_date_birth'];
    $teacher_sex = $_POST['teacher_sex'];
    $teacher_status = $_POST['teacher_status'];
    $teacher_snils = $_POST['teacher_snils'];
    $teacher_inn = $_POST['teacher_inn'];
    $teacher_position = $_POST['teacher_position'];
    $teacher_rate = $_POST['teacher_rate'];
    $teacher_phone = $_POST['teacher_phone'];
    $teacher_email = $_POST['teacher_email'];
    $teacher_location = $_POST['teacher_location'];
    $teacher_education = $_POST['teacher_education'];
    $teacher_category = $_POST['teacher_category'];
    $teacher_identification = $_POST['teacher_identification'];
    $teacher_series = $_POST['teacher_series'];
    $teacher_number_identification = $_POST['teacher_number_identification'];
    $teacher_issued_by = $_POST['teacher_issued_by'];
    $teacher_date_issue = $_POST['teacher_date_issue'];
    $teacher_place_registration = $_POST['teacher_place_registration'];
    $teacher_discipline = $_POST['teacher_discipline'];
    $teacher_discipline = serialize($teacher_discipline);

  

    $papke = mkdir("images/$teacher_surname", 0700);
    move_uploaded_file($teacher_image, "$papke/$teacher_image");

    if(empty($teacher_image)) { // empty - определяет, установлена ли переменная
            
            $query = "SELECT * FROM asu_teacher WHERE teacher_id = $the_teacher_id ";
            $select_image = mysqli_query($connection,$query);
            
            while($row = mysqli_fetch_assoc($select_image)) {
                
                $teacher_image = $row['teacher_image'];
                
            }
            
        }
    
    $query = "UPDATE asu_teacher SET ";
    $query .= "teacher_image = '{$teacher_image}', ";
    $query .= "teacher_surname = '{$teacher_surname}', ";
    $query .= "teacher_name = '{$teacher_name}', ";
    $query .= "teacher_patronymic = '{$teacher_patronymic}', ";
    $query .= "teacher_patronymic = '{$teacher_patronymic}', ";
    $query .= "teacher_date_birth = '{$teacher_date_birth}', ";
    $query .= "teacher_sex = '{$teacher_sex}', ";
    $query .= "teacher_status = '{$teacher_status}', ";
    $query .= "teacher_snils = '{$teacher_snils}', ";
    $query .= "teacher_inn = '{$teacher_inn}', ";
    $query .= "teacher_position = '{$teacher_position}', ";
    $query .= "teacher_rate = '{$teacher_rate}', ";
    $query .= "teacher_phone = '{$teacher_phone}', ";
    $query .= "teacher_email = '{$teacher_email}', ";
    $query .= "teacher_location = '{$teacher_location}', ";
    $query .= "teacher_education = '{$teacher_education}', ";
    $query .= "teacher_category = '{$teacher_category}', ";
    $query .= "teacher_identification = '{$teacher_identification}', ";
    $query .= "teacher_series = '{$teacher_series}', ";
    $query .= "teacher_number_identification = {$teacher_number_identification}, ";
    $query .= "teacher_issued_by = '{$teacher_issued_by}', ";
    $query .= "teacher_date_issue = '{$teacher_date_issue}', ";
    $query .= "teacher_place_registration = '{$teacher_place_registration}', ";
    $query .= "teacher_discipline = '{$teacher_discipline}' ";
    
    $query .= "WHERE teacher_id = {$the_teacher_id} ";

    $update_teacher_query = mysqli_query($connection,$query);
    
    if(!$update_teacher_query) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }

    $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";

    header("refresh: 1; url=./teachers.php");
        
}
        
?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-id-card-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Форма редактирования карточки преподавателя
        </h1>
    </div>
</div>  
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="teachers.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<?php echo $message; ?>
<br>

<form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
    <h3 class="page-header text-primary"><i class="fa fa-info-circle fa-fw" aria-hidden="true"></i>&nbsp;Личная информация</h3>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="teacher_image">Фотография преподавателя</label><br>
            <img class="img-thumbnail" src="images/bg_photo.jpg" width="150" alt="photo">
            <input type="file" name="image">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_surname">Фамилия <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="teacher_surname" value="<?php echo $teacher_surname; ?>"  required>
        </div>
        
        <div class="col-sm-6">
            <label for="teacher_date_birth">Дата рождения <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="date" class="form-control" name="teacher_date_birth" value="<?php echo $teacher_date_birth; ?>" required>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_name">Имя <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="teacher_name" value="<?php echo $teacher_name; ?>" required>
        </div>
        
        <div class="col-sm-6">
            <label for="teacher_sex">Пол</label>
            <select name="teacher_sex" id="" class="form-control">
                
                <?php
                    if($teacher_sex) {
                        echo "<option value='{$teacher_sex}'>{$teacher_sex}</option>";
                    } else {
                        echo "<option value=''>Выбрать пол</option>";
                    }

                    if($teacher_sex == 'Мужской') {
                        echo "<option value='Женский'>Женский</option>";
                    } else {
                        echo "<option value='Мужской'>Мужской</option>";
                    }
                ?>
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_patronymic">Отчество</label>
            <input type="text" class="form-control" name="teacher_patronymic" value="<?php echo $teacher_patronymic; ?>">
        </div>
        
        <div class="col-sm-6">
            <label for="teacher_status">Статус</label>
            <select name="teacher_status" id="" class="form-control">
                <?php
                
                    if($teacher_status) {
                        echo "<option value='{$teacher_status}'>{$teacher_status}</option>";
                    } else {
                        echo "<option value=''>Выбрать статус</option>";
                    }
                
                    if($teacher_status == 'Действующий') {
                        echo "<option value='Недействующий'>Недействующий</option>";
                    } else {
                        echo "<option value='Действующий'>Действующий</option>";
                    }
                    
                ?>
                               
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_snils">СНИЛС <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="teacher_snils" value="<?php echo $teacher_snils; ?>" required>
        </div>
        
        <div class="col-sm-6">
            <label for="teacher_inn">ИНН</label>
            <input type="text" class="form-control" name="teacher_inn" value="<?php echo $teacher_inn; ?>">
        </div>
    </div>
        
    <h3 class="page-header text-primary"><i class="fa fa-briefcase fa-fw" aria-hidden="true"></i>&nbsp;Место работы </h3>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_position">Должность <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="teacher_position" value="<?php echo $teacher_position; ?>" required>
        </div>
        
        <div class="col-sm-6">
            <label for="teacher_rate">Ставка</label>
            <input type="text" class="form-control" name="teacher_rate" value="<?php echo $teacher_rate; ?>">
        </div>
    </div>


    <h3 class="page-header text-primary"><i class="fa fa-map-marker fa-fw" aria-hidden="true"></i>&nbsp;Место жительства и контактные данные </h3>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_phone">Телефон</label>
            <input type="text" class="form-control" name="teacher_phone" value="<?php echo $teacher_phone; ?>">
        </div>
        
        <div class="col-sm-6">
            <label for="teacher_email">E-mail</label>
            <input type="text" class="form-control" name="teacher_email" value="<?php echo $teacher_email; ?>">
        </div>
    </div> 
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="teacher_location">Место жительства <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="teacher_location" value="<?php echo $teacher_location; ?>" required>
        </div>
    </div>
    
    <h3 class="page-header text-primary"><i class="fa fa-graduation-cap fa-fw" aria-hidden="true"></i>&nbsp;Образование</h3>
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_education">Базовое образование</label>
            <select name="teacher_education" id="" class="form-control">
                
                <?php 
                
                    if(!empty($teacher_education)) {
                        echo "<option value='$teacher_education'>$teacher_education</option>";
                    } else {
                        echo "<option value=''>Выбрать . . . </option>";
                    }
                    
                    if($teacher_education == 'Высшее') {
                        echo "<option value='Основное общее образование'>Основное общее образование</option>";
                        echo "<option value='Среднее'>Среднее</option>";
                        echo "<option value='Среднее общее образование'>Среднее общее образование</option>";
                        echo "<option value='Среднее профессиональное образование'>Среднее профессиональное образование</option>";
                    } else if($teacher_education == 'Основное общее образование') {
                        echo "<option value='Высшее'>Высшее</option>";
                        echo "<option value='Среднее'>Среднее</option>";
                        echo "<option value='Среднее общее образование'>Среднее общее образование</option>";
                        echo "<option value='Среднее профессиональное образование'>Среднее профессиональное образование</option>";
                    } else if($teacher_education == 'Среднее') {
                        echo "<option value='Высшее'>Высшее</option>";
                        echo "<option value='Основное общее образование'>Основное общее образование</option>";
                        echo "<option value='Среднее общее образование'>Среднее общее образование</option>";
                        echo "<option value='Среднее профессиональное образование'>Среднее профессиональное образование</option>";
                    } else if($teacher_education == 'Среднее профессиональное образование') {
                        echo "<option value='Высшее'>Высшее</option>";
                        echo "<option value='Основное общее образование'>Основное общее образование</option>";
                        echo "<option value='Среднее'>Среднее</option>";
                        echo "<option value='Среднее общее образование'>Среднее общее образование</option>";
                    } else {
                        echo "<option value='Высшее'>Высшее</option>";
                        echo "<option value='Основное общее образование'>Основное общее образование</option>";
                        echo "<option value='Среднее'>Среднее</option>";
                        echo "<option value='Среднее профессиональное образование'>Среднее профессиональное образование</option>";
                    }
                ?>

            </select>
        </div>

    </div>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_category">Категория</label>
            <select name="teacher_category" id="" class="form-control">
                
                <?php 
                    if(!empty($teacher_category)) {
                        echo "<option value='$teacher_category'>$teacher_category</option>";
                    } else {
                        echo "<option value=''>Выбрать . . . </option>";
                    }
                
                    if($teacher_category == '1-я категория') {
                        echo "<option value='2-я категория'>2-я категория</option>";
                        echo "<option value='3-я категория'>3-я категория</option>";
                        echo "<option value='Высшая категория'>Высшая категория</option>";
                    } else if($teacher_category == '2-я категория') {
                        echo "<option value='1-я категория'>1-я категория</option>";
                        echo "<option value='3-я категория'>3-я категория</option>";
                        echo "<option value='Высшая категория'>Высшая категория</option>";
                    } else if($teacher_category == '3-я категория') {
                        echo "<option value='1-я категория'>1-я категория</option>";
                        echo "<option value='2-я категория'>2-я категория</option>";
                        echo "<option value='Высшая категория'>Высшая категория</option>";
                    } else {
                        echo "<option value='1-я категория'>1-я категория</option>";
                        echo "<option value='2-я категория'>2-я категория</option>";
                        echo "<option value='3-я категория'>3-я категория</option>";
                    }
                ?>
            </select>
        </div>
    </div>
    
    <h3 class="page-header text-primary"><i class="fa fa-id-card-o fa-fw" aria-hidden="true"></i>&nbsp;Документ удостоверяющий личность</h3>

    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_identification">Документ <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <select name="teacher_identification" id="" class="form-control" required>
                
                <?php 
                    
                    if($teacher_identification) {
                        
                        echo "<option value='{$teacher_identification}'>{$teacher_identification}</option>";
    
                        } else {
                        
                        echo "<option value=''>Выбрать</option>";
                        
                    }
                
                    if($teacher_identification == 'Паспорт гражданина РФ') {
                        
                        echo "<option value='Паспорт гражданина иностранного государства'>Паспорт гражданина иностранного государства</option>";
                        echo "<option value='Временное удостоверение личности'>Временное удостоверение личности</option>";
                        echo "<option value='Военный билет'>Военный билет</option>";
                        
                    } else if ($teacher_identification == 'Паспорт гражданина иностранного государства') {
                        
                        echo "<option value='Паспорт гражданина РФ'>Паспорт гражданина РФ</option>";
                        echo "<option value='Временное удостоверение личности'>Временное удостоверение личности</option>";
                        echo "<option value='Военный билет'>Военный билет</option>";
                        
                    } else if ($teacher_identification == 'Временное удостоверение личности') {
                        
                        echo "<option value='Паспорт гражданина РФ'>Паспорт гражданина РФ</option>";
                        echo "<option value='Паспорт гражданина иностранного государства'>Паспорт гражданина иностранного государства</option>";
                        echo "<option value='Военный билет'>Военный билет</option>";
                        
                    } else {
                        
                        echo "<option value='Паспорт гражданина РФ'>Паспорт гражданина РФ</option>";
                        echo "<option value='Паспорт гражданина иностранного государства'>Паспорт гражданина иностранного государства</option>";
                        echo "<option value='Временное удостоверение личности'>Временное удостоверение личности</option>";
                        
                    }
                
                ?>
                
            </select>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_series">Серия</label>
            <input type="text" class="form-control" name="teacher_series" value="<?php echo $teacher_series; ?>">
        </div>
        
        <div class="col-sm-6">
            <label for="teacher_number_identification">Номер <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="teacher_number_identification" value = "<?php echo $teacher_number_identification; ?>" required>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="teacher_issued_by">Кем выдан</label>
            <input type="text" class="form-control" name="teacher_issued_by" value="<?php echo $teacher_issued_by; ?>">
        </div>
        
        <div class="col-sm-6">
            <label for="teacher_date_issue">Дата выдачи</label>
            <input type="date" class="form-control" name="teacher_date_issue" value="<?php echo $teacher_date_issue; ?>">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="teacher_place_registration">Место регистрации</label>
            <input type="text" class="form-control" name="teacher_place_registration" value="<?php echo $teacher_place_registration; ?>">
        </div>
    </div>
    
    <h3 class="page-header text-primary"><i class="fa fa-suitcase fa-fw" aria-hidden="true"></i>&nbsp;Список дисциплин преподавателя</h3> 
    <div class="form-group">
        <div class="col-sm-12">
            <select size="15" name="teacher_discipline[]" id="" class="form-control" multiple>

                <?php   
                    $array = count($teacher_discipline);
                    $array_count = $array - 1;
                    $query_1 = "SELECT * FROM  asu_disciplines WHERE ";

                    for($i = 0; $i < count($teacher_discipline); $i++) {

                        $id = $teacher_discipline[$i];

                        $query = "SELECT * FROM  asu_disciplines WHERE discipline_id = {$id} ORDER BY discipline_title ";
                        $select_discipline = mysqli_query($connection, $query);

                        $row = mysqli_fetch_assoc($select_discipline);

                        $discipline_id = $row['discipline_id'];
                        $discipline_title = $row['discipline_title'];

                        echo "<option class='text-success' value='$discipline_id' selected>{$discipline_title}</option>";

                        if($array_count > $i) {

                                $query_1 .= " discipline_id != {$id} AND";

                            } else {

                                $query_1 .= " {$id} ORDER BY discipline_title ";

                            } 
                        }


                        $select_all_discipline = mysqli_query($connection, $query_1);

                        while($row = mysqli_fetch_assoc($select_all_discipline)) {

                            $discipline_id = $row['discipline_id'];
                            $discipline_title = $row['discipline_title'];

                            echo "<option value='$discipline_id'>{$discipline_title}</option>";

                        } 

                ?>

            </select>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <div class="page-header"></div>
            <input class="btn btn-primary" type="submit" name="update_teacher" value="Сохранить">
        </div>
    </div>  
    
</form>