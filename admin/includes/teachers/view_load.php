<?php 

    $today = date("Y-m-d");
    $query =    "  
                    SELECT 
                        session_id,
                        session_end,
                        session_open,
                        CONCAT(session_period,' ',session_time) session_current
                    FROM asu_session 
                    ORDER BY session_time
                ";
    $select_all = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_all)) {
        
        $session_end = $row['session_end'];
        $session_open = $row['session_open'];
        
        if ($session_open > 0 && $session_open <= $today && $session_end >= $today) {
            
            $current_session_id = $row['session_id'];
            $session_current = $row['session_current'];
            
        }
    }

   

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-info-circle fa-fw" aria-hidden="true"></i>&nbsp;Нагрузка</h3>
    </div>
    
</div>
<br>
<div class="row">
    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
       
        <select class="form-control" name="select_session_vload" id="select_session_vload">
            
            <?php
                            
                $query =    "   
                                SELECT
                                   asu_session.session_id,
                                   CONCAT(session_period,' ',session_time) session,
                                   asu_load_teacher.teacher_id
                                   
                                
                                FROM asu_session 
                                INNER JOIN asu_load_teacher
                                    ON asu_session.session_id = asu_load_teacher.load_session_id
                                
                                WHERE asu_load_teacher.teacher_id = {$the_teacher_id}
                                GROUP BY asu_session.session_id
                                HAVING asu_load_teacher.teacher_id = {$the_teacher_id}
                                ORDER BY session_time
                
                            ";
            
            
            
                $select_all = mysqli_query($connection, $query);
                
                while($row = mysqli_fetch_assoc($select_all)) {
                    $session_id = $row['session_id'];
                    $session = $row['session'];
                    
                    if ($current_session_id == $session_id) {
                        $is_current = true;
                        echo "<option value='$session_id' selected>$session</option>";
                    } else  {
                        echo "<option value='$session_id'>$session</option>";
                    }
                    
                
                }
                if(!$is_current) {
                    echo "<option value='' selected>Выбрать . . . </option>";
                }
                    
            
            ?>
        </select>
        <input type="hidden" name="teacher_id_vload" id="teacher_id_vload" value="<?php echo $the_teacher_id; ?>">
    </div>
</div>
<br>

<div id="result">
    <?php
    if($is_current) {
        $query = "SELECT SUM(load_teacher) AS sum FROM asu_load_teacher WHERE teacher_id = {$the_teacher_id} ";
    
        
            $query .= "AND load_session_id = {$current_session_id}";
        
        $select_load = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_load);

        $sum = $row['sum'];

    ?>
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <p>Максимальная нагрузка: 150</p>
        </div>
    </div>
    <div class="progress">



        <?php

            $max_load = 100;
            $sum_proc = $sum/150 * 100; 

            if($max_load < $sum_proc) {


        ?>

            <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: <?php echo $sum_proc; ?>%">
                <span><?php echo $sum; ?></span>
            </div>


        <?php

            } else {

        ?>

        <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: <?php echo $sum_proc; ?>%">
            <span><?php echo $sum; ?></span>
        </div>

        <?php } ?>

    </div>

    <br>
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
            <table class="table table-hover table-bordered">
            <thead>
                <tr class="active">
                    <th>№</th>
                    <th>Дисциплина</th>
                    <th>Период</th>
                    <th>Нагрузка</th>
                </tr>
            </thead>
            <tbody>

                <?php
                                
                    
                        $query =    "    
                                        SELECT

                                            asu_load_teacher.discipline_moodle_id AS discipline_moodle_id,
                                            asu_load_teacher.load_teacher AS load_teacher,
                                            CONCAT(asu_session.session_period,' ',asu_session.session_time) session

                                        FROM asu_load_teacher 
                                        LEFT JOIN asu_session
                                            ON asu_load_teacher.load_session_id = asu_session.session_id


                                        WHERE asu_load_teacher.teacher_id = {$the_teacher_id}
                                        
                                    ";    
                    
                        
                            
                            $query .= "AND asu_load_teacher.load_session_id = {$current_session_id}";                                          
                        
                        
                    

                    $select_teacher_by_id = mysqli_query($connection, $query);

                    while($row = mysqli_fetch_assoc($select_teacher_by_id)) {

                        $number_load++;
                        $discipline_moodle_id = $row['discipline_moodle_id'];
                        $load_teacher = $row['load_teacher'];
                        $session = $row['session'];

                        echo "<tr>";
                        echo "<td>{$number_load}</td>";


                        $query = "SELECT id, fullname FROM clg_course WHERE id = {$discipline_moodle_id} ";
                        $select_course_by_id = mysqli_query($connection,$query);

                        $row = mysqli_fetch_assoc($select_course_by_id);

                        $id = $row['id'];
                        $fullname = $row['fullname'];

                        echo "<td><a href='teachers.php?source=view_load_discipline&d_id={$id}&t_id={$the_teacher_id}'>{$fullname}</a></td>";

                        echo "<td>{$session}</td>";

                        echo "<td>{$load_teacher}</td>";



                        echo "</tr>";

                    }

                    echo "<td colspan = '3'><b>Итого:</b></td>";
                    echo "<td><b>{$sum}</b></td>";

                ?>

            </tbody>
            </table>
            
        </div>
    </div>
    <?php } else { echo "<h1 class='text-danger text-center'>Нет нагрузки на текущий семестр</h1>"; }?>
</div>
