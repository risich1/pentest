<?php

    if(isset($_GET['t_id'])) {

        $the_teacher_id = $_GET['t_id'];

        $query = "SELECT teacher_surname, teacher_name, teacher_patronymic
        FROM asu_teacher WHERE teacher_id = {$the_teacher_id}";
        $select_teacher_by_id = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_teacher_by_id);

        $teacher_id = $row['teaher_id'];
        $teacher_surname = $row['teacher_surname'];
        $teacher_name = $row['teacher_name'];
        $teacher_patronymic = $row['teacher_patronymic'];
        $teacher = $teacher_surname;
        $teacher .= " ";
        $teacher .= $teacher_name;
        $teacher .= " ";
        $teacher .= $teacher_patronymic;

    } else {

        $query = "SELECT teacher_id, teacher_surname, teacher_name, teacher_patronymic FROM asu_teacher ORDER BY teacher_surname";
        $select_all_teacher = mysqli_query($connection, $query);

    }

    if(isset($_GET['moodle_id'])) {

        $the_moodle_id = $_GET['moodle_id'];

    }

    if(isset($_GET['d_id'])) {
        
        $discipline_moodle = $_GET['d_id'];
        
    }

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-download text-muted" aria-hidden="true"></i> 
            &nbsp;Добавить дисциплину
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
       <div class="btn-group">
        <a href="teachers.php?source=view_teacher&t_id=<?php echo $the_teacher_id; ?>" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
        </div>
    </div>
</div>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">     
           
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
            <table class="table table-hover table-bordered">
                <thead>
                    <tr class="active">
                        <th>№</th>
                        <th>Учебный план</th>
                        <th class="text-center">УП ID</th>
                        <th>Дисциплина Moodle</th>
                        <th class="text-center">ID</th>
                        <th>Семестр</th>
                        <th>Курс</th>
                        <th>Студентов</th>
                        <th>Аудит. часы</th>
                        <th>Курсовая работа</th>
                        <th>Тип итогового контроля</th>
                    </tr>
                </thead>
                <tbody>
    
    <?php
    
    $hour_audience = array();
    $course_work = array();
    $discipline_control = array();
    
    $query = "SELECT * FROM asu_content_discipline WHERE moodle_id = {$discipline_moodle} ";
    $select_discipline_by_id = mysqli_query($connection,$query);
    $count_discipline = mysqli_num_rows($select_discipline_by_id);
    

    while($row = mysqli_fetch_assoc($select_discipline_by_id)) {
        
        $number++;
        $content_discipline_id = $row['$content_discipline_id'];
        $content_discipline_ac_plan_id = $row['content_discipline_ac_plan_id'];
        $content_discipline_semester = $row['content_discipline_semester'];
        $content_discipline_courses = $row['content_discipline_courses'];
        $content_discipline_hour_audience = $row['content_discipline_hour_audience'];
        
        $hour_audience[$number] = $content_discipline_hour_audience;
        
        // Устанавливаем 1 дисциплине по которой есть курсовая работа и 0 у которой её нет
        // Записываем полученные значения в массив $discipline_control
        
        $content_discipline_course_work = $row['content_discipline_course_work'];
        
        if($content_discipline_course_work == 'Нет') {
            $course_work[$number] = 0;
            $sum_students_course_work = 0;
        } else {
            $course_work[$number] = 1;
        }
        
        // Устанавливаем 1 дисциплине по которой есть экзамен и 0 у которой нет экзамена
        // Записываем полученные значения в массив $discipline_control
        
        $content_discipline_control = $row['content_discipline_control'];
        
        if($content_discipline_control == 'Экзамен') {
            
            $discipline_control[$number] = 1;
            
        } else {
            $discipline_control[$number] = 0;
            $sum_students_exam = 0;
 
        }
        
        $moodle_id = $row['moodle_id'];
        
        $query = "SELECT * FROM clg_course WHERE id = {$moodle_id} ";
        $select_course_by_id = mysqli_query($connection, $query);

            $row = mysqli_fetch_assoc($select_course_by_id);
            $id = $row['id'];
            $fullname = $row['fullname'];
        
        $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$content_discipline_ac_plan_id} ";
        $select_academic_plan_by_id = mysqli_query($connection, $query);
        
        $row = mysqli_fetch_assoc($select_academic_plan_by_id);
        $academic_plan_name = $row['academic_plan_name'];

        ?>
        
        <tr>
            <td><?php echo $number; ?></td>
            <td><?php echo $academic_plan_name; ?></td>
            <td><?php echo $content_discipline_ac_plan_id; ?></td>
            <td><?php echo $fullname; ?></td>
            <td><?php echo $id; ?></td>
            <td><?php echo $content_discipline_semester; ?></td>
            <td><?php echo $content_discipline_courses; ?></td>
            
            <?php 
        
                $query = "SELECT * FROM asu_groups WHERE group_ac_plan_id = {$content_discipline_ac_plan_id} ";
                $select_group = mysqli_query($connection, $query);

                    echo "<td>";
                while($row = mysqli_fetch_assoc($select_group)) {
                    
                    $group_id = $row['group_id'];
                    $group_number = $row['group_number'];

                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_group_id = {$group_id} AND enrollee_status='Студент'";
                    $select_all_students = mysqli_query($connection, $query);

                    $count_students = mysqli_num_rows($select_all_students);
                    $sum = $sum + $count_students;
        
                    if ($count_students>0) echo "$count_students ($group_number); ";
                } 

                    echo "</td>";
                
        
            ?>
            
            <td><?php echo $content_discipline_hour_audience; ?></td>
            <td><?php echo $content_discipline_course_work; ?></td>
            <td><?php echo $content_discipline_control; ?></td>
        </tr>
        
        <?php
        
    }
    
    $message = "id дисциплины: ";
    $message .= $discipline_moodle;
    //$message .= "<br>";
    //$message .= "id сессии: ";
    //$message .= $session;
    $message .= "<br>";
    $message .= "Количество дисциплин: ";
    $message .= $count_discipline;
    $message .= "<br>";
    $message .= "Всего студентов: ";
    $message .= $sum;
    $message .= "<br><br>";
    
    
    
    $max_hour_audience = max($hour_audience);
    $max_course_work = max($course_work);
    $max_discipline_control = max($discipline_control);
    
    ?>
    
            </tbody>
        </table>
    </div>
    </div>
    
    <?php
    
    
    

    // Определяем количество студентов, сдающих экзамен

    /*$query = "SELECT * FROM asu_content_discipline WHERE moodle_id = {$discipline_moodle} AND content_discipline_control = 'Экзамен' ";
    $select_exam = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_exam)) {

        $content_discipline_ac_plan_id = $row['content_discipline_ac_plan_id'];

        $query = "SELECT * FROM asu_groups WHERE group_ac_plan_id = {$content_discipline_ac_plan_id} ";
        $select_group = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_group);
        $group_id = $row['group_id'];
        $group_number = $row['group_number'];

        $query = "SELECT * FROM asu_enrollee WHERE enrollee_group_id = {$group_id} AND enrollee_status='Студент'";
        $select_all_students = mysqli_query($connection, $query);

        $count_students_exam = mysqli_num_rows($select_all_students);
        $sum_students_exam = $sum_students_exam + $count_students_exam;

    }*/
    $query_exam = "SELECT COUNT(asu_enrollee.enrollee_id) AS sum_students_exam
              FROM asu_content_discipline
              LEFT JOIN asu_groups ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
              LEFT JOIN asu_enrollee ON asu_enrollee.enrollee_group_id = asu_groups.group_id AND enrollee_status='Студент'
              WHERE asu_content_discipline.moodle_id = {$discipline_moodle} AND asu_content_discipline.content_discipline_control IN ('Экзамен', 'Диф. зачёт')";
    $select_exam = mysqli_query($connection, $query_exam);
    $row_exam = mysqli_fetch_assoc($select_exam);
    $sum_students_exam = $row_exam['sum_students_exam'];


    // Определяем количество студентов, выполняющих курсовую работу

    /*$query = "SELECT * FROM asu_content_discipline WHERE moodle_id = {$discipline_moodle} AND content_discipline_course_work = 'Есть' ";
    $select_course_work = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_course_work)) {

        $content_discipline_ac_plan_id = $row['content_discipline_ac_plan_id'];

        $query = "SELECT * FROM asu_groups WHERE group_ac_plan_id = {$content_discipline_ac_plan_id} ";
        $select_group = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_group);

        $group_id = $row['group_id'];
        $group_number = $row['group_number'];

        $query = "SELECT * FROM asu_enrollee WHERE enrollee_group_id = {$group_id} AND enrollee_status='Студент'";
        $select_all_students = mysqli_query($connection, $query);

        $count_students_course_work = mysqli_num_rows($select_all_students);
        $sum_students_course_work = $sum_students_course_work + $count_students_course_work;

    }*/

    $query_course_work = "SELECT COUNT(asu_enrollee.enrollee_id) AS sum_students_course_work
              FROM asu_content_discipline
              LEFT JOIN asu_groups ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
              LEFT JOIN asu_enrollee ON asu_enrollee.enrollee_group_id = asu_groups.group_id AND enrollee_status='Студент'
              WHERE asu_content_discipline.moodle_id = {$discipline_moodle} AND asu_content_discipline.content_discipline_course_work = 'Есть'";
    $select_course_work = mysqli_query($connection, $query_course_work);
    $row_course_work = mysqli_fetch_assoc($select_course_work);
    $sum_students_course_work = $row_course_work['sum_students_course_work'];


    // $calculation = $max_hour_audience + ($max_course_work * $sum) + ($max_discipline_control * $sum) + (0.25 * $sum);
    $calculation = $max_hour_audience + ($sum_students_course_work * 1) + ($sum_students_exam * 0.25) + ($sum * 0.25);
    
    $load = "<b>Нагрузка</b>";
    $load .= "<hr>";
    $load .= "Макс. аудит. часы: ";
    $load .= $max_hour_audience;
    $load .= "<br>";
    $load .= "Курсовая работа: $max_course_work";
    $load .= "<br>";
    $load .= "Итоговый контроль: $max_discipline_control";
    $load .= "<br>";
    $load .= "Нагрузка по дисциплине ($fullname): $calculation";
    $load .= "<br>";
    
    echo $message;
    echo "Количество студентов (Экзамен, Диф. зачёт): ";
    echo $sum_students_exam;
    echo "<br>";
    echo "Количество студентов (Курсовая работа): ";
    echo $sum_students_course_work;
    echo "<br><br>";
    echo $load;

    /*$formula = "<b>Формула</b>";
    $formula .= "<hr>";
    $formula .= "Аудит. часы(";
    $formula .= $max_hour_audience;
    $formula .= ") + ";
    $formula .= "Курсовая работа(";
    $formula .= $max_course_work;
    $formula .= " * $sum_students_course_work) + ";
    $formula .= "Экзамен(";
    $formula .= $max_discipline_control;
    $formula .= " * $sum_students_exam) + ";
    $formula .= "Проверка контрольных работ(";
    $formula .= "0.25 * $sum) = ";
    $formula .= $calculation;*/
    $formula = "<b>Формула</b><hr>
                Аудит. часы($max_hour_audience) + 
                Курсовая работа($sum_students_course_work * 1) + 
                Экзамен($sum_students_exam * 0.25) + 
                Проверка контрольных работ($sum * 0.25) = 
                $calculation";
    
    echo "<br>";    
    echo $formula;
    echo "<br><br><br><br><br>";  

        
  ?>      
        
        
        
        
    </div>
</div>










