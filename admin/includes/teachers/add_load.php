<?php


if(isset($_GET['t_id'])) {

    $the_teacher_id = $_GET['t_id'];

    $query = "SELECT teacher_surname, teacher_name, teacher_patronymic, teacher_moodle_id
    FROM asu_teacher WHERE teacher_id = {$the_teacher_id}";
    $select_teacher_by_id = mysqli_query($connection, $query);

    $row = mysqli_fetch_assoc($select_teacher_by_id);

    $teacher_moodle_id = $row['teacher_moodle_id'];
    $teacher_id = $row['teaher_id'];
    $teacher_surname = $row['teacher_surname'];
    $teacher_name = $row['teacher_name'];
    $teacher_patronymic = $row['teacher_patronymic'];
    $teacher = $teacher_surname;
    $teacher .= " ";
    $teacher .= $teacher_name;
    $teacher .= " ";
    $teacher .= $teacher_patronymic;

} else {

    $query = "SELECT teacher_id, teacher_surname, teacher_name, teacher_patronymic FROM asu_teacher WHERE teacher_moodle_id != 0 ORDER BY teacher_surname";
    $select_all_teacher = mysqli_query($connection, $query);

}

if(isset($_GET['moodle_id']) || isset($_GET['session_id'])) {

    $the_moodle_id = $_GET['moodle_id'];
    $the_session_id = $_GET['session_id'];

}

if(isset($_POST['add_discipline_moodle'])) {

    $discipline_moodle = $_POST['discipline_moodle'];
    $session = $_POST['session'];
    $the_teacher_id = $_POST['teacher'];


    /*$hour_audience = array();
    $course_work = array();
    $discipline_control = array();

    $query = "SELECT * FROM asu_content_discipline WHERE moodle_id = {$discipline_moodle} ";
    $select_discipline_by_id = mysqli_query($connection,$query);
    $count_discipline = mysqli_num_rows($select_discipline_by_id);


    while($row = mysqli_fetch_assoc($select_discipline_by_id)) {

        $number++;
        $content_discipline_id = $row['$content_discipline_id'];
        $content_discipline_ac_plan_id = $row['content_discipline_ac_plan_id'];
        $content_discipline_semester = $row['content_discipline_semester'];
        $content_discipline_courses = $row['content_discipline_courses'];
        $content_discipline_hour_audience = $row['content_discipline_hour_audience'];

        $hour_audience[$number] = $content_discipline_hour_audience;

        // Устанавливаем 1 дисциплине по которой есть курсовая работа и 0 у которой её нет
        // Записываем полученные значения в массив $discipline_control

        $content_discipline_course_work = $row['content_discipline_course_work'];

        if($content_discipline_course_work == 'Нет') {
            $course_work[$number] = 0;
            $sum_students_course_work = 0;
        } else {
            $course_work[$number] = 1;
        }

        // Устанавливаем 1 дисциплине по которой есть экзамен и 0 у которой нет экзамена
        // Записываем полученные значения в массив $discipline_control

        $content_discipline_control = $row['content_discipline_control'];

        if($content_discipline_control == 'Экзамен') {

            $discipline_control[$number] = 1;

        } else {
            $discipline_control[$number] = 0;
            $sum_students_exam = 0;

        }

        $moodle_id = $row['moodle_id'];

        $query = "SELECT * FROM clg_course WHERE id = {$moodle_id} ";
        $select_course_by_id = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_course_by_id);
        $id = $row['id'];
        $fullname = $row['fullname'];

        $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$content_discipline_ac_plan_id} ";
        $select_academic_plan_by_id = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_academic_plan_by_id);
        $academic_plan_name = $row['academic_plan_name'];

        $query = "SELECT * FROM asu_groups WHERE group_ac_plan_id = {$content_discipline_ac_plan_id} ";
        $select_group = mysqli_query($connection, $query);

        while($row = mysqli_fetch_assoc($select_group)) {

            $group_id = $row['group_id'];
            $group_number = $row['group_number'];

            $query = "SELECT * FROM asu_enrollee WHERE enrollee_group_id = {$group_id} AND enrollee_status!='Архив'";
            $select_all_students = mysqli_query($connection, $query);

            $count_students = mysqli_num_rows($select_all_students);
            $sum = $sum + $count_students;

            echo "<td>$count_students ($group_number)</td>";
        }

    }

    $max_hour_audience = max($hour_audience);
    $max_course_work = max($course_work);
    $max_discipline_control = max($discipline_control);


    // Определяем количество студентов, сдающих экзамен

    $query = "SELECT * FROM asu_content_discipline WHERE moodle_id = {$discipline_moodle} AND content_discipline_control = 'Экзамен' ";
    $select_exam = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_exam)) {

        $content_discipline_ac_plan_id = $row['content_discipline_ac_plan_id'];

        $query = "SELECT * FROM asu_groups WHERE group_ac_plan_id = {$content_discipline_ac_plan_id} ";
        $select_group = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_group);

        $group_id = $row['group_id'];
        $group_number = $row['group_number'];

        $query = "SELECT * FROM asu_enrollee WHERE enrollee_group_id = {$group_id} AND enrollee_status!='Архив'";
        $select_all_students = mysqli_query($connection, $query);

        $count_students_exam = mysqli_num_rows($select_all_students);
        $sum_students_exam = $sum_students_exam + $count_students_exam;

    }

    // Определяем количество студентов, выполняющих курсовую работу

    $query = "SELECT * FROM asu_content_discipline WHERE moodle_id = {$discipline_moodle} AND content_discipline_course_work = 'Есть' ";
    $select_course_work = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_course_work)) {

        $content_discipline_ac_plan_id = $row['content_discipline_ac_plan_id'];

        $query = "SELECT * FROM asu_groups WHERE group_ac_plan_id = {$content_discipline_ac_plan_id} ";
        $select_group = mysqli_query($connection, $query);

        $row = mysqli_fetch_assoc($select_group);

        $group_id = $row['group_id'];
        $group_number = $row['group_number'];

        $query = "SELECT * FROM asu_enrollee WHERE enrollee_group_id = {$group_id} AND enrollee_status!='Архив'";
        $select_all_students = mysqli_query($connection, $query);

        $count_students_course_work = mysqli_num_rows($select_all_students);
        $sum_students_course_work = $sum_students_course_work + $count_students_course_work;

    }*/

    $query_students = "SELECT COUNT(asu_enrollee.enrollee_id) AS count_students_all
                       FROM asu_content_discipline
                       LEFT JOIN asu_groups ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
                       LEFT JOIN asu_enrollee ON asu_enrollee.enrollee_group_id = asu_groups.group_id AND enrollee_status='Студент'
                       WHERE asu_content_discipline.moodle_id = {$discipline_moodle}";
    $select_students = mysqli_query($connection, $query_students);
    $row_students = mysqli_fetch_assoc($select_students);
    $count_students_all = $row_students['count_students_all'];
    
    $query_audience = "SELECT MAX(1*asu_content_discipline.content_discipline_hour_audience) AS max_hour_audience
                       FROM asu_content_discipline
                       WHERE asu_content_discipline.moodle_id = {$discipline_moodle}";
    $select_audience = mysqli_query($connection, $query_audience);
    $row_audience = mysqli_fetch_assoc($select_audience);
    $max_hour_audience = $row_audience['max_hour_audience'];

    $query_exam = "SELECT COUNT(asu_enrollee.enrollee_id) AS sum_students_exam
                   FROM asu_content_discipline
                   LEFT JOIN asu_groups ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
                   LEFT JOIN asu_enrollee ON asu_enrollee.enrollee_group_id = asu_groups.group_id AND enrollee_status='Студент'
                   WHERE asu_content_discipline.moodle_id = {$discipline_moodle} AND asu_content_discipline.content_discipline_control IN ('Экзамен', 'Диф. зачёт')";
    $select_exam = mysqli_query($connection, $query_exam);
    $row_exam = mysqli_fetch_assoc($select_exam);
    $sum_students_exam = $row_exam['sum_students_exam'];

    $query_course_work = "SELECT COUNT(asu_enrollee.enrollee_id) AS sum_students_course_work
                          FROM asu_content_discipline
                          LEFT JOIN asu_groups ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
                          LEFT JOIN asu_enrollee ON asu_enrollee.enrollee_group_id = asu_groups.group_id AND enrollee_status='Студент'
                          WHERE asu_content_discipline.moodle_id = {$discipline_moodle} AND asu_content_discipline.content_discipline_course_work = 'Есть'";
    $select_course_work = mysqli_query($connection, $query_course_work);
    $row_course_work = mysqli_fetch_assoc($select_course_work);
    $sum_students_course_work = $row_course_work['sum_students_course_work'];


    //$calculation = $max_hour_audience + ($max_course_work * $sum) + ($max_discipline_control * $sum) + (0.25 * $sum);
    $calculation = $max_hour_audience + ($sum_students_course_work * 1) + ($sum_students_exam * 0.25) + ($count_students_all * 0.25);



    // Сохраняем полученные данные в базу данных

    $load_teacher_date = date('d-m-y');

    $query = "INSERT INTO asu_load_teacher (teacher_id, load_session_id, discipline_moodle_id, load_teacher, load_teacher_date) ";

    $query .= "VALUES({$the_teacher_id}, {$the_session_id}, {$discipline_moodle}, {$calculation}, now()) ";

    $create_load_teacher_query = mysqli_query($connection,$query);

    if(!$create_load_teacher_query) {
        echo "<br>";
        echo $query;
        echo "<br>";
        echo $the_teacher_id;
        echo "<br>";

        die('QUERY FAILED' . mysqli_error($connection));

    }

    $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";




    header("refresh: 1; url=./teachers.php");



}



?>


<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-download text-muted" aria-hidden="true"></i>
            &nbsp;Добавить дисциплину
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-group">
            <a href="teachers.php" class="btn btn-default">
                <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться
            </a>
        </div>
    </div>
</div>
<?php echo $message; ?>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <form action="" class="form-horizontal well" method="POST" enctype="multipart/form-data">

            <h4><i class="fa fa-filter text-muted" aria-hidden="true"></i> Параметры</h4>

            <?php



            ?>

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="teacher">Преподаватель</label>
                    <select name="teacher" id="" class="form-control">
                        <?php
                        if(isset($_GET['t_id'])) {

                            echo "<option value='$teacher_id'>$teacher</option>";

                        } else {

                            while($row = mysqli_fetch_assoc($select_all_teacher)) {

                                $teacher_id = $row['teacher_id'];
                                $teacher_surname = $row['teacher_surname'];
                                $teacher_name = $row['teacher_name'];
                                $teacher_patronymic = $row['teacher_patronymic'];
                                $teaher = $teacher_surname;
                                $teaher .= " ";
                                $teaher .= $teacher_name;
                                $teaher .= " ";
                                $teaher .= $teacher_patronymic;

                                echo "<option value='$teacher_id'>$teaher</option>";

                            }
                        }

                        ?>

                    </select>
                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="discipline_moodle">Дисциплина</label>

                    <select name="discipline_moodle" id="" class="form-control">



                        <?php

                        if(isset($the_moodle_id)) {

                            $query = "SELECT id, fullname FROM clg_course WHERE id = {$the_moodle_id} ORDER BY fullname";
                            $select_course_by_id = mysqli_query($connection,$query);

                            $row = mysqli_fetch_assoc($select_course_by_id);

                            $id = $row['id'];
                            $fullname = $row['fullname'];

                            echo "<option value='$id'>$fullname</option>";

                        } else {

                            echo "<option value=''>Выбрать . . . </option>";

                            $query = "SELECT clg_course.id, clg_course.fullname
                                                    FROM clg_course 
                                                    ORDER BY fullname ";

                            $select_all_courses = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_all_courses)) {

                                $id = $row['id'];
                                $fullname = $row['fullname'];

                                /*$query = " SELECT clg_course.id, clg_course.fullname
                                                        FROM clg_course 
                                                        ORDER BY fullname ";*/

                                $query = "SELECT asu_content_discipline.moodle_id, asu_load_teacher.discipline_moodle_id 
                                            FROM asu_content_discipline
                                            INNER JOIN asu_load_teacher
                                            ON asu_content_discipline.moodle_id != asu_load_teacher.discipline_moodle_id
                                            WHERE moodle_id = {$id}";



                                $select_check = mysqli_query($connection,$query);

                                $row = mysqli_fetch_assoc($select_check);

                                $moodle_id = $row['moodle_id'];

                                if ($moodle_id > 0) {
                                    echo "<option value='$id'>$fullname</option>";
                                }

                            }

                        }

                        ?>

                    </select>

                </div>
            </div>

            <!--
                <div class="form-group">
                    <div class="col-sm-12">
                        <label for="session">Сессия</label>
                        <select name="session" class="form-control">

                            <?php

            //                                $query = "SELECT * FROM asu_session";
            //                                $select_all_session = mysqli_query($connection,$query);
            //
            //                                while($row = mysqli_fetch_assoc($select_all_session)) {
            //
            //                                    $session_id = $row['session_id'];
            //                                    $session_period = $row['session_period'];
            //                                    $session_time = $row['session_time'];
            //                                    $session_start = $row['session_start'];
            //                                    $session_end = $row['session_end'];
            //
            //                                    $description_session = $session_period;
            //                                    $description_session .= ' ';
            //                                    $description_session .= $session_time;
            //
            //                                    echo "<option value='$session_id'>$description_session</option>";
            //
            //                                }

            ?>

                        </select>
                    </div>
                </div>
-->

            <div class="form-group">
                <div class="col-sm-3">
                    <input class="btn btn-primary" type="submit" name="add_discipline_moodle" value="Сохранить">

                </div>
            </div>
        </form>
    </div>
</div>











