<?php

if(isset($_GET['o_id']) || isset($_GET['e_id'])) {
    
    $the_order_id = $_GET['o_id'];
    $the_enrollee_id = $_GET['e_id'];
    
}

    $query =    "   
                    SELECT 
                        
                        asu_orders.order_number AS order_number,
                        DATE_FORMAT(asu_orders.order_date, '%d.%m.%Y') order_date,
                        
                        asu_types_orders.types_orders_title AS types_orders_title,
                        asu_types_orders.types_orders_id AS types_orders_id
                        
                    FROM asu_orders 
                    LEFT JOIN asu_types_orders
                        ON asu_orders.order_types_id = asu_types_orders.types_orders_id
                    WHERE order_id = {$the_order_id} 
                    
                ";

    $select_order_id = mysqli_query($connection,$query);
    
    while($row = mysqli_fetch_assoc($select_order_id)) {
        
        $order_number = $row['order_number'];
        $order_date = $row['order_date'];
        $types_orders_title = $row['types_orders_title'];
        $types_orders_id = $row['types_orders_id'];
        
        if(isset($_POST['update_enrollee_group'])) {
       
            $enrollee_group_id = $_POST['enrollee_group_id'];

            $query = "UPDATE asu_enrollee SET ";
            $query .= "enrollee_group_id = '{$enrollee_group_id}' ";
            $query .= "WHERE enrollee_id = {$the_enrollee_id} ";

            $update_enrollee_group = mysqli_query($connection,$query);

            if(!$update_enrollee_group) {

                die("QUERY FAILED ." . mysqli_error($connection));

            }

            $message = "<i class='fa fa-refresh fa-spin fa-fw'></i> 
                        Абитуриент добавлен в приказ от {$order_date} № {$order_number}.
                        <br>";
        
            header("refresh: 1; url=./order.php?source=paid_students&o_id={$the_order_id}");

        }
        
    }


        



?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-users text-muted" aria-hidden="true"></i> 
            &nbsp;Добавить студентов в приказ от <?php echo $order_date; ?> № <?php echo $order_number; ?>
            <input type="hidden" id="add_students_order" value="<?php echo $the_order_id; ?>">
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="order.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
        <button class="btn btn-success" data-toggle="modal" data-target=".bs-example-modal-lg">
            <i class="fa fa-plus-circle fa-fw" aria-hidden="true"></i>&nbsp;Добавить студента
        </button>
    </div>
</div>
<br>


<!-- Modal -->
<div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Выбрать студента</h4>
            </div>
            <div class="modal-body layer">
                
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <h2><i class="fa fa-filter" aria-hidden="true"></i> Фильтр</h2>
                            </div>

                            <div class="panel-footer form-horizontal">

                                <div class="form-group">
                                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                        <label for="">Фамилия студента</label>
                                        <input name="filter_name" id="filter_name" type="text" class="form-control" value="" placeholder="Фамилия">
                                    </div>
                                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                        <label for="">Семестр</label>
                                        <select name="filter_semester" id="filter_semester" class="form-control"  value="">
                                            <option value=''>Все семестры</option>
                                            <?php selectSemestersForList(); ?>
                                        </select>
                                    </div>
                                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                        <label for="">Период обучения</label>
                                        <select name="filter_period" class="form-control" id="filter_period" value="">
                                            <option value=''>Все периоды обучения</option>
                                            <?php selectSessionForList(); ?>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                        <label for="">Регион</label>
                                        <select name="filter_region" class="form-control" id="filter_region" value="">
                                            <option value=''>Все регионы</option>
                                            <?php selectRegionsForList(); ?>
                                        </select>
                                    </div>

                                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                        <label for="">Группа</label>
                                        <select name="filter_group" class="form-control" id="filter_group" value="">
                                            <option value=''>Все группы</option>
                                            <?php selectGroupsForList(); ?>
                                        </select>
                                    </div>

                                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                        <label for="">Год</label>
                                        <select name="filter_year" class="form-control" id="filter_year" value="">
                                            <option value=''>Все года</option>
                                            <?php selectYearForList(); ?>
                                        </select>
                                    </div>
                                    <input type="hidden" name="order_id" id="order_id" value="<?php echo $the_order_id; ?>">
                                </div>

                                <div class="form-group">
                                    <div class="col-sm-12">
                                        <input class="btn btn-primary" type="submit" name="btn_filter_student_order" id="btn_filter_student_order" value="Найти">
                                        <a class="btn btn-primary" href="sdo.php">Сбросить</a>
                                    </div>
                                </div> 
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id="result">                          
                   
                    </div>
                </div>
                
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header">
            Перечень лиц, включенных в приказ
        </h3>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <p><b>Вид приказа:</b> <?php echo $types_orders_title; ?></p>
    </div>
</div>
<?php if ($types_orders_id == 3) { ?>
<div class="row">
    <div class="col-xs-6 col-sm-3 col-md-3 col-lg-3">
                <div class="alert alert-warning alert-dismissable" id="wanning_add_students_order" style="display:none;">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                    <strong>Студент выбран!</strong> Выберете группу и нажмите кнопку выбрать.
                </div>
                <div class="form-select-group" id="select_group_order" style="display:none">

                </div>
                <label for="">Группа</label>
                <select name="id_group_add_students" class="form-control" id="id_group_add_students" value="">
                    <option value=''>Выбрать группу . . . </option>
                    <?php selectGroupsForList(); ?>
                </select>
                <input class="btn btn-primary" type="submit" name="btn_select_group_add_student" id="btn_select_group_add_student" value="Выбрать">

    </div>
</div>
<br>
<?php } ?>
<?php if ($types_orders_id == 4) { ?>
<div class="row">
    <div class="col-xs-6 col-sm-3 col-md-3 col-lg-3">
                <div class="alert alert-warning alert-dismissable" id="wanning_add_students_order" style="display:none;">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                    <strong>Студент выбран!</strong> Введите новую фамилию и нажмите кнопку сохранить.
                </div>
                <div class="select_surname_order" id="select_surname_order" style="display:none">
                    
                </div>
                <label for="">Фамилия</label>
                    <input type="text" class="form-control" name="new_surname" id="new_surname">
                    <input class="btn btn-primary" type="submit" name="btn_update_surname_add_student" id="btn_update_surname_add_student" value="Сохранить">

    </div>
</div>
<br>
<?php } ?>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                          
        
        <table class="table table-hover table-bordered">
                        
            <thead>
                <tr class="active">
                    <th>№</th>
                    <th>Ф.И.О.</th>
                    <th>Статус</th>
                    <?php 
                        if($types_orders_id == 3) {
                        
                            echo "  <th>
                                        <div class ='pull-left'>Группа(Текущая)</div> 
                                        <div class='pull-right'>
                                            <small>Редактировать</small>
                                        </div>
                                    </th>";
                        
                        } else {
                            echo "<th>Группа</th>";
                        } 
                    ?>
                    <?php echo ($types_orders_id == 3) ? "<th>Группа (Старая)</th>" : ""; ?>
                    <th>Регион</th>
                    <th>ID</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="show-students">

            </tbody>
                        
        </table>
    </div>
</div>



