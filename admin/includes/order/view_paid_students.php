<?php

if(isset($_GET['o_id']) || isset($_GET['e_id'])) {
    
    $the_order_id = $_GET['o_id'];
    $the_enrollee_id = $_GET['e_id'];
    
}

    $query = "SELECT * FROM asu_orders WHERE order_id = {$the_order_id} ";
    $select_order_id = mysqli_query($connection,$query);
    
    while($row = mysqli_fetch_assoc($select_order_id)) {
        
        $order_number = $row['order_number'];
        $order_date = $row['order_date'];
        $order_date = date_create($order_date)->Format('d.m.Y');
        
        if(isset($_POST['update_enrollee_group'])) {
       
            $enrollee_group_id = $_POST['enrollee_group_id'];

            $query = "UPDATE asu_enrollee SET ";
            $query .= "enrollee_group_id = '{$enrollee_group_id}' ";
            $query .= "WHERE enrollee_id = {$the_enrollee_id} ";

            $update_enrollee_group = mysqli_query($connection,$query);

            if(!$update_enrollee_group) {

                die("QUERY FAILED ." . mysqli_error($connection));

            }

            $message = "<i class='fa fa-refresh fa-spin fa-fw'></i> 
                        Абитуриент добавлен в приказ от {$order_date} № {$order_number}.
                        <br>";
        
            header("refresh: 1; url=./order.php?source=paid_students&o_id={$the_order_id}");

        }
        
    }

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-users text-muted" aria-hidden="true"></i> 
            &nbsp;Добавить студентов в приказ от <?php echo $order_date; ?> № <?php echo $order_number; ?>
        </h1>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="order.php?source=view_order&o_id=<?php echo $the_order_id; ?>" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<br>
<?php


    $query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$the_enrollee_id} ";
    $select_enrollee_id = mysqli_query($connection,$query);

    while($row = mysqli_fetch_assoc($select_enrollee_id)) {
        
        $enrollee_surname = $row['enrollee_surname'];
        $enrollee_name = $row['enrollee_name'];
        $enrollee_patronymic = $row['enrollee_patronymic'];
        
        echo "<div class='alert alert-success'>{$message}<b>Добавить в группу:</b>&nbsp;{$enrollee_surname}&nbsp;{$enrollee_name}&nbsp;{$enrollee_patronymic}</div>";
    }

?>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

        <form class="form-inline" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <select name="enrollee_group_id" class="form-control" required>
                    <option value="">Выбрать . . . </option>
                    <?php

                        $query = "SELECT * FROM asu_groups";
                        $select_groups = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_groups)) {

                            $group_id = $row['group_id'];
                            $group_number = $row['group_number'];

                            echo "<option value='$group_id'>{$group_number}</option>";

                        }

                    ?>
                </select>
            </div>
  
            <input class="btn btn-primary" type="submit" name="update_enrollee_group" value="Добавить в группу">
        </form>
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                          
        <table class="table table-hover table-bordered table-filter">
        <thead>
            <tr class="active">
                <th>Фамилия</th>
                <th>Имя</th>
                <th>Отчество</th>
                <th>Статус</th>
                <th>Регион</th>
                <th>Группа</th>
                <th class="text-center">ID</th>
                <th class="text-center">Выбрать</th>
                <th class="text-center">Личное дело</th>
                <th class="text-center">Исключить</th>
            </tr>
        </thead>
        <tbody>


                <?php
                    
                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_order_id = {$the_order_id} ";
                    $select_all_enrollee = mysqli_query($connection, $query);

                    while($row = mysqli_fetch_assoc($select_all_enrollee)) {

                        $enrollee_id = $row['enrollee_id'];
                        $enrollee_surname = $row['enrollee_surname'];
                        $enrollee_name = $row['enrollee_name'];
                        $enrollee_patronymic = $row['enrollee_patronymic'];
                        $enrollee_status = $row['enrollee_status'];
                        $enrollee_region = $row['enrollee_region'];
                        $enrollee_region_id = $row['enrollee_region_id'];
                        $enrollee_group_id = $row['enrollee_group_id'];

                        echo "<tr>";
                        echo "<td>{$enrollee_surname}</td>";
                        echo "<td>{$enrollee_name}</td>";
                        echo "<td>{$enrollee_patronymic}</td>";
                        echo "<td>{$enrollee_status}</td>";

                        $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                        $select_region_id = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_region_id)) {
                            $region_id = $row['region_id'];
                            $region_title = $row['region_title'];

                            echo "<td>{$region_title}</td>";
                        }
                        
                        if ($enrollee_group_id) { 
                            
                            $query = "SELECT * FROM asu_groups WHERE group_id = {$enrollee_group_id} ";
                            $select_group_id = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_group_id)) {

                                $group_number = $row['group_number'];

                                echo "<td class='text-center'>{$group_number}</td>";
                            }

                        } else {
                            
                            echo "<td class='text-center text-danger'>группы нет</td>";
                        }

                        echo "<td class='text-center'>{$enrollee_id}</td>";
                        echo "<td class='text-center'><a href='order.php?source=paid_students&o_id={$the_order_id}&e_id={$enrollee_id}'><i class='fa fa-check-square' aria-hidden='true'></i> Выбрать</a></td>";
                        echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                        echo "<td class='text-center'><a href='order.php?source=paid_students&exc_enrollee={$enrollee_id}&o_id={$the_order_id}'><i class='fa fa-minus-circle' aria-hidden='true'></i> Исключить</a></td>";
                        echo "</tr>";
                        
                        if(isset($_GET['exc_enrollee'])) {
                         
                            $the_enrollee_id = $_GET['exc_enrollee'];
                            $the_order_id = $_GET['o_id'];

                            $query = "UPDATE asu_enrollee SET enrollee_order_id = '',  enrollee_group_id = ''  WHERE enrollee_id = {$the_enrollee_id} ";

                            $update_query = mysqli_query($connection, $query);

                            $query = "UPDATE asu_enrollee SET enrollee_status = 'В приказ' WHERE enrollee_id = {$the_enrollee_id} ";

                            $update_query = mysqli_query($connection, $query);

                            header("Location: order.php?source=paid_students&o_id={$the_order_id}");
    
                        }
                    }
                ?>


        </tbody>
        </table>
    </div>
</div>


<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header">
            <i class="fa fa-users text-muted" aria-hidden="true"></i> 
            &nbsp;Перечень абитуриентов, оплативших обучение
        </h3>
    </div>
</div>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                          
        <table class="table table-hover table-bordered table-filter">
        <thead>
            <tr class="active">
                <th>Фамилия</th>
                <th>Имя</th>
                <th>Отчество</th>
                <th>Статус</th>
                <th>Регион</th>
                <th class="text-center">ID</th>
                <th class="text-center">Личное дело</th>
                <th class="text-center">Добавить</th>
            </tr>
        </thead>
        <tbody>


                <?php
                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'В приказ' ";
                    $select_all_enrollee = mysqli_query($connection, $query);

                    while($row = mysqli_fetch_assoc($select_all_enrollee)) {

                        $enrollee_id = $row['enrollee_id'];
                        $enrollee_surname = $row['enrollee_surname'];
                        $enrollee_name = $row['enrollee_name'];
                        $enrollee_patronymic = $row['enrollee_patronymic'];
                        $enrollee_status = $row['enrollee_status'];
                        $enrollee_region = $row['enrollee_region'];
                        $enrollee_region_id = $row['enrollee_region_id'];

                        echo "<tr>";
                        echo "<td>{$enrollee_surname}</td>";
                        echo "<td>{$enrollee_name}</td>";
                        echo "<td>{$enrollee_patronymic}</td>";
                        echo "<td>{$enrollee_status}</td>";

                        $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                        $select_region_id = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_region_id)) {
                            $region_id = $row['region_id'];
                            $region_title = $row['region_title'];

                            echo "<td>{$region_title}</td>";
                        }

                        echo "<td class='text-center'>{$enrollee_id}</td>";
                        echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                        echo "<td class='text-center'><a href='order.php?source=paid_students&add_enrollee={$enrollee_id}&o_id={$the_order_id}'><i class='fa fa-plus-circle' aria-hidden='true'></i> Добавить</a></td>";
                        echo "</tr>";

                    }
            
                     if(isset($_GET['add_enrollee'])) {
                         
                        $the_enrollee_id = $_GET['add_enrollee'];
                        $the_order_id = $_GET['o_id'];
    
                        $query = "UPDATE asu_enrollee SET enrollee_order_id = '{$the_order_id}' WHERE enrollee_id = {$the_enrollee_id} ";

                        $update_query = mysqli_query($connection, $query);
                         
                        $query = "UPDATE asu_enrollee SET enrollee_status = 'Студент' WHERE enrollee_id = {$the_enrollee_id} ";

                        $update_query = mysqli_query($connection, $query);
                         
                        
    
                        header("Location: order.php?source=paid_students&o_id={$the_order_id}");
    
                     }
                ?>


        </tbody>
        </table>
    </div>
</div>



