<?php

if(isset($_GET['d_id'])) {
    
    $the_doc_id = $_GET['d_id'];
    
}


$query = "SELECT * FROM asu_doc_templates WHERE doc_id = {$the_doc_id} ";
$select_doc_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_doc_by_id)) {

    $doc_title = $row['doc_title'];
    $doc_description = $row['doc_description'];
    $doc_number = $row['doc_number'];        
    $doc_file = $row['doc_file'];
    $doc_date = $row['doc_date']; 
    
 
    if(isset($_POST['update_doc'])) {
       
        $doc_title = $_POST['doc_title'];
        $doc_description = $_POST['doc_description'];
        $doc_number = $_POST['doc_number'];  
        
        $doc_file = $_FILES['doc']['name'];
        $doc_file_temp = $_FILES['doc']['tmp_name'];
        
        $doc_date = date('d-m-y');

        move_uploaded_file($doc_file_temp, "documents/$doc_file");
        
        if(empty($doc_file)) { // empty - определяет, установлена ли переменная
            
            $query = "SELECT * FROM asu_doc_templates WHERE doc_id = $the_doc_id ";
            $select_doc = mysqli_query($connection,$query);
            
            while($row = mysqli_fetch_assoc($select_doc)) {
                
                $doc_file = $row['doc_file'];
                
            }
            
        }
        
        $query = "UPDATE asu_doc_templates SET ";
        $query .= "doc_title = '{$doc_title}', ";
        $query .= "doc_description = '{$doc_description}', ";
        $query .= "doc_date = now(), ";
        $query .= "doc_number = '{$doc_number}', ";
        $query .= "doc_file = '{$doc_file}' ";
        $query .= "WHERE doc_id = {$the_doc_id} ";
        
        $update_doc = mysqli_query($connection,$query);
        
        
        $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";
        
        header("refresh: 1; url=./documents.php");
        
       
    }
    
    
}


?>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-pencil-square-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Редактировать документ
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="documents.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<?php echo $message; ?>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">   
        <form action="" method="post" enctype="multipart/form-data">

            <div class="form-group">
                <label for="enrollee_patronymic">Номер документа</label>
                <input type="text" class="form-control" name="doc_number" value="<?php echo $doc_number; ?>">
            </div>

            <div class="form-group">
                <label for="enrollee_surname">Название документа</label>
                <input type="text" class="form-control" name="doc_title" value="<?php echo $doc_title; ?>">
            </div>

            <div class="form-group">
                <label for="enrollee_name">Описание документа</label>
                <input type="text" class="form-control" name="doc_description" value="<?php echo $doc_description; ?>">
            </div>

            <div class="form-group">
                <div class="well">
                    <label for="enrollee_image">Файл документа</label><br>
                    <a href="documents/<?php echo $doc_file; ?>"><?php echo $doc_file; ?></a>
                    <input type="file" name="doc">
                </div>
            </div>

            <div class="form-group">
                <input class="btn btn-primary" type="submit" name="update_doc" value="Сохранить">
            </div>  

        </form> 
    </div>
</div>    
         

   
   
