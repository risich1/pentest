<?php
if(isset($_GET['pay_id'])) {
    $the_treaty_id = $_GET['pay_id'];
    $the_payment_number = $the_treaty_id;
}

$query =    "   SELECT 
                    treaty_number,
                    DATE_FORMAT(treaty_date_conclusion, '%d.%m.%Y') treaty_date_conclusion,
                    treaty_enrollee_id,
                    treaty_cost,
                    treaty_plan_id
                    
                    FROM asu_treaty 
                    WHERE treaty_id = {$the_treaty_id} 
            ";

$select_treaty_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_treaty_by_id)) {
    $treaty_number = $row['treaty_number'];
    $treaty_date_conclusion = $row['treaty_date_conclusion'];
    $treaty_enrollee_id = $row['treaty_enrollee_id'];
    $treaty_cost = $row['treaty_cost'];
    $treaty_plan_id = $row['treaty_plan_id'];
}

$query = "SELECT * FROM asu_payment WHERE payment_treaty_id = {$the_treaty_id} ";
$select_payment_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_payment_by_id)) {
    $payment_number = $row['payment_number'];
}

$query = "SELECT * FROM asu_payment WHERE payment_treaty_id = {$the_treaty_id} ";
$select_all_payment = mysqli_query($connection,$query);
$payment_count = mysqli_num_rows($select_all_payment);

if($payment_number) {
    
    $the_payment_number = $treaty_number . '-' . $payment_count = $payment_count+1;

} else if($the_payment_number) {
    $i = 1;
    $the_payment_number = $treaty_number . '-' . $i;

}   

$query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$treaty_plan_id} ";
$select_academic_plan_id = mysqli_query($connection, $query);

$row = mysqli_fetch_assoc($select_academic_plan_id);

$academic_plan_period = $row['academic_plan_period'];


 if(isset($_POST['add_payment'])) {
     
     $payment_treaty_id = $the_treaty_id;
     $payment_enrollee_id = $treaty_enrollee_id;
     $payment_number = $the_payment_number;
     $payment_create_date = $_POST['payment_create_date'];
     $payment_cost = $_POST['payment_cost'];
     $payment_semester_id = $_POST['payment_semester_id'];
     $payment_status = 'Оплачен';
     $payment_comment = $_POST['payment_comment'];
     
     $payment_file = $_FILES['file']['name'];
     $payment_file_temp = $_FILES['file']['tmp_name'];
     
     move_uploaded_file($payment_file_temp, "file/payment/$payment_file");
     
     $query = "INSERT INTO asu_payment(payment_treaty_id, payment_enrollee_id, payment_number, payment_create_date, payment_cost, payment_semester_id, payment_status, payment_comment, payment_file, payment_date) ";
                    
     $query .= "VALUES ($payment_treaty_id, $payment_enrollee_id, '{$payment_number}', '{$payment_create_date}', '{$payment_cost}', $payment_semester_id, '{$payment_status}', '{$payment_comment}', '{$payment_file}', now())";

     $create_payment_query = mysqli_query($connection,$query);

     if(!$create_payment_query) {

        die('QUERY FAILED' . mysqli_error($connection));
         
    

     }

//     $query = "UPDATE asu_treaty SET ";
//     $query .= "treaty_finance_status = 'Оплачен', ";
//     $query .= "treaty_finance_date = now() ";
//        
//     $query .= "WHERE treaty_id = {$the_treaty_id} ";
        
//     $update_treaty = mysqli_query($connection,$query);
     
     $query =   "
                
                    SELECT 
                        asu_enrollee.enrollee_id AS enrollee_id,
                        asu_enrollee.enrollee_status AS enrollee_status
                        FROM asu_treaty 
                        LEFT JOIN asu_enrollee
                        ON asu_treaty.treaty_enrollee_id = asu_enrollee.enrollee_id
                        WHERE treaty_id = {$the_treaty_id} 
     
                ";
     
     $select_enrollee = mysqli_query($connection, $query);
     
     while($row = mysqli_fetch_assoc($select_enrollee)) {
     
        $treaty_enrollee_id = $row['enrollee_id'];
        $enrollee_status = $row['enrollee_status'];
   
     }
     
     if($enrollee_status == 'Договор заключен') {
         $query = "UPDATE asu_enrollee SET ";
         $query .= "enrollee_status = 'В приказ' ";

         $query .= "WHERE enrollee_id = {$treaty_enrollee_id} ";

         $update_enrollee_status = mysqli_query($connection,$query);
     }
         $query = "UPDATE asu_treaty SET ";
         $query .= "treaty_payment_status_{$payment_semester_id} = 'Оплачен' ";

         $query .= "WHERE treaty_id = {$payment_treaty_id} ";

         $update_treaty_payment_status = mysqli_query($connection,$query);
     
     
//    $query = "UPDATE posts SET post_comment_count = post_comment_count + 1 ";
//    $query .= "WHERE post_id = {$the_post_id}";
//
//    $update_comment_count = mysqli_query($connection, $query);
//
//
//    } else {
//
//        echo "<script>alert('vdvdf');</script>";
//
//    }
     
     $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";
     header("refresh: 1; url=./payment.php");

 }


?>


<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="text-primary">
            <i class="fa fa-credit-card" aria-hidden="true"></i> 
            Добавление данных об оплате по договору № <?php echo $treaty_number; ?> от <?php echo $treaty_date_conclusion; ?>
        </h3>
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="payment.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<br>
<?php echo $message; ?>
<form class="form-horizontal" action="" method="post" enctype="multipart/form-data">  
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="payment_number">Номер документа</label>
            <input type="text" class="form-control" nameid="disabledInput" placeholder="<?php echo $the_payment_number; ?>" disabled>
        </div>

        <div class="col-sm-6">
            <label for="payment_create_date">Дата платежа</label>
            <input type="date" class="form-control" name="payment_create_date">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="payment_cost">Сумма, руб.</label>
            <input type="text" class="form-control" name="payment_cost" value="<?php echo $treaty_cost; ?>">
        </div>
        <div class="col-sm-6">
            <label for="payment_kind">Семестр</label>
            <select name="payment_semester_id" id="" class="form-control">
                <?php 
                    
                    $query = "SELECT * FROM asu_payment WHERE payment_treaty_id = {$the_treaty_id} ORDER BY payment_id";
                    $select_payment_by_id = mysqli_query($connection, $query);
                
                    $query = "SELECT * FROM asu_semesters ";
                
//                    while($row = mysqli_fetch_assoc($select_payment_by_id)) {
//                        
//                        
//                        $payment_semester_id = $row['payment_semester_id'];
//                        
//                        
//                        if($payment_count == 1) {
//
//                            $query .= "WHERE semester_id != {$payment_semester_id} "; 
//                            
//                        } else {
//                            if($payment_semester_id == 1) {
//                                $query .= "WHERE semester_id != {$payment_semester_id} ";
//                            } else {
//                                
//                                $query .= "AND semester_id != {$payment_semester_id} ";
//                            } 
//                        }
//
//                    }
                    
                    
                           
                    $select_all_semester = mysqli_query($connection, $query);

                    while($row = mysqli_fetch_assoc($select_all_semester)) {

                        $semester_id = $row['semester_id'];
                        $semester_title = $row['semester_title'];

                            if($semester_id <= $academic_plan_period) {
                                echo "<option value='{$semester_id}'>{$semester_title}</option>"; 
                            }
                            
                        }

                ?>
            </select>
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-6">
            <label for="payment_comment">Примечание</label>
            <input type="text" class="form-control" name="payment_comment">
        </div>
    </div>
<!--
    <div class="form-group">
        <div class="col-sm-6">
            <div class="well">
                <label for="payment_file"><i class="fa fa-paperclip" aria-hidden="true"></i> Файл документа</label>
                <input type="file" name="file">
            </div>
        </div>
    </div>
-->
    
    <div class="form-group">
        <div class="col-sm-12">
            <div class="page-header"></div>
            <input class="btn btn-primary" type="submit" name="add_payment" value="Добавить">
        </div>
    </div>  
   
</form>  