
<?php

    $link_page = $_SERVER['REQUEST_URI'];
	
    if(isset($_POST['search_payment'])) {
        $payment_semester_id = $_POST['payment_semester_id'];
        $payment_treaty_number = $_POST['search_treaty'];
        
        $surname=$_POST['search_surname'];
        $name=$_POST['search_name'];
        $patronymic=$_POST['search_patronymic'];
        
    }

	if ($payment_treaty_number) {
		$query="SELECT * FROM asu_treaty WHERE treaty_number LIKE '%$payment_treaty_number%' AND treaty_status='Заключен'";
	}					
	else {
		$query = "SELECT * FROM asu_treaty WHERE treaty_status='Заключен' ";
	}
		
		
    if ($surname || $name || $patronymic) {
		$get = "SELECT enrollee_id FROM asu_enrollee WHERE enrollee_status !='Архив' ";
		if ($surname) {
			$get = $get." AND enrollee_surname LIKE '%$surname%' ";						
		}
		if ($name) {
			$get = $get." AND enrollee_name LIKE '%$name%' ";	
		}
		if ($patronymic) {
			$get = $get." AND enrollee_patronymic LIKE '%$patronymic%'";	
		}				
		//$get = "SELECT enrollee_id FROM asu_enrollee WHERE enrollee_surname='{$surname}' AND enrollee_name='{$name}' AND enrollee_patronymic='{$patronymic}'";
		$get_id=mysqli_query($connection, $get);
		
		$query=$query." AND (";
		
		while($row = mysqli_fetch_assoc($get_id)) {					
			$id=$row['enrollee_id'];
			$query=$query." treaty_enrollee_id={$id} OR ";
		}
		
		$query=$query."treaty_enrollee_id={$id})";

	}					

    $select_all_treaty = mysqli_query($connection, $query);

	
	
    if(isset($_POST['search_payment'])) {
       
        $count = mysqli_num_rows($select_all_treaty);

        if($count == 0) {

            $message = "<div class='alert alert-success'>По Вашему поисковому запросу ни чего не найдено.</div>";

        } else {
            $message = "<div class='alert alert-success'><b>Результат поиска</b>
                        <p>Найдено: {$count}</p></div>";
        }
    }

?>




<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="text-primary"><i class="fa fa-calendar" aria-hidden="true"></i> График оплаты</h3>
    </div>
</div>
<br>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <form action="" class="form-horizontal well" method="POST" enctype="multipart/form-data">
                
                    <h4><i class="fa fa-filter text-muted" aria-hidden="true"></i> Фильтр</h4>

                <div class="form-group">
                    <div class="col-sm-3">      
                        <label for="payment_create_date">Семестр</label>
                        <select name="payment_semester_id" id="" class="form-control">
                            <?php 

                                if (isset($payment_semester_id) and $payment_semester_id >= 1) {
                                
                                    $query = "SELECT * FROM asu_semesters WHERE semester_id = {$payment_semester_id}";
                                    $select_semester_by_id = mysqli_query($connection, $query);
                               
                                    $row = mysqli_fetch_assoc($select_semester_by_id); 
                                    $semester_id = $row['semester_id'];
                                    $semester_title = $row['semester_title'];
                                    
                                    $query = "SELECT * FROM asu_semesters WHERE semester_id != {$semester_id}";

                                    echo "<option value='{$semester_id}'>{$semester_title}</option>";
                                    
                                } else {

                                    echo "<option value=''>Выбрать . . . </option>";
                                    $query = "SELECT * FROM asu_semesters"; 
                                    
                                }
                            
                                $select_all_semester = mysqli_query($connection, $query);
                                while($row = mysqli_fetch_assoc($select_all_semester)) {
                                    $semester_id = $row['semester_id'];
                                    $semester_title = $row['semester_title'];
                                    echo "<option value='{$semester_id}'>{$semester_title}</option>";
                                }

                            ?>
                        </select>
                    </div>
                    <div class="col-sm-3"> 
                        <label for="search_treaty">Номер договора</label> 
                        <input type="text" name="search_treaty" class="form-control" value="<?php echo $payment_treaty_number; ?>">                                       
                    </div>
                    <div class="col-sm-2">
                        <label for="search_surname">Фамилия</label>
                        <input type="text" name="search_surname" class="form-control" value="<?php echo $surname; ?>">
                    </div>
                    <div class="col-sm-2">                              
                        <label for="search_name">Имя</label>                                
                        <input type="text" name="search_name" class="form-control"  value="<?php echo $name; ?>">
                    </div>
                    <div class="col-sm-2">
                        <label for="search_patronymic">Отчество</label>                               
                        <input type="text" name="search_patronymic" class="form-control"  value="<?php echo $patronymic; ?>"> 
                    </div>			
				</div>				

								
				<div class="form-group">
					<div class="col-sm-12">
						<input class="btn btn-primary" type="submit" name="search_payment" value="Найти">
                        <input class="btn btn-primary" type="submit" name="default_payment" value="Сбросить">
						<!-- <a class="btn btn-default" href="payment.php?source=payment_schedule">Сбросить</a> -->
					</div>
				</div>      
            </form>
    </div>
</div>
<?php echo $message; ?>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">	
	
<!-- Tab panes -->
             <table class="tablesorter table table-hover table-bordered table-filter">
			<!--<table class="tablesorter">-->
            <thead>
                <tr class="active">
                    <th>Номер договора</th>
                    <th>Статус договора</th>
                    <th>Дата заключения</th>
                    <th>Ф.И.О.</th>
                    <th>Семестр</th>
                    <th>Срок оплаты</th>
                    <th>Стоимость, руб.</th>
                    <th class="text-center">Статус оплаты</th>
                    <th class="text-center">№ док. об оплате, дата</th>
            <!--        <th class="text-center">Подробнее</th>-->
            <!--
                    <th class="text-center">Редактировать</th>
                    <th class="text-center">Удалить</th>
            -->
                </tr>
				
				
            </thead>
            <tbody>

            <?php
				
                
                while($row = mysqli_fetch_assoc($select_all_treaty)) {

                    $treaty_id = $row['treaty_id'];
                    $treaty_number = $row['treaty_number'];
                    $treaty_date_conclusion = $row['treaty_date_conclusion'];
                    $treaty_date_conclusion = date_create($treaty_date_conclusion)->Format('d.m.Y');
                    
                    $treaty_count_semesters = $row['treaty_count_semesters'];
                    $treaty_autumn_date = $row['treaty_autumn_date'];
                    $treaty_spring_date = $row['treaty_spring_date'];
                    $treaty_cost = $row['treaty_cost'];
                    $treaty_semester_id = $row['treaty_semester_id'];
                    $treaty_status = $row['treaty_status'];
                    $treaty_plan_id = $row['treaty_plan_id'];
                    $treaty_enrollee_id = $row['treaty_enrollee_id'];
					
					
					
                    $treaty_autumn_date_1 = $row['treaty_autumn_date_1'];
                    if($treaty_autumn_date_1 > '0000-00-00 00:00:00') {
                        $treaty_autumn_date_1 = date_create($treaty_autumn_date_1)->Format('d.m.Y'); 
                    } else {
                        $treaty_autumn_date_1 = '-';
                    }
                    
                   
                    $treaty_autumn_date_3 = $row['treaty_autumn_date_3'];
                    if($treaty_autumn_date_3 > '0000-00-00 00:00:00') {
                        $treaty_autumn_date_3 = date_create($treaty_autumn_date_3)->Format('d.m.Y');
                    } else {
                        $treaty_autumn_date_3 = '-';
                    }
                    
                    $treaty_autumn_date_5 = $row['treaty_autumn_date_5'];
                    if($treaty_autumn_date_5 > '0000-00-00 00:00:00') {
                        $treaty_autumn_date_5 = date_create($treaty_autumn_date_5)->Format('d.m.Y');
                    } else {
                        $treaty_autumn_date_5 = '-';
                    }
                    
                    $treaty_autumn_date_7 = $row['treaty_autumn_date_7'];
                    if($treaty_autumn_date_7 > '0000-00-00 00:00:00') {
                        $treaty_autumn_date_7 = date_create($treaty_autumn_date_7)->Format('d.m.Y');
                    } else {
                        $treaty_autumn_date_7 = '-';
                    }
                    
                    $treaty_autumn_date_9 = $row['treaty_autumn_date_9'];
                    if($treaty_autumn_date_9 > '0000-00-00 00:00:00') {
                        $treaty_autumn_date_9 = date_create($treaty_autumn_date_9)->Format('d.m.Y');
                    } else {
                        $treaty_autumn_date_9 = '-';
                    }

                    $treaty_spring_date_2 = $row['treaty_spring_date_2'];
                    if($treaty_spring_date_2 > '0000-00-00 00:00:00') {
                        $treaty_spring_date_2 = date_create($treaty_spring_date_2)->Format('d.m.Y');
                    } else {
                        $treaty_spring_date_2 = '-';
                    }
                    
                    $treaty_spring_date_4 = $row['treaty_spring_date_4'];
                    if($treaty_spring_date_4 > '0000-00-00 00:00:00') {
                        $treaty_spring_date_4 = date_create($treaty_spring_date_4)->Format('d.m.Y');
                    } else {
                        $treaty_spring_date_4 = '-';
                    }
                    
                    $treaty_spring_date_6 = $row['treaty_spring_date_6'];
                    if($treaty_spring_date_6 > '0000-00-00 00:00:00') {
                        $treaty_spring_date_6 = date_create($treaty_spring_date_6)->Format('d.m.Y');
                    } else {
                        $treaty_spring_date_6 = '-';
                    }
                    
                    $treaty_spring_date_8 = $row['treaty_spring_date_8'];
                    if($treaty_spring_date_8 > '0000-00-00 00:00:00') {
                        $treaty_spring_date_8 = date_create($treaty_spring_date_8)->Format('d.m.Y');
                    } else {
                        $treaty_spring_date_8 = '-';
                    }
                    
                    $treaty_payment_status_1 = $row['treaty_payment_status_1'];
                    $treaty_payment_status_2 = $row['treaty_payment_status_2'];
                    $treaty_payment_status_3 = $row['treaty_payment_status_3'];
                    $treaty_payment_status_4 = $row['treaty_payment_status_4'];
                    $treaty_payment_status_5 = $row['treaty_payment_status_5'];
                    $treaty_payment_status_6 = $row['treaty_payment_status_6'];
                    $treaty_payment_status_7 = $row['treaty_payment_status_7'];
                    $treaty_payment_status_8 = $row['treaty_payment_status_8'];
                    $treaty_payment_status_9 = $row['treaty_payment_status_9'];
					

                    if($payment_semester_id && (!isset($_POST['default_payment'])) ) {

                        $query = "SELECT * FROM asu_semesters WHERE semester_id = {$payment_semester_id} ";
                        $select_semester_by_id = mysqli_query($connection, $query);

                                while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                    $semester_title = $row['semester_title'];

                                        echo "<tr>";       
                                        echo "<td><a href='treaty.php?source=view_treaty&treaty_id={$treaty_id}&link_page={$link_page}'>{$treaty_number}</a></td>";
                                        echo "<td>{$treaty_status}</td>";
                                        echo "<td>{$treaty_date_conclusion}</td>";
										
										
										$query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id} ";
										$select_enrollee_by_id = mysqli_query($connection, $query);
											
										
                                        while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {
											$enrollee_surname = $row['enrollee_surname'];
											$enrollee_name = $row['enrollee_name'];
											$enrollee_patronymic = $row['enrollee_patronymic'];
										
                                            echo "<td><a href='enrollee.php?source=view_enrollee&e_id={$treaty_enrollee_id}&link_page={$link_page}'>{$enrollee_surname} {$enrollee_name} {$enrollee_patronymic}</a></td>";
                                        }


                                        echo "<td>{$semester_title}</td>";

                                        if(${treaty_autumn_date_.$payment_semester_id}) {
                                            echo "<td>${treaty_autumn_date_.$payment_semester_id}</td>";
                                        } else {
                                            echo "<td>${treaty_spring_date_.$payment_semester_id}</td>";
                                        }


                                        echo "<td>{$treaty_cost}</td>";


                                        if(${treaty_payment_status_.$payment_semester_id}) {
                                            echo "<td>${treaty_payment_status_.$payment_semester_id}</td>";
                                        } else {
                                            echo "<td class='text-danger'>Не оплачен</td>";
                                        }


                                        if(!${treaty_payment_status_.$payment_semester_id}) {
                                            echo "<td>-</td>";
                                        } else {
                                            
                                        $query = "SELECT * FROM asu_payment WHERE payment_semester_id = {$payment_semester_id} AND payment_treaty_id =  {$treaty_id}";
                                        $select_payment_semester_by_id = mysqli_query($connection, $query);

                                        while($row = mysqli_fetch_assoc($select_payment_semester_by_id)) {

                                            $payment_number = $row['payment_number'];
                                            $payment_create_date = $row['payment_create_date'];
                                            $payment_create_date = date_create($payment_create_date)->Format('d.m.Y');

                                            echo "<td>{$payment_number}, {$payment_create_date}</td>";
                                        }
                                        }
                                        echo "</tr>";

                                    }   

                    } else {

                    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$treaty_plan_id}";
                    $select_all_academic_plan = mysqli_query($connection,$query);

                    while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                        $academic_plan_period = $row['academic_plan_period'];

                        for($i=1; $i <= $academic_plan_period; $i++) {

                            if ($i % 2) { 
                               
                                $query = "SELECT * FROM asu_semesters WHERE semester_id = {$i} ";
                                $select_semester_by_id = mysqli_query($connection, $query);

                                while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                    $semester_title = $row['semester_title'];

                                        echo "<tr>";                             
                                    
                                        echo "<td><a href='treaty.php?source=view_treaty&treaty_id={$treaty_id}&link_page={$link_page}'>{$treaty_number}</a></td>";
                                        echo "<td>{$treaty_status}</td>";
                                        echo "<td>{$treaty_date_conclusion}</td>";
										
										
										$query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id} ";	
										$select_enrollee_by_id = mysqli_query($connection, $query);
                                        

                                        while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {
                                            $enrollee_surname = $row['enrollee_surname'];
                                            $enrollee_name = $row['enrollee_name'];
                                            $enrollee_patronymic = $row['enrollee_patronymic'];

                                            echo "<td><a href='enrollee.php?source=view_enrollee&e_id={$treaty_enrollee_id}&link_page={$link_page}'>{$enrollee_surname} {$enrollee_name} {$enrollee_patronymic}</a></td>";
                                        }

                                        echo "<td>{$semester_title}</td>";
                                        echo "<td>${treaty_autumn_date_.$i}</td>";
                                        echo "<td>{$treaty_cost}</td>";

                                        if(${treaty_payment_status_.$i}) {
                                            echo "<td>${treaty_payment_status_.$i}</td>";
                                        } else {
                                            echo "<td class='text-danger'>Не оплачен</td>";
                                        }


                                        if(!${treaty_payment_status_.$i}) {
                                            echo "<td>-</td>";
                                        } else {
                                            $query = "SELECT * FROM asu_payment WHERE payment_semester_id = {$i} AND payment_treaty_id =  {$treaty_id}";
                                            $select_payment_semester_by_id = mysqli_query($connection, $query);

                                            while($row = mysqli_fetch_assoc($select_payment_semester_by_id)) {

                                                $payment_number = $row['payment_number'];
                                                $payment_create_date = $row['payment_create_date'];
                                                $payment_create_date = date_create($payment_create_date)->Format('d.m.Y');                                            

                                                echo "<td>{$payment_number}, {$payment_create_date}</td>";
                                            }
                                        }
                                        echo "</tr>";

                                    }   


                                $j = $i +1;
                                
                                if($j <= $academic_plan_period) {
                                                                    
                                    $query = "SELECT * FROM asu_semesters WHERE semester_id = {$j} ";
                                    $select_semester_by_id = mysqli_query($connection, $query);

                                    while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                        $semester_title = $row['semester_title'];

                                            echo "<tr>";
                                            echo "<td><a href='treaty.php?source=view_treaty&treaty_id={$treaty_id}&link_page={$link_page}'>{$treaty_number}</a></td>";
                                            echo "<td>{$treaty_status}</td>";
                                            echo "<td>{$treaty_date_conclusion}</td>";


                                            $query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id} ";								


                                            $select_enrollee_by_id = mysqli_query($connection, $query);


                                            while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {
                                                $enrollee_surname = $row['enrollee_surname'];
                                                $enrollee_name = $row['enrollee_name'];
                                                $enrollee_patronymic = $row['enrollee_patronymic'];

                                                echo "<td><a href='enrollee.php?source=view_enrollee&e_id={$treaty_enrollee_id}&link_page={$link_page}'>{$enrollee_surname} {$enrollee_name} {$enrollee_patronymic}</a></td>";
                                            }

                                            echo "<td>{$semester_title}</td>";
                                            echo "<td>${treaty_spring_date_.$j}</td>";
                                            echo "<td>{$treaty_cost}</td>";

                                            if(${treaty_payment_status_.$j}) {
                                                echo "<td>${treaty_payment_status_.$j}</td>";
                                            } else {
                                                echo "<td class='text-danger'>Не оплачен</td>";
                                            }

                                            if(!${treaty_payment_status_.$j}) {
                                                echo "<td>-</td>";
                                            } else {
                                            $query = "SELECT * FROM asu_payment WHERE payment_semester_id = {$j} AND payment_treaty_id =  {$treaty_id} ";
                                            $select_payment_semester_by_id = mysqli_query($connection, $query);

                                                while($row = mysqli_fetch_assoc($select_payment_semester_by_id)) {

                                                    $payment_number = $row['payment_number'];
                                                    $payment_create_date = $row['payment_create_date'];
                                                    $payment_create_date = date_create($payment_create_date)->Format('d.m.Y');

                                                    echo "<td>{$payment_number}, {$payment_create_date}</td>";
                                                }
                                            }
                                            echo "</tr>";
                                        }
                                    }
                                }

                            } 

                        }

                    }
                }

            ?>


                </tbody>
            </table>
			
    </div>
</div>

