<?php
require_once("../includes/db.php");


if(isset($_GET['a_id']) && isset($_GET['e_id'])) {
    
    $the_academic_plan_id = $_GET['a_id'];
    $the_enrollee_id = $_GET['e_id'];
    
}

$query =    "
                SELECT
                    
                    asu_academic_plan.academic_plan_direction_id AS academic_plan_direction_id,
                    asu_academic_plan.academic_plan_period AS academic_plan_period,
                    asu_academic_plan.academic_plan_name AS academic_plan_name,
                    
                    asu_groups.group_number AS group_number,

                    CONCAT(asu_enrollee.enrollee_surname,' ',asu_enrollee.enrollee_name,' ',asu_enrollee.enrollee_patronymic) enrollee
                    
                    FROM asu_academic_plan
                    INNER JOIN asu_groups
                        ON asu_academic_plan.academic_plan_id = asu_groups.group_ac_plan_id
                    INNER JOIN asu_enrollee
                        ON asu_groups.group_id = asu_enrollee.enrollee_group_id
                    WHERE asu_enrollee.enrollee_id = {$the_enrollee_id}
                    
                
            ";

$select_academic_plan_id = mysqli_query($connection, $query);

$row = mysqli_fetch_assoc($select_academic_plan_id);

$academic_plan_direction_id = $row['academic_plan_direction_id'];
$academic_plan_period = $row['academic_plan_period'];
$academic_plan_name = $row['academic_plan_name'];
$enrollee = $row['enrollee'];
$group_number = $row['group_number'];




if(isset($_POST['create_additional_discipline'])) {

        $additional_discipline_d_id = $_POST['additional_discipline_d_id'];
        $additional_discipline_ac_plan_id = $the_academic_plan_id;
        $additional_discipline_semester = $_POST['additional_discipline_semester'];
        $additional_discipline_courses = $_POST['additional_discipline_courses'];
        $additional_discipline_hour = $_POST['additional_discipline_hour'];
        $additional_discipline_hour_audience = $_POST['additional_discipline_hour_audience'];
        $additional_discipline_hour_independent = $_POST['additional_discipline_hour_independent'];
        $additional_discipline_hour_lecture = $_POST['additional_discipline_hour_lecture'];
        $additional_discipline_hour_practice = $_POST['additional_discipline_hour_practice'];
        $additional_discipline_hour_laboratory = $_POST['additional_discipline_hour_laboratory'];
        $additional_discipline_hour_courses = $_POST['additional_discipline_hour_courses'];
        $additional_discipline_control = $_POST['additional_discipline_control'];
        $additional_discipline_course_work = $_POST['additional_discipline_course_work'];
        
        if($_POST['additional_discipline_moodle_id'] != '') {
            $additional_discipline_moodle_id = $_POST['additional_discipline_moodle_id'];
            file_get_contents($prefixsdo."/my/insert_student_enrol.php?student_id={$the_enrollee_id}&course_id={$additional_discipline_moodle_id}");
        } else {
            $additional_discipline_moodle_id = 0;
        }
    
        $additional_discipline_enrollee_id = $the_enrollee_id;
        $additional_discipline_session = $_POST['additional_discipline_session'];

        $query = "INSERT INTO asu_additional_discipline(additional_discipline_d_id, additional_discipline_ac_plan_id, additional_discipline_moodle_id, additional_discipline_semester, additional_discipline_courses,additional_discipline_hour, additional_discipline_hour_audience, additional_discipline_hour_independent, additional_discipline_hour_lecture, additional_discipline_hour_practice, additional_discipline_hour_laboratory, additional_discipline_hour_courses, additional_discipline_control, additional_discipline_course_work, additional_discipline_enrollee_id, additional_discipline_session, additional_discipline_date) ";
    
        $query .= "VALUES({$additional_discipline_d_id}, {$additional_discipline_ac_plan_id}, {$additional_discipline_moodle_id}, '{$additional_discipline_semester}', '{$additional_discipline_courses}', '{$additional_discipline_hour}', '{$additional_discipline_hour_audience}', '{$additional_discipline_hour_independent}', '{$additional_discipline_hour_lecture}', '{$additional_discipline_hour_practice}', '{$additional_discipline_hour_laboratory}', '{$additional_discipline_hour_courses}', '{$additional_discipline_control}', '{$additional_discipline_course_work}', {$additional_discipline_enrollee_id}, {$additional_discipline_session}, now()) ";
    
        $create_additional_discipline = mysqli_query($connection,$query);
        
    
        if(!$create_additional_discipline) {
        
            die("QUERY FAILED " . mysqli_error($connection));
            echo "<br>";
        
        }
    
    
        $message = "<div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Дисциплина добавлена.</div>";
        
        header("refresh: 1; url=./enrollee.php?source=view_enrollee&e_id={$the_enrollee_id}");

}


?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-plus-circle text-muted" aria-hidden="true"></i> 
            &nbsp;Добавить дополнительную дисциплину
        </h1>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="./enrollee.php?source=view_enrollee&e_id=<?php echo $the_enrollee_id; ?>" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="well">
            <p><b>Студент:</b> <?php echo $enrollee; ?></p>
            <p><b>Группа:</b> <?php echo $group_number; ?></p>
            <p><b>Учебный план:</b> <?php echo $academic_plan_name; ?></p>
            <?php 
                $query = "SELECT * FROM asu_directions WHERE direction_id = {$academic_plan_direction_id}";
                $select_directions_id = mysqli_query($connection,$query);

                while($row = mysqli_fetch_assoc($select_directions_id)) {

                    $direction_code = $row['direction_code'];
                    $direction_title = $row['direction_title'];

                    echo "<p><b>Направление:</b>&nbsp;{$direction_code}&nbsp;{$direction_title}</p>";

                }


                $query = "SELECT * FROM asu_basic_education WHERE basic_education_id = {$academic_plan_basic_education_id}";
                $select_basic_education_id = mysqli_query($connection,$query);

                while($row = mysqli_fetch_assoc($select_basic_education_id)) {

                    $basic_education_title = $row['basic_education_title'];

                    echo "<p><b>Базовое образование:</b>&nbsp;{$basic_education_title}</p>";
                }

                echo "<p><b>Срок обучения:</b>&nbsp;{$academic_plan_period}";
            ?>
        </div>
    </div>
</div>

<?php echo $message; ?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
 
        <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
           
           <div class="form-group">
                
                <div class="col-sm-12">
                    <label for="additional_discipline_moodle_id">
                        Дисциплина Moodle 
                    </label>

                    <select name="additional_discipline_moodle_id" class="form-control">
                        <option value=''>Выбрать . . . </option>
                    <?php

                        $query = "SELECT * FROM clg_course ORDER BY fullname";
                        $select_all_course = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_all_course)) {

                            $id = $row['id'];
                            $fullname = $row['fullname'];

                            echo "<option value='{$id}'>{$fullname}</option>";
                        }

                    ?>
                    </select>

                </div>
            </div>
           
           
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="additional_discipline_discipline_d_id">
                        Дисциплина&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>

                    <select name="additional_discipline_d_id" class="form-control" required>
                        <option value=''>Выбрать . . . </option>
                    <?php

                        $query = "SELECT * FROM asu_disciplines ORDER BY discipline_title ";
                        $select_all_disciplines = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_all_disciplines)) {

                            $discipline_id = $row['discipline_id'];
                            $discipline_title = $row['discipline_title'];

                            echo "<option value='$discipline_id'>{$discipline_title}</option>";
                        }

                    ?>
                    </select>

                </div>
            </div>
            
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="additional_discipline_session">
                        Период обучения&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>

                    <select name="additional_discipline_session" class="form-control" required>
                        <option value=''>Выбрать . . . </option>
                        <?php selectSessionForList (); ?>
                    </select>

                </div>
            </div>
            
            <div class="form-group">
                <div class="col-sm-2">
                    <label for="additional_discipline_semester">
                        Семестр&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_semester" required>
                </div>
                
                <div class="col-sm-2">
                    <label for="additional_discipline_courses">
                        Курс&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_courses" required>
                </div>
                
                <div class="col-sm-2">
                    <label for="content_discipline_hour">
                        Часы&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_hour" required>
                </div>
                
                <div class="col-sm-2">
                    <label for="additional_discipline_hour_audience">
                        Аудит. часы&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_hour_audience" required>
                </div>
                
                <div class="col-sm-2">
                    <label for="additional_discipline_hour_independent">
                        Сам. часы&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_hour_independent" required>
                </div>
                
                <div class="col-sm-2">
                    <label for="additional_discipline_hour_lecture">
                        Лек. часы&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_hour_lecture" required>
                </div>
 
            </div>
            <div class="form-group">
                <div class="col-sm-2">
                    <label for="additional_discipline_hour_practice">
                        Практ. часы&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_hour_practice" required>
                </div>
                
                <div class="col-sm-2">
                    <label for="additional_discipline_hour_laboratory">
                        Лаб. часы&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_hour_laboratory" required>
                </div>
                
                <div class="col-sm-2">
                    <label for="additional_discipline_hour_courses">
                       Курс. часы&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="additional_discipline_hour_courses" required>
                </div>
                
                <div class="col-sm-2">
                    <label for="additional_discipline_control">
                        Вид контроля&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <select name="additional_discipline_control" class="form-control" required>
                        <option value=''>Выбрать . . . </option>
                        <option value='Диф. зачёт'>Диф. зачёт</option>
                        <option value='Зачёт'>Зачёт</option>
                        <option value='Курсовая работа'>Курсовая работа</option>
                        <option value='Экзамен'>Экзамен</option>
                    </select>
                </div>
                <div class="col-sm-2">
                    <label for="additional_discipline_course_work">
                        Курсовая работа
                    </label>
                    <select name="additional_discipline_course_work" class="form-control">
                        <option value='Нет'>Нет</option>
                        <option value='Есть'>Есть</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-12">
                    <input class="btn btn-primary" type="submit" name="create_additional_discipline" value="Добавить">
                </div>
            </div>  

        </form>
  
    </div>
</div>


