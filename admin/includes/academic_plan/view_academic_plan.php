<?php

if(isset($_GET['a_id'])) {
    
    $the_academic_plan_id = $_GET['a_id'];
    
}

$query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$the_academic_plan_id} ";
$select_academic_plan_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_academic_plan_id)) {

    $academic_plan_direction_id = $row['academic_plan_direction_id'];
    $academic_plan_period = $row['academic_plan_period'];
    $academic_plan_organization_id = $row['academic_plan_organization_id'];
    $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
    $academic_plan_name = $row['academic_plan_name'];
    // $academic_count_semesters = $row['academic_count_semesters'];
    
}

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-graduation-cap text-muted" aria-hidden="true"></i> 
            &nbsp;Учебный план:&nbsp;<?php echo $academic_plan_name; ?>
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <?php 
            $query = "SELECT * FROM asu_directions WHERE direction_id = {$academic_plan_direction_id}";
            $select_directions_id = mysqli_query($connection,$query);

            while($row = mysqli_fetch_assoc($select_directions_id)) {

                $direction_code = $row['direction_code'];
                $direction_title = $row['direction_title'];

                echo "<p><b>Направление:</b>&nbsp;{$direction_code}&nbsp;{$direction_title}</p>";

            }
        
        
            $query = "SELECT * FROM asu_basic_education WHERE basic_education_id = {$academic_plan_basic_education_id}";
            $select_basic_education_id = mysqli_query($connection,$query);

            while($row = mysqli_fetch_assoc($select_basic_education_id)) {

                $basic_education_title = $row['basic_education_title'];

                echo "<p><b>Базовое образование:</b>&nbsp;{$basic_education_title}</p>";
            }
        
            echo "<p><b>Срок обучения:</b>&nbsp;{$academic_plan_period}";
        ?>

    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-group">
            <a href="academic_plan.php" class="btn btn-success">
                <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
            </a>
            <a class="btn btn-primary" href="./academic_plan.php?source=add_disciplines&a_id=<?php echo $the_academic_plan_id; ?>"><i class="fa fa-plus fa-fw" aria-hidden="true"></i>&nbsp; Добавить дисциплину</a>
        </div>
    </div>
</div>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <ul class="nav nav-tabs">
            <?php 

                for($i=1; $i <= $academic_plan_period; $i++) {
                    
                    if($i == 1) {
                        echo "<li class='active'><a href='#semester{$i}' data-toggle='tab'>Семестр № {$i}</a></li>";
                    } else {
                        echo "<li><a href='#semester{$i}' data-toggle='tab'>Семестр № {$i}</a></li>";
                    }
                    
                } 

            ?>
        </ul>
    </div>
</div>
<br>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

        <!-- Tab panes -->
        <div class="tab-content">
            <?php 
                for($i=1; $i <= $academic_plan_period; $i++) { 
                    if($i == 1) {
                        echo "<div class='tab-pane active' id='semester{$i}'>";
                    } else {
                        echo "<div class='tab-pane' id='semester{$i}'>";
                    }
            
            
            ?>
                    
                        
                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr class="active">
                                    <th>Дисциплина АСУ <small>(cеместр / cрок обучения)</small></th>
                                    <th>Дисциплина Moodle</th>
                                    <th>Семестр</th>
                                    <th>Курс</th>
                                    <th>Часы</th>
                                    <th>Аудит. часы</th>
                                    <th>Сам. часы</th>
                                    <th>Лек. часы</th>
                                    <th>Практ. часы</th>
                                    <th>Лаб. часы</th>
                                    <th>Курс. часы</th>
                                    <th>Курсовая работа</th>
                                    <th>Тип итогового контроля</th>
                                    <th class="text-center">ID</th>
                                    <th class="text-center">Редактировать</th>
                                    <th class="text-center">Удалить</th>
                                </tr>
                            </thead>
                            <tbody>

                               <?php

                                    //$query = "SELECT * FROM asu_content_discipline WHERE content_discipline_ac_plan_id = {$the_academic_plan_id} AND content_discipline_semester = {$i} ORDER BY content_discipline_d_id";

                                    $query = "
SELECT asu_content_discipline.*, asu_disciplines.discipline_title, asu_session.session_period, asu_session.session_time, clg_course.fullname
FROM asu_content_discipline
LEFT JOIN asu_disciplines ON asu_disciplines.discipline_id = asu_content_discipline.content_discipline_d_id
LEFT JOIN asu_session ON asu_session.session_id = asu_content_discipline.content_discipline_session
LEFT JOIN clg_course ON clg_course.id = asu_content_discipline.moodle_id
WHERE asu_content_discipline.content_discipline_ac_plan_id = {$the_academic_plan_id} AND asu_content_discipline.content_discipline_semester = {$i}
ORDER BY asu_content_discipline.content_discipline_d_id";
                                    $select_content_discipline_by_id = mysqli_query($connection, $query);

                                    while($row = mysqli_fetch_assoc($select_content_discipline_by_id)) {

                                        $content_discipline_id = $row['content_discipline_id'];
                                        $content_discipline_d_id = $row['content_discipline_d_id'];
                                        $content_discipline_session = $row['content_discipline_session'];
                                        $content_discipline_semester = $row['content_discipline_semester'];
                                        $content_discipline_courses = $row['content_discipline_courses'];
                                        $content_discipline_hour = $row['content_discipline_hour'];
                                        $content_discipline_hour_audience = $row['content_discipline_hour_audience'];
                                        $content_discipline_hour_independent = $row['content_discipline_hour_independent'];
                                        $content_discipline_hour_lecture = $row['content_discipline_hour_lecture'];
                                        $content_discipline_hour_practice = $row['content_discipline_hour_practice'];
                                        $content_discipline_hour_laboratory = $row['content_discipline_hour_laboratory'];
                                        $content_discipline_hour_courses = $row['content_discipline_hour_courses'];
                                        $content_discipline_course_work = $row['content_discipline_course_work'];
                                        $content_discipline_control = $row['content_discipline_control'];
                                        $moodle_id = $row['moodle_id'];
                                        $discipline_title = $row['discipline_title'];
                                        $session_period = $row['session_period'];
                                        $session_time = $row['session_time'];
                                        $fullname = $row['fullname'];

                                        echo "<tr>";

                                        $session = $session_period;
                                        $session .= " ";
                                        $session .= $session_time;
                                        
                                        if(isset($session_period)) {
                                            echo "<td>{$discipline_title} <span class='text-warning'>({$session})</span></td>";
                                        } else {
                                            echo "<td>{$discipline_title}</td>";
                                        }
                                        

                                        if($moodle_id == 0) {
                                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                        } else {
                                            echo "<td>{$fullname}</td>";
                                        }
                                        
                                        echo "<td>{$content_discipline_semester}</td>";
                                        echo "<td>{$content_discipline_courses}</td>";
                                        echo "<td>{$content_discipline_hour}</td>";
                                        echo "<td>{$content_discipline_hour_audience}</td>";
                                        echo "<td>{$content_discipline_hour_independent}</td>";
                                        echo "<td>{$content_discipline_hour_lecture}</td>";
                                        echo "<td>{$content_discipline_hour_practice}</td>";
                                        echo "<td>{$content_discipline_hour_laboratory}</td>";
                                        echo "<td>{$content_discipline_hour_courses}</td>";
                                        echo "<td>{$content_discipline_course_work}</td>";
                                        echo "<td>{$content_discipline_control}</td>";
                                        echo "<td class='text-center'>{$content_discipline_id}</td>";
                                        echo "<td class='text-center'>
                                                <a class='text-muted' href='academic_plan.php?source=edit_content_discipline&con_dis_id={$content_discipline_id}&a_id={$the_academic_plan_id}'>
                                                    <i class='fa fa-pencil-square-o' aria-hidden='true'>
                                                    </i>
                                                </a>
                                            </td>";
                                        echo "<td class='text-center'>
                                                <a class='text-danger' href='academic_plan.php?source=view_academic_plan&a_id={$the_academic_plan_id}&delete={$content_discipline_id}'>
                                                    <i class='fa fa-trash' aria-hidden='true'></i>
                                                </a>
                                            </td>";
                                        echo "</tr>";

                                    } 

                                ?>
                            </tbody>
                        </table>
                    
                    
                        
            <?php echo "</div>"; } ?>

        </div>
    </div>
</div>
<br>





<?php

if(isset($_GET['delete'])) {
    
    $the_content_discipline_id = $_GET['delete'];
    
    $query = "DELETE FROM asu_content_discipline WHERE content_discipline_id = {$the_content_discipline_id} ";
    
    $delete_query = mysqli_query($connection, $query);
    
    header("Location: ./academic_plan.php?source=view_academic_plan&a_id={$the_academic_plan_id}");
    
}

?>

