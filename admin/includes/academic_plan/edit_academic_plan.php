<?php

if(isset($_GET['a_id'])) {
    
    $the_academic_plan_id = $_GET['a_id'];
    
}


$query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$the_academic_plan_id} ";
$select_academic_plan_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_academic_plan_id)) {

    $academic_plan_direction_id = $row['academic_plan_direction_id'];
    $academic_plan_period = $row['academic_plan_period'];
    $academic_plan_organization_id = $row['academic_plan_organization_id'];
    $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
    $academic_plan_name = $row['academic_plan_name'];
    $academic_plan_qualification_id = $row['academic_plan_qualification_id'];
    
 
    if(isset($_POST['update_academic_plan'])) {
       
        $academic_plan_direction_id = $_POST['academic_plan_direction_id'];
        $academic_plan_period = $_POST['academic_plan_period'];
        $academic_plan_organization_id = $_POST['academic_plan_organization_id'];
        $academic_plan_basic_education_id = $_POST['academic_plan_basic_education_id'];
        $academic_plan_name = $_POST['academic_plan_name'];
        $academic_plan_qualification_id = $_POST['academic_plan_qualification_id'];
        
        $query = "UPDATE asu_academic_plan SET ";
        $query .= "academic_plan_direction_id = {$academic_plan_direction_id}, ";
        $query .= "academic_plan_period = '{$academic_plan_period}', ";
        $query .= "academic_plan_organization_id = {$academic_plan_organization_id}, ";
        $query .= "academic_plan_basic_education_id = {$academic_plan_basic_education_id}, ";
        $query .= "academic_plan_name = '{$academic_plan_name}', ";
        $query .= "academic_plan_qualification_id = '{$academic_plan_qualification_id}' ";
        $query .= "WHERE academic_plan_id = {$the_academic_plan_id} ";
        
        $update_academic_plan = mysqli_query($connection,$query);
        
        if(!$update_academic_plan) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }
        
        $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";
        
        header("refresh: 1; url=./academic_plan.php");
        
       
    }
    
    
}


?>


<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-id-card-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Форма создания учебного плана
        </h1>
    </div>
</div>  
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="./academic_plan.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div> 
<br>
<?php echo $message; ?>

<div class="row">
    <div class="col-xs-6 col-sm-6 col-md-12 col-lg-12">
        <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
        <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_name">
                        Название&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="academic_plan_name" value="<?php echo $academic_plan_name; ?>" required>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_direction_id">
                        Направление подготовки&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>

                    <select name="academic_plan_direction_id" class="form-control" required>

                    <?php

                        $query =    " SELECT 
                                        direction_id,
                                        CONCAT(direction_code,' ',direction_title) AS direction
                                        FROM asu_directions 
                                        WHERE direction_id = {$academic_plan_direction_id}
                                    ";
                        $select_direction_by_id = mysqli_query($connection,$query);
                        $row = mysqli_fetch_assoc($select_direction_by_id);

                        $direction_id = $row['direction_id'];
                        $direction = $row['direction'];

                        echo "<option value='{$direction_id}'>{$direction}</option>";


                        $query =    " SELECT 
                                        direction_id,
                                        CONCAT(direction_code,' ',direction_title) AS direction
                                        FROM asu_directions 
                                        WHERE direction_id != {$direction_id}
                                    ";
                        $select_directions = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_directions)) {

                            $direction_id = $row['direction_id'];
                            $direction = $row['direction'];

                            echo "<option value='$direction_id'>{$direction}</option>";

                        }

                    ?>
                    </select>

                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-12">

                    <label for="academic_plan_period">
                        Срок обучения (семестры)&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <select name="academic_plan_period" class="form-control" required>
                        <option value="<?php echo $academic_plan_period; ?>"><?php echo $academic_plan_period; ?></option>
                        <?php

                            $query = "SELECT semester_id FROM asu_semesters WHERE semester_id != {$academic_plan_period}";
                            $select_semesters = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_semesters)) {

                                $semester_id = $row['semester_id'];

                                echo "<option value='{$semester_id}'>{$semester_id}</option>";

                            }

                        ?>
                    </select>



                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_organization_id">
                        Образовательное учреждение&nbsp;
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <select name="academic_plan_organization_id" class="form-control" required>

                    <?php

                        $query =    " SELECT
                                        organization_id,
                                        organization_title 
                                        FROM asu_organizations 
                                        WHERE organization_id = {$academic_plan_organization_id}
                                    ";

                        $select_organization_by_id = mysqli_query($connection,$query);
                        $row = mysqli_fetch_assoc($select_organization_by_id);

                        $organization_id = $row['organization_id'];
                        $organization_title = $row['organization_title'];

                        echo "<option value='$organization_id'>{$organization_title}</option>";


                        $query =    " SELECT 
                                        organization_id,
                                        organization_title  
                                        FROM asu_organizations
                                        WHERE organization_id != {$organization_id}
                                    ";

                        $select_organizations = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_organizations)) {

                            $organization_id = $row['organization_id'];
                            $organization_title = $row['organization_title'];

                            echo "<option value='$organization_id'>{$organization_title}</option>";

                        }

                    ?>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_basic_education_id">
                        Базовое образование&nbsp;
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>

                    <select name="academic_plan_basic_education_id" class="form-control" id=" " required>

                    <?php

                        $query = "SELECT * FROM asu_basic_education WHERE basic_education_id = {$academic_plan_basic_education_id}";
                        $select_basic_education_id = mysqli_query($connection,$query);

                        $row = mysqli_fetch_assoc($select_basic_education_id);

                        $basic_education_id = $row['basic_education_id'];
                        $basic_education_title = $row['basic_education_title'];

                        echo "<option value='$basic_education_id'>{$basic_education_title}</option>";


                        $query = "SELECT * FROM asu_basic_education WHERE basic_education_id != {$basic_education_id}";
                        $select_basic_education = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_basic_education)) {

                            $basic_education_id = $row['basic_education_id'];
                            $basic_education_title = $row['basic_education_title'];

                            echo "<option value='$basic_education_id'>{$basic_education_title}</option>";

                        }

                    ?>
                    </select>

                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_qualification_id">Квалификация&nbsp;
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <select name="academic_plan_qualification_id" id="" class="form-control" required>

                        <?php

                            $query = "SELECT * FROM asu_qualification WHERE qualification_id = {$academic_plan_qualification_id}";
                            $select_qualification_by_id = mysqli_query($connection,$query);

                            $row = mysqli_fetch_assoc($select_qualification_by_id);
                            $qualification_id = $row['qualification_id'];
                            $qualificati_name = $row['qualification_name'];

                            echo "<option value='{$qualification_id}'>{$qualificati_name}</option>";


                            $query = "SELECT * FROM asu_qualification WHERE qualification_id != {$qualification_id}";
                            $select_all_qualification = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_all_qualification)) {

                                $qualification_id = $row['qualification_id'];
                                $qualificati_name = $row['qualification_name'];

                                echo "<option value='{$qualification_id}'>{$qualificati_name}</option>";

                            }

                        ?>

                    </select>
                </div>
            </div>


            <div class="form-group">
                <div class="col-sm-12">
                    <div class="page-header"></div>
                    <input class="btn btn-primary" type="submit" name="update_academic_plan" value="Сохранить">
                </div>
            </div>  

        </form> 
    </div>
</div>


   
   
