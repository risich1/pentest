<?php

if(isset($_GET['a_id'])) {
    
    $the_academic_plan_id = $_GET['a_id'];
    
}

$query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$the_academic_plan_id} ";
$select_academic_plan_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_academic_plan_id)) {

    $academic_plan_name = $row['academic_plan_name'];
    $academic_plan_direction_id = $row['academic_plan_direction_id'];
    $academic_plan_period = $row['academic_plan_period'];
    $academic_plan_organization_id = $row['academic_plan_organization_id'];
    $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
    $academic_plan_qualification_id = $row['academic_plan_qualification_id'];
    
}


if(isset($_POST['copy_academic_plan'])) {
    
    $academic_plan_name = $_POST['academic_plan_name'];
    $academic_plan_direction_id = $_POST['academic_plan_direction_id'];
    $academic_plan_period = $_POST['academic_plan_period'];
    $academic_plan_organization_id = $_POST['academic_plan_organization_id'];
    $academic_plan_basic_education_id = $_POST['academic_plan_basic_education_id'];
    $academic_plan_qualification_id = $_POST['academic_plan_qualification_id'];
    
    $query = "INSERT INTO asu_academic_plan(academic_plan_name, academic_plan_direction_id, academic_plan_period, academic_plan_organization_id, academic_plan_basic_education_id,  academic_plan_qualification_id, academic_plan_date) ";
    
    $query .= "VALUES('{$academic_plan_name}', {$academic_plan_direction_id}, '{$academic_plan_period}', {$academic_plan_organization_id}, {$academic_plan_basic_education_id}, {$academic_plan_qualification_id}, now()) ";

    $create_academic_plan_query = mysqli_query($connection,$query);

    if(!$create_academic_plan_query) {

        die("QUERY FAILED ." . mysqli_error($connection));
        
    }
    
    $query = "SELECT max(academic_plan_id) AS max_academic_plan_id FROM asu_academic_plan";
    $get_max_academic_plan_id = mysqli_query($connection,$query);
    $get = mysqli_fetch_assoc($get_max_academic_plan_id);
    
    $max_academic_plan_id = $get['max_academic_plan_id'];
        
    $query = "SELECT * FROM asu_content_discipline WHERE content_discipline_ac_plan_id = {$the_academic_plan_id}";
    
    $select_content_discipline_by_id = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_content_discipline_by_id)) {

        $content_discipline_d_id = $row['content_discipline_d_id'];
        $content_discipline_ac_plan_id = $max_academic_plan_id;
        
        $content_discipline_semester = $row['content_discipline_semester'];
        $content_discipline_courses = $row['content_discipline_courses'];
        $content_discipline_hour = $row['content_discipline_hour'];
        $content_discipline_hour_audience = $row['content_discipline_hour_audience'];
        $content_discipline_hour_independent = $row['content_discipline_hour_independent'];
        $content_discipline_hour_lecture = $row['content_discipline_hour_lecture'];
        $content_discipline_hour_practice = $row['content_discipline_hour_practice'];
        $content_discipline_hour_laboratory = $row['content_discipline_hour_laboratory'];
        $content_discipline_hour_courses = $row['content_discipline_hour_courses'];
        $content_discipline_control = $row['content_discipline_control'];
        $content_discipline_course_work = $row['content_discipline_course_work'];
        $content_discipline_session = $row['content_discipline_session'];
        
        $query = "INSERT INTO asu_content_discipline(content_discipline_d_id, content_discipline_ac_plan_id, content_discipline_semester, content_discipline_courses, content_discipline_hour, content_discipline_hour_audience, content_discipline_hour_independent, content_discipline_hour_lecture, content_discipline_hour_practice, content_discipline_hour_laboratory, content_discipline_hour_courses, content_discipline_control, content_discipline_course_work, content_discipline_session, content_discipline_date) ";
    
        $query .= "VALUES({$content_discipline_d_id}, {$content_discipline_ac_plan_id}, '{$content_discipline_semester}', '{$content_discipline_courses}', '{$content_discipline_hour}', '{$content_discipline_hour_audience}', '{$content_discipline_hour_independent}', '{$content_discipline_hour_lecture}', '{$content_discipline_hour_practice}', '{$content_discipline_hour_laboratory}', '{$content_discipline_hour_courses}', '{$content_discipline_control}', '{$content_discipline_course_work}', {$content_discipline_session}, now()) ";
    
        $create_content_discipline = mysqli_query($connection,$query);
        
        if(!$create_content_discipline) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }

    
    }
    
    
}

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-graduation-cap text-muted" aria-hidden="true"></i> 
            &nbsp;Скопировать учебный план:&nbsp;<?php echo $academic_plan_name; ?>
        </h1>
    </div>
</div>

<!--
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <?php 
//            $query = "SELECT * FROM asu_directions WHERE direction_id = {$academic_plan_direction_id}";
//            $select_directions_id = mysqli_query($connection,$query);
//
//            while($row = mysqli_fetch_assoc($select_directions_id)) {
//
//                $direction_code = $row['direction_code'];
//                $direction_title = $row['direction_title'];
//
//                echo "<p><b>Направление:</b>&nbsp;{$direction_code}&nbsp;{$direction_title}</p>";
//
//            }
//        
//        
//            $query = "SELECT * FROM asu_basic_education WHERE basic_education_id = {$academic_plan_basic_education_id}";
//            $select_basic_education_id = mysqli_query($connection,$query);
//
//            while($row = mysqli_fetch_assoc($select_basic_education_id)) {
//
//                $basic_education_title = $row['basic_education_title'];
//
//                echo "<p><b>Базовое образование:</b>&nbsp;{$basic_education_title}</p>";
//            }
//        
//            echo "<p><b>Срок обучения:</b>&nbsp;{$academic_plan_period}";
        ?>

    </div>
</div>
-->
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-group">
            <a href="academic_plan.php" class="btn btn-success">
                <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
            </a>
        </div>
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
        <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_name">
                        Название&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <input type="text" class="form-control" name="academic_plan_name" placeholder="Введите название учебного плана" required>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_direction_id">
                        Направление подготовки&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>

                    <select name="academic_plan_direction_id" class="form-control" required>
                    <?php

                        $query = "SELECT * FROM asu_directions";
                        $select_directions = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_directions)) {

                            $direction_id = $row['direction_id'];
                            $direction_code = $row['direction_code'];
                            $direction_title = $row['direction_title'];
                            
                            if($academic_plan_direction_id == $direction_id) {
                                echo "<option value='$direction_id' selected>{$direction_code}&nbsp;{$direction_title}</option>";
                            } else {
                                echo "<option value='$direction_id'>{$direction_code}&nbsp;{$direction_title}</option>";
                            }
                            

                        }

                    ?>
                    </select>

                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_period">
                        Срок обучения (семестры)&nbsp; 
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <select name="academic_plan_period" class="form-control" required>
                        <?php

                            $query = "SELECT * FROM asu_semesters";
                            $select_semesters = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_semesters)) {

                                $semester_id = $row['semester_id'];
                                
                                if($academic_plan_period == $semester_id) {
                                    echo "<option value='{$semester_id}' selected>{$semester_id}</option>"; 
                                } else {
                                    echo "<option value='{$semester_id}'>{$semester_id}</option>";
                                }
                                

                            }

                        ?>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_organization_id">
                        Образовательное учреждение&nbsp;
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <select name="academic_plan_organization_id" class="form-control" required>
                    <?php

                        $query = "SELECT * FROM asu_organizations";
                        $select_organizations = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_organizations)) {

                            $organization_id = $row['organization_id'];
                            $organization_title = $row['organization_title'];
                            
                            if ($academic_plan_organization_id == $organization_id) {
                                echo "<option value='$organization_id' selected>{$organization_title}</option>"; 
                            } else {
                                echo "<option value='$organization_id'>{$organization_title}</option>"; 
                            }

                        }

                    ?>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_basic_education_id">
                        Базовое образование&nbsp;
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>

                    <select name="academic_plan_basic_education_id" class="form-control" id=" " required>
                    <?php

                        $query = "SELECT * FROM asu_basic_education";
                        $select_basic_education = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_basic_education)) {

                            $basic_education_id = $row['basic_education_id'];
                            $basic_education_title = $row['basic_education_title'];
                            
                            if ($academic_plan_basic_education_id == $basic_education_id) {
                                echo "<option value='$basic_education_id' selected>{$basic_education_title}</option>";
                            } else {
                                echo "<option value='$basic_education_id'>{$basic_education_title}</option>";
                            }
                            

                        }

                    ?>
                    </select>

                </div>
            </div>
            
            <div class="form-group">
                <div class="col-sm-12">
                    <label for="academic_plan_qualification_id">Квалификация&nbsp;
                        <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
                    </label>
                    <select name="academic_plan_qualification_id" id="" class="form-control" required>
                        <option value="">Выбрать . . . </option>
                        <?php

                            $query = "SELECT * FROM asu_qualification";
                            $select_all_qualification = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_all_qualification)) {

                                $qualification_id = $row['qualification_id'];
                                $qualificati_name = $row['qualification_name'];
                                
                                if ($academic_plan_qualification_id == $qualification_id) {
                                    echo "<option value='{$qualification_id}' selected>{$qualificati_name}</option>";   
                                } else {
                                    echo "<option value='{$qualification_id}'>{$qualificati_name}</option>";    
                                }

                            }

                        ?>

                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <div class="col-sm-12">
                    <div class="page-header"></div>
                    <input class="btn btn-primary" type="submit" name="copy_academic_plan" value="Сохранить">
                </div>
            </div>  

        </form>
    </div>
</div>


<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <ul class="nav nav-tabs">
            <?php 

                for($i=1; $i <= $academic_plan_period; $i++) {
                    
                    if($i == 1) {
                        echo "<li class='active'><a href='#semester{$i}' data-toggle='tab'>Семестр № {$i}</a></li>";
                    } else {
                        echo "<li><a href='#semester{$i}' data-toggle='tab'>Семестр № {$i}</a></li>";
                    }
                    
                } 

            ?>
        </ul>
    </div>
</div>
<br>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

        <!-- Tab panes -->
        <div class="tab-content">
            <?php 
                for($i=1; $i <= $academic_plan_period; $i++) { 
                    if($i == 1) {
                        echo "<div class='tab-pane active' id='semester{$i}'>";
                    } else {
                        echo "<div class='tab-pane' id='semester{$i}'>";
                    }
            
            
            ?>
                    
                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr class="active">
                                    <th>Дисциплина АСУ <small>(период обучения)</small></th>
                                    <th>Семестр</th>
                                    <th>Курс</th>
                                    <th>Часы</th>
                                    <th>Аудит. часы</th>
                                    <th>Сам. часы</th>
                                    <th>Лек. часы</th>
                                    <th>Практ. часы</th>
                                    <th>Лаб. часы</th>
                                    <th>Курс. часы</th>
                                    <th>Курсовая работа</th>
                                    <th>Тип итогового контроля</th>
                                    <th class="text-center">ID</th>

                                </tr>
                            </thead>
                            <tbody>

                               <?php

                                    $query = "SELECT * FROM asu_content_discipline WHERE content_discipline_ac_plan_id = {$the_academic_plan_id} AND content_discipline_semester = {$i} ORDER BY content_discipline_d_id";
                                    $select_content_discipline_by_id = mysqli_query($connection, $query);

                                    while($row = mysqli_fetch_assoc($select_content_discipline_by_id)) {

                                        $content_discipline_id = $row['content_discipline_id'];
                                        $content_discipline_d_id = $row['content_discipline_d_id'];
                                        $content_discipline_session = $row['content_discipline_session'];
                                        $content_discipline_semester = $row['content_discipline_semester'];
                                        $content_discipline_courses = $row['content_discipline_courses'];
                                        $content_discipline_hour = $row['content_discipline_hour'];
                                        $content_discipline_hour_audience = $row['content_discipline_hour_audience'];
                                        $content_discipline_hour_independent = $row['content_discipline_hour_independent'];
                                        $content_discipline_hour_lecture = $row['content_discipline_hour_lecture'];
                                        $content_discipline_hour_practice = $row['content_discipline_hour_practice'];
                                        $content_discipline_hour_laboratory = $row['content_discipline_hour_laboratory'];
                                        $content_discipline_hour_courses = $row['content_discipline_hour_courses'];
                                        $content_discipline_course_work = $row['content_discipline_course_work'];
                                        $content_discipline_control = $row['content_discipline_control'];

                                        echo "<tr>";

                                        $query = "SELECT * FROM  asu_disciplines WHERE discipline_id = {$content_discipline_d_id} ";
                                        $select_discipline_by_id = mysqli_query($connection, $query);

                                        $row = mysqli_fetch_assoc($select_discipline_by_id);

                                        $discipline_title = $row['discipline_title'];
                                        
                                        $query = "SELECT session_period, session_time FROM asu_session WHERE session_id = {$content_discipline_session} ";
                                        $select_session_by_id = mysqli_query($connection, $query);
                                        
                                        $row = mysqli_fetch_assoc($select_session_by_id);
                                        
                                        $session_period = $row['session_period'];
                                        $session_time = $row['session_time'];
                                        $session = $session_period;
                                        $session .= " ";
                                        $session .= $session_time;
                                        
                                        if(isset($session_period)) {
                                            echo "<td>{$discipline_title} <span class='text-warning'>({$session})</span></td>";
                                        } else {
                                            echo "<td>{$discipline_title}</td>";
                                        }
                                        
//
//                                        if($moodle_id == 0) {
//                                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
//                                        } else {
//
//                                            $query = "SELECT fullname FROM clg_course WHERE id = {$moodle_id}";
//                                            $select_fullname_by_id = mysqli_query($connection,$query);
//
//                                            $row = mysqli_fetch_assoc($select_fullname_by_id);
//                                            $fullname = $row['fullname'];
//
//                                            echo "<td>{$fullname}</td>";
//                                        }
                                        
                                        echo "<td>{$content_discipline_semester}</td>";
                                        echo "<td>{$content_discipline_courses}</td>";
                                        echo "<td>{$content_discipline_hour}</td>";
                                        echo "<td>{$content_discipline_hour_audience}</td>";
                                        echo "<td>{$content_discipline_hour_independent}</td>";
                                        echo "<td>{$content_discipline_hour_lecture}</td>";
                                        echo "<td>{$content_discipline_hour_practice}</td>";
                                        echo "<td>{$content_discipline_hour_laboratory}</td>";
                                        echo "<td>{$content_discipline_hour_courses}</td>";
                                        echo "<td>{$content_discipline_course_work}</td>";
                                        echo "<td>{$content_discipline_control}</td>";
                                        echo "<td class='text-center'>{$content_discipline_id}</td>";
                                        echo "</tr>";

                                    } 

                                ?>
                            </tbody>
                        </table>
                    
                    
                        
            <?php echo "</div>"; } ?>

        </div>
    </div>
</div>
<br>





<?php

if(isset($_GET['delete'])) {
    
    $the_content_discipline_id = $_GET['delete'];
    
    $query = "DELETE FROM asu_content_discipline WHERE content_discipline_id = {$the_content_discipline_id} ";
    
    $delete_query = mysqli_query($connection, $query);
    
    header("Location: ./academic_plan.php?source=view_academic_plan&a_id={$the_academic_plan_id}");
    
}

?>

