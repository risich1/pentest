
<?php

    if(isset($_POST['submit'])) {

        $enrollee_surname = $_POST['enrollee_surname'];
        $enrollee_region_id = $_POST['enrollee_region_id'];

        
        if($enrollee_region_id) {
            $query = "SELECT * FROM asu_enrollee WHERE enrollee_surname LIKE '%$enrollee_surname%' AND enrollee_region_id = {$enrollee_region_id} AND enrollee_status = 'Архив'";
        } else {
            $query = "SELECT * FROM asu_enrollee WHERE enrollee_surname LIKE '%$enrollee_surname%' AND enrollee_status = 'Архив'";
            
        }


        $select_all_enrollee = mysqli_query($connection, $query);
        $count = mysqli_num_rows($select_all_enrollee);
        
        if(!$select_all_enrollee) {
            
            die("QUERY FAILED" . mysqli_error($connection));

        }

        if($count == 0) {

            $message = "<div class='alert alert-success'>По Вашему поисковому запросу ни чего не найдено.</div>";

        } else {
            $message = "<div class='alert alert-success'><b>Результат поиска</b>
                        <p>Найдено: {$count}</p></div>";
        }

        
    } else {

        $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'Архив' ";
        $select_all_enrollee = mysqli_query($connection, $query);

    }

    
            
?>    
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-address-book fa-fw text-muted" aria-hidden="true"></i>&nbsp;Архив личных дел
        </h1>
    </div>
</div>

<?php if($_SESSION['user_role_id'] == 1) { ?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <form class="form-horizontal well" action="" method="post">
        <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

            <h4><i class="fa fa-filter text-muted" aria-hidden="true"></i> Фильтр</h4>
            <div class="form-group">
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <input name="enrollee_surname" type="text" class="form-control" value="<?php echo isset($enrollee_surname) ? $enrollee_surname : '' ?>" placeholder="Фамилия">
                </div>
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <select name="enrollee_region_id" class="form-control" id="enrollee_region_id" value="<?php echo $enrollee_region_id; ?>">
                        
                            <?php
                                
                                if(isset($enrollee_region_id)) {
                                    
                                    $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                                    $select_region_by_id = mysqli_query($connection,$query);
                                    
                                    $row = mysqli_fetch_assoc($select_region_by_id);
                                    
                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    if($enrollee_region_id == '') {
                                        echo "<option value=''>Все . . . </option>";
                                    } else {

                                        echo "<option value='{$region_id}'>{$region_title}</option>";
                                        echo "<option value=''>Все . . . </option>";
                                    }

                                } else {
                                    echo "<option value=''>Выбрать регион . . . </option>";
                                }            
                                
                                if ($enrollee_region_id == '') {
                                    $query = "SELECT * FROM asu_region ORDER BY region_title ";
                                } else {
                                    $query = "SELECT * FROM asu_region WHERE region_id != {$enrollee_region_id} ORDER BY region_title ";
                                }
                               
                                $select_region = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_region)) {

                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    echo "<option value='{$region_id}'>{$region_title}</option>";

                                }

                            ?>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <input class="btn btn-primary" type="submit" name="submit" value="Найти">
                    <a class="btn btn-default" href="archiv.php">Сбросить</a>
                </div>
            </div> 
        </form>
    </div>
</div>

<?php echo isset($message) ? $message : ''; ?>
<?php } ?>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                           
        <table class="table table-hover table-bordered">
            <thead>
                <tr class="active">
                    <th>№</th>
                    <th>Фамилия</th>
                    <th>Имя</th>
                    <th>Отчество</th>
                    <th>Статус</th>
		    <?php
			if($_SESSION['user_role_id'] == 1) {
		    	    echo '<th>Вернуть</th>';
		        }
		    ?>
                    <th>Семестр</th>
                    <th>Регион</th>
                    <th>Логин в СДО</th>
                    <?php if($_SESSION['user_role_id'] == 1) {
                        echo "<th>Статус в СДО</th>";
                    }?>
                    <th class="text-center">ID</th>
                    <th class="text-center">Личное дело</th>
                    <th class="text-center">Редактировать</th>
                    <?php //if($_SESSION['user_role_id'] == 1) { ?>
<!--                        <th class="text-center">Удалить</th>-->
                    <?php //} ?>
                </tr>
            </thead>
            <tbody>

                <?php

                    if($_SESSION['user_role_id'] == 1) { 


                        } else {
                            if(isset($_SESSION['user_region_id'])) {

                                $user_region_id = $_SESSION['user_region_id'];

                                $query = "SELECT * FROM asu_enrollee WHERE enrollee_region_id = {$user_region_id} AND enrollee_status = 'Архив' ";
                                $select_all_enrollee = mysqli_query($connection, $query);
                            }
                        }
                    $num = 0;

                    while($row = mysqli_fetch_assoc($select_all_enrollee)) {
                        $enrollee_id = $row['enrollee_id'];
                        $moodle_id = $row['moodle_id'];
                        $enrollee_surname = $row['enrollee_surname'];
                        $enrollee_name = $row['enrollee_name'];
                        $enrollee_patronymic = $row['enrollee_patronymic'];
                        $enrollee_status = $row['enrollee_status'];
                        $current_sem = $row['current_sem'];
                        $enrollee_region_id = $row['enrollee_region_id'];

                        echo "<tr>";
                        echo "<td class='text-muted'>{$num}</td>";
                        echo "<td>{$enrollee_surname}</td>";
                        echo "<td>{$enrollee_name}</td>";
                        echo "<td>{$enrollee_patronymic}</td>";
                        echo "<td>{$enrollee_status}</td>";
			if($_SESSION['user_role_id'] == 1) {
				echo "<td><a class='text-primary' href='archiv.php?move={$enrollee_id}'><i class='fa fa-plus-circle' aria-hidden='true' title='Добавить студента в личные дела'></i></a></td>";
			}
                        echo "<td>{$current_sem}</td>";


                        $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                        $select_region_id = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_region_id)) {
                            $region_id = $row['region_id'];
                            $region_title = $row['region_title'];

                            echo "<td>{$region_title}</td>";
                        }
                        
                        if(!isset($moodle_id)) {

                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                        }
                        if($moodle_id)
                        {
                            $query = "SELECT * FROM clg_user WHERE id = {$moodle_id}";
                            $select_users_by_moodleid = mysqli_query($connection,$query);
                            while($row = mysqli_fetch_assoc($select_users_by_moodleid)) {
    
                                $username = $row['username'];
                                $suspended = $row['suspended'];
    
                                echo "<td class='text-center'>{$username}</td>";
                            }
                        }

                        if($_SESSION['user_role_id'] == 1) {
                            if($enrollee_status == 'Студент' && !isset($moodle_id)) {
                                echo "<td class='text-center'><a class='text-primary' href='personal_things.php?add_enrollee_inSDO={$enrollee_id}'><i class='fa fa-plus-circle' aria-hidden='true' title='Добавить пользователя в СДО'></i></a></td>";  
                            } elseif(isset($moodle_id)) {
                                
                                if($suspended == 1) {
                                    echo "<td class='text-center'><i class='fa fa-times-circle text-danger' aria-hidden='true' title='Пользователь заблокирован в СДО'></i></td>";
                                } else {
                                    echo "<td class='text-center'><i class='fa fa-check-circle text-success' aria-hidden='true' title='Пользователь создан в СДО'></i></td>";
                                }
                            } else {
                                echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                            }
                        }
                        
                        
                        
                        echo "<td class='text-center'>{$enrollee_id}</td>";
                        echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                        echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=edit_enrollee&e_id={$enrollee_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";

    //                        if($_SESSION['user_role_id'] == 1) {
    //                            echo "<td class='text-center'><a class='text-danger' href='personal_things.php?delete={$enrollee_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
    //                        }
                        echo "</tr>";

                    }

                ?>

            </tbody>
        </table>
    </div>
</div>

<?php

if(isset($_GET['move'])) {
    
    $the_enrollee_id = $_GET['move'];
    
    $query = "UPDATE asu_enrollee SET enrollee_status = 'Студент' WHERE enrollee_id = {$the_enrollee_id}";
    
    mysqli_query($connection, $query);
    
    header("Location: archiv.php");
    
}

?>