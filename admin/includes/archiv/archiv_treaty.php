<?php
	
    if(isset($_POST['search_all_treaty'])) {
        
        $payment_treaty_number = $_POST['search_treaty'];
        
        $surname = $_POST['search_surname'];
        $name = $_POST['search_name'];
        $patronymic = $_POST['search_patronymic'];
        
        if ($payment_treaty_number) {
            $query = "SELECT * FROM asu_treaty WHERE treaty_number = {$payment_treaty_number} AND treaty_status = 'Архив' ";
        }					
        else {
            $query = "SELECT * FROM asu_treaty WHERE 1 AND treaty_status = 'Архив'";
        }


        if ($surname || $name || $patronymic) {
            $get = "SELECT enrollee_id FROM asu_enrollee WHERE 1";
            if ($surname) {
                $get = $get." AND enrollee_surname='{$surname}'";						
            }
            if ($name) {
                $get = $get." AND enrollee_name='{$name}'";	
            }
            if ($patronymic) {
                $get = $get." AND enrollee_patronymic='{$patronymic}'";	
            }				
            //$get = "SELECT enrollee_id FROM asu_enrollee WHERE enrollee_surname='{$surname}' AND enrollee_name='{$name}' AND enrollee_patronymic='{$patronymic}'";
            $get_id=mysqli_query($connection, $get);

            $query = $query." AND (";

            while($row = mysqli_fetch_assoc($get_id)) {					
                $id = $row['enrollee_id'];
                $query = $query." treaty_enrollee_id={$id} OR ";
            }

            $query = $query."treaty_enrollee_id={$id})";
        }					

        $select_all_treaty = mysqli_query($connection, $query);

            $count = mysqli_num_rows($select_all_treaty);

            if($count == 0) {

                $message = "<div class='alert alert-success'>По Вашему поисковому запросу ни чего не найдено.</div>";

            } else {
                $message = "<div class='alert alert-success'><b>Результат поиска</b>
                            <p>Найдено: {$count}</p></div>";
            }

    } else {
        $query = "SELECT * FROM asu_treaty WHERE treaty_status = 'Архив'";
    }

?>
   

   
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h2 class="page-header"><i class="fa fa-handshake-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Архив договоров</h2>
    </div>
</div>
                     
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <form action="" class="form-horizontal well" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

                <h4><i class="fa fa-filter text-muted" aria-hidden="true"></i> Фильтр</h4>

                <div class="form-group">
                    
                    <div class="col-sm-3"> 
                        <label for="payment_create_date">Номер договора</label> 
                        <input type="text" name="search_treaty" class="form-control" value="<?php echo isset($payment_treaty_number) ? $payment_treaty_number : ''; ?>">                                       
                    </div>
                    <div class="col-sm-2">
                        <label for="payment_create_date">Фамилия</label>
                        <input type="text" name="search_surname" class="form-control" value="<?php echo isset($surname) ? $surname : ''; ?>">
                    </div>
                    <div class="col-sm-2">                              
                        <label for="payment_create_date">Имя</label>                                
                        <input type="text" name="search_name" class="form-control"  value="<?php echo isset($name) ? $name : ''; ?>">
                    </div>
                    <div class="col-sm-2">
                        <label for="payment_create_date">Отчество</label>                               
                        <input type="text" name="search_patronymic" class="form-control"  value="<?php echo isset($patronymic) ? $patronymic : ''; ?>"> 
                    </div>			
				</div>				


								
				<div class="form-group">
					<div class="col-sm-12">
						<input class="btn btn-primary" type="submit" name="search_all_treaty" value="Найти">
                        <a href="archiv.php?source=archiv_treaty" class="btn btn-primary">Сбросить</a>
						<!-- <a class="btn btn-default" href="payment.php?source=payment_schedule">Сбросить</a> -->
					</div>
				</div>      
            </form>
    </div>
</div>
<?php echo $message ?? ''; ?>
<br>                          
                           
<table class="table table-hover table-bordered">
<thead>
    <tr class="active">
        <th>№</th>
        <th>Номер</th>
        <th>Ф.И.О.</th>
        <th>План</th>
        <th>Стоимость, руб.</th>
        <th>Дата заключения</th>
        <th>Дата окончания</th>
        <th>Статус</th>
	<?php
	    if($_SESSION['user_role_id'] == 1) {
	        echo '<th>Вернуть</th>';
	    }
	?>
        <th class="text-center">ID</th>
        <th class="text-center">Договор</th>
        <th class="text-center">Редактировать</th>
<!--        <th class="text-center">Удалить</th>-->
    </tr>
</thead>
<tbody>

        <?php
    
            
            $select_all_treaty = mysqli_query($connection, $query);
            $number = 0;
            while($row = mysqli_fetch_assoc($select_all_treaty)) {
                
                $number++;
                $treaty_id = $row['treaty_id'];
                $treaty_enrollee_id = $row['treaty_enrollee_id'];
                $treaty_number = $row['treaty_number'];
                $treaty_date_conclusion = $row['treaty_date_conclusion'];
                $treaty_user = $row['treaty_user'] ?? '';
                $treaty_plan_id = $row['treaty_plan_id'];
                $treaty_cost = $row['treaty_cost'];
                $treaty_end_date = $row['treaty_end_date'];
                $treaty_status = $row['treaty_status'];
                
                $query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id}";
                $select_enrollee_id = mysqli_query($connection,$query); 
                
                while($row = mysqli_fetch_assoc($select_enrollee_id)) {
                    
                    $enrollee_surname = $row['enrollee_surname'];
                    $enrollee_name = $row['enrollee_name'];
                    $enrollee_patronymic = $row['enrollee_patronymic'];
                    $treaty_user = $enrollee_surname .' '.$enrollee_name.' '.$enrollee_patronymic; 
                }
                
                
                    echo "<tr>";
                    echo "<td>{$number}</td>";
                    echo "<td>{$treaty_number}</td>";
                    echo "<td><a href='enrollee.php?source=view_enrollee&e_id={$treaty_enrollee_id}'>{$treaty_user}</a></td>";
                
                
                    
                
                    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$treaty_plan_id} ";
                    $select_all_academic_plan = mysqli_query($connection,$query);

                    while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                    $academic_plan_name = $row['academic_plan_name'];
 
                        echo "<td>{$academic_plan_name}</td>";
                    
                    }
                
                    echo "<td>{$treaty_cost}</td>";
                    echo "<td>{$treaty_date_conclusion}</td>";
                    echo "<td>{$treaty_end_date}</td>";
                    echo "<td>{$treaty_status}</td>";
		    if($_SESSION['user_role_id'] == 1) {
		    	echo "<td><a class='text-primary' href='archiv.php?source=archiv_treaty&move_treaty={$treaty_enrollee_id}'><i class='fa fa-plus-circle' aria-hidden='true' title='Добавить в договора'></i></a></td>";
		    }
                    echo "<td>{$treaty_id}</td>";
        //                echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-search' aria-hidden='true'></i></a></td>";
                    echo "<td class='text-center'><a class='text-muted' href='treaty.php?source=view_treaty&treaty_id={$treaty_id}'><i class='fa fa-file-text' aria-hidden='true'></i></a></td>";
                    
                    if($treaty_status == 'Расторгнут') {
                        echo "<td class='text-center'><i class='fa fa-times text-muted' aria-hidden='true'></i></td>";
                    } else {
                        echo "<td class='text-center'><a class='text-muted' href='treaty.php?source=edit_treaty&treaty_id={$treaty_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";
                    }
//                    if($treaty_status == 'Расторгнут') {
//                        echo "<td class='text-center'><i class='fa fa-times text-muted' aria-hidden='true'></i></td>";
//                    } else {
//                        echo "<td class='text-center'><a class='text-danger' href='treaty.php?delete={$treaty_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
//                    }
                    echo "</tr>";

                }
        ?>


</tbody>
</table>


<?php
if(isset($_GET['move_treaty'])) {
    
    $the_enrollee_id = $_GET['move_treaty'];
    
    $query = "UPDATE asu_treaty SET treaty_status = 'Заключен' WHERE treaty_enrollee_id = {$the_enrollee_id}";
    
    mysqli_query($connection, $query);
    
    header("Location: archiv.php?source=archiv_treaty");
    
}
?>