<?php

if(isset($_POST['add_organization'])) {

    $organization_region_id = $_POST['organization_region_id'];
    $organization_title = $_POST['organization_title'];

    $query = "INSERT INTO asu_organizations(organization_region_id, organization_title, organization_date) ";
    $query .= "VALUE({$organization_region_id}, '{$organization_title}', now()) ";

    $create_organization = mysqli_query($connection, $query);

    if(!$create_organization) {

        die('QUERY FAILED' . mysqli_error($connection));

    }
}

?> 
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-university fa-fw text-muted" aria-hidden="true"></i>&nbsp;
            Организации осуществляющие образовательный процесс 
        </h1>
    </div>
</div>
   
<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
    <h4 class="text-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i> Добавить организацию</h4>
    <br>
    <form action="" method="post" enctype="multipart/form-data"> 
    <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

        <div class="form-group">
            <label for="organization_region_id">
                Регион&nbsp;
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            
            <select name="organization_region_id" class="form-control" id="organization_region_id" required>
                <option value="">Выбрать . . . </option>
                <?php

                    $query = "SELECT * FROM asu_region";
                    $select_region = mysqli_query($connection,$query);

                    while($row = mysqli_fetch_assoc($select_region)) {

                        $region_id = $row['region_id'];
                        $region_title = $row['region_title'];

                        echo "<option value='{$region_id}'>{$region_title}</option>";

                    }

                ?>
            </select>
        </div>   
           
        <div class="form-group">
            <label for="organization_title">
                Название&nbsp;
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" class="form-control" name="organization_title">
        </div>

        <div class="form-group">
            <input class="btn btn-primary" type="submit" name="add_organization" value="Добавить">
        </div>    
    </form>
    
    <?php 
    
        if(isset($_GET['edit'])) {
            
            include("../admin/includes/organization/update_organization.php");
            
        }  
    
    ?>

</div>
<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
    <table class="table table-hover table-bordered">
        <thead>
            <tr class="active">
                <th class="text-center">ID</th>
                <th>Название</th>
                <th>Регион</th>
                <th class="text-center">Редактировать</th>
                <th class="text-center">Удалить</th>
            </tr>
        </thead>

        <tbody>
            <?php
                $query = "SELECT * FROM asu_organizations";
                $select_all_organizations = mysqli_query($connection, $query);
                while($row = mysqli_fetch_assoc($select_all_organizations)) {				
                    $organization_id = $row['organization_id']; 
                    $organization_title = $row['organization_title'];
                    $organization_region_id = $row['organization_region_id'];
                    $organization_date = $row['organization_date'];

                    echo "<tr>";
                        echo "<td class='text-center'>{$organization_id}</td>";
                        echo "<td>{$organization_title}</td>";
                        
                        $query = "SELECT * FROM asu_region WHERE region_id = {$organization_region_id} ";
                        $select_region_id = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_region_id)) {

                        $region_title = $row['region_title'];

                        echo "<td>{$region_title}</td>";

                        }
                    
                        
                        echo "<td class='text-center'>
                            <a class='text-muted' href='organizations.php?edit={$organization_id}'>
                                <i class='fa fa-pencil-square-o' aria-hidden='true'>
                                </i>
                            </a>
                        </td>";
                        echo "<td class='text-center'>
                            <a class='text-danger' href='organizations.php?delete={$organization_id}'>
                                <i class='fa fa-trash' aria-hidden='true'>
                                </i>
                            </a>
                        </td>";
                    echo "</tr>";
                }	
            ?>
        </tbody>
    </table>
</div>

<?php
	if(isset($_GET['delete'])) {
		$the_organization_id = $_GET['delete'];
        $query = "DELETE FROM asu_organizations WHERE organization_id = {$the_organization_id} ";
        $delete_query = mysqli_query($connection, $query);
        header("Location: organizations.php");
    }
?>