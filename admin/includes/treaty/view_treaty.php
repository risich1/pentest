<?php
if(isset($_GET['treaty_id'])) {
    
    $the_treaty_id = $_GET['treaty_id'];
    
}


$query = "SELECT * FROM asu_treaty WHERE treaty_id = {$the_treaty_id} ";
$select_treaty_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_treaty_by_id)) {
    
    $treaty_id = $row['treaty_id'];
    $treaty_enrollee_id = $row['treaty_enrollee_id'];
    $treaty_number = $row['treaty_number'];
    $treaty_date_conclusion = $row['treaty_date_conclusion'];
    $treaty_dissolve_date = $row['treaty_dissolve_date'];
    $treaty_plan_id = $row{'treaty_plan_id'};
    $treaty_cost = $row['treaty_cost'];
    $treaty_end_date = $row['treaty_end_date'];
    $treaty_start_date = $row['treaty_start_date'];
    $treaty_status = $row['treaty_status'];
    
    $treaty_autumn_date_1 = $row['treaty_autumn_date_1'];
    $treaty_autumn_date_3 = $row['treaty_autumn_date_3'];
    $treaty_autumn_date_5 = $row['treaty_autumn_date_5'];
    $treaty_autumn_date_7 = $row['treaty_autumn_date_7'];
    $treaty_autumn_date_9 = $row['treaty_autumn_date_9'];
     
    $treaty_spring_date_2 = $row['treaty_spring_date_2'];
    $treaty_spring_date_4 = $row['treaty_spring_date_4'];
    $treaty_spring_date_6 = $row['treaty_spring_date_6'];
    $treaty_spring_date_8 = $row['treaty_spring_date_8'];

    $treaty_customer = $row['treaty_customer'];
    
    
    
    $query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id}";
    $select_enrollee_id = mysqli_query($connection,$query); 

    while($row = mysqli_fetch_assoc($select_enrollee_id)) {

        $enrollee_image = $row['enrollee_image'];
        $enrollee_surname = $row['enrollee_surname'];
        $enrollee_name = $row['enrollee_name'];
        $enrollee_patronymic = $row['enrollee_patronymic'];
        $enrollee_date_birth = $row['enrollee_date_birth'];
        $enrollee_sex = $row['enrollee_sex'];
        $enrollee_status = $row['enrollee_status'];
        $enrollee_region_id = $row['enrollee_region_id'];
         
    }
    
    $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
    $select_region_id = mysqli_query($connection,$query);

    while($row = mysqli_fetch_assoc($select_region_id)) {
    
        $region_title = $row['region_title'];
    
    }
    
    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$treaty_plan_id} ";
    $select_all_academic_plan = mysqli_query($connection,$query);

    while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

        $academic_plan_id = $row['academic_plan_id'];
        $academic_plan_name = $row['academic_plan_name'];
        $academic_plan_period = $row['academic_plan_period'];
        $academic_plan_direction_id = $row['academic_plan_direction_id'];
        $academic_plan_organization_id = $row['academic_plan_organization_id'];
        $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
        
                    
    }  
    
    $query = "SELECT * FROM asu_directions WHERE direction_id = {$academic_plan_direction_id}";
    $select_direction_id = mysqli_query($connection,$query);

    while($row = mysqli_fetch_assoc($select_direction_id)) {

        $direction_code = $row['direction_code'];
        $direction_title = $row['direction_title'];

    }
    
    $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";
    $select_organization_id = mysqli_query($connection,$query);

    while($row = mysqli_fetch_assoc($select_organization_id)) {

        $organization_title = $row['organization_title'];

    } 
}
                
if(isset($_POST['dissolve'])) {

    $treaty_dissolve_date = $_POST['treaty_dissolve_date'];

    $query = "UPDATE asu_treaty SET ";
    $query .= "treaty_dissolve_date = '{$treaty_dissolve_date}', ";
    $query .= "treaty_status = 'Расторгнут' ";

    $query .= "WHERE treaty_id = {$treaty_id} ";

    $update_treaty_status = mysqli_query($connection,$query);

    $query = "UPDATE asu_enrollee SET ";
    $query .= "enrollee_status = 'Договор расторгнут' ";
    $query .= "WHERE enrollee_id = {$treaty_enrollee_id} ";

    $update_enrollee_status = mysqli_query($connection,$query);

    
    header("Location: treaty.php?source=view_treaty&treaty_id={$treaty_id}");

}

?>
   

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h2 class="page-header"><i class="fa fa-file-text text-muted" aria-hidden="true"></i>&nbsp; 
         Договор от <?php echo $treaty_date_conclusion; ?> № <?php echo $treaty_number; ?>
         <?php 
            if($treaty_status == 'Расторгнут') {
                echo "<span class='label label-danger'>{$treaty_status}&nbsp;{$treaty_dissolve_date}</span>"; 
            }  
        ?>    
        </h2>
        
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-group">
            <?php 
                if($treaty_status != 'Расторгнут') { ?>
                    <a href="treaty.php" class="btn btn-success">
                        <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
                    </a>
                    <a class="btn btn-success" href="treaty.php?source=edit_treaty&treaty_id=<?php echo $treaty_id; ?>"><i class="fa fa-pencil-square-o fa-fw" aria-hidden="true"></i>&nbsp; Редактировать</a>
                    <a class="btn btn-success" href="<?php echo $siteprefix;?>/admin/includes/treaty_pdf.php?student_id=<?php echo $treaty_enrollee_id; ?>&treaty_customer=<?php echo $treaty_customer; ?>" target="_blank"> 
                       
                        <i class="fa fa-file-pdf-o" aria-hidden="true"></i>&nbsp; Создать PDF
                    </a>
                    <a class="btn btn-danger" data-toggle="modal" data-target="#modDissolve"><i class="fa fa-times fa-fw" aria-hidden="true"></i>&nbsp; Расторгнуть</a>
               <?php } else { ?>
                    <a href="treaty.php" class="btn btn-default">
                        <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
                    </a>
              <?php } ?>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-info-circle fa-fw" aria-hidden="true"></i>&nbsp;Личная информация</h3>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
        <?php
            if(!empty($enrollee_image)) {
                echo "<img class='img-thumbnail' src='images/{$enrollee_image}' width='150' alt='photo'>";   
            } else {
                echo "<img class='img-thumbnail' src='images/bg_photo.jpg' width='150' alt='photo'>";
            }
        ?>
        
    </div>
    <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9">
        <p><b>Фамилия: </b><?php echo $enrollee_surname; ?></p>
        <p><b>Имя: </b><?php echo $enrollee_name; ?></p>
        <p><b>Отчество: </b><?php echo $enrollee_patronymic; ?></p>
        <p><b>Дата рождения: </b><?php echo $enrollee_date_birth; ?></p>
        <p><b>Пол: </b><?php echo $enrollee_sex; ?></p>
        <p><b>Регион: </b><?php echo $region_title; ?></p>
        <p><b>Статус: </b><?php echo $enrollee_status; ?></p>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-graduation-cap fa-fw" aria-hidden="true"></i>&nbsp;Учебный план</h3>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <p><b>Название: </b><?php echo $academic_plan_name; ?></p>
        <p><b>Направление подготовки: </b><?php echo "{$direction_code}&nbsp;{$direction_title}"; ?></p>
        <p><b>Организация: </b><?php echo $organization_title; ?></p>
        <p><b>Количество семестров: </b><?php echo $academic_plan_period; ?> семестров</p>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-file-text fa-fw" aria-hidden="true"></i>&nbsp;Предмет договора</h3>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <p><b>Стоимость обучения за семестр:</b>&nbsp;<?php echo $treaty_cost; ?>&nbsp;руб.</p>
        <p><b>Начало обучения:</b>&nbsp;<?php echo $treaty_start_date; ?></p>
        <p><b>Окончание обучения:</b>&nbsp;<?php echo $treaty_end_date; ?></p>
    
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;График оплаты обучения</h3>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <table class="table table-hover table-bordered">
            <thead>
                <tr class="active">
                    <th class="text-center" colspan="2">Осень</th>
                    <th class="text-center" colspan="2">Весна</th>
                </tr>
                <tr class="active">
                    <th>Семестр</th>
                    <th>Дата</th>
                    <th>Семестр</th>
                    <th>Дата</th>
                </tr>
            </thead>
            <tbody>
               
               <?php
                
                    $query = "SELECT * FROM asu_treaty WHERE treaty_enrollee_id = {$treaty_enrollee_id}";
                    $select_all_treaty = mysqli_query($connection, $query);

                        while($row = mysqli_fetch_assoc($select_all_treaty)) {

                            $treaty_number = $row['treaty_number'];
                            $treaty_count_semesters = $row['treaty_count_semesters'];
                            $treaty_cost = $row['treaty_cost'];
                            $treaty_semester_id = $row['treaty_semester_id'];
                            $treaty_status = $row['treaty_status'];

                            $treaty_autumn_date_1 = $row['treaty_autumn_date_1'];
                            if($treaty_autumn_date_1 > '0000-00-00 00:00:00') {
                                $treaty_autumn_date_1 = date_create($treaty_autumn_date_1)->Format('d.m.Y');
                            }

                            $treaty_autumn_date_3 = $row['treaty_autumn_date_3'];
                            if($treaty_autumn_date_3 > '0000-00-00 00:00:00') {
                                $treaty_autumn_date_3 = date_create($treaty_autumn_date_3)->Format('d.m.Y');
                            }

                            $treaty_autumn_date_5 = $row['treaty_autumn_date_5'];
                            if($treaty_autumn_date_5 > '0000-00-00 00:00:00') {
                                $treaty_autumn_date_5 = date_create($treaty_autumn_date_5)->Format('d.m.Y');
                            }

                            $treaty_autumn_date_7 = $row['treaty_autumn_date_7'];
                            if($treaty_autumn_date_7 > '0000-00-00 00:00:00') {
                                $treaty_autumn_date_7 = date_create($treaty_autumn_date_7)->Format('d.m.Y');
                            }

                            $treaty_autumn_date_9 = $row['treaty_autumn_date_9'];
                            if($treaty_autumn_date_9 > '0000-00-00 00:00:00') {
                                $treaty_autumn_date_9 = date_create($treaty_autumn_date_9)->Format('d.m.Y');
                            }

                            $treaty_spring_date_2 = $row['treaty_spring_date_2'];
                            if($treaty_spring_date_2 > '0000-00-00 00:00:00') {
                                $treaty_spring_date_2 = date_create($treaty_spring_date_2)->Format('d.m.Y');
                            }

                            $treaty_spring_date_4 = $row['treaty_spring_date_4'];
                            if($treaty_spring_date_4 > '0000-00-00 00:00:00') {
                                $treaty_spring_date_4 = date_create($treaty_spring_date_4)->Format('d.m.Y');
                            }

                            $treaty_spring_date_6 = $row['treaty_spring_date_6'];
                            if($treaty_spring_date_6 > '0000-00-00 00:00:00') {
                                $treaty_spring_date_6 = date_create($treaty_spring_date_6)->Format('d.m.Y');
                            }

                            $treaty_spring_date_8 = $row['treaty_spring_date_8'];
                            if($treaty_spring_date_8 > '0000-00-00 00:00:00') {
                                $treaty_spring_date_8 = date_create($treaty_spring_date_8)->Format('d.m.Y');
                            }

                            for($i=1; $i <= $academic_plan_period; $i++) {

                                echo "<tr>";
                                if ($i % 2) { 


                                    $query = "SELECT * FROM asu_semesters WHERE semester_id = {$i} ";
                                    $select_semester_by_id = mysqli_query($connection, $query);

                                    while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                        $semester_title = $row['semester_title'];

                                        echo "<td>{$semester_title}</td>";
                                    }

                                    if(isset(${'treaty_autumn_date_'.$i})) {
                                        echo "<td>${'treaty_autumn_date_'.$i}</td>";
                                    } else {
                                        echo "<td>-</td>";
                                    }


                                    $j = $i+1;

                                    if ($academic_plan_period >= $j) {

                                        $query = "SELECT * FROM asu_semesters WHERE semester_id = {$j} ";
                                        $select_semester_by_id = mysqli_query($connection, $query);

                                        while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                        $semester_title = $row['semester_title'];

                                        echo "<td>{$semester_title}</td>";

                                        }

                                        if(isset(${'treaty_spring_date_'.$j})) {
                                            echo "<td>${'treaty_spring_date_'.$j}</td>";
                                        } else {
                                            echo "<td>-</td>";
                                        }  
                                    } else {
                                        echo "<td>-</td>";
                                        echo "<td>-</td>";
                                    }

                                } 

                                echo "</tr>";
                            }
                        }
                ?>    

            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-rub fa-fw" aria-hidden="true"></i>&nbsp;Оплата обучения</h3>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <table class="table table-hover table-bordered">
            <thead>
                <tr class="active">
                    <th>Вид оплаты</th>
                    <th>Номер документа</th>
                    <th>Сумма, руб.</th>
                    <th>Дата платежа</th>
                    <th>Номер договора</th>
                    <th>Дата заключения</th>
                    <th class="text-center">ID</th>
                    <th>Примечание</th>
                </tr>
            </thead>
            <tbody>
            
            <?php
                
            
                $query = "SELECT * FROM asu_payment WHERE payment_enrollee_id = {$treaty_enrollee_id} ";
                $select_payment_id = mysqli_query($connection, $query);

                while($row = mysqli_fetch_assoc($select_payment_id)) {

                    $payment_id = $row['payment_id'];
                    $payment_number = $row['payment_number'];
                    $payment_create_date = $row['payment_create_date'];
                    $payment_cost = $row['payment_cost'];
                    $payment_semester_id = $row['payment_semester_id'];
                    $payment_treaty_id = $row['payment_treaty_id'];
                    $payment_comment = $row['payment_comment'];


                        echo "<tr>";
                    
                        $query = "SELECT * FROM asu_semesters WHERE semester_id = {$payment_semester_id} ";
                        $select_semester_by_id = mysqli_query($connection, $query);

                        while($row = mysqli_fetch_assoc($select_semester_by_id)) {
                            
                            $semester_title = $row['semester_title'];
                            
                            echo "<td>{$semester_title}</td>";
                        }
                    
                        echo "<td>{$payment_number}</td>";
                        echo "<td>{$payment_cost}</td>";
                        echo "<td>{$payment_create_date}</td>";
                    
                        $query = "SELECT * FROM asu_treaty WHERE treaty_id = {$payment_treaty_id} ";
                        $select_treaty = mysqli_query($connection,$query);
                        
                        while($row = mysqli_fetch_assoc($select_treaty)) {
                            
                            $treaty_number = $row['treaty_number'];
                            $treaty_date_conclusion = $row['treaty_date_conclusion'];
                            
                            echo "<td>{$treaty_number}</td>";
                            echo "<td>{$treaty_date_conclusion}</td>";
                        }

                        echo "<td class='text-center'>{$payment_id}</td>";
                        echo "<td>{$payment_comment}</td>";
                        echo "</tr>";

                    }
            ?>

            </tbody>
        </table>
    
    </div>
</div>                          
                                                                              

<!-- Modal -->
<div class="modal fade" id="modDissolve" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Расторгнуть договор?</h4>
            </div>
            <div class="modal-body">
                            
                <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">  
                <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

                    <div class="form-group">
                        <div class="col-sm-6">
                            <label for="treaty_number">Дата расторжения</label>
                            <input class="form-control" type="date" name="treaty_dissolve_date">
                        </div>                
                    </div>
                    <div class="form-group">
                        <div class="col-sm-12">  
                            <input class="btn btn-primary" type="submit" name="dissolve" value="Да">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Нет</button>
                        </div>
                    </div> 
                </form>
            <div class="modal-footer">
                
<!--                <button type="button" class="btn btn-primary">Выбрать</button>-->
            </div>
        </div>
    </div>
</div>