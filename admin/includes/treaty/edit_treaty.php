<?php
    if(isset($_GET['treaty_id'])) {
        $the_treaty_id = $_GET['treaty_id'];
    }

    $query = "SELECT * FROM asu_treaty WHERE treaty_id = {$the_treaty_id} ";
    $select_treaty_by_id = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_treaty_by_id)) {
        $treaty_id = $row['treaty_id'];
        $treaty_enrollee_id = $row['treaty_enrollee_id'];
        $treaty_number = $row['treaty_number'];
        $treaty_date_conclusion = $row['treaty_date_conclusion'];
        $treaty_plan_id = $row['treaty_plan_id'];
        $treaty_cost = $row['treaty_cost'];
        $treaty_start_date = $row['treaty_start_date'];
        $treaty_end_date = $row['treaty_end_date'];
        $treaty_count_semesters = $row['treaty_count_semesters'];
    
        $treaty_autumn_date_1 = $row['treaty_autumn_date_1'];
        $treaty_autumn_date_3 = $row['treaty_autumn_date_3'];
        $treaty_autumn_date_5 = $row['treaty_autumn_date_5'];
        $treaty_autumn_date_7 = $row['treaty_autumn_date_7'];
        $treaty_autumn_date_9 = $row['treaty_autumn_date_9'];

        $treaty_spring_date_2 = $row['treaty_spring_date_2'];
        $treaty_spring_date_4 = $row['treaty_spring_date_4'];
        $treaty_spring_date_6 = $row['treaty_spring_date_6'];
        $treaty_spring_date_8 = $row['treaty_spring_date_8'];
    
        $treaty_customer = $row['treaty_customer'];
    
        if(isset($_POST['update_treaty'])) {
            $treaty_date_conclusion = $_POST['treaty_date_conclusion'];
            $treaty_plan_id = $_POST['treaty_plan_id'];
            $treaty_start_date = $_POST['treaty_start_date'];
            $treaty_cost = $_POST['treaty_cost'];
            $treaty_end_date = $_POST['treaty_end_date'];
            $treaty_autumn_date_1 = $_POST['treaty_autumn_date_1'];
            $treaty_autumn_date_3 = $_POST['treaty_autumn_date_3'];
            $treaty_autumn_date_5 = $_POST['treaty_autumn_date_5'];
            $treaty_autumn_date_7 = $_POST['treaty_autumn_date_7'];
            $treaty_autumn_date_9 = $_POST['treaty_autumn_date_9'];
            $treaty_spring_date_2 = $_POST['treaty_spring_date_2'];
            $treaty_spring_date_4 = $_POST['treaty_spring_date_4'];
            $treaty_spring_date_6 = $_POST['treaty_spring_date_6'];
            $treaty_spring_date_8 = $_POST['treaty_spring_date_8']; 
        
            $query = "UPDATE asu_treaty SET ";
            $query .= "treaty_date_conclusion = '{$treaty_date_conclusion}', ";
            $query .= "treaty_plan_id = {$treaty_plan_id}, ";
            $query .= "treaty_cost = '{$treaty_cost}', ";
            $query .= "treaty_start_date = '{$treaty_start_date}', ";
            $query .= "treaty_end_date = '{$treaty_end_date}', ";
            $query .= "treaty_autumn_date_1 = '{$treaty_autumn_date_1}', ";
            $query .= "treaty_autumn_date_3 = '{$treaty_autumn_date_3}', ";
            $query .= "treaty_autumn_date_5 = '{$treaty_autumn_date_5}', ";
            $query .= "treaty_autumn_date_7 = '{$treaty_autumn_date_7}', ";
            $query .= "treaty_autumn_date_9 = '{$treaty_autumn_date_9}', ";
            $query .= "treaty_spring_date_2 = '{$treaty_spring_date_2}', ";
            $query .= "treaty_spring_date_4 = '{$treaty_spring_date_4}', ";
            $query .= "treaty_spring_date_6 = '{$treaty_spring_date_6}', ";
            $query .= "treaty_spring_date_8 = '{$treaty_spring_date_8}' ";
            $query .= "WHERE treaty_id = {$treaty_id} ";

            $update_treaty = mysqli_query($connection,$query);
            if(!$update_treaty) {
                die("QUERY FAILED ." . mysqli_error($connection));
            }

            
            if ($_POST['treaty_customer'] == 'on') {
                $treaty_customer = 0;
            }
            else {
                $treaty_customer = 1;
            }
            $query = "UPDATE asu_treaty SET treaty_customer = {$treaty_customer} WHERE treaty_id = {$treaty_id}";
            $update_treaty = mysqli_query($connection, $query);
            if(!$update_treaty) {        
                die("QUERY FAILED ." . mysqli_error($connection));        
            }


            $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";
        
            header("refresh: 1; url=./treaty.php?source=view_treaty&treaty_id={$the_treaty_id}");
        }
    }
?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h2 class="page-header"><i class="fa fa-handshake-o fa-fw text-muted" aria-hidden="true"></i>
            &nbsp;Редактировать договор от <?php echo $treaty_date_conclusion; ?> № <?php echo $treaty_number; ?>
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="treaty.php?source=view_treaty&treaty_id=<?php echo $the_treaty_id; ?>" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>

<?php if ($message) {echo $message;} ?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-file-text" aria-hidden="true"></i> Предмет договора</h3>
    </div>
</div>


<form class="form-horizontal" action="" method="POST" enctype="multipart/form-data">  

    <div class="form-group">
        <div class="col-sm-6">
            <label for="treaty_number">Номер</label>
                <input class="form-control" id="disabledInput" placeholder="<?php echo $treaty_number; ?>" disabled>
        </div>

        <div class="col-sm-6">
            <label for="treaty_date_conclusion">Дата заключения <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
                    <input type="date" class="form-control" name="treaty_date_conclusion" value="<?php echo $treaty_date_conclusion; ?>" required>
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-6">
            <p><b>Учебный план</b></p>
                <?php
                    if(isset($_GET['select'])) {
                        $the_academic_plan_id = $_GET['select'];
                        
                        $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$the_academic_plan_id}";
                        $select_all_academic_plan = mysqli_query($connection,$query);
                        $row = mysqli_fetch_assoc($select_all_academic_plan);

                        $academic_plan_id = $row['academic_plan_id'];
                        $academic_plan_name = $row['academic_plan_name'];
                        $academic_plan_period = $row['academic_plan_period'];
                        $academic_plan_organization_id = $row['academic_plan_organization_id'];
                        $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
                        $academic_plan_qualification_id = $row['academic_plan_qualification_id'];
                            
                        $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";
                        $select_organization_id = mysqli_query($connection,$query);
                        $row = mysqli_fetch_assoc($select_organization_id);
                        
                        $organization_title = $row['organization_title'];

                        $query = "SELECT * FROM asu_qualification WHERE qualification_id = {$academic_plan_qualification_id}";
                        $select_qualification_by_id = mysqli_query($connection,$query);
                        $row = mysqli_fetch_assoc($select_qualification_by_id);

                        $qualification_name = $row['qualification_name'];

                        echo "<input type='hidden' class='form-control' name='treaty_plan_id' value='$academic_plan_id'>";
                        echo "<p><b>ID: </b>{$academic_plan_id}</p>";
                        echo "<p><b>Название: </b>{$academic_plan_name}</p>";
                        echo "<p><b>Организация: </b>{$organization_title}</p>";
                        echo "<p><b>Квалификация: </b>{$qualification_name}</p>";
                        echo "<p><b>Количество семестров: </b>{$academic_plan_period} семестров</p>";
                            
                    } 
                    else {
                        $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$treaty_plan_id}";
                        $select_all_academic_plan = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_all_academic_plan)) {
                            $academic_plan_id = $row['academic_plan_id'];
                            $academic_plan_name = $row['academic_plan_name'];
                            $academic_plan_period = $row['academic_plan_period'];
                            $academic_plan_organization_id = $row['academic_plan_organization_id'];
                            $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
                            $academic_plan_qualification_id = $row['academic_plan_qualification_id'];

                            $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";
                            $select_organization_id = mysqli_query($connection,$query);
                            $row = mysqli_fetch_assoc($select_organization_id);

                            $organization_title = $row['organization_title'];
                                
                            $query = "SELECT * FROM asu_qualification WHERE qualification_id = {$academic_plan_qualification_id}";
                            $select_qualification_by_id = mysqli_query($connection,$query);
                            $row = mysqli_fetch_assoc($select_qualification_by_id);

                            $qualification_name = $row['qualification_name'];
                                
                            echo "<input type='hidden' class='form-control' name='treaty_plan_id' value='$academic_plan_id'>";
                            echo "<p><b>ID: </b>{$academic_plan_id}</p>";
                            echo "<p><b>Название: </b>{$academic_plan_name}</p>";
                            echo "<p><b>Организация: </b>{$organization_title}</p>";
                            echo "<p><b>Квалификация: </b>{$qualification_name}</p>";
                            echo "<p><b>Количество семестров: </b>{$academic_plan_period} семестров</p>";
                        }
                    }
                ?>
                
            <!-- Button trigger modal -->
            <a class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                Выбрать
            </a>
        </div>

        <div class="col-sm-6">
            <label for="treaty_start_date">Начало обучения <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
                <input type="date" class="form-control" name="treaty_start_date" value="<?php echo $treaty_start_date; ?>" required>
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-6">
            <label for="treaty_enrollee_session_id">Период обучения семестра</label>
                <select name="treaty_enrollee_session_id" id="" class="form-control">
                    <?php 
                        if(!isset($treaty_enrollee_session_id)) {
                            echo "<option value=''>Выбрать . . .</option>";
                        }

                        $curent_date = date("Y-m-d");
                            
                        $query = "  
                            SELECT 
                                session_id,
                                CONCAT(session_period,' ',session_time) AS session,
                                session_start
                            FROM
                                asu_session
                            ORDER BY
                                session_start
                        ";
                        $select_all_session = mysqli_query($connection,$query);
                            
                        while($row = mysqli_fetch_assoc($select_all_session)) {
                            $session_id = $row['session_id'];
                            $session = $row['session'];
                            $session_start = $row['session_start'];
                                
                            if($session_start <= $curent_date) {
                                echo "<option class='text-danger' value='{$session_id}'>{$session}</option>";
                            }
                            else {
                                echo "<option value='{$session_id}'>{$session}</option>";
                            } 
                        }
                    ?>
                </select>
        </div>

        <div class="col-sm-6">
            <label for="treaty_semester_id">Семестр</label>
                <select name="treaty_semester_id" id="" class="form-control">
                    <?php
                        if(!isset($treaty_semester_id)) {
                            echo "<option value=''>Выбрать . . .</option>";
                        }
                        
                        $query = "
                            SELECT
                                semester_id,
                                semester_title
                            FROM
                                asu_semesters
                        ";
                        $select_all_semesters = mysqli_query($connection, $query);
                            
                        while($row = mysqli_fetch_assoc($select_all_semesters)){
                            $semester_id = $row['semester_id'];
                            $semester_title = $row['semester_title'];
                            echo "<option value='{$semester_id}'>{$semester_title}</option>";   
                        }
                    ?>
                </select>
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-6">
                <?php
                    if ($treaty_customer == 0) {
                        echo '<input type="checkbox" name="treaty_customer" value="on" checked>';
                    }
                    elseif ($treaty_customer == 1) {
                        echo '<input type="checkbox" name="treaty_customer" value="on">';
                    }
                ?>
                Заказчиком является родитель обучающегося
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-6">
            <label for="treaty_cost">Стоимость обучения за семестр, руб.</label>
            <!-- <input type="text" class="form-control" name="treaty_cost" value="<?php echo $treaty_cost; ?>">-->
                <select class="form-control" name="treaty_cost">
                    <?php 
                        if($treaty_cost) {
                            echo "<option value='{$treaty_cost}' selected>{$treaty_cost} руб.</option>";
                        }
                        selectCostTreaty($treaty_cost); 
                    ?>
                </select>
        </div>

        <div class="col-sm-6">
            <label for="treaty_end_date">Окончание обучения <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
                <input type="date" class="form-control" name="treaty_end_date" value="<?php echo $treaty_end_date; ?>" required>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <h3 class="page-header text-primary"><i class="fa fa-calendar" aria-hidden="true"></i> Сроки оплаты</h3>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <h4>Осень</h4>
        </div>

        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <h4>Весна</h4>
        </div>
    </div>

    <div class="form-grosp">
        <?php
            if(isset($_GET['select'])) {
                $the_academic_plan_id = $_GET['select'];
                $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$the_academic_plan_id}";
                $select_all_academic_plan = mysqli_query($connection,$query);
                while($row = mysqli_fetch_assoc($select_all_academic_plan)) {
                    $academic_plan_period = $row['academic_plan_period'];
                }

                for($i=1, $j=1; $i<=$academic_plan_period, $j<=$academic_plan_period; $i++, $j++) { 
                    if ($i % 2) {
                        echo "
                            <div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>
                                <label for='treaty_autumn_date_{$i}'>Семестр № {$i}</label>
                                <input type='date' class='form-control' name='treaty_autumn_date_{$i}' value='${treaty_autumn_date_.$i}'>
                            </div>
                        ";
                    } 
                    else { 
                        echo "
                            <div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>
                                <label for='treaty_spring_date_{$j}'>Семестр № {$j}</label>
                                <input type='date' class='form-control' name='treaty_spring_date_{$j}' value='${treaty_spring_date_.$j}'>
                            </div>
                        ";
                    }
                } 
            } 
            else {
                $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$treaty_plan_id}";
                $select_all_academic_plan = mysqli_query($connection,$query);
                while($row = mysqli_fetch_assoc($select_all_academic_plan)) {
                    $academic_plan_period = $row['academic_plan_period'];
                }

                for($i=1, $j=1; $i<=$academic_plan_period, $j<=$academic_plan_period; $i++, $j++) { 
                    if ($i % 2) {
                        echo "
                            <div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>
                                <label for='treaty_autumn_date_{$i}'>Семестр № {$i}</label>
                                <input type='date' class='form-control' name='treaty_autumn_date_{$i}' value='${treaty_autumn_date_.$i}'>
                            </div>";
                    }
                    else { 
                        echo "
                            <div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>
                                <label for='treaty_spring_date_{$j}'>Семестр № {$j}</label>
                                <input type='date' class='form-control' name='treaty_spring_date_{$j}' value='${treaty_spring_date_.$j}'>
                            </div>
                        ";
                    }
                }   
            }
        ?>
    </div>

    <div class="form-group">
        <div class="col-sm-12">
            <div class="page-header"></div>
                <input class="btn btn-primary" type="submit" name="update_treaty" value="Сохранить">
        </div>
    </div>       
</form>  

        
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Учебные планы</h4>
            </div>

            <div class="modal-body">
                <table class="table table-hover table-bordered">
                    <thead>
                        <tr class="active">
                            <th>Название</th>
                            <th>Организация</th>
                            <th>Сроки</th>
                            <th class="text-center">ID</th>
                            <th class="text-center">Выбрать</th>
                        </tr>
                    </thead>

                    <tbody>
                        <?php 
                            $query = "SELECT * FROM asu_academic_plan";
                            $select_all_academic_plan = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_all_academic_plan)) {
                                $academic_plan_id = $row['academic_plan_id'];
                                $academic_plan_name = $row['academic_plan_name'];
                                $academic_plan_period = $row['academic_plan_period'];
                                $academic_plan_organization_id = $row['academic_plan_organization_id'];
                                $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];

                                $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";
                                $select_organization_id = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_organization_id)) {
                                    $organization_title = $row['organization_title'];
                                }
                                
                                echo "<tr>";
                                    echo "<td>$academic_plan_name</td>";
                                    echo "<td>$organization_title</td>";
                                    echo "<td>$academic_plan_period</td>";
                                    echo "<td>$academic_plan_id</td>";
                                    echo "<td class='text-center'>
                                        <a class='text-muted' href='treaty.php?source=edit_treaty&e_id={$the_enrollee_id}&select={$academic_plan_id}&treaty_id={$the_treaty_id}'>
                                            <i class='fa fa-flag' aria-hidden='true'></i>
                                        </a>
                                    </td>";
                                echo "</tr>";
                            }
                        ?>
                    </tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                <!-- <button type="button" class="btn btn-primary">Выбрать</button>-->
            </div>
        </div>
    </div>
</div>    