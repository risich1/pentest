<?php

if(isset($_GET['e_id'])) {
    
    $the_enrollee_id = $_GET['e_id'];
    $the_treaty_number = $the_enrollee_id;
    
}



$query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$the_enrollee_id} ";
$select_enrollee_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {
    
    $enrollee_image = $row['enrollee_image'];
    $enrollee_surname = $row['enrollee_surname'];
    $enrollee_name = $row['enrollee_name'];
    $enrollee_patronymic = $row['enrollee_patronymic'];
    $enrollee_date_birth = $row['enrollee_date_birth'];
    $enrollee_sex = $row['enrollee_sex'];
    $enrollee_status = $row['enrollee_status'];
    $enrollee_region_id = $row['enrollee_region_id'];

}

if($the_treaty_number) {
    
    $the_treaty_number = $the_treaty_number;
    $the_treaty_number .= '-';
    $the_treaty_number .= $enrollee_region_id; 
    $the_treaty_number .= '-';
    $the_treaty_number .= date('y');
    $the_treaty_number .= '/ДИС';
    
}

$query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
$select_region_id = mysqli_query($connection,$query);

while($row = mysqli_fetch_assoc($select_region_id)) {
    
    $region_title = $row['region_title'];
    
}

 if(isset($_POST['add_treaty'])) {
     
     $treaty_enrollee_id = $the_enrollee_id;
     $treaty_number = $the_treaty_number;
     $academic_plan_id = $_POST['academic_plan_id'];
     $treaty_date_conclusion = $_POST['treaty_date_conclusion'];
     $treaty_plan_id = $_POST['treaty_plan_id'];
     $treaty_cost = $_POST['treaty_cost'];
     $treaty_start_date = $_POST['treaty_start_date'];
     $treaty_end_date = $_POST['treaty_end_date'];
     $treaty_count_semesters = $_POST['treaty_count_semesters'];
     $treaty_autumn_date_1 = $_POST['treaty_autumn_date_1'];
     $treaty_autumn_date_3 = $_POST['treaty_autumn_date_3'];
     $treaty_autumn_date_5 = $_POST['treaty_autumn_date_5'];
     $treaty_autumn_date_7 = $_POST['treaty_autumn_date_7'];
     $treaty_autumn_date_9 = $_POST['treaty_autumn_date_9'];
     
     $treaty_spring_date_2 = $_POST['treaty_spring_date_2'];
     $treaty_spring_date_4 = $_POST['treaty_spring_date_4'];
     $treaty_spring_date_6 = $_POST['treaty_spring_date_6'];
     $treaty_spring_date_8 = $_POST['treaty_spring_date_8'];

     
     $treaty_date = date('d-m-y');
     
     $query = "INSERT INTO asu_treaty(treaty_enrollee_id, treaty_number, treaty_date_conclusion, treaty_plan_id, treaty_cost, treaty_start_date, treaty_end_date, treaty_count_semesters, treaty_autumn_date_1, treaty_autumn_date_3, treaty_autumn_date_5, treaty_autumn_date_7, treaty_autumn_date_9, treaty_spring_date_2, treaty_spring_date_4, treaty_spring_date_6, treaty_spring_date_8, treaty_date, treaty_customer) ";
                    
     $query .= "VALUES ({$treaty_enrollee_id}, '{$treaty_number}', '{$treaty_date_conclusion}', {$treaty_plan_id}, '{$treaty_cost}', '{$treaty_start_date}', '{$treaty_end_date}', '{$treaty_count_semesters}', '{$treaty_autumn_date_1}', '{$treaty_autumn_date_3}', '{$treaty_autumn_date_5}', '{$treaty_autumn_date_7}', '{$treaty_autumn_date_9}', '{$treaty_spring_date_2}', '{$treaty_spring_date_4}', '{$treaty_spring_date_6}', '{$treaty_spring_date_8}',  now(), 0)";

     $create_treaty_query = mysqli_query($connection,$query);

     if(!$create_treaty_query) {

        die('QUERY FAILD' . mysqli_error($connection));

     }
     
     $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";
        
     
     $query = "UPDATE asu_enrollee SET ";
     $query .= "enrollee_status = 'Договор заключен' ";
        
     $query .= "WHERE enrollee_id = {$treaty_enrollee_id} ";
        
     $update_enrollee_status = mysqli_query($connection,$query);

//    $query = "UPDATE posts SET post_comment_count = post_comment_count + 1 ";
//    $query .= "WHERE post_id = {$the_post_id}";
//
//    $update_comment_count = mysqli_query($connection, $query);
//
//
//    } else {
//
//        echo "<script>alert('vdvdf');</script>";
//
//    }
     
     header("refresh: 1; url=./enrollee.php?source=view_enrollee&e_id={$the_enrollee_id}");
     
 }


?>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="enrollee.php?source=view_enrollee&e_id=<?php echo $the_enrollee_id; ?>" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>

<?php echo $message ?? ''; ?>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-info-circle" aria-hidden="true"></i> 
            Информация об абитуриенте 
            <small>(Личное дело № <?php echo $the_enrollee_id; ?>)</small>
        </h3>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
        <?php
            if(!empty($enrollee_image)) {
                echo "<img class='img-thumbnail' src='images/{$enrollee_image}' width='150' alt='photo'>";   
            } else {
                echo "<img class='img-thumbnail' src='images/bg_photo.jpg' width='150' alt='photo'>";
            }
        ?> 
    </div>
    <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9">
        <p><b>Фамилия: </b><?php echo $enrollee_surname; ?></p>
        <p><b>Имя: </b><?php echo $enrollee_name; ?></p>
        <p><b>Отчество: </b><?php echo $enrollee_patronymic; ?></p>
        <p><b>Дата рождения: </b><?php echo $enrollee_date_birth; ?></p>
        <p><b>Пол: </b><?php echo $enrollee_sex; ?></p>
        <p><b>Регион: </b><?php echo $region_title; ?></p>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="page-header text-primary"><i class="fa fa-file-text" aria-hidden="true"></i> Предмет договора</h3>
    </div>
</div>

<div class="row">
    <div class="col-xs-6 col-sm-6 col-md-12 col-lg-12">
<form class="form-horizontal" action="" method="post" enctype="multipart/form-data">  
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="treaty_number">Номер</label>
            <input class="form-control" id="disabledInput" placeholder="<?php echo $the_treaty_number; ?>" disabled>
        </div>

        <div class="col-sm-6">
            <label for="treaty_date_conclusion">Дата заключения <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="date" class="form-control" name="treaty_date_conclusion" required>
        </div>
    </div>
    
    <div class="form-group">
       
       <div class="col-sm-6">
            <p><b>Учебный план</b></p>
            
            <?php
            
                if(isset($_GET['select'])) {
                    
                    $the_academic_plan_id = $_GET['select'];
                    
                    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$the_academic_plan_id}";
                    $select_all_academic_plan = mysqli_query($connection,$query);

                    while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                        $academic_plan_id = $row['academic_plan_id'];
                        $academic_plan_name = $row['academic_plan_name'];
                        $academic_plan_period = $row['academic_plan_period'];
                        $academic_plan_organization_id = $row['academic_plan_organization_id'];
                        $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];


                        $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";
                        $select_organization_id = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_organization_id)) {

                            $organization_title = $row['organization_title'];

                        }
                            
                        echo "<input type='hidden' class='form-control' name='treaty_plan_id' value='$academic_plan_id'>";
                        echo "<p><b>ID: </b>{$academic_plan_id}</p>";
                        echo "<p><b>Название: </b>{$academic_plan_name}</p>";
                        echo "<p><b>Организация: </b>{$organization_title}</p>";
                        echo "<p><b>Количество семестров: </b>{$academic_plan_period} семестров</p>";



                    }
                }
            ?>
            
            <!-- Button trigger modal -->
            <a class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                Выбрать
            </a>
        </div>
        <div class="col-sm-6">
            <label for="treaty_start_date">Начало обучения <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="date" class="form-control" name="treaty_start_date" required>
        </div>
    </div>
    
    
    <div class="form-group">
        <div class="col-sm-6">
            <label for="treaty_cost">Стоимость обучения за семестр, руб.</label>            
            <select class="form-control" name="treaty_cost">
                <?php selectCostTreaty(null); ?>
            </select>
            
            
        </div>
        <div class="col-sm-6">
            <label for="treaty_end_date">Окончание обучения <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="date" class="form-control" name="treaty_end_date" required>
        </div>
    </div>
    
    
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <h3 class="page-header text-primary"><i class="fa fa-calendar" aria-hidden="true"></i> Сроки оплаты</h3>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <h4>Осенний семестр</h4>
        </div>
        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <h4>Весенний семестр</h4>
        </div>
    </div>
    <div class="form-grosp">
            
    <?php
        if(isset($_GET['select'])) {
                    
            $the_academic_plan_id = $_GET['select'];
            
            $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$the_academic_plan_id}";
            $select_all_academic_plan = mysqli_query($connection,$query);
            
             while($row = mysqli_fetch_assoc($select_all_academic_plan)) {
            
                $academic_plan_period = $row['academic_plan_period'];
             
             }
            
            for($i=1, $j=1; $i <= $academic_plan_period, $j <= $academic_plan_period; $i++, $j++) { 
            
                
            if ($i % 2) {
                echo "
                    
                    <div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>
                        <label for='treaty_autumn_date_{$i}'>Семестр № {$i}</label>
                        <input type='date' class='form-control' name='treaty_autumn_date_{$i}'>
                    </div>";
                    
                    } else { 
                echo "
                    
                    <div class='col-xs-6 col-sm-6 col-md-6 col-lg-6'>
                        <label for='treaty_spring_date_{$j}'>Семестр № {$j}</label>
                        <input type='date' class='form-control' name='treaty_spring_date_{$j}'>
                    </div>";
            }
                
                } } 
    ?>


    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <div class="page-header"></div>
            <input class="btn btn-primary" type="submit" name="add_treaty" value="Сохранить">
        </div>
    </div>       
</form>  

        
        

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Учебные планы</h4>
            </div>
            <div class="modal-body">
                <table class="table table-hover table-bordered">
                    <thead>
                        <tr class="active">
                            <th>Название</th>
                            <th>Организация</th>
                            <th>Сроки</th>
                            <th class="text-center">ID</th>
                            <th class="text-center">Выбрать</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php 
                            $query = "SELECT * FROM asu_academic_plan";
                            $select_all_academic_plan = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                                $academic_plan_id = $row['academic_plan_id'];
                                $academic_plan_name = $row['academic_plan_name'];
                                $academic_plan_period = $row['academic_plan_period'];
                                $academic_plan_organization_id = $row['academic_plan_organization_id'];
                                $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];


                                $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id}";
                                $select_organization_id = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_organization_id)) {

                                    $organization_title = $row['organization_title'];

                                }
                                
                                echo "<tr>";
                                echo "<td>$academic_plan_name</td>";
                                echo "<td>$organization_title</td>";
                                echo "<td>$academic_plan_period</td>";
                                echo "<td>$academic_plan_id</td>";
                                echo "<td class='text-center'>
                                        <a class='text-muted' href='treaty.php?source=add_treaty&e_id={$the_enrollee_id}&select={$academic_plan_id}'>
                                            <i class='fa fa-flag' aria-hidden='true'>
                                            </i>
                                        </a>
                                    </td>";
                                echo "</tr>";



                            }
                        ?>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
<!--                <button type="button" class="btn btn-primary">Выбрать</button>-->
            </div>
        </div>
    </div>
</div>     
   
    
    
    
    
    


            