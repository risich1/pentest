<?php include "includes/menu_deanery.php"; ?>
<?php $link_page = $_SERVER['REQUEST_URI']; ?>
<?php

require_once("../includes/db.php");

if(isset($_POST['submit'])) {
    $enrollee_surname = $_POST['enrollee_surname'];
    $enrollee_region_id = $_POST['enrollee_region_id'];
    $enrollee_order_id = $_POST['enrollee_order_id'];
    $query = "
        SELECT * FROM asu_enrollee
        WHERE enrollee_status = 'Студент' 
    ";
    if($enrollee_region_id) {
        $query .= "
            AND enrollee_region_id = {$enrollee_region_id}
        ";
    } 
    if ($enrollee_surname) {
        $query .= "
            AND enrollee_surname LIKE '%$enrollee_surname%'
        ";
    }
    if ($enrollee_order_id) {
        $query .= "
            AND enrollee_order_id = {$enrollee_order_id}
        ";
    }
    $select_all_enrollee = mysqli_query($connection, $query);
    $count = mysqli_num_rows($select_all_enrollee);

    if(!$select_all_enrollee) {

        die("QUERY FAILED" . mysqli_error($connection));

    }

    if($count == 0) {

        $message = "<div class='alert alert-success'>По Вашему поисковому запросу ни чего не найдено.</div>";

    } else {
        $message = "<div class='alert alert-success'><b>Результат поиска</b>
                    <p>Найдено: {$count}</p></div>";
    }


} else {

    $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'Студент' ";
    
    $select_all_enrollee = mysqli_query($connection, $query);

}
        
?>    

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-address-book-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Студенты
        </h1>
    </div>
</div> 
<!--
<div class="well">
    <h4>Поиск</h4>
    <form action="search.php" method="post">
        <div class="input-group">
            <input name="search" type="text" class="form-control" required>

            <span class="input-group-btn">
                <button class="btn btn-default" name="submit" type="submit">
                    <span class="glyphicon glyphicon-search"></span>
                </button>
            </span>

        </div>
    </form>
</div>
-->
<br>
 
<?php if($_SESSION['user_role_id'] == 1) { ?>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <form class="form-horizontal well" action="" method="post">
        <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

            <h4><i class="fa fa-filter text-muted" aria-hidden="true"></i>Фильтр</h4>
            <div class="form-group">
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <input name="enrollee_surname" type="text" class="form-control" value="<?php echo $enrollee_surname; ?>" placeholder="Фамилия">
                </div>
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <select name="enrollee_region_id" class="form-control" id="enrollee_region_id" value="<?php echo $enrollee_region_id; ?>">
                        
                            <?php
                                
                                if(isset($enrollee_region_id)) {
                                    
                                    $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                                    $select_region_by_id = mysqli_query($connection,$query);
                                    
                                    $row = mysqli_fetch_assoc($select_region_by_id);
                                    
                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    if($enrollee_region_id == '') {
                                        echo "<option value=''>Все . . . </option>";
                                    } else {

                                        echo "<option value='{$region_id}'>{$region_title}</option>";
                                        echo "<option value=''>Все . . . </option>";
                                    }

                                } else {
                                    echo "<option value=''>Выбрать регион . . . </option>";
                                }            
                                
                                if ($enrollee_region_id == '') {
                                    $query = "SELECT * FROM asu_region ORDER BY region_title ";
                                } else {
                                    $query = "SELECT * FROM asu_region WHERE region_id != {$enrollee_region_id} ORDER BY region_title ";
                                }
                               
                                $select_region = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_region)) {

                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    echo "<option value='{$region_id}'>{$region_title}</option>";

                                }

                            ?>
                    </select>
                </div>
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <select name="enrollee_order_id" class="form-control" id="enrollee_order_id" value="<?php echo $enrollee_order_id; ?>">
                            <?php
                                
                                if(isset($enrollee_order_id)) {
                                    $query = "SELECT * FROM asu_orders WHERE order_id = {$enrollee_order_id} ";
                                    $select_order_by_id = mysqli_query($connection, $query);
                                    $row = mysqli_fetch_assoc($select_order_by_id);
                                    $order_id = $row['order_id'];
                                    $order_number = $row['order_number'];
                                    if($enrollee_order_id == '') {
                                        echo "<option value=''>Все . . . </option>";
                                    } else {
                                        echo "<option value='{$order_id}'>{$order_number}</option>";
                                        echo "<option value=''>Все . . . </option>";
                                    }
                                } else {
                                    echo "<option value=''>Выбрать приказ . . . </option>";
                                }            
                                
                                if ($enrollee_order_id == '') {
                                    $query = "SELECT * FROM asu_orders ORDER BY order_id ";
                                } else {
                                    $query = "SELECT * FROM asu_orders WHERE order_id != {$enrollee_order_id} ORDER BY order_id ";
                                }
                               
                                $select_order = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_order)) {
                                    $order_id = $row['order_id'];
                                    $order_number = $row['order_number'];
                                    echo "<option value='{$order_id}'>{$order_number}</option>";
                                }

                            ?>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    <input class="btn btn-primary" type="submit" name="submit" value="Найти">
                    <a class="btn btn-default" href="students.php">Сбросить</a>
                </div>
            </div> 
        </form>
    </div>
</div>

<?php echo $message; ?>
<?php } ?>                           
                                                    
                                                                                                      
<table class="table table-hover table-bordered table-filter">
<thead>
    <tr class="active">
        <th>№</th>
        <th>Фамилия</th>
        <th>Имя</th>
        <th>Отчество</th>
        <th>Семестр</th>
        <th>Дата рождения</th>
        <th>Группа</th>
        <th>Приказ</th>
        <th>Регион</th>
        <th>Логин в СДО</th>
        <th>Статус в СДО</th>
        <th class="text-center">ID</th>
        <th class="text-center">Личное дело</th>
    </tr>
</thead>
<tbody>
       
       
        <?php
    
            if($_SESSION['user_role_id'] == 1) { 
                
                } else {
                    if(isset($_SESSION['user_region_id'])) {

                        $user_region_id = $_SESSION['user_region_id'];

                        $query = "SELECT * FROM asu_enrollee WHERE enrollee_region_id = {$user_region_id} AND enrollee_status = 'Студент' ";
                        $select_all_enrollee = mysqli_query($connection, $query);
                    }
                }

            while($row = mysqli_fetch_assoc($select_all_enrollee)) {

                $number++;
                $enrollee_id = $row['enrollee_id'];
                $moodle_id = $row['moodle_id'];
                $enrollee_surname = $row['enrollee_surname'];
                $enrollee_name = $row['enrollee_name'];
                $enrollee_patronymic = $row['enrollee_patronymic'];
                $current_sem = $row['current_sem'];
                $enrollee_date = $row['enrollee_date_birth'];
                $enrollee_status = $row['enrollee_status'];
                $enrollee_region_id = $row['enrollee_region_id'];
                $current_sem = $row['current_sem'];
                $enrollee_group_id = $row['enrollee_group_id'];
                $enrollee_order_id = $row['enrollee_order_id'];

                echo "<tr>";
                echo "<td>{$number}</td>";
                echo "<td>{$enrollee_surname}</td>";
                echo "<td>{$enrollee_name}</td>";
                echo "<td>{$enrollee_patronymic}</td>";
                echo "<td>{$current_sem}</td></td>";
                echo "<td>{$enrollee_date}</td></td>";
                
                if($enrollee_group_id) {
                    
                    $query = "SELECT * FROM asu_groups WHERE group_id = {$enrollee_group_id} ";
                    $select_group_by_id = mysqli_query($connection, $query);

                    while($row = mysqli_fetch_assoc($select_group_by_id)) {

                        $group_number = $row['group_number'];

                        echo "<td>{$group_number}</td>";
                    } 
                    
                } else {
                    
                    echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                    
                }
                
                $query = "SELECT * FROM asu_orders WHERE order_id = {$enrollee_order_id} ";
                $select_order_by_id = mysqli_query($connection,$query);
                
                while($row = mysqli_fetch_assoc($select_order_by_id)) {
                    
                    $order_id = $row['order_id'];
                    $order_number = $row['order_number'];
                    $order_date = $row['order_date'];
                    $order_date = date_create($order_date)->Format('d.m.Y');
                    $order_info = $order_number;
                    $order_info .= ' от ';
                    $order_info .= $order_date;
                    
                    
                    echo "<td><a href='order.php?source=view_order&o_id={$order_id}'>{$order_info}</a></td>";
   
                }
                
                $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id}";
                $select_region_by_id = mysqli_query($connection,$query);

                while($row = mysqli_fetch_assoc($select_region_by_id)) {

                    $region_id = $row['region_id'];
                    $region_title = $row['region_title'];

                    echo "<td>{$region_title}</td>";

                }

                
                if(!isset($moodle_id)) {

                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                        }
                        $query = "SELECT * FROM clg_user WHERE id = '{$moodle_id}'";

                        // echo $query;
                        // die;

                        $select_users_by_moodleid = mysqli_query($connection,$query);
                        while($row = mysqli_fetch_assoc($select_users_by_moodleid)) {

                            $username = $row['username'];

                            echo "<td class='text-center'>{$username}</td>";
                        }
                        
                       
                            
                        if($enrollee_status == 'Студент' && !isset($moodle_id)) {
                            echo "<td class='text-center'><a class='text-primary' href='students.php?add_enrollee_inSDO={$enrollee_id}'><i class='fa fa-plus-circle' aria-hidden='true' title='Добавить пользователя в СДО'></i></a></td>";  
                        } elseif(isset($moodle_id)) {
                            echo "<td class='text-center'><i class='text-success fa fa-check-circle text-muted' aria-hidden='true' title='Пользователь создан в СДО'></i></td>";
                        } else {
                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                        }
                            
                        
                
                        echo "<td class='text-center'>{$enrollee_id}</td>";
                        echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}&link_page={$link_page}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                        echo "</tr>";

                    }
                ?>

</tbody>
</table>


<?php

if(isset($_GET['delete'])) {
    
    $the_enrollee_id = $_GET['delete'];
    
    $query = "DELETE FROM asu_enrollee WHERE enrollee_id = {$the_enrollee_id} ";
    
    $delete_query = mysqli_query($connection, $query);
    
    header("Location: enrollee.php");
    
}

if(isset($_GET['add_enrollee_inSDO'])) {
                         
    $the_enrollee_id = $_GET['add_enrollee_inSDO'];


    file_get_contents($prefixsdo."/webservice/synchronization.php?id={$the_enrollee_id}");

    header("Location: students.php");
    
 }



?>