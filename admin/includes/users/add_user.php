<?php

    if(isset($_POST['usercreate'])) {
    
        $user_login = $_POST['user_login'];
        $user_email = $_POST['user_email'];
        $user_password = $_POST['user_password'];
        $user_surname = $_POST['user_surname'];
        $user_name = $_POST['user_name'];
        $user_patronymic = $_POST['user_patronymic'];
        $user_phone = $_POST['user_phone'];
        $user_region_id = $_POST['user_region_id'];
        $user_role_id = $_POST['user_role_id'];
        
        $user_date = date('d-m-y');
        
        if(!empty($user_login) && !empty($user_email) && !empty($user_password)) {
        
            

            $query = "SELECT randSalt FROM asu_users";
            $select_randsalt_query = mysqli_query($connection, $query);

            if(!$select_randsalt_query) {
                die("Ошибка" . mysqli_error($connection));
            }

            $row = mysqli_fetch_array($select_randsalt_query);
            echo $salt = $row['randSalt']."<br>";
            $user_password = crypt($user_password, $salt);
            
            $query = "INSERT INTO asu_users (user_login, user_email, user_password, user_surname, user_name, user_patronymic, user_phone, user_region_id, user_role_id, user_date) ";
            $query .= "VALUES('{$user_login}', '{$user_email}', '{$user_password}', '{$user_surname}',  '{$user_name}', '{$user_patronymic}', '{$user_phone}', {$user_region_id}, {$user_role_id}, now())";
            
            $add_user_query = mysqli_query($connection, $query);
            
            if(!$add_user_query) {
                die("Ошибка" . mysqli_error($connection) . ' ' . mysqli_errno($connection));
            }
            
            
            //$message = "Все ок!";
            
        } else {
            //$message = "Все плохо!";
        }
        
    }
        
        


?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-user-plus fa-fw text-muted" aria-hidden="true"></i>&nbsp;Форма создания нового пльзователя
        </h1>
    </div>
</div>  
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="users.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<form class="form-horizontal" role="form" action="" method="post" id="login-form" autocomplete="off">
<input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

    <h4 class="text-center"><?php echo $message; ?></h4>
    
    <h3 class="page-header text-primary"><i class="fa fa-sign-in fa-fw" aria-hidden="true"></i>&nbsp;Данные для авторизации</h3>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="login">
                Логин (Email)
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" name="user_login" id="login" class="form-control" required>
        </div>
    </div>
     <div class="form-group">
        <div class="col-sm-12">
            <label for="email">
                Email
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" name="user_email" id="email" class="form-control" required>
         </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_password">
                Пароль
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="password" name="user_password" id="user_password" class="form-control" required>
        </div>
    </div>
    
    <h3 class="page-header text-primary"><i class="fa fa-info-circle fa-fw" aria-hidden="true"></i>&nbsp;Личная информация</h3>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_surname">
                Фамилия 
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" class="form-control" name="user_surname" id="user_surname" required>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_name">
                Имя 
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" class="form-control" name="user_name" id="user_name" required>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_patronymic">Отчество</label>
            <input type="text" class="form-control" name="user_patronymic" id="user_patronymic">
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_phone">Телефон</label>
            <input type="text" class="form-control" name="user_phone" id="user_phone">
        </div>
    </div>
    
    <h3 class="page-header text-primary"><i class="fa fa-user-secret fa-fw" aria-hidden="true"></i>&nbsp;Права доступа</h3>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_region_id">
                Регион
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <select name="user_region_id" class="form-control" id="user_region_id" required>
                <option value="">Выберете регион</option>
                <?php

                    $query = "SELECT * FROM asu_region";
                    $select_region = mysqli_query($connection,$query);

                    while($row = mysqli_fetch_assoc($select_region)) {

                        $region_id = $row['region_id'];
                        $region_title = $row['region_title'];

                        echo "<option value='$region_id'>{$region_title}</option>";

                    }

                ?>
                
            </select>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_role_id">
                Роль
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <select name="user_role_id" class="form-control" id="user_role_id" required>
                <option value="">Выберете роль</option>
                <?php

                    $query = "SELECT * FROM asu_role";
                    $select_role = mysqli_query($connection,$query);

                    while($row = mysqli_fetch_assoc($select_role)) {

                        $role_id = $row['role_id'];
                        $role_name = $row['role_name'];

                        echo "<option value='$role_id'>{$role_name}</option>";

                    }

                ?>
                
            </select>
        </div>
    </div>
    
    <div class="form-group">
        
        <div class="col-sm-12">
            <div class="page-header"></div>
            <input type="submit" name="usercreate" id="btn-login" class="btn btn-primary" value="Создать">
        </div>
    </div>
    
</form> 
   
    
     
      
       
        
          
