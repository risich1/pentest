<?php

if($_SESSION['user_role_id'] == 1) { 

} else {
    
    header('Location: ./personal_things.php');
    
}

if(isset($_GET['u_id'])) {
    
    $the_user_id = $_GET['u_id'];
    
}

$query = "SELECT * FROM asu_users WHERE user_id = {$the_user_id} ";
$select_user_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_user_by_id)) {
    
    $user_id = $row['user_id'];
    $user_login = $row['user_login'];
    $user_email = $row['user_email'];
    $user_password = $row['user_password'];
    $user_surname = $row['user_surname'];
    $user_name = $row['user_name'];
    $user_patronymic = $row['user_patronymic'];
    $user_phone = $row['user_phone'];
    $user_region_id = $row['user_region_id'];
    $user_role_id = $row['user_role_id'];

    if(isset($_POST['update_user'])) {

        
        $user_login = $_POST['user_login'];
        $user_email = $_POST['user_email'];
        $user_password = $_POST['user_password'];
        $user_surname = $_POST['user_surname'];
        $user_name = $_POST['user_name'];
        $user_patronymic = $_POST['user_patronymic'];
        $user_phone = $_POST['user_phone'];
        $user_region_id = $_POST['user_region_id'];
        $user_role_id = $_POST['user_role_id'];
        
        $query = "SELECT randSalt FROM asu_users";
        $select_randsalt_query = mysqli_query($connection, $query);
        if(!$select_randsalt_query) {
            die("Query Faild" . mysqli_error($connection));   
        }
        
//        $row = mysqli_fetch_array($select_randsalt_query);
//        echo $sal = $row['randSalt'];
        echo $hashed_password = crypt($user_password, $salt);

        $query = "UPDATE asu_users SET ";
        $query .= "user_login = '{$user_login}', ";
        $query .= "user_email = '{$user_email}', ";
        $query .= "user_password = '{$hashed_password}', ";
        $query .= "user_surname = '{$user_surname}', ";
        $query .= "user_name = '{$user_name}', ";
        $query .= "user_patronymic = '{$user_patronymic}', ";
        $query .= "user_phone = '{$user_phone}', ";
        $query .= "user_region_id = {$user_region_id}, ";
        $query .= "user_role_id = {$user_role_id} ";

        $query .= "WHERE user_id = {$user_id} ";

        $update_user = mysqli_query($connection,$query);
        
        if(!$update_user) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }
        
        $message = "<div class='alert alert-success'>Данные обновлены.</div>";

    }
}
 


?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-user-plus fa-fw text-muted" aria-hidden="true"></i>&nbsp;Редактировать данные пользователя 
        </h1>
    </div>
</div>  
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="users.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<form class="form-horizontal" role="form" action="" method="post" id="login-form" autocomplete="off">
<input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

    <h4 class="text-center"><?php echo $message; ?></h4>
    
    <h3 class="page-header text-primary"><i class="fa fa-sign-in fa-fw" aria-hidden="true"></i>&nbsp;Данные для авторизации</h3>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="login">
                Логин (Email)
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" name="user_login" id="login" class="form-control" value="<?php echo $user_login; ?>" required>
        </div>
    </div>
     <div class="form-group">
        <div class="col-sm-12">
            <label for="email">
                Email
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" name="user_email" id="email" class="form-control" value="<?php echo $user_email; ?>" required>
         </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="password">
                Пароль
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="password" name="user_password" id="password" class="form-control" value="<?php echo $user_password; ?>" required>
        </div>
    </div>
    
    <h3 class="page-header text-primary"><i class="fa fa-info-circle fa-fw" aria-hidden="true"></i>&nbsp;Личная информация</h3>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_surname">
                Фамилия 
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" class="form-control" name="user_surname" id="user_surname" value="<?php echo $user_surname; ?>" required>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_name">
                Имя 
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <input type="text" class="form-control" name="user_name" id="user_name" value="<?php echo $user_name; ?>" required>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_patronymic">Отчество</label>
            <input type="text" class="form-control" name="user_patronymic" id="user_patronymic" value="<?php echo $user_patronymic; ?>">
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_phone">Телефон</label>
            <input type="text" class="form-control" name="user_phone" id="user_phone" value="<?php echo $user_phone; ?>">
        </div>
    </div>
    
    <h3 class="page-header text-primary"><i class="fa fa-user-secret fa-fw" aria-hidden="true"></i>&nbsp;Права доступа</h3>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_region_id">
                Регион
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <select name="user_region_id" class="form-control" id="user_region_id" required>
                
                <?php
                    
                    $query = "SELECT * FROM asu_region WHERE region_id = {$user_region_id} ";
                    $select_region_by_id = mysqli_query($connection,$query);
                    
                    $row = mysqli_fetch_assoc($select_region_by_id);
                
                    $region_id = $row['region_id'];
                    $region_title = $row['region_title'];
                    
                    echo "<option value='$region_id'>{$region_title}</option>";
                    
                    $query = "SELECT * FROM asu_region";
                    $select_region = mysqli_query($connection,$query);

                    while($row = mysqli_fetch_assoc($select_region)) {

                        $region_id = $row['region_id'];
                        $region_title = $row['region_title'];

                        echo "<option value='$region_id'>{$region_title}</option>";

                    }

                ?>
                
            </select>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="user_role_id">
                Роль
                <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i>
            </label>
            <select name="user_role_id" class="form-control" id="user_role_id" required>
                
                <?php
                    
                    $query = "SELECT * FROM asu_role WHERE role_id = {$user_role_id} ";
                    $select_role_by_id = mysqli_query($connection,$query);
                    
                    $row = mysqli_fetch_assoc($select_role_by_id);
                
                    $role_id = $row['role_id'];
                    $role_name = $row['role_name'];
                    
                    echo "<option value='$role_id'>{$role_name}</option>";
                
                
                    $query = "SELECT * FROM asu_role";
                    $select_role = mysqli_query($connection,$query);

                    while($row = mysqli_fetch_assoc($select_role)) {

                        $role_id = $row['role_id'];
                        $role_name = $row['role_name'];

                        echo "<option value='$role_id'>{$role_name}</option>";

                    }

                ?>
                
            </select>
        </div>
    </div>
    
    <div class="form-group">
        
        <div class="col-sm-12">
            <div class="page-header"></div>
            <input type="submit" name="update_user" id="btn-login" class="btn btn-primary" value="Сохранить">
        </div>
    </div>
    
</form> 