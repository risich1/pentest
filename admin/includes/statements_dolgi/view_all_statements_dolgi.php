<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-file-text-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Зачетные ведомости (долги)
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h2><i class="fa fa-filter" aria-hidden="true"></i> Фильтр</h2>
            </div>
            
            <div class="panel-footer form-horizontal">
               
                <div class="form-group">

                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Период обучения</label>
                        <select name="filter_period" class="form-control" id="filter_period" value="">
                            <option value=''>Все периоды обучения</option>
                            <?php selectSessionForList(); ?>
                        </select>
                    </div>
                    
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Группа</label>
                        <select name="filter_group" class="form-control" id="filter_group" value="">
                            <option value=''>Все группы</option>
                            <?php selectGroupsForList(); ?>
                        </select>
                    </div>
                    
                </div>
            
                <div class="form-group">
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Дисциплина</label>
                        <select name="filter_discipline" class="form-control" id="filter_discipline" value="">
                            <option value=''>Все дисциплины</option>
                            <?php selectDisciplineForList(); ?>
                        </select>
                    </div>
                    
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Фамилия преподавателя</label>
                        <input name="filter_name" id="filter_name" type="text" class="form-control" value="" placeholder="Фамилия">
                    </div>
                </div>
            
                <div class="form-group">
                    <div class="col-sm-12">
                        <input class="btn btn-primary" type="submit" name="btn_filter_vastatements_dolgi" id="btn_filter_vastatements_dolgi" value="Найти">
                        <a class="btn btn-primary" href="statements_dolgi.php">Сбросить</a>
                    </div>
                </div> 
                
            </div>
        </div>
    </div>
</div>

<div id="result">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
            <table class="table table-hover table-bordered table-filter">
                <thead>
                    <tr class="active">
                        <th>№</th>
                        <th>Сессия</th>
                        <th>Группа</th>
                        <th>Учебный план</th>
                        <th>Дисциплина</th>
                        <th>Преподаватель</th>
                        <th>Ведомости</th>
                        <th class="text-center"></th>
                    </tr>
                </thead>
                <tbody>
                    <?php

                        $query =    "
                            SELECT DISTINCT
                                asu_session.session_id AS session_id,
                                CONCAT(asu_session.session_period,' ',asu_session.session_time) AS session_period,
                                asu_groups.group_id AS group_id,
                                asu_groups.group_number AS group_number,
                                asu_academic_plan.academic_plan_id AS academic_plan_id,
                                asu_academic_plan.academic_plan_name AS academic_plan_name,
                                clg_course.id AS fullname_id,
                                clg_course.fullname AS fullname,
                                CONCAT(teacher_surname,' ',teacher_name,' ',teacher_patronymic) AS teacher

                            FROM
                                asu_enrollee

                            LEFT JOIN asu_groups
                                ON asu_groups.group_id = asu_enrollee.enrollee_group_id

                            LEFT JOIN asu_academic_plan
                                ON asu_academic_plan.academic_plan_id = asu_groups.group_ac_plan_id

                            LEFT JOIN asu_content_discipline
                                ON asu_content_discipline.content_discipline_ac_plan_id = asu_academic_plan.academic_plan_id

                            LEFT JOIN asu_session
                                ON asu_session.session_id = asu_content_discipline.content_discipline_session

                            LEFT JOIN asu_load_teacher
                                ON asu_load_teacher.discipline_moodle_id = asu_content_discipline.moodle_id

                            LEFT JOIN asu_teacher
                                ON asu_teacher.teacher_id = asu_load_teacher.teacher_id

                            LEFT JOIN asu_grades
                                ON (asu_grades.moodle_student_id = asu_enrollee.moodle_id AND asu_grades.moodle_course_id = asu_content_discipline.moodle_id)

                            LEFT JOIN clg_course
                                ON clg_course.id = asu_content_discipline.moodle_id

                            WHERE
                                asu_content_discipline.moodle_id <> 0

                                AND (
                                    (asu_grades.grade NOT IN('н/я','Незачёт','2 (неуд.)','-')
                                    OR
                                    asu_grades.coursework_grade NOT IN('н/я','Незачёт','2 (неуд.)','-'))
                                    AND
                                    (STR_TO_DATE(DATE_FORMAT(asu_grades.grade_date, '%m/%d/%Y'), '%m/%d/%Y') > asu_session.session_end)
                                    AND (
                                        STR_TO_DATE(DATE_FORMAT(asu_grades.grade_date, '%m/%d/%Y'), '%m/%d/%Y') >= '2019-01-25'
                                        AND
                                        STR_TO_DATE(DATE_FORMAT(asu_grades.grade_date, '%m/%d/%Y'), '%m/%d/%Y') <= '2019-02-20'
                                    )
                                )

                                AND asu_enrollee.enrollee_status = 'Студент'

                            ORDER BY
                                clg_course.fullname

                        ";
                        /*
                        AND (
                            STR_TO_DATE(DATE_FORMAT(asu_grades.grade_date, '%m/%d/%Y'), '%m/%d/%Y') > asu_session.session_end
                        )
                        AND (
                            STR_TO_DATE(DATE_FORMAT(asu_grades.grade_date, '%m/%d/%Y'), '%m/%d/%Y') >= '2019-01-01'
                            AND
                            STR_TO_DATE(DATE_FORMAT(asu_grades.grade_date, '%m/%d/%Y'), '%m/%d/%Y') <= '2019-02-01'
                        )
                        */
                        // AND STR_TO_DATE(DATE_FORMAT(asu_grades.grade_date, '%m/%d/%Y'), '%m/%d/%Y') > DATE_ADD(asu_session.session_end, INTERVAL 14 DAY)
                        $select_all_discipline = mysqli_query($connection, $query);

                        while($row = mysqli_fetch_assoc($select_all_discipline)) {
                            $number++;

                            $session_id = $row['session_id'];
                            $session_period = $row['session_period'];

                            $group_id = $row['group_id'];
                            $group_number = $row['group_number'];

                            $academic_plan_id = $row['academic_plan_id'];
                            $academic_plan_name = $row['academic_plan_name'];

                            $fullname_id = $row['fullname_id'];
                            $fullname = $row['fullname'];
                            
                            $teacher = $row['teacher'];


                            echo "<tr>";
                            echo "<td>{$number}</td>";
                            echo "<td>{$session_period}</td>";
                            echo "<td>{$group_number}</td>";
                            echo "<td>{$academic_plan_name}</td>";
                            echo "<td>{$fullname}</td>";
                            echo "<td>{$teacher}</td>";

                            $query = "SELECT * FROM asu_statements 

                                        WHERE statements_session = {$session_id}
                                        AND statements_academic_plan = {$academic_plan_id}
                                        AND statements_group = {$group_id}
                                        AND statements_fullname = {$fullname_id}

                                    ";

                            echo "<td>";
                            $select_statements_by_data = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_statements_by_data)) {
                                $statements_id = $row['statements_id'];
                                $statements_date = $row['statements_date'];

                                echo "<a target='_blank' href='statements_dolgi.php?source=view_statement_dolgi&s_id={$statements_id}'>№{$statements_id} от {$statements_date}</a>";
                                echo "<br>";
                            }
                               
                            echo "</td>";

                            echo "<td class='text-center'>
                                    <a target='_blank' href='statements_dolgi.php?source=add_statement_dolgi&f_id={$fullname_id}&s_id={$session_id}&g_id={$group_id}&ap_id={$academic_plan_id}'>
                                        <i class='fa fa-plus-circle text-primary' aria-hidden='true'></i>
                                    </a>
                                </td>";
                            
                            echo "</tr>";

                        }
                    ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

