<?php

    $query = "SELECT * FROM asu_groups WHERE group_id = {$enrollee_group_id} ";
    $select_group_by_id = mysqli_query($connection, $query);

    $row = mysqli_fetch_assoc($select_group_by_id);

    $group_number = $row['group_number'];
    $group_ac_plan_id = $row['group_ac_plan_id'];

    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$group_ac_plan_id} ";
    $select_academic_plan_id = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_academic_plan_id)) {

        $academic_plan_id = $row['academic_plan_id'];
        $academic_plan_direction_id = $row['academic_plan_direction_id'];
        $academic_plan_period = $row['academic_plan_period'];
        $academic_plan_organization_id = $row['academic_plan_organization_id'];
        $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];
        $academic_plan_name = $row['academic_plan_name'];
        $academic_count_semesters = $row['academic_count_semesters'];
        $academic_plan_direction_id = $row['academic_plan_direction_id'];

    }

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-graduation-cap text-muted" aria-hidden="true"></i> 
            &nbsp;Учебный план:&nbsp;<?php echo $academic_plan_name; ?>
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        
        <?php 
            
            echo "<p>ID: $academic_plan_id</p>";
            
            $query = "SELECT * FROM asu_directions WHERE direction_id = {$academic_plan_direction_id}";
            $select_directions_id = mysqli_query($connection,$query);

            while($row = mysqli_fetch_assoc($select_directions_id)) {

                $direction_code = $row['direction_code'];
                $direction_title = $row['direction_title'];

                echo "<p><b>Направление:</b>&nbsp;{$direction_code}&nbsp;{$direction_title}</p>";

            }
        
        
            $query = "SELECT * FROM asu_basic_education WHERE basic_education_id = {$academic_plan_basic_education_id}";
            $select_basic_education_id = mysqli_query($connection,$query);

            while($row = mysqli_fetch_assoc($select_basic_education_id)) {

                $basic_education_title = $row['basic_education_title'];

                echo "<p><b>Базовое образование:</b>&nbsp;{$basic_education_title}</p>";
            }
        
            echo "<p><b>Срок обучения:</b>&nbsp;{$academic_plan_period}";
        ?>
        <br>
        <br>
        <a href="./academic_plan.php?source=add_additional_discipline&a_id=<?php echo $group_ac_plan_id; ?>&e_id=<?php echo $the_enrollee_id; ?>" class="btn btn-success"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp;Добавить дополнительную дисциплину</a>
        
    </div>
</div>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <ul class="nav nav-tabs">
            <?php 

                for($i=1; $i <= $academic_plan_period; $i++) {
                    
                    if($i == $current_sem) {
                        echo "<li class='active'>
                                <a href='#semester{$i}' data-toggle='tab'>
                                    <i class='fa fa-check-circle text-success' aria-hidden='true'></i>
                                    Семестр № {$i}
                                </a>
                            </li>";
                    } else {
                        echo "<li><a href='#semester{$i}' data-toggle='tab'>Семестр № {$i}</a></li>";
                    }
                    
                } 

            ?>
        </ul>
    </div>
</div>
<br>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

        <!-- Tab panes -->
        <div class="tab-content">
            <?php 
                for($i=1; $i <= $academic_plan_period; $i++) {
                    
                    $number = 0;
                    
                    if($i == $current_sem) {
                        echo "<div class='tab-pane active' id='semester{$i}'>";
                    } else {
                        echo "<div class='tab-pane' id='semester{$i}'>";                        
                    }
            
            
            ?>
                    
                        
                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr class="active">
                                    <th>№</th>
                                    <th>Дисциплина АСУ</th>
                                    <th>Дисциплина Moodle</th>
                                    <th>Семестр</th>
                                    <th>Курс</th>
                                    <th>Часы</th>
                                    <th>Аудит. часы</th>
                                    <th>Сам. часы</th>
                                    <th>Лек. часы</th>
                                    <th>Практ. часы</th>
                                    <th>Лаб. часы</th>
                                    <th>Курс. часы</th>
                                    <th>Курсовая работа</th>
                                    <th>Тип итогового контроля</th>
                                    <th class="text-center">ID</th>
                                </tr>
                            </thead>
                            <tbody>

                               <?php

                                    $query = "SELECT * FROM asu_content_discipline WHERE content_discipline_ac_plan_id = {$group_ac_plan_id} AND content_discipline_semester = {$i} ";
                                    $select_content_discipline_by_id = mysqli_query($connection, $query);

                                    while($row = mysqli_fetch_assoc($select_content_discipline_by_id)) {
                                        $number++;
                                        
                                        $content_discipline_id = $row['content_discipline_id'];
                                        $content_discipline_d_id = $row['content_discipline_d_id'];
                                        $content_discipline_semester = $row['content_discipline_semester'];
                                        $content_discipline_courses = $row['content_discipline_courses'];
                                        $content_discipline_hour = $row['content_discipline_hour'];
                                        $content_discipline_hour_audience = $row['content_discipline_hour_audience'];
                                        $content_discipline_hour_independent = $row['content_discipline_hour_independent'];
                                        $content_discipline_hour_lecture = $row['content_discipline_hour_lecture'];
                                        $content_discipline_hour_practice = $row['content_discipline_hour_practice'];
                                        $content_discipline_hour_laboratory = $row['content_discipline_hour_laboratory'];
                                        $content_discipline_hour_courses = $row['content_discipline_hour_courses'];
                                        $content_discipline_course_work = $row['content_discipline_course_work'];
                                        $content_discipline_control = $row['content_discipline_control'];
                                        $moodle_discipline_id = $row['moodle_id'];

                                        echo "<tr>";
                                        echo "<td>{$number}</td>";
                                        $query = "SELECT * FROM  asu_disciplines WHERE discipline_id = {$content_discipline_d_id} ";
                                        $select_discipline_by_id = mysqli_query($connection, $query);

                                        while($row = mysqli_fetch_assoc($select_discipline_by_id)) {

                                            $discipline_title = $row['discipline_title'];

                                            echo "<td>{$discipline_title}</td>";

                                        }
                                        
                                        if(!empty($moodle_discipline_id)) {
                                            $query = "SELECT * FROM clg_course WHERE id = {$moodle_discipline_id} ";
                                            $select_course_by_id = mysqli_query($connection, $query);

                                            while($row = mysqli_fetch_assoc($select_course_by_id)) {
                                                
                                                $id = $row['id'];
                                                $fullname = $row['fullname'];
                                                
                                                $query = "SELECT * FROM clg_user_enrolments
                                                INNER JOIN clg_enrol ON clg_user_enrolments.enrolid = clg_enrol.id
                                                WHERE clg_enrol.courseid = {$id} AND clg_user_enrolments.userid = {$moodle_id}";
                                                
                                                $select = mysqli_query($connection, $query);
                                                $row = mysqli_fetch_assoc($select);
                                                
                                                $courseid = $row['courseid'];
                                                
                                                if(isset($courseid)) {
                                                    echo "<td>
                                                        <div class='pull-left'>{$fullname}</div>
                                                        <div class='pull-right text-success'>
                                                            <i class='fa fa-check' aria-hidden='true'></i>
                                                        </div>
                                                    </td>";
                                                } else {
                                                    echo "<td><div class='pull-left'>{$fullname}</div></td>";
                                                }
                                                
                                            }
                                        } else {
                            
                                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                        }
                                      
                                        echo "<td>{$content_discipline_semester}</td>";
                                        echo "<td>{$content_discipline_courses}</td>";
                                        echo "<td>{$content_discipline_hour}</td>";
                                        echo "<td>{$content_discipline_hour_audience}</td>";
                                        echo "<td>{$content_discipline_hour_independent}</td>";
                                        echo "<td>{$content_discipline_hour_lecture}</td>";
                                        echo "<td>{$content_discipline_hour_practice}</td>";
                                        echo "<td>{$content_discipline_hour_laboratory}</td>";
                                        echo "<td>{$content_discipline_hour_courses}</td>";
                                        echo "<td>{$content_discipline_course_work}</td>";
                                        echo "<td>{$content_discipline_control}</td>";
                                        echo "<td class='text-center'>{$content_discipline_id}</td>";

                                        echo "</tr>";

                                    } 

                                ?>
                            </tbody>
                        </table>
                        <h3>Дополнительные дисциплины индивидуального учебного плана</h3>
                        <br>
                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr class="active">
                                    <th>№</th>
                                    <th>Дисциплина АСУ</th>
                                    <th>Дисциплина Moodle</th>
                                    <th>Семестр</th>
                                    <th>Курс</th>
                                    <th>Часы</th>
                                    <th>Аудит. часы</th>
                                    <th>Сам. часы</th>
                                    <th>Лек. часы</th>
                                    <th>Практ. часы</th>
                                    <th>Лаб. часы</th>
                                    <th>Курс. часы</th>
                                    <th>Курсовая работа</th>
                                    <th>Тип итогового контроля</th>
                                    <th class="text-center">ID</th>
                                    <th><i class='fa fa-trash' aria-hidden='true'></i></th>
                                </tr>
                            </thead>
                            <tbody>
                               
                                <?php
                    
                                    $query =    "   SELECT *
                                    
                                                    FROM asu_additional_discipline
                                                    WHERE additional_discipline_enrollee_id =  {$the_enrollee_id}
                                                    AND additional_discipline_semester = {$i}
                                                    AND additional_discipline_ac_plan_id = {$group_ac_plan_id}
                                                   
                                                ";
                    
                                    $select_additional_discipline_by_id = mysqli_query($connection, $query);
                    
                                    while($row = mysqli_fetch_assoc($select_additional_discipline_by_id)) {
                                        $number++;
                                        
                                        $additional_discipline_id = $row['additional_discipline_id'];
                                        $additional_discipline_d_id = $row['additional_discipline_d_id'];
                                        $additional_discipline_semester = $row['additional_discipline_semester'];
                                        $additional_discipline_courses = $row['additional_discipline_courses'];
                                        $additional_discipline_hour = $row['additional_discipline_hour'];
                                        $additional_discipline_hour_audience = $row['additional_discipline_hour_audience'];
                                        $additional_discipline_hour_independent = $row['additional_discipline_hour_independent'];
                                        $additional_discipline_hour_lecture = $row['additional_discipline_hour_lecture'];
                                        $additional_discipline_hour_practice = $row['additional_discipline_hour_practice'];
                                        $additional_discipline_hour_laboratory = $row['additional_discipline_hour_laboratory'];
                                        $additional_discipline_hour_courses = $row['additional_discipline_hour_courses'];
                                        $additional_discipline_course_work = $row['additional_discipline_course_work'];
                                        $additional_discipline_control = $row['additional_discipline_control'];
                                        $additional_discipline_moodle_id = $row['additional_discipline_moodle_id'];

                                        echo "<tr id='add_d_{$additional_discipline_id}'>";
                                        echo "<td>{$number}</td>";
                                        $query = "SELECT * FROM  asu_disciplines WHERE discipline_id = {$additional_discipline_d_id} ";
                                        $select_discipline_by_id = mysqli_query($connection, $query);

                                        while($row = mysqli_fetch_assoc($select_discipline_by_id)) {

                                            $discipline_title = $row['discipline_title'];

                                            echo "<td>{$discipline_title}</td>";

                                        }
                                        
                                        if(!empty($additional_discipline_moodle_id) && $additional_discipline_moodle_id != 0) {
                                            $query = "SELECT * FROM clg_course WHERE id = {$additional_discipline_moodle_id} ";
                                            $select_course_by_id = mysqli_query($connection, $query);

                                            while($row = mysqli_fetch_assoc($select_course_by_id)) {
                                                
                                                $id = $row['id'];
                                                $fullname = $row['fullname'];
                                                
                                                $query = "SELECT * FROM clg_user_enrolments
                                                INNER JOIN clg_enrol ON clg_user_enrolments.enrolid = clg_enrol.id
                                                WHERE clg_enrol.courseid = {$id} AND clg_user_enrolments.userid = {$moodle_id}";
                                                
                                                $select = mysqli_query($connection, $query);
                                                $row = mysqli_fetch_assoc($select);
                                                
                                                $courseid = $row['courseid'];
                                                
                                                if(isset($courseid)) {
                                                    echo "<td>
                                                        <div class='pull-left'>{$fullname}</div>
                                                        <div class='pull-right text-success'>
                                                            <i class='fa fa-check' aria-hidden='true'></i>
                                                        </div>
                                                    </td>";
                                                } else {
                                                    echo "<td><div class='pull-left'>{$fullname}</div></td>";
                                                }
                                                
                                            }
                                        } else {
                            
                                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                                        }
                                      
                                        echo "<td>{$additional_discipline_semester}</td>";
                                        echo "<td>{$additional_discipline_courses}</td>";
                                        echo "<td>{$additional_discipline_hour}</td>";
                                        echo "<td>{$additional_discipline_hour_audience}</td>";
                                        echo "<td>{$additional_discipline_hour_independent}</td>";
                                        echo "<td>{$additional_discipline_hour_lecture}</td>";
                                        echo "<td>{$additional_discipline_hour_practice}</td>";
                                        echo "<td>{$additional_discipline_hour_laboratory}</td>";
                                        echo "<td>{$additional_discipline_hour_courses}</td>";
                                        echo "<td>{$additional_discipline_course_work}</td>";
                                        echo "<td>{$additional_discipline_control}</td>";
                                        echo "<td class='text-center'>{$additional_discipline_id}</td>";
                                        echo "<td><a class='text-danger' href='#' onclick='delete_add_d({$additional_discipline_id})'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";

                                        echo "</tr>";

                                    } 
                                    
                                ?>
                               
                            </tbody>
                        </table>
                    
                    
                        
            <?php echo "</div>"; } ?>

        </div>
    </div>
</div>
<br>
<br>
<br>

<script>
    function delete_add_d(id){
        var url = "<?= "$siteprefix/admin/queries/delete_additional_discipline.php?id="; ?>" + id;
        $.ajax({
            type: 'GET',
            url: url,
            success: function ( data ) {
                alert(data);
                $( "#add_d_" + id ).remove();
                return false;
            },
            error: function ( data ) {
                var msg = 'Ошибка: ' + data.responseText;
                alert(msg);
                // console.log( msg );
                return false;
            }
        });
    }
</script>



<?php

/*if(isset($_GET['delete'])) {
    
    $the_content_discipline_id = $_GET['delete'];
    
    $query = "DELETE FROM asu_content_discipline WHERE content_discipline_id = {$the_content_discipline_id} ";
    
    $delete_query = mysqli_query($connection, $query);
    
    header("Location: ./academic_plan.php?source=view_academic_plan&a_id={$the_academic_plan_id}");
    
}*/

?>

