<?php

    if(isset($_POST['create_enrollee'])) {
        
        
        $enrollee_image = $_FILES['image']['name'];
        $enrollee_image_temp = $_FILES['image']['tmp_name'];
        
        
        $enrollee_surname = $_POST['enrollee_surname'];
        $enrollee_name = $_POST['enrollee_name'];
        $enrollee_patronymic = $_POST['enrollee_patronymic'];
        $enrollee_date_birth = $_POST['enrollee_date_birth'];
        $enrollee_sex = $_POST['enrollee_sex'];
        $enrollee_region_id = $_POST['enrollee_region_id'];
        $enrollee_phone = $_POST['enrollee_phone'];
        $enrollee_email = $_POST['enrollee_email'];
        $enrollee_location = $_POST['enrollee_location'];
        
        $enrollee_education = $_POST['enrollee_education'];
        $enrollee_language = $_POST['enrollee_language'];
        
        $enrollee_doc_education = $_POST['enrollee_doc_education'];
        $enrollee_doc_number = $_POST['enrollee_doc_number'];
        $enrollee_date_docextradition = $_POST['enrollee_date_docextradition'];
        $enrollee_institution = $_POST['enrollee_institution'];
        $enrollee_basic_document = $_POST['enrollee_basic_document'];
        
        
        $enrollee_identification = $_POST['enrollee_identification'];
        $enrollee_series = $_POST['enrollee_series'];
        $enrollee_number_identification = $_POST['enrollee_number_identification'];
        $enrollee_issued_by = $_POST['enrollee_issued_by'];
        $enrollee_date_issue = $_POST['enrollee_date_issue'];
        $enrollee_place_registration = $_POST['enrollee_place_registration'];
        $enrollee_snils = $_POST['enrollee_snils'];
        $enrollee_average_score = $_POST['enrollee_average_score'];
        
        
        $enrollee_file_diploma = $_FILES['file_diploma']['name'];
        $enrollee_file_diploma_temp = $_FILES['file_diploma']['tmp_name'];
        
        $enrollee_file_passport = $_FILES['file_passport']['name'];
        $enrollee_file_passport_temp = $_FILES['file_passport']['tmp_name'];
        
        $enrollee_date = date('d-m-y');
        
        $current_sem = 1;
        
        move_uploaded_file($enrollee_image_temp, "images/$enrollee_image");
        move_uploaded_file($enrollee_file_diploma_temp, "file/$enrollee_file_diploma");
        move_uploaded_file($enrollee_file_passport_temp, "file/$enrollee_file_passport");

    
        $query = "INSERT INTO asu_enrollee(enrollee_image, enrollee_surname, enrollee_name, enrollee_patronymic, enrollee_date_birth, enrollee_sex, enrollee_region_id, enrollee_phone, enrollee_email, enrollee_location, enrollee_education, enrollee_language, enrollee_doc_education,enrollee_doc_number, enrollee_date_docextradition, enrollee_institution, enrollee_basic_document, enrollee_identification, enrollee_series, enrollee_number_identification, enrollee_issued_by, enrollee_date_issue, enrollee_place_registration, enrollee_snils, enrollee_average_score, enrollee_file_diploma, enrollee_file_passport, current_sem, enrollee_date) ";
    
        $query .= "VALUES('{$enrollee_image}', '{$enrollee_surname}', '{$enrollee_name}', '{$enrollee_patronymic}', '{$enrollee_date_birth}', '{$enrollee_sex}', {$enrollee_region_id}, '{$enrollee_phone}', '{$enrollee_email}', '{$enrollee_location}', '{$enrollee_education}', '{$enrollee_language}', '{$enrollee_doc_education}', '{$enrollee_doc_number}', '{$enrollee_date_docextradition}', '{$enrollee_institution}', '{$enrollee_basic_document}', '{$enrollee_identification}', '{$enrollee_series}', '{$enrollee_number_identification}', '{$enrollee_issued_by}', '{$enrollee_date_issue}', '{$enrollee_place_registration}', '{$enrollee_snils}', '{$enrollee_average_score}', '{$enrollee_file_diploma}', '{$enrollee_file_passport}', {$current_sem}, now()) ";
    
        $create_enrollee_query = mysqli_query($connection,$query);
        
    
//        confirmQuery($create_enrollee_query);
    
        $the_enrollee_id = mysqli_insert_id($connection);
    
        $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";
        
        header("refresh: 1; url=./enrollee.php");
        
}

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-id-card-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Форма создания личного дела
        </h1>
    </div>
</div>  
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <a href="enrollee.php" class="btn btn-default">
            <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
        </a>
    </div>
</div>
<?php echo $message; ?>
  
<form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
<input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

    <h3 class="page-header text-primary"><i class="fa fa-info-circle fa-fw" aria-hidden="true"></i>&nbsp;Личная информация</h3>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_image">Фото абитуриента</label><br>
            <img class="img-thumbnail" src="images/bg_photo.jpg" width="150" alt="photo">
            <input type="file" name="image">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_surname">Фамилия <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="enrollee_surname" required>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_name">Имя <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="enrollee_name" required>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_patronymic">Отчество</label>
            <input type="text" class="form-control" name="enrollee_patronymic">
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-4">
            <label for="enrollee_date_birth">Дата рождения <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="date" class="form-control" name="enrollee_date_birth" required>
        </div>
    </div>  

    <div class="form-group">
        <div class="col-sm-4">
            <label for="enrollee_sex">Пол</label>
            <select name="enrollee_sex" id="" class="form-control">
                <option value="">Выбрать пол</option>
                <option value="Мужской">Мужской</option>
                <option value="Женский">Женский</option>
            </select>
        </div>
    </div> 

    <h3 class="page-header text-primary"><i class="fa fa-map-marker fa-fw" aria-hidden="true"></i>&nbsp;Место жительства и контактные данные </h3>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_phone">Телефон <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="enrollee_phone" required>
        </div>
    </div> 
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_email">E-mail</label>
            <input type="email" class="form-control" name="enrollee_email">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">            
            <label for="enrollee_region_id">Регион</label>

                <select name="enrollee_region_id" class="form-control" id="enrollee_region_id">

                <?php
                    
                    if ($_SESSION['user_role_id'] == 1) {
                    
                        $query = "SELECT * FROM asu_region ORDER BY region_title";
                        $select_region = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_region)) {

                            $region_id = $row['region_id'];
                            $region_title = $row['region_title'];

                            echo "<option value='$region_id'>{$region_title}</option>";

                        }
                    } else {
                        
                        $user_region_id = $_SESSION['user_region_id'];
                        
                        $query = "SELECT * FROM asu_region WHERE region_id = {$user_region_id} ";
                        $select_region_by_id = mysqli_query($connection,$query);
                        
                        $row = mysqli_fetch_assoc($select_region_by_id);
                        
                        $region_id = $row['region_id'];
                        $region_title = $row['region_title'];
                        
                        echo "<option value='$region_id'>{$region_title}</option>";
                        
                    }

                ?>
                </select>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_location">Место жительства <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="enrollee_location" required>
        </div>
    </div>
    
    <h3 class="page-header text-primary"><i class="fa fa-graduation-cap fa-fw" aria-hidden="true"></i>&nbsp;Образование</h3>
    <div class="form-group">
        <div class="col-sm-4">
            <label for="enrollee_education">Базовое образование</label>
            <select name="enrollee_education" id="" class="form-control">

                <option value="">Выбрать</option>
                <option value="Высшее">Высшее</option>
                <option value="Основное общее образование">Основное общее образование</option>
                <option value="Среднее">Начальное профессиональное образование</option>
                <option value="Среднее общее образование">Среднее общее образование</option>

            </select>
        </div>

        <div class="col-sm-4">
            <label for="enrollee_language">Иностранный язык</label>
            <select name="enrollee_language" id="" class="form-control">

                <option value="">Выбрать язык</option>
                <option value="Английский">Английский</option>
                <option value="Немецкий">Немецкий</option>

            </select>
        </div>
        
    </div>
    
    <div class="form-group">
        <div class="col-sm-4">
            <label for="enrollee_doc_education">Документ:</label>
            <select name="enrollee_doc_education" id="" class="form-control">

                <option value="">Выбрать документ</option>
                <option value="Аттестат о среднем (полном) общем образовании (дубликат)">Аттестат о среднем (полном) общем образовании (дубликат)</option>
                <option value="Аттестат об основном общем образовании">Аттестат об основном общем образовании</option>
                <option value="Аттестат о среднем образовании">Аттестат о среднем образовании</option>
                <option value="Диплом о начальном профессиональном образовании">Диплом о начальном профессиональном образовании</option>

            </select>
        </div>
        <div class="col-sm-4">
            <label for="enrollee_doc_number">Номер и серия:</label>
            <input type="text" class="form-control" name="enrollee_doc_number">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-4">
            <label for="enrollee_date_docextradition">Дата выдачи:</label>
            <input type="date" class="form-control" name="enrollee_date_docextradition">
        </div>
        
        <div class="col-sm-4">
            <label for="enrollee_average_score">Средний балл <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="enrollee_average_score" required>
        </div>
    </div>
    
    <div class="checkbox">
        <label>
            <input type="checkbox" name="enrollee_basic_document" value="1"> Основной документ
        </label>
    </div>
    <br>
    
    
    <div class="form-group">
        <div class="col-sm-8">
            <label for="enrollee_institution">Учебное заведение:</label>
            <input type="text" class="form-control" name="enrollee_institution">
        </div>
    </div>
    
<!--
    <div class="form-group">
        <div class="col-sm-12">
            <div class="well">
                <label for="enrollee_file_diploma"><i class="fa fa-paperclip" aria-hidden="true"></i> Копия документа об образовании</label>
                <input type="file" name="file_diploma">
            </div>
        </div>
    </div>
-->
    
    <h3 class="page-header text-primary"><i class="fa fa-id-card-o fa-fw" aria-hidden="true"></i>&nbsp;Паспортные данные</h3>
    
    <div class="form-group">
        <div class="col-sm-4">
            <label for="enrollee_identification">Документ <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <select name="enrollee_identification" id="" class="form-control" required>

                <option value="">Выбрать</option>
                <option value="Паспорт гражданина РФ">Паспорт гражданина РФ</option>
                <option value="Паспорт гражданина иностранного государства">Паспорт гражданина иностранного государства</option>
                <option value="Временное удостоверение личности">Временное удостоверение личности</option>
                <option value="Военный билет">Военный билет</option>

            </select>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_series">Серия</label>
            <input type="text" class="form-control" name="enrollee_series">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_number_identification">Номер <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="enrollee_number_identification" required>
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_issued_by">Кем выдан</label>
            <input type="text" class="form-control" name="enrollee_issued_by">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-4">
            <label for="enrollee_date_issue">Дата выдачи</label>
            <input type="date" class="form-control" name="enrollee_date_issue">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_place_registration">Место регистрации</label>
            <input type="text" class="form-control" name="enrollee_place_registration">
        </div>
    </div>
    
    <div class="form-group">
        <div class="col-sm-12">
            <label for="enrollee_snils">СНИЛС <i class="fa fa-exclamation-triangle text-danger" aria-hidden="true" title="Обязательное поле для заполнения"></i></label>
            <input type="text" class="form-control" name="enrollee_snils" required>
        </div>
    </div>
    
    
<!--
    <div class="form-group">
        <div class="col-sm-12">
            <div class="well">
                <label for="enrollee_file_passport"><i class="fa fa-paperclip" aria-hidden="true"></i> Копия паспорта</label>
                <input type="file" name="file_passport">
            </div>
        </div>
    </div>
-->
    
    <div class="form-group">
        
        <div class="col-sm-12">
            <div class="page-header"></div>
            <input class="btn btn-primary" type="submit" name="create_enrollee" value="Добавить">
        </div>
    </div>  
    
</form>