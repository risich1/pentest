<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-users fa-fw text-muted" aria-hidden="true"></i>&nbsp;Абитуриенты
        </h1>
    </div>
</div>

<?php

    if(isset($_POST['submit'])) {
        
        $enrollee_surname = $_POST['enrollee_surname'];
        
        if($_SESSION['user_role_id'] == 2) {
            $enrollee_region_id = $_SESSION['user_role_id'];
        } else {
            $enrollee_region_id = $_POST['enrollee_region_id'];
        }
        

        $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'Абитуриент' AND enrollee_surname LIKE '%$enrollee_surname%' AND enrollee_region_id LIKE '%$enrollee_region_id%' ";

        $search_query = mysqli_query($connection, $query);

        if(!$search_query) {

            die("QUERY FAILED" . mysqli_error($connection));

        }

        $count = mysqli_num_rows($search_query);

        if($count == 0) {

            $message = "<div class='alert alert-success'>По Вашему поисковому запросу ни чего не найдено.</div>";

        } else {
            $message = "<div class='alert alert-success'><b>Результат поиска</b>
                        <p>Найдено: {$count}</p></div>";
        }
    
            
?> 


<form action="" method="post" class="form-horizontal well">
    <div class="form-group">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
           <h4><i class="fa fa-filter" aria-hidden="true"></i> Поиск</h4> 
        </div>
    </div>
    <div class="form-group">
        <div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
            <input name="enrollee_surname" type="text" class="form-control" placeholder="Фамилия" value="<?php echo $enrollee_surname; ?>">
        </div>
    </div>
    <?php if($_SESSION['user_role_id'] == 1) { ?>
        <div class="form-group">
            <div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
                <select name="enrollee_region_id" class="form-control" id="enrollee_region_id" value="<?php echo $enrollee_region_id; ?>">

                        <?php

                            if($enrollee_region_id) {

                                $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                                $select_region_by_id = mysqli_query($connection,$query);

                                $row = mysqli_fetch_assoc($select_region_by_id);

                                $region_id = $row['region_id'];
                                $region_title = $row['region_title'];

                                echo "<option value='{$region_id}'>{$region_title}</option>";
                                echo "<option value=''>Все . . . </option>";

                                $query = "SELECT * FROM asu_region";
                                $select_region = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_region)) {

                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    echo "<option value='{$region_id}'>{$region_title}</option>";

                                }

                            } else {
                                echo "<option value=''>Выбрать . . . </option>";

                                $query = "SELECT * FROM asu_region";
                                $select_region = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_region)) {

                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    echo "<option value='{$region_id}'>{$region_title}</option>";

                                }
                            }            



                        ?>
                </select>
            </div>
        </div>
    <?php } ?>
    <button class="btn btn-primary" name="submit" type="submit">Найти</button>
    <a href="enrollee.php" class="btn btn-default">Сбросить</a>
</form>

<?php echo $message; ?>

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-group">
            <a class="btn btn-primary" href="./enrollee.php?source=add_enrollee"><i class="fa fa-user-plus fa-fw" aria-hidden="true"></i>&nbsp; Добавить абитуриента</a>
        </div>
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
        <table class="table table-hover table-bordered table-filter">
            <thead>
                <tr class="active">
                    <th>Фамилия</th>
                    <th>Имя</th>
                    <th>Отчество</th>
                    <th>Статус</th>
                    <th>Регион</th>
                    <th class="text-center">ID</th>
                    <th class="text-center">Личное дело</th>
                    <th class="text-center">Редактировать</th>
                    <?php if($_SESSION['user_role_id'] == 1) { ?>
                        <th class="text-center">Удалить</th>
                    <?php } ?>
                </tr>
            </thead>
            <tbody>
                    <?php

                        if($_SESSION['user_role_id'] == 1) {


                            while($row = mysqli_fetch_assoc($search_query)) {

                                $enrollee_id = $row['enrollee_id'];
                                $enrollee_surname = $row['enrollee_surname'];
                                $enrollee_name = $row['enrollee_name'];
                                $enrollee_patronymic = $row['enrollee_patronymic'];
                                $enrollee_status = $row['enrollee_status'];
                                $enrollee_region_id = $row['enrollee_region_id'];

                                echo "<tr>";
                                echo "<td>{$enrollee_surname}</td>";
                                echo "<td>{$enrollee_name}</td>";
                                echo "<td>{$enrollee_patronymic}</td>";
                                echo "<td>{$enrollee_status}</td>";

                                $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                                $select_region_id = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_region_id)) {
                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    echo "<td>{$region_title}</td>";
                                }

                                echo "<td class='text-center'>{$enrollee_id}</td>";
                                echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                                echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=edit_enrollee&e_id={$enrollee_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";
                                echo "<td class='text-center'><a class='text-danger' href='enrollee.php?delete={$enrollee_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
                                echo "</tr>";

                            }

                        } else {

                            if(isset($_SESSION['user_login'])) {

                                $user_region_id = $_SESSION['user_region_id'];

                                $query = "SELECT * FROM asu_enrollee WHERE enrollee_region_id = {$user_region_id} AND enrollee_status = 'Абитуриент' ";
                                $select_all_enrollee = mysqli_query($connection, $query);

                                while($row = mysqli_fetch_assoc($select_all_enrollee)) {

                                    $enrollee_id = $row['enrollee_id'];
                                    $enrollee_surname = $row['enrollee_surname'];
                                    $enrollee_name = $row['enrollee_name'];
                                    $enrollee_patronymic = $row['enrollee_patronymic'];
                                    $enrollee_status = $row['enrollee_status'];
                                    $enrollee_region_id = $row['enrollee_region_id'];

                                    echo "<tr>";
                                    echo "<td>{$enrollee_surname}</td>";
                                    echo "<td>{$enrollee_name}</td>";
                                    echo "<td>{$enrollee_patronymic}</td>";
                                    echo "<td>{$enrollee_status}</td>";

                                    $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                                    $select_region_id = mysqli_query($connection,$query);

                                    while($row = mysqli_fetch_assoc($select_region_id)) {
                                        $region_id = $row['region_id'];
                                        $region_title = $row['region_title'];

                                        echo "<td>{$region_title}</td>";
                                    }

                                    echo "<td class='text-center'>{$enrollee_id}</td>";
                                    echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                                    echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=edit_enrollee&e_id={$enrollee_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";

                                    if($_SESSION['user_role_id'] == 1) {
                                        echo "<td class='text-center'><a class='text-danger' href='enrollee.php?delete={$enrollee_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
                                    }
                                    echo "</tr>";

                                }
                            }
                        }
                    ?>


            </tbody>
        </table>
    </div>
</div>

<?php

    if(isset($_GET['delete'])) {

        $the_enrollee_id = $_GET['delete'];

        $query = "DELETE FROM asu_enrollee WHERE enrollee_id = {$the_enrollee_id} ";

        $delete_query = mysqli_query($connection, $query);

        header("Location: enrollee.php");

    }

} else {

?>

<form action="" method="post" class="form-horizontal well">
    <div class="form-group">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
           <h4><i class="fa fa-filter" aria-hidden="true"></i> Поиск</h4> 
        </div>
    </div>
    <div class="form-group">
        <div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
            <input name="enrollee_surname" type="text" class="form-control" placeholder="Фамилия" >
        </div>
    </div>
    <?php if($_SESSION['user_role_id'] == 1) { ?>
        <div class="form-group">
            <div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
                <select name="enrollee_region_id" class="form-control" id="enrollee_region_id">
                    <option value="">Выбрать регион . . . </option>
                        <?php     

                            $query = "SELECT * FROM asu_region ORDER BY region_title ";
                            $select_region = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_region)) {

                                $region_id = $row['region_id'];
                                $region_title = $row['region_title'];

                                echo "<option value='{$region_id}'>{$region_title}</option>";

                            }

                        ?>
                </select>
            </div>
        </div>
    <?php } ?>

    <button class="btn btn-primary" name="submit" type="submit">Найти</button>
    <a href="enrollee.php" class="btn btn-default">Сбросить</a>
    
</form>
 

<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-group">
            <a class="btn btn-primary" href="./enrollee.php?source=add_enrollee"><i class="fa fa-user-plus fa-fw" aria-hidden="true"></i>&nbsp; Добавить абитуриента</a>
        </div>
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
        <table class="table table-hover table-bordered table-filter">
        <thead>
            <tr class="active">
                <th>Фамилия</th>
                <th>Имя</th>
                <th>Отчество</th>
                <th>Статус</th>
                <th>Регион</th>
                <th class="text-center">ID</th>
                <th class="text-center">Личное дело</th>
                <th class="text-center">Редактировать</th>
                <?php if($_SESSION['user_role_id'] == 1) { ?>
                    <th class="text-center">Удалить</th>
                <?php } ?>
            </tr>
        </thead>
        <tbody>
                <?php
                    
                    if($_SESSION['user_role_id'] == 1) {
                        
                        
                        $query = "SELECT * FROM asu_enrollee WHERE enrollee_status = 'Абитуриент'";
                        $select_all_enrollee = mysqli_query($connection, $query);

                        while($row = mysqli_fetch_assoc($select_all_enrollee)) {

                            $enrollee_id = $row['enrollee_id'];
                            $enrollee_surname = $row['enrollee_surname'];
                            $enrollee_name = $row['enrollee_name'];
                            $enrollee_patronymic = $row['enrollee_patronymic'];
                            $enrollee_status = $row['enrollee_status'];
                            $enrollee_region_id = $row['enrollee_region_id'];

                            echo "<tr>";
                            echo "<td>{$enrollee_surname}</td>";
                            echo "<td>{$enrollee_name}</td>";
                            echo "<td>{$enrollee_patronymic}</td>";
                            echo "<td>{$enrollee_status}</td>";

                            $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                            $select_region_id = mysqli_query($connection,$query);

                            while($row = mysqli_fetch_assoc($select_region_id)) {
                                $region_id = $row['region_id'];
                                $region_title = $row['region_title'];

                                echo "<td>{$region_title}</td>";
                            }

                            echo "<td class='text-center'>{$enrollee_id}</td>";
                            echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                            echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=edit_enrollee&e_id={$enrollee_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";
                            echo "<td class='text-center'><a class='text-danger' href='enrollee.php?delete={$enrollee_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
                            echo "</tr>";

                        }
                        
                    } else {

                        if(isset($_SESSION['user_login'])) {

                            $user_region_id = $_SESSION['user_region_id'];

                            $query = "SELECT * FROM asu_enrollee WHERE enrollee_region_id = {$user_region_id} AND enrollee_status = 'Абитуриент' ";
                            $select_all_enrollee = mysqli_query($connection, $query);

                            while($row = mysqli_fetch_assoc($select_all_enrollee)) {

                                $enrollee_id = $row['enrollee_id'];
                                $enrollee_surname = $row['enrollee_surname'];
                                $enrollee_name = $row['enrollee_name'];
                                $enrollee_patronymic = $row['enrollee_patronymic'];
                                $enrollee_status = $row['enrollee_status'];
                                $enrollee_region_id = $row['enrollee_region_id'];

                                echo "<tr>";
                                echo "<td>{$enrollee_surname}</td>";
                                echo "<td>{$enrollee_name}</td>";
                                echo "<td>{$enrollee_patronymic}</td>";
                                echo "<td>{$enrollee_status}</td>";

                                $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                                $select_region_id = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_region_id)) {
                                    $region_id = $row['region_id'];
                                    $region_title = $row['region_title'];

                                    echo "<td>{$region_title}</td>";
                                }

                                echo "<td class='text-center'>{$enrollee_id}</td>";
                                echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                                echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=edit_enrollee&e_id={$enrollee_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";
                                
                                if($_SESSION['user_role_id'] == 1) {
                                    echo "<td class='text-center'><a class='text-danger' href='enrollee.php?delete={$enrollee_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
                                }
                                echo "</tr>";

                            }
                        }
                    }
                ?>


        </tbody>
        </table>
    </div>
</div>

<?php

    if(isset($_GET['delete'])) {

        $the_enrollee_id = $_GET['delete'];

        $query = "DELETE FROM asu_enrollee WHERE enrollee_id = {$the_enrollee_id} ";

        $delete_query = mysqli_query($connection, $query);

        header("Location: enrollee.php");

    }
} 

?>