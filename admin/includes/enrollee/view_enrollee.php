<?php
require_once("../includes/db.php");

$link_page = $_SERVER['REQUEST_URI']; 


if(isset($_GET['e_id'])) {
    
    $the_enrollee_id = $_GET['e_id'];
    
}

if(isset($_GET['link_p'])) {
    $the_link_p = $_GET['link_p'];
}


$query = "SELECT *,DATE_FORMAT(enrollee_date_issue, '%d.%m.%Y' ) de FROM asu_enrollee WHERE enrollee_id = {$the_enrollee_id} ";
$select_enrollee_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {

    
    $enrollee_id = $row['enrollee_id'];
    
    $enrollee_image = $row['enrollee_image'];
        
    $enrollee_surname = $row['enrollee_surname'];
    $enrollee_name = $row['enrollee_name'];
    $enrollee_patronymic = $row['enrollee_patronymic'];
    $enrollee_date_birth = $row['enrollee_date_birth'];
    $enrollee_sex = $row['enrollee_sex'];
    $enrollee_status = $row['enrollee_status'];
    $enrollee_region_id = $row['enrollee_region_id'];
    $enrollee_phone = $row['enrollee_phone'];
    $enrollee_email = $row['enrollee_email'];
    
    $enrollee_location = $row['enrollee_location'];
    $enrollee_education = $row['enrollee_education'];
    $enrollee_doc_education = $row['enrollee_doc_education'];
    $enrollee_doc_number = $row['enrollee_doc_number'];
    $enrollee_date_docextradition = $row['enrollee_date_docextradition'];
    $enrollee_institution = $row['enrollee_institution'];
    $enrollee_basic_document = $row['enrollee_basic_document'];
    
    $enrollee_language = $row['enrollee_language'];
    $enrollee_identification = $row['enrollee_identification'];
    $enrollee_series = $row['enrollee_series'];
    $enrollee_number_identification = $row['enrollee_number_identification'];
    $enrollee_issued_by = $row['enrollee_issued_by'];
    $enrollee_date_issue = $row['de'];
    $enrollee_place_registration = $row['enrollee_place_registration'];
    $enrollee_file_diploma = $row['enrollee_file_diploma'];
    $enrollee_file_passport = $row['enrollee_file_passport'];
    $enrollee_group_id = $row['enrollee_group_id'];
    $enrollee_snils = $row['enrollee_snils'];
    $enrollee_average_score = $row['enrollee_average_score'];
    $moodle_id = $row['moodle_id'];
    $current_sem = $row['current_sem'];
    
    $enrollee_date = $row['enrollee_date'];
    
}

$query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
$select_region_id = mysqli_query($connection,$query);

while($row = mysqli_fetch_assoc($select_region_id)) {
    
    $region_title = $row['region_title'];
    
}

$query = "SELECT * FROM asu_treaty WHERE treaty_enrollee_id = {$the_enrollee_id}";
$select_all_treaty = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_all_treaty)) {

    $treaty_id = $row['treaty_id'];
    $treaty_number = $row['treaty_number'];
    $treaty_plan_id = $row['treaty_plan_id'];
    
}

$query = "SELECT * FROM asu_groups WHERE group_id = {$enrollee_group_id} ";
$select_group_by_id = mysqli_query($connection, $query);

while($row = mysqli_fetch_assoc($select_group_by_id)) {

    $group_number = $row['group_number'];
    $group_ac_plan_id = $row['group_ac_plan_id'];
        
    $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$group_ac_plan_id} ";
    $select_academic_plan_by_id = mysqli_query($connection, $query);

    while($row = mysqli_fetch_assoc($select_academic_plan_by_id)) {

        $academic_plan_direction_id = $row['academic_plan_direction_id'];
        $academic_plan_period = $row['academic_plan_period'];   
        $academic_plan_basic_education_id = $row['academic_plan_basic_education_id'];   
        $academic_plan_name = $row['academic_plan_name']; 
        $academic_plan_organization_id = $row['academic_plan_organization_id']; 
        
        $query = "SELECT * FROM asu_directions WHERE direction_id = {$academic_plan_direction_id} ";
        $select_direction_by_id = mysqli_query($connection, $query);

        while($row = mysqli_fetch_assoc($select_direction_by_id)) {
        
            $direction_code = $row['direction_code'];
            $direction_title = $row['direction_title']; 
        
        }

        $query = "SELECT * FROM asu_organizations WHERE organization_id = {$academic_plan_organization_id} ";
        $select_organization_by_id = mysqli_query($connection, $query);

        while($row = mysqli_fetch_assoc($select_organization_by_id)) {
        
            $organization_title = $row['organization_title'];
        
        }
        
        
        
        $query = "SELECT * FROM asu_basic_education WHERE basic_education_id = {$academic_plan_basic_education_id} ";
        $select_basic_education_by_id = mysqli_query($connection, $query);

        while($row = mysqli_fetch_assoc($select_basic_education_by_id)) {
        
            $basic_education_title = $row['basic_education_title'];
        
        }
    }
}

?>
<script>
    
    // This update pages
    
    setInterval(function(){
        if(flag_updateGradeBoook)  {       
            updateGradeBoook();
            flag_updateGradeBoook = false;
            }   
                    
    }, 1000);
    
    
    // Update pages code function ends
                
    function updateGradeBoook() {
        
        var enrollee_id = <?php echo $enrollee_id; ?>;
        var moodle_id = <?php echo $moodle_id; ?>;
        var enrollee_group_id = <?php echo $enrollee_group_id; ?>;
        var current_sem = <?php echo $current_sem; ?>;
		
		var site = <?php echo "'$siteprefix/admin/queries/grades/grade_book.php'"; ?>;
        
        $.ajax({

            url: site,
            data:{enrollee_id:enrollee_id, moodle_id:moodle_id, enrollee_group_id:enrollee_group_id, current_sem: current_sem},
            type: 'POST',
            success: function(update_grade) {

                if(!update_grade.error) {

                    $("#grade-book").html(update_grade);

                }

            } 
        }); 
        
        flag_updateGradeBoook = true;

    }// End function updateCars


</script>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-address-card fa-fw text-muted" aria-hidden="true"></i>&nbsp;Личное дело № <?php echo $the_enrollee_id; ?>
            <small>Регион: <?php echo $region_title; ?></small>
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-group">
           <?php 
                if(isset($_GET['link_page'])) {
                    
                    $link_page = $_GET['link_page'];
                    
                    if(isset($_GET['o_id'])) {
                        $o_id = $_GET['o_id']; 
                        $link_page .= "&o_id={$o_id}";
                    } 
                    echo "<a href='{$link_page}' class='btn btn-success'>";
                } else {
                    echo "<a href='personal_things.php' class='btn btn-success'>";
                        
                }
            ?>
                    <i class="fa fa-arrow-circle-o-left fa-fw" aria-hidden="true"></i>&nbsp;Вернуться  
                </a>
            
            <a class="btn btn-success" href="enrollee.php?source=edit_enrollee&e_id=<?php echo $the_enrollee_id; ?>"><i class="fa fa-pencil-square-o fa-fw" aria-hidden="true"></i>&nbsp; Редактировать</a>
            
            <?php if(!$treaty_number) { ?>
                <a class="btn btn-primary" href="treaty.php?source=add_treaty&e_id=<?php echo $the_enrollee_id; ?>"><i class="fa fa-handshake-o fa-fw" aria-hidden="true"></i>&nbsp; Заключить договор</a>
            <?php } else { ?>
                <a class="btn btn-primary" href="treaty.php?source=view_treaty&treaty_id=<?php echo $treaty_id; ?>&link_page=<?php echo $link_page; ?>"><i class="fa fa-handshake-o fa-fw" aria-hidden="true"></i>&nbsp; Договор</a>
            <?php } ?>
        </div>
    </div>
</div>

<br>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        
        <ul class="nav nav-tabs">
            <li class='active'><a href='#personal_information' data-toggle='tab'>&nbsp;Личная информация</a></li>
            <li><a href='#personal_academic_plan' data-toggle='tab'>&nbsp;Учебный план</a></li>
            <li><a href='#personal_record_book' data-toggle='tab'>&nbsp;Зачетная книжка</a></li>
        </ul>
        <!-- Tab panes -->
  
    </div>
</div>
<div class="tab-content">
    <div class='tab-pane active' id='personal_information'>
        <?php require_once "personal_information.php"; ?>
    </div>
    <div class='tab-pane' id='personal_academic_plan'>
        <?php require_once "personal_academic_plan.php"; ?>
    </div>
    <div class='tab-pane' id='personal_record_book'>
        <?php require_once "personal_record_book.php"; ?>
    </div>
</div>
