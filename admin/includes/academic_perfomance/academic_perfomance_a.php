
<?php 

    if($_SESSION['user_role_id'] == 1) { 
        
    } else {
        header('Location: ./personal_things.php');
    }

?>


<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 table-responsive>" id="result">                         
    <table class="table table-hover table-bordered table-condensed table-filter">
    <thead>
        <tr class="active">
            <th>№</th>
            <th>
                Ф.И.О.<br><small>Личное дело, контакты</small>
            </th>
            <th class="text-center">Семестр №1</th>
            <th class="text-center">Семестр №2</th>
            <th class="text-center">Семестр №3</th>
            <th class="text-center">Семестр №4</th>
            <th class="text-center">Семестр №5</th>
            <th class="text-center">Семестр №6</th>
            <th class="text-center">Семестр №7</th>
            <th class="text-center">Семестр №8</th>
            <th class="text-center">Семестр №9</th>            

            <th class="text-center">ID</th>

        </tr>
    </thead>
    <tbody>

        <?php

            $query = "
                        SELECT
                            clg_user.id AS user_id,
                            CONCAT(enrollee_surname,' ',enrollee_name,' ',enrollee_patronymic) enrollee,
                            asu_enrollee.enrollee_id AS enrollee_id,
                            asu_enrollee.enrollee_phone AS phone,
                            
                            asu_enrollee.current_sem AS current_sem,
                            asu_semesters.semester_title AS semester,
                            
                            asu_region.region_title AS region,

                            CONCAT(asu_session.session_period,' ',asu_session.session_time) session,

                            FROM_UNIXTIME(clg_user.lastaccess, '%d.%m.%Y %H:%i:%s') lastaccess,
                            clg_user.email AS email,
                            asu_groups.group_number AS group_number,

                            asu_payment.payment_status AS payment_status,
                            asu_payment.payment_number AS payment_number,
                            DATE_FORMAT(asu_payment.payment_create_date, '%d.%m.%Y') payment_create_date,
                            asu_payment.payment_cost AS payment_cost


                            FROM asu_enrollee
                            LEFT JOIN clg_user
                                ON asu_enrollee.moodle_id = clg_user.id
                            LEFT JOIN asu_session
                                ON asu_enrollee.enrollee_session_id = asu_session.session_id
                            LEFT JOIN asu_region
                                ON asu_enrollee.enrollee_region_id = asu_region.region_id
                            LEFT JOIN asu_groups
                                ON asu_enrollee.enrollee_group_id = asu_groups.group_id
                            LEFT JOIN asu_semesters
                                ON  asu_enrollee.current_sem = asu_semesters.semester_id
                            LEFT JOIN asu_payment
                                ON  asu_enrollee.current_sem = asu_payment.payment_semester_id 
                                AND asu_enrollee.enrollee_id = asu_payment.payment_enrollee_id

                            WHERE asu_enrollee.enrollee_status = 'Студент'

                    ";

            
            $select_all_students = mysqli_query($connection, $query);

            if(!$select_all_students) {

                die("QUERY FAILED ." . mysqli_error($connection));

            }
            // current date
            $date = date('d.m.Y');

            while($row = mysqli_fetch_assoc($select_all_students)) {

                $number++;
                $user_id = $row['user_id'];
                $enrollee = $row['enrollee'];
                $enrollee_id = $row['enrollee_id'];
                $lastaccess = $row['lastaccess'];
                $semester = $row['semester'];
                $current_sem = $row['current_sem'];
                $session = $row['session'];
                $region = $row['region'];
                $group = $row['group_number'];
                $phone = $row['phone'];
                $email = $row['email'];
                
                $payment_status = $row['payment_status'];
                $payment_number = $row['payment_number'];
                $payment_create_date = $row['payment_create_date'];
                $payment_cost = $row['payment_cost'];
                
                $avg_grade = round($row['avg_grade']);

                $interval = intval(abs(strtotime($date) - strtotime($lastaccess)));

                // amount of days
                $interval = round($interval / (3600 * 24));

                // count test in grades

                $query =   " SELECT  

                                COUNT(clg_quiz_grades.userid) AS count_test_in_grades

                                FROM clg_quiz_grades
                                WHERE clg_quiz_grades.userid = {$user_id};

                            ";
                $count_test_for_user = mysqli_query($connection, $query);
                $row = mysqli_fetch_assoc($count_test_for_user);

                $count_test_in_grades = $row['count_test_in_grades'];

                // count test

                $query =    "   SELECT 

                                    COUNT(clg_quiz.name) AS count_test

                                    FROM clg_user_enrolments
                                    LEFT JOIN clg_enrol
                                        ON clg_user_enrolments.enrolid = clg_enrol.id
                                    LEFT JOIN clg_course
                                        ON clg_enrol.courseid = clg_course.id
                                    LEFT JOIN clg_quiz
                                        ON clg_course.id = clg_quiz.course
                                    WHERE clg_enrol.enrol='manual' AND clg_user_enrolments.userid = {$user_id}
                            ";

                $count_test_for_user = mysqli_query($connection, $query);
                $row = mysqli_fetch_assoc($count_test_for_user);

                $count_test = $row['count_test'];

                // average greade
                $query = "SELECT SUM(clg_quiz_grades.grade) AS sum_grade FROM clg_quiz_grades WHERE clg_quiz_grades.userid = {$user_id}";

                $avg_grade_by_id = mysqli_query($connection, $query);
                $row = mysqli_fetch_assoc($avg_grade_by_id);

                $sum_grade = $row['sum_grade'];
                
                $avg_grade = $sum_grade / $count_test;
                
                $avg_grade = round($avg_grade,2);
                
                echo "<tr>";
                echo "<td>{$number}</td>";
                echo "  <td>
                            <div class ='pull-left'>{$enrollee}</div>
                            <div class='pull-right'>
                                
                                <a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true' title = 'Личное дело'> </i></a>
                                <a href='#' class='text-muted' rel='popover' data-content='{$phone}<br>{$email}' data-original-title='Контакты'>
                                    <i class='fa fa-phone-square' aria-hidden='true' title = 'Контакты'></i>
                                </a>
                            </div>

                        </td>";

                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                echo "<td class='text-center'>-</td>";
                
                echo "</tr>";

            }


        ?>

        </tbody>
    </table>

    </div>
</div>

