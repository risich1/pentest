<?php
	require_once("../includes/db.php");
	
	if(isset($_GET['enrol_course']) && isset($_GET['enrol_student'])) {
		$course_id = $_GET['enrol_course'];
		$user_id = $_GET['enrol_student'];
	}

	if(isset($course_id)) {
		$query="SELECT MAX(id) AS id FROM clg_user_enrolments";
		$max_enrol = mysqli_query($connection, $query); 
		$max_enrol = mysqli_fetch_assoc($max_enrol);
		$max_enrol = $max_enrol['id'] + 1;

		$query="SELECT clg_enrol.id AS id FROM clg_enrol WHERE clg_enrol.courseid = {$course_id} AND clg_enrol.enrol = 'manual'";
		$enrol_id = mysqli_query($connection, $query); 
		$enrol_id = mysqli_fetch_assoc($enrol_id);
		$enrol_id = $enrol_id['id'];

		$query="
			SELECT
				clg_user_enrolments.id AS id
			FROM
				clg_user_enrolments
			WHERE
				clg_user_enrolments.enrolid = {$enrol_id} AND clg_user_enrolments.userid = {$user_id}
		";
		$exist_id = mysqli_query($connection, $query);
		$exist_id = mysqli_fetch_assoc($exist_id);
		$exist_id = $exist_id['id'];

		if (is_null($exist_id)) {
			$query = "
			INSERT INTO clg_user_enrolments (
				`id`,
				`status`,
				`enrolid`,
				`userid`,
				`timestart`,
				`timeend`,
				`modifierid`,
				`timecreated`,
				`timemodified`
			)
			VALUES (
				{$max_enrol},
				'0',
				{$enrol_id},
				{$user_id},
				'0',
				'0',
				'0',
				'0',
				'0'
			)
			";
			mysqli_query($connection, $query);
			$linkk = $link."/admin/debtors.php";
			header($linkk);
		}
		else {
			echo "A student has been already enrolled";
		}
	}
	else {
		echo "Such course is not available.";
	}
?>