<?php
	$query = "
		SELECT
		    asu_enrollee.moodle_id                                     AS student_id,
		    asu_enrollee.enrollee_surname                              AS student_surname,
		    asu_enrollee.enrollee_name                                 AS student_name,
		    asu_enrollee.enrollee_patronymic                           AS student_patronymic,
		    asu_enrollee.current_sem                                   AS student_semester,
		    asu_content_discipline.moodle_id                           AS course_id,
		    clg_course.fullname                           			   AS course_name,
		    asu_content_discipline.content_discipline_semester         AS course_semester,
		    asu_grades.grade                                           AS course_grade,
		    asu_grades.coursework_grade                                AS coursework_grade,
		    asu_session.session_period								   AS session_period,
		    asu_session.session_time 								   AS session_time

		FROM
		    asu_enrollee

		LEFT JOIN asu_groups
		    ON asu_groups.group_id = asu_enrollee.enrollee_group_id

		LEFT JOIN asu_academic_plan
		    ON asu_academic_plan.academic_plan_id = asu_groups.group_ac_plan_id

		LEFT JOIN asu_content_discipline
		    ON asu_content_discipline.content_discipline_ac_plan_id = asu_academic_plan.academic_plan_id

		LEFT JOIN asu_grades
		    ON (
		        asu_grades.moodle_student_id = asu_enrollee.moodle_id
		        AND
		        asu_grades.moodle_course_id = asu_content_discipline.moodle_id
		    )

		LEFT JOIN asu_session
		    ON asu_session.session_id = asu_content_discipline.content_discipline_session

		LEFT JOIN clg_course
		    ON clg_course.id = asu_content_discipline.moodle_id

		WHERE
		    (asu_grades.grade IN('н/я','Незачёт','2 (неуд.)','-') OR asu_grades.coursework_grade IN('н/я','Незачёт','2 (неуд.)','-'))
		    AND asu_enrollee.enrollee_status = 'Студент'
		    AND asu_content_discipline.moodle_id  != 0
			AND (
				asu_session.debtors=1 OR asu_grades.grade = '-' OR asu_grades.coursework_grade = '-'
			)
	";
	/*
				(asu_session.session_period = 'Осенний' AND asu_session.session_time = '2018/2019')
				OR 
				(asu_session.session_period = 'Весенний' AND asu_session.session_time = '2018/2019')
	*/
	$debtors = mysqli_query($connection, $query);

	echo '
	<div class="row">
    	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id="result">                           
        	<table class="table table-hover table-bordered table-filter">
            	<thead>
                	<tr class="active">
                    	<th>Фамилия</th>
                    	<th>Имя</th>
                    	<th>Отчество</th>
                    	<th>Семестр обучения</th>
                    	<th>Долговая дисциплина</th>
                    	<th>Семестр дисциплины</th>
                    	<th>Оценка</th>
                    	<th>Оценка за курсовую работу</th>
						<th>Дисциплина на пересдачу</th>
                    	<th>Запись на пересдачу</th>
                	</tr>
            	</thead>
            	<tbody>
    ';
    while($row = mysqli_fetch_assoc($debtors)) {
				$course_name = preg_split("#_#", $row['course_name']);
				$course_name = $course_name[0].'_d1';
				$query = "
					SELECT
						clg_course.id,
						clg_course.fullname
					FROM
						clg_course
					WHERE
						clg_course.category = 6
						AND
						clg_course.fullname = '{$course_name}'
				";
				$course_name = mysqli_fetch_assoc(mysqli_query($connection, $query));
    			echo "
    				<tr>
    					<td>{$row['student_surname']}</td>
    					<td>{$row['student_name']}</td>
    					<td>{$row['student_patronymic']}</td>
    					<td>{$row['student_semester']}</td>
    					<td>{$row['course_name']}</td>
    					<td>{$row['course_semester']}</td>
    					<td>{$row['course_grade']}</td>
    					<td>{$row['coursework_grade']}</td>
				";
				if (!$course_name['fullname']) {
						echo '<td></td>';
						echo "<td class='text-center'><i class='fa fa-times-circle text-danger' aria-hidden='true' title='Дисциплина не создана в СДО'></i></td>";
				}
				else {
						echo "<td>{$course_name['fullname']}</td>";
						$query = "
							SELECT
								clg_user_enrolments.id AS id,
								clg_user_enrolments.userid AS user_id,
								clg_course.id AS course_id
							FROM
								clg_user_enrolments
							LEFT JOIN clg_enrol
								ON clg_enrol.id = clg_user_enrolments.enrolid
							LEFT JOIN clg_course
								ON clg_course.id = clg_enrol.courseid
							WHERE
								clg_user_enrolments.userid = {$row['student_id']}
						";
						$student_courses = mysqli_query($connection, $query);
						$count = 0;
						while ($student_course = mysqli_fetch_assoc($student_courses)) {
							if ($course_name['id'] == $student_course['course_id']) {
								$count = 1;
								echo "<td class='text-center'><i class='text-success fa fa-check-circle text-muted' aria-hidden='true' title='Студент записан на курс'></i></td>";
								break;
							}
							else {
								
							}
						}
						if ($count == 0) {
								echo "<td class='text-center'><a class='text-primary' href='./debtors.php?source=enrol_debtor&enrol_student={$row['student_id']}&enrol_course={$course_name['id']}'><i class='fa fa-plus-circle' aria-hidden='true' title='Записать студента'></i></a></td>";
						}
				}
				echo "
					</tr>
    			";
    }
    echo '
            	</tbody>
        	</table>
    	</div>
	</div>
	';
?>