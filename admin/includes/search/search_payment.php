<?php include "../includes/db.php"; ?>
<?php include "includes/header.php"; ?>
    
<div id="wrapper">

    <?php include "includes/navigation.php"; ?>

        <div id="page-wrapper">

            <div class="container-fluid">

                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="page-header">
                            <h4>Поиск</h4>
                        </div>
                        <form action="../admin/includes/search/search_payment.php" class="form-horizontal" method="post" enctype="multipart/form-data">
                            <div class="form-group">
                                <div class="col-sm-6">
                                    <label for="payment_number">Фамилия</label>
                                    <input type="text" class="form-control"  name="surname">
                                </div>

                                <div class="col-sm-6">
                                    <label for="payment_semester_id">Семестр</label>
                                    <select name="payment_semester_id" id="" class="form-control">
                                        <?php 

                                            $query = "SELECT * FROM asu_semesters";
                                            $select_all_semester = mysqli_query($connection, $query);

                                            while($row = mysqli_fetch_assoc($select_all_semester)) {

                                                $semester_id = $row['semester_id'];
                                                $semester_title = $row['semester_title'];

                                                echo "<option value='{$semester_id}'>{$semester_title}</option>";

                                            }

                                        ?>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="col-sm-6">
                                    <label for="payment_number">Договор</label>
                                    <input type="text" class="form-control"  name="surname">
                                </div>

                                <div class="col-sm-6">
                                    <label for="payment_create_date">Статус оплаты</label>
                                    <select name="payment_semester_id" id="" class="form-control">
                                        <option value=''>Оплачено</option>
                                        <option value=''>Не оплачено   </option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="col-sm-12">

                                    <input class="btn btn-primary" type="submit" name="search_payment" value="Найти">
                                </div>
                            </div>   

                        </form>
                    </div>
                </div>
                <br>
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

  
                    <?php
                        if(isset($_POST['search_payment'])) {

                            $payment_semester_id = $_POST['payment_semester_id'];

                            $query = "SELECT * FROM asu_payment WHERE payment_semester_id LIKE '%$payment_semester_id%' ";

                            $search_payment_query = mysqli_query($connection, $query);

                            if(!$search_payment_query) {

                                die("QUERY FAILED" . mysqli_error($connection));

                            }

                            $count = mysqli_num_rows($search_payment_query);

                            if($count == 0) {

                                echo "<h4> По Вашему поисковому запросу ни чего не найдено. </h4>";

                            } else {
                                echo "<h4>Результат поиска</h4>" . "<br>";
                                echo "<p>Найдено: {$count}</p>";

                    ?>
                    
                    <table class="table table-hover table-bordered">
                        <thead>
                            <tr class="active">
                                <th>Номер договора</th>
                                <th>Дата заключения	</th>
                                <th>Ф.И.О.</th>
                                <th>Семестр</th>
                                <th>Срок оплаты</th>
                                <th>Стоимость, руб.</th>
                                <th class="text-center">Статус оплаты</th>
                                <th class="text-center">№ док. об оплате, дата</th>
                        <!--        <th class="text-center">Подробнее</th>-->
                        <!--
                                <th class="text-center">Редактировать</th>
                                <th class="text-center">Удалить</th>
                        -->
                            </tr>
                        </thead>
                        <tbody>

                        <?php


                            $query = "SELECT * FROM asu_treaty";
                            $select_all_treaty = mysqli_query($connection, $query);

                            while($row = mysqli_fetch_assoc($select_all_treaty)) {

                                $treaty_id = $row['treaty_id'];
                                $treaty_number = $row['treaty_number'];
                                $treaty_date_conclusion = $row['treaty_date_conclusion'];
                                $treaty_count_semesters = $row['treaty_count_semesters'];
                                $treaty_autumn_date = $row['treaty_autumn_date'];
                                $treaty_spring_date = $row['treaty_spring_date'];
                                $treaty_cost = $row['treaty_cost'];
                                $treaty_semester_id = $row['treaty_semester_id'];
                                $treaty_status = $row['treaty_status'];
                                $treaty_plan_id = $row['treaty_plan_id'];
                                $treaty_enrollee_id = $row['treaty_enrollee_id'];

                                $treaty_autumn_date_1 = $row['treaty_autumn_date_1'];
                                $treaty_autumn_date_3 = $row['treaty_autumn_date_3'];
                                $treaty_autumn_date_5 = $row['treaty_autumn_date_5'];
                                $treaty_autumn_date_7 = $row['treaty_autumn_date_7'];
                                $treaty_autumn_date_9 = $row['treaty_autumn_date_9'];

                                $treaty_spring_date_2 = $row['treaty_spring_date_2'];
                                $treaty_spring_date_4 = $row['treaty_spring_date_4'];
                                $treaty_spring_date_6 = $row['treaty_spring_date_6'];
                                $treaty_spring_date_8 = $row['treaty_spring_date_8'];


                                $treaty_payment_status_1 = $row['treaty_payment_status_1'];
                                $treaty_payment_status_2 = $row['treaty_payment_status_2'];
                                $treaty_payment_status_3 = $row['treaty_payment_status_3'];
                                $treaty_payment_status_4 = $row['treaty_payment_status_4'];
                                $treaty_payment_status_5 = $row['treaty_payment_status_5'];
                                $treaty_payment_status_6 = $row['treaty_payment_status_6'];
                                $treaty_payment_status_7 = $row['treaty_payment_status_7'];
                                $treaty_payment_status_8 = $row['treaty_payment_status_8'];
                                $treaty_payment_status_9 = $row['treaty_payment_status_9'];

                                
                                
                                
                                if($i || $j) {
                                    $query = "SELECT * FROM asu_semesters WHERE semester_id = {$i} ";
                                            $select_semester_by_id = mysqli_query($connection, $query);

                                            while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                                $semester_title = $row['semester_title'];

                                                    echo "<tr>";       
                                                    echo "<td>{$treaty_number}</td>";
                                                    echo "<td>{$treaty_date_conclusion}</td>";

                                                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id} ";
                                                    $select_enrollee_by_id = mysqli_query($connection, $query);

                                                    while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {
                                                        $enrollee_surname = $row['enrollee_surname'];
                                                        $enrollee_name = $row['enrollee_name'];
                                                        $enrollee_patronymic = $row['enrollee_patronymic'];

                                                        echo "<td>{$enrollee_surname} {$enrollee_name} {$enrollee_patronymic}</td>";
                                                    }



                                                    echo "<td>{$semester_title}</td>";
                                                    echo "<td>${treaty_autumn_date_.$i}</td>";
                                                    echo "<td>{$treaty_cost}</td>";
                                                    echo "<td>${treaty_payment_status_.$i}</td>";

                                                    if(!${treaty_payment_status_.$i}) {
                                                        echo "<td>-</td>";
                                                    } else {
                                                    $query = "SELECT * FROM asu_payment WHERE payment_semester_id = {$i} AND payment_treaty_id =  {$treaty_id}";
                                                    $select_payment_semester_by_id = mysqli_query($connection, $query);

                                                    while($row = mysqli_fetch_assoc($select_payment_semester_by_id)) {

                                                        $payment_number = $row['payment_number'];
                                                        $payment_create_date = $row['payment_create_date'];

                                                        echo "<td>{$payment_number}, {$payment_create_date}</td>";
                                                    }
                                                    }
                                                    echo "</tr>";

                                                } // while
                                    
                                    
                                                 $query = "SELECT * FROM asu_semesters WHERE semester_id = {$j} ";
                                            $select_semester_by_id = mysqli_query($connection, $query);

                                            while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                                $semester_title = $row['semester_title'];

                                                    echo "<tr>";
                                                    echo "<td>{$treaty_number}</td>";
                                                    echo "<td>{$treaty_date_conclusion}</td>";

                                                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id} ";
                                                    $select_enrollee_by_id = mysqli_query($connection, $query);

                                                    while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {
                                                        $enrollee_surname = $row['enrollee_surname'];
                                                        $enrollee_name = $row['enrollee_name'];
                                                        $enrollee_patronymic = $row['enrollee_patronymic'];

                                                        echo "<td>{$enrollee_surname} {$enrollee_name} {$enrollee_patronymic}</td>";
                                                    }

                                                    echo "<td>{$semester_title}</td>";
                                                    echo "<td>${treaty_spring_date_.$j}</td>";
                                                    echo "<td>{$treaty_cost}</td>";
                                                    echo "<td>${treaty_payment_status_.$j}</td>";

                                                    if(!${treaty_payment_status_.$j}) {
                                                        echo "<td>-</td>";
                                                    } else {
                                                    $query = "SELECT * FROM asu_payment WHERE payment_semester_id = {$j} AND payment_treaty_id =  {$treaty_id} ";
                                                    $select_payment_semester_by_id = mysqli_query($connection, $query);

                                                    while($row = mysqli_fetch_assoc($select_payment_semester_by_id)) {

                                                        $payment_number = $row['payment_number'];
                                                        $payment_create_date = $row['payment_create_date'];

                                                        echo "<td>{$payment_number}, {$payment_create_date}</td>";
                                                    }
                                                    }
                                                    echo "</tr>";
                                                } // while
                                } else {
                                
                                
                                $query = "SELECT * FROM asu_academic_plan WHERE academic_plan_id = {$treaty_plan_id}";
                                $select_all_academic_plan = mysqli_query($connection,$query);

                                while($row = mysqli_fetch_assoc($select_all_academic_plan)) {

                                    $academic_plan_period = $row['academic_plan_period'];

                                    for($i=1, $j=2; $i <= $academic_plan_period, $j <= $academic_plan_period; $i++, $j++) {


                                        if ($i % 2) { 

                                            $query = "SELECT * FROM asu_semesters WHERE semester_id = {$i} ";
                                            $select_semester_by_id = mysqli_query($connection, $query);

                                            while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                                $semester_title = $row['semester_title'];

                                                    echo "<tr>";       
                                                    echo "<td>{$treaty_number}</td>";
                                                    echo "<td>{$treaty_date_conclusion}</td>";

                                                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id} ";
                                                    $select_enrollee_by_id = mysqli_query($connection, $query);

                                                    while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {
                                                        $enrollee_surname = $row['enrollee_surname'];
                                                        $enrollee_name = $row['enrollee_name'];
                                                        $enrollee_patronymic = $row['enrollee_patronymic'];

                                                        echo "<td>{$enrollee_surname} {$enrollee_name} {$enrollee_patronymic}</td>";
                                                    }



                                                    echo "<td>{$semester_title}</td>";
                                                    echo "<td>${treaty_autumn_date_.$i}</td>";
                                                    echo "<td>{$treaty_cost}</td>";
                                                    echo "<td>${treaty_payment_status_.$i}</td>";

                                                    if(!${treaty_payment_status_.$i}) {
                                                        echo "<td>-</td>";
                                                    } else {
                                                    $query = "SELECT * FROM asu_payment WHERE payment_semester_id = {$i} AND payment_treaty_id =  {$treaty_id}";
                                                    $select_payment_semester_by_id = mysqli_query($connection, $query);

                                                    while($row = mysqli_fetch_assoc($select_payment_semester_by_id)) {

                                                        $payment_number = $row['payment_number'];
                                                        $payment_create_date = $row['payment_create_date'];

                                                        echo "<td>{$payment_number}, {$payment_create_date}</td>";
                                                    }
                                                    }
                                                    echo "</tr>";

                                                }   



                                            $query = "SELECT * FROM asu_semesters WHERE semester_id = {$j} ";
                                            $select_semester_by_id = mysqli_query($connection, $query);

                                            while($row = mysqli_fetch_assoc($select_semester_by_id)) {

                                                $semester_title = $row['semester_title'];

                                                    echo "<tr>";
                                                    echo "<td>{$treaty_number}</td>";
                                                    echo "<td>{$treaty_date_conclusion}</td>";

                                                    $query = "SELECT * FROM asu_enrollee WHERE enrollee_id = {$treaty_enrollee_id} ";
                                                    $select_enrollee_by_id = mysqli_query($connection, $query);

                                                    while($row = mysqli_fetch_assoc($select_enrollee_by_id)) {
                                                        $enrollee_surname = $row['enrollee_surname'];
                                                        $enrollee_name = $row['enrollee_name'];
                                                        $enrollee_patronymic = $row['enrollee_patronymic'];

                                                        echo "<td>{$enrollee_surname} {$enrollee_name} {$enrollee_patronymic}</td>";
                                                    }

                                                    echo "<td>{$semester_title}</td>";
                                                    echo "<td>${treaty_spring_date_.$j}</td>";
                                                    echo "<td>{$treaty_cost}</td>";
                                                    echo "<td>${treaty_payment_status_.$j}</td>";

                                                    if(!${treaty_payment_status_.$j}) {
                                                        echo "<td>-</td>";
                                                    } else {
                                                    $query = "SELECT * FROM asu_payment WHERE payment_semester_id = {$j} AND payment_treaty_id =  {$treaty_id} ";
                                                    $select_payment_semester_by_id = mysqli_query($connection, $query);

                                                    while($row = mysqli_fetch_assoc($select_payment_semester_by_id)) {

                                                        $payment_number = $row['payment_number'];
                                                        $payment_create_date = $row['payment_create_date'];

                                                        echo "<td>{$payment_number}, {$payment_create_date}</td>";
                                                    }
                                                    }
                                                    echo "</tr>";
                                                }

                                            } //if
                                        } 
                                        }
                                    }

                                }
                            }

                        ?>


                            </tbody>
                        </table>
                    
                    
                    
                    </div>
                </div>
                <!-- /.row -->

            </div>
            <!-- /.container-fluid -->

        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

<?php include "includes/footer.php"; ?>