<?php 
		require_once("../includes/db.php");

        if($_SESSION['user_role_id'] == 1) {
            include "includes/menu_deanery.php"; 
        }

        $query = "SELECT * FROM asu_enrollee WHERE enrollee_status != 'Архив' ";
        $select_all_enrollee = mysqli_query($connection, $query);
         
?>    

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-address-book fa-fw text-muted" aria-hidden="true"></i>&nbsp;Личные дела
        </h1>
    </div>
</div>
<?php if($_SESSION['user_role_id'] == 1 || $_SESSION['user_role_id'] == 3) { ?>
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h2><i class="fa fa-filter" aria-hidden="true"></i> Фильтр</h2>
                </div>

                <div class="panel-footer form-horizontal">

                    <div class="form-group">
                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                            <label for="">Фамилия студента</label>
                            <input name="filter_name" id="filter_name" type="text" class="form-control" value="" placeholder="Фамилия">
                        </div>
                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                            <label for="">Семестр</label>
                            <select name="filter_semester" id="filter_semester" class="form-control"  value="">
                                <option value=''>Все семестры</option>
                                <?php selectSemestersForList(); ?>
                            </select>
                        </div>
                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                            <label for="">Период обучения</label>
                            <select name="filter_period" class="form-control" id="filter_period" value="">
                                <option value=''>Все периоды обучения</option>
                                <?php selectSessionForList(); ?>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                            <label for="">Регион</label>
                            <select name="filter_region" class="form-control" id="filter_region" value="">
                                <option value=''>Все регионы</option>
                                <?php selectRegionsForList(); ?>
                            </select>
                        </div>

                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                            <label for="">Группа</label>
                            <select name="filter_group" class="form-control" id="filter_group" value="">
                                <option value=''>Все группы</option>
                                <?php selectGroupsForList(); ?>
                            </select>
                        </div>

                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                            <label for="">Год</label>
                            <select name="filter_year" class="form-control" id="filter_year" value="">
                                <option value=''>Все года</option>
                                <?php selectYearForList(); ?>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-12">
                            <input class="btn btn-primary" type="submit" name="btn_filter" id="btn_filter_personal_things" value="Найти">
                            <a class="btn btn-primary" href="personal_things.php">Сбросить</a>
                        </div>
                    </div> 
                </div>
            </div>
        </div>
    </div>

<?php echo $message ?? ''; ?>
<?php } ?>
<br>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id="result">                           
        <table class="table table-hover table-bordered table-filter">
            <thead>
                <tr class="active">
                    <th>№</th>
                    <th>Фамилия</th>
                    <th>Имя</th>
                    <th>Отчество</th>
                    <th>Статус</th>
                    <?php
                        if($_SESSION['user_role_id'] == 1) {
		                    echo '<th>В архив</th>';
                        }
                    ?>
                    <th>Семестр</th>
                    <th>Регион</th>
                    <th>Логин в СДО</th>
                    <?php if($_SESSION['user_role_id'] == 1) {
                        echo "<th>Статус в СДО</th>";
                    }?>
                    <th class="text-center">ID</th>
                    <th class="text-center">Личное дело</th>
                    <th class="text-center">Редактировать</th>
                </tr>
            </thead>
            <tbody>

                <?php

                    if($_SESSION['user_role_id'] == 1) {
				// 
				
				//
                        } else {
                            if(isset($_SESSION['user_region_id'])) {
                                $user_region_id = $_SESSION['user_region_id'];
                                $query = "SELECT * FROM asu_enrollee WHERE enrollee_region_id = {$user_region_id} AND enrollee_status != 'Архив'";
                                $select_all_enrollee = mysqli_query($connection, $query);
                            }
                        }

                    $num = 0;
                    while($row = mysqli_fetch_assoc($select_all_enrollee)) {

                        $num++;
                        $enrollee_id = $row['enrollee_id'];
                        $moodle_id = $row['moodle_id'];
                        $enrollee_surname = $row['enrollee_surname'];
                        $enrollee_name = $row['enrollee_name'];
                        $enrollee_patronymic = $row['enrollee_patronymic'];
                        $enrollee_status = $row['enrollee_status'];
                        $current_sem = $row['current_sem'];
                        $enrollee_region_id = $row['enrollee_region_id'];

                        echo "<tr>";
                        echo "<td class='text-muted'>{$num}</td>";
                        echo "<td>{$enrollee_surname}</td>";
                        echo "<td>{$enrollee_name}</td>";
                        echo "<td>{$enrollee_patronymic}</td>";
                        echo "<td>{$enrollee_status}</td>";
                        if($_SESSION['user_role_id'] == 1) {
			                echo "<td><a class='text-danger' href='personal_things.php?archive={$enrollee_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
                        }
                        echo "<td>{$current_sem}</td>";


                        $query = "SELECT * FROM asu_region WHERE region_id = {$enrollee_region_id} ";
                        $select_region_id = mysqli_query($connection,$query);

                        while($row = mysqli_fetch_assoc($select_region_id)) {
                            $region_id = $row['region_id'];
                            $region_title = $row['region_title'];

                            echo "<td>{$region_title}</td>";
                        }
                        
                        if(!isset($moodle_id)) {

                            echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                        }
                        $query = "SELECT * FROM clg_user WHERE id = {$moodle_id}";
                        $select_users_by_moodleid = mysqli_query($connection,$query);
                        while($row = mysqli_fetch_assoc($select_users_by_moodleid)) {

                            $username = $row['username'];

                            echo "<td class='text-center'>{$username}</td>";
                        }
                        
                        if($_SESSION['user_role_id'] == 1) {
                            if($enrollee_status == 'Студент' && !isset($moodle_id)) {
                                echo "<td class='text-center'><a class='text-primary' href='personal_things.php?add_enrollee_inSDO={$enrollee_id}'><i class='fa fa-plus-circle' aria-hidden='true' title='Добавить пользователя в СДО'></i></a></td>";  
                            } elseif(isset($moodle_id)) {
                                echo "<td class='text-center'><i class='text-success fa fa-check-circle text-muted' aria-hidden='true' title='Пользователь создан в СДО'></i></td>";
                            } else {
                                echo "<td class='text-center'><i class='fa fa-circle-thin text-warning' aria-hidden='true'></i></td>";
                            }
                        }
                        
                        
                        
                        echo "<td class='text-center'>{$enrollee_id}</td>";
                        echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true'></i></a></td>";
                        echo "<td class='text-center'><a class='text-muted' href='enrollee.php?source=edit_enrollee&e_id={$enrollee_id}'><i class='fa fa-pencil-square-o' aria-hidden='true'></i></a></td>";

    //                        if($_SESSION['user_role_id'] == 1) {
    //                            echo "<td class='text-center'><a class='text-danger' href='personal_things.php?delete={$enrollee_id}'><i class='fa fa-trash' aria-hidden='true'></i></a></td>";
    //                        }
                        echo "</tr>";

                    }

                ?>

            </tbody>
        </table>
    </div>
</div>

<?php

if(isset($_GET['delete'])) {
    
    $the_enrollee_id = $_GET['delete'];
    
    $query = "DELETE FROM asu_enrollee WHERE enrollee_id = {$the_enrollee_id} ";
    
    $delete_query = mysqli_query($connection, $query);
    
    header("Location: personal_things.php");
    
}

if(isset($_GET['add_enrollee_inSDO'])) {
                         
    $the_enrollee_id = $_GET['add_enrollee_inSDO'];


    file_get_contents($prefixsdo."/webservice/synchronization.php?id={$the_enrollee_id}");

    header("Location: personal_things.php");
    
 }


if(isset($_GET['archive'])) {
    
    $the_enrollee_id = $_GET['archive'];
    
    $query = "UPDATE asu_enrollee SET enrollee_status = 'Архив' WHERE enrollee_id = {$the_enrollee_id}";
    
    mysqli_query($connection, $query);
    
    header("Location: personal_things.php");
    
}

?>