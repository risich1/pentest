
<?php 

    if($_SESSION['user_role_id'] == 1) { 
        
    } else {
        header('Location: ./personal_things.php');
    }

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h2><i class="fa fa-filter" aria-hidden="true"></i> Фильтр</h2>
            </div>
            
            <div class="panel-footer form-horizontal">
               
                <div class="form-group">
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Фамилия студента</label>
                        <input name="filter_name" id="filter_name" type="text" class="form-control" value="" placeholder="Фамилия">
                        <input type="hidden" name="token" value="<?php echo $_SESSION['token'] ?? '' ?>">

                    </div>
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Семестр</label>
                        <select name="filter_semester" id="filter_semester" class="form-control"  value="">
                            <option value=''>Все семестры</option>
                            <?php selectSemestersForList(); ?>
                        </select>
                    </div>
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Период обучения</label>
                        <select name="filter_period" class="form-control" id="filter_period" value="">
                            <option value=''>Все периоды обучения</option>
                            <?php selectSessionForList(); ?>
                        </select>
                    </div>
                </div>
            
                <div class="form-group">
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Регион</label>
                        <select name="filter_region" class="form-control" id="filter_region" value="">
                            <option value=''>Все регионы</option>
                            <?php selectRegionsForList(); ?>
                        </select>
                    </div>
                    
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Группа</label>
                        <select name="filter_group" class="form-control" id="filter_group" value="">
                            <option value=''>Все группы</option>
                            <?php selectGroupsForList(); ?>
                        </select>
                    </div>
                    
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                        <label for="">Год</label>
                        <select name="filter_year" class="form-control" id="filter_year" value="">
                            <option value=''>Все года</option>
                            <?php selectYearForList(); ?>
                        </select>
                    </div>
                </div>
            
                <div class="form-group">
                    <div class="col-sm-12">
                        <input class="btn btn-primary" type="submit" name="btn_filter" id="btn_filter" value="Найти">
                        <a class="btn btn-primary" href="sdo.php">Сбросить</a>
                    </div>
                </div> 
            </div>
        </div>
    </div>
</div>

<?php echo $message ?? ''; ?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 table-responsive>" id="result">                         
    <table class="table table-hover table-bordered table-condensed table-filter">
    <thead>
        <tr class="active">
            <th>№</th>
            <th>
                Ф.И.О.<br><small>Личное дело, контакты</small>
            </th>

            <th class="text-center">Последний вход в СДО</th>
            <th class="text-center">Текущий семестр<br>(Период обучения)</th>

            <th class="text-center">Регион</th>
            <th class="text-center">Группа</th>
            <th class="text-center">Статус оплаты<br>(Текущий семестр)</th>
            <th class="text-center">Статус оплаты<br>(Следующий семестр)</th>

            <th class="text-center">Средний балл по тестам<br><small>Результаты тестирования</small></th>
            <th class="text-center">К-во начатых тестов<br>/ К-во тестов</th>

            <th class="text-center">ID</th>
            <th class="text-center">Назначить семестр</th>
        </tr>
    </thead>
    <tbody>

        <?php

            $query = "
                        SELECT
                            clg_user.id AS user_id,
                            CONCAT(enrollee_surname,' ',enrollee_name,' ',enrollee_patronymic) enrollee,
                            asu_enrollee.enrollee_id AS enrollee_id,
                            asu_enrollee.enrollee_phone AS phone,
                            
                            asu_enrollee.current_sem AS current_sem,
                            asu_semesters.semester_title AS semester,
                            
                            asu_region.region_title AS region,
                            
                            asu_treaty.treaty_id AS treaty_id,

                            CONCAT(asu_session.session_period,' ',asu_session.session_time) session,
                            
                            DATE_FORMAT(asu_session.session_open, '%d.%m.%Y') session_open,
                            DATE_FORMAT(asu_session.session_end, '%d.%m.%Y') session_end,

                            FROM_UNIXTIME(clg_user.lastaccess, '%d.%m.%Y %H:%i:%s') lastaccess,
                            clg_user.email AS email,
                            asu_groups.group_number AS group_number,

                            asu_payment.payment_status AS payment_status,
                            asu_payment.payment_number AS payment_number,
                            DATE_FORMAT(asu_payment.payment_create_date, '%d.%m.%Y') payment_create_date,
                            asu_payment.payment_cost AS payment_cost


                            FROM asu_enrollee
                            LEFT JOIN clg_user
                                ON asu_enrollee.moodle_id = clg_user.id
                            LEFT JOIN asu_session
                                ON asu_enrollee.enrollee_session_id = asu_session.session_id
                            LEFT JOIN asu_treaty 
                                ON asu_enrollee.enrollee_id = asu_treaty.treaty_enrollee_id
                            LEFT JOIN asu_region
                                ON asu_enrollee.enrollee_region_id = asu_region.region_id
                            LEFT JOIN asu_groups
                                ON asu_enrollee.enrollee_group_id = asu_groups.group_id
                            LEFT JOIN asu_semesters
                                ON  asu_enrollee.current_sem = asu_semesters.semester_id
                            LEFT JOIN asu_payment
                                ON  asu_enrollee.current_sem = asu_payment.payment_semester_id 
                                AND asu_enrollee.enrollee_id = asu_payment.payment_enrollee_id

                            WHERE asu_enrollee.enrollee_status = 'Студент'
                            ORDER BY asu_enrollee.enrollee_surname

                    ";

            
            $select_all_students = mysqli_query($connection, $query);

            if(!$select_all_students) {

                die("QUERY FAILED ." . mysqli_error($connection));

            }
            // current date
            $date = date('d.m.Y');

            $number = 0;
            while($row = mysqli_fetch_assoc($select_all_students)) {

                $number++;
                $user_id = $row['user_id'];
                $enrollee = $row['enrollee'];
                $enrollee_id = $row['enrollee_id'];
                $lastaccess = $row['lastaccess'];
                $semester = $row['semester'];
                $current_sem = $row['current_sem'];
                $session = $row['session'];
                $session_open = $row['session_open']; 
                $session_end = $row['session_end']; 
                
                $treaty_id = $row['treaty_id'];
                
                $region = $row['region'];
                $group = $row['group_number'];
                $phone = $row['phone'];
                $email = $row['email'];
                
                $payment_status = $row['payment_status'];
                $payment_number = $row['payment_number'];
                $payment_create_date = $row['payment_create_date'];
                $payment_cost = $row['payment_cost'];
                
                // $avg_grade = round($row['avg_grade']);

                $interval = intval(abs(strtotime($date) - strtotime($lastaccess)));

                // amount of days
                $interval = round($interval / (3600 * 24));

                // count test in grades

                $query =   " SELECT  

                                COUNT(clg_quiz_grades.userid) AS count_test_in_grades

                                FROM clg_quiz_grades
                                WHERE clg_quiz_grades.userid = {$user_id};

                            ";
                $count_test_for_user = mysqli_query($connection, $query);
                $row = mysqli_fetch_assoc($count_test_for_user);

                $count_test_in_grades = $row['count_test_in_grades'];

                // count test

                $query =    "   SELECT 

                                    COUNT(clg_quiz.name) AS count_test

                                    FROM clg_user_enrolments
                                    LEFT JOIN clg_enrol
                                        ON clg_user_enrolments.enrolid = clg_enrol.id
                                    LEFT JOIN clg_course
                                        ON clg_enrol.courseid = clg_course.id
                                    LEFT JOIN clg_quiz
                                        ON clg_course.id = clg_quiz.course
                                    WHERE clg_enrol.enrol='manual' AND clg_user_enrolments.userid = {$user_id}
                            ";

                $count_test_for_user = mysqli_query($connection, $query);
                $row = mysqli_fetch_assoc($count_test_for_user);

                $count_test = $row['count_test'];

                // average greade
                $query = "SELECT SUM(clg_quiz_grades.grade) AS sum_grade FROM clg_quiz_grades WHERE clg_quiz_grades.userid = {$user_id}";

                $avg_grade_by_id = mysqli_query($connection, $query);
                $row = mysqli_fetch_assoc($avg_grade_by_id);

                $sum_grade = $row['sum_grade'];
                
                if ( 0 != $count_test ) {
                    $avg_grade = $sum_grade / $count_test;
                    $avg_grade = round($avg_grade,2);
                }
                else {
                    $avg_grade = '-';
                }
                

                echo "<tr >";

                echo "<td>{$number}</td>";
                echo "  <td>
                            <div class ='pull-left'>{$enrollee}</div>
                            <div class='pull-right'>
                                
                                <a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true' title = 'Личное дело'> </i></a>
                                <a href='#' class='text-muted' rel='popover' data-content='{$phone}<br>{$email}' data-original-title='Контакты'>
                                    <i class='fa fa-phone-square' aria-hidden='true' title = 'Контакты'></i>
                                </a>
                            </div>

                        </td>";

                if(isset($lastaccess) AND $lastaccess != '01.01.1970 03:00:00') {
                    if($interval == 0) {
                        echo "<td class='text-center'>$lastaccess</td>";
                    } else if($interval > 7) {
                        echo "<td class='text-center'>
                                <strong class='text-danger'>
                                    $lastaccess<br>($interval дн.)
                                </strong>
                            </td>";
                    } else {
                        echo "<td class='text-center'>
                                {$lastaccess}<br><span class='text-success'>({$interval} дн.)</span>
                            </td>";
                    }
                } else {
                    echo "<td class='text-center'>Никогда</td>";
                }
                
                
                if (strtotime($session_open) < strtotime($date) && strtotime($session_end) > strtotime($date)) {
                    echo "<td>{$semester}<br>({$session})</td>";
                } else {
                    echo "<td><strong class='text-danger'>{$semester}<br>({$session})</strong></td>";
                }
                
                

                echo "<td>{$region}</td>";
                echo "<td>{$group}</td>";
                
                if($payment_status) {  
                    echo "  <td>
                                {$payment_status}
                                <a href='#' class='text-muted' rel='popover' data-content='№ {$payment_number} от $payment_create_date<br>Сумма: $payment_cost руб.' data-original-title='Документ об оплате'>
                                    <i class='fa fa-file-text' aria-hidden='true' title = 'Документ об оплате'></i>
                                </a>
                            </td>";
                } else {
                    
                    echo "<td class='text-danger'><b>Не оплачен</b></td>";
                    
                }
                
                
                $current_next = $current_sem + 1;
                
                $query =    "   
                                SELECT 
                                    payment_number, 
                                    DATE_FORMAT(payment_create_date, '%d.%m.%Y') payment_create_date, 
                                    payment_cost, 
                                    payment_status 
                                FROM asu_payment 
                                WHERE payment_semester_id = {$current_next} 
                                AND payment_enrollee_id = {$enrollee_id}
                            ";
                
                $select_payment_by_id = mysqli_query($connection,$query);
                
                $row = mysqli_fetch_assoc($select_payment_by_id);
                $payment_status_next = $row['payment_status'];
                $payment_number_next = $row['payment_number'];
                $payment_create_date_next = $row['payment_create_date'];
                $payment_cost_next = $row['payment_cost'];
                
                if($payment_status_next) {
                    
                    echo "  <td>
                                $payment_status_next
                                <a href='#' class='text-muted' rel='popover' data-content='№ {$payment_number_next} от $payment_create_date_next<br>Сумма: $payment_cost_next руб.' data-original-title='Документ об оплате'>
                                    <i class='fa fa-file-text' aria-hidden='true' title = 'Документ об оплате'></i>
                                </a>
                            </td>"; 
                    
                } else {
                    echo    "   <td class='text-danger'><b>Не оплачен</b> 
                                    <a href='payment.php?source=add_payment&pay_id={$treaty_id}'>
                                        <i class='fa fa-plus-circle' aria-hidden='true'></i>
                                    </a>
                                </td>
                            ";
                }
                
                
                
                
                echo "  <td>
                            <div class ='pull-left'>{$avg_grade}</div>
                            <div class='pull-right'>
                                <a href='sdo.php?source=student_progress&e_id={$enrollee_id}'>
                                    <i class='fa fa-calendar' aria-hidden='true' title = 'Результаты тестирования'> </i>
                                </a>
                            </div>
                        </td>";
                
                echo "<td>{$count_test_in_grades} / {$count_test}</td>";
//                echo "<td>{$count_test}</td>";
                echo "<td>{$enrollee_id}</td>";
                
                if($payment_status_next) {
                    echo "<td class='text-center'><a href='sdo.php?source=edit_semestr&e_id={$enrollee_id}' class='btn btn-primary'><i class='fa fa-pencil' aria-hidden='true'></i></a></td>";
                } else {
                    echo "<td class='text-center'><a href='sdo.php?source=edit_semestr&e_id={$enrollee_id}' class='btn btn-default disabled' role='button'><i class='fa fa-pencil' aria-hidden='true'></i></a></td>";
                }
                
                echo "</tr>";

            }


        ?>

    </tbody>
</table>

    </div>
</div>

