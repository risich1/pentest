<?php

    if(isset($_GET['e_id'])) {
        
        $the_enrollee_id = mysqli_real_escape_string($connection, $_GET['e_id']);
        
        $query = "
                    SELECT 
                        CONCAT(enrollee_surname,' ',enrollee_name,' ',enrollee_patronymic) enrollee,
                        current_sem,
                        moodle_id 
                    FROM asu_enrollee 
                    WHERE enrollee_id = {$the_enrollee_id}
                    
                ";
        
        
        
        $select_enrollee_by_id = mysqli_query($connection, $query);
                
        $row = mysqli_fetch_assoc($select_enrollee_by_id);
        
        $enrollee = $row['enrollee'];
        $current_sem = $row['current_sem'];
        $enrollee_moodle_id = $row['moodle_id'];
        
        
        $query = "                                     
                            SELECT
                                
                                clg_course.shortname AS course_name,
                                
                                clg_course.category AS category,
                                clg_course_categories.name AS category_name,
                                
                                clg_quiz_grades.grade AS grade,
                                
                                clg_quiz.name AS quiz_name,
                                
                                FROM_UNIXTIME(clg_quiz.timeopen, '%d.%m.%Y') timeopen,
                                FROM_UNIXTIME(clg_quiz.timeclose, '%d.%m.%Y') timeclose
                                
                                FROM clg_quiz
                                
                                LEFT JOIN clg_course
                                    ON clg_quiz.course = clg_course.id
                                    
                                    
                                LEFT JOIN clg_course_categories
                                    ON clg_course.category = clg_course_categories.id
                                    

                                LEFT JOIN clg_enrol
                                    ON clg_course.id = clg_enrol.courseid

                                LEFT JOIN clg_user_enrolments
                                    ON clg_enrol.id = clg_user_enrolments.enrolid

                                LEFT JOIN clg_user
                                    ON clg_user_enrolments.userid = clg_user.id

                                LEFT JOIN clg_quiz_grades
                                    ON clg_quiz.id = clg_quiz_grades.quiz AND clg_quiz_grades.userid = clg_user.id

                                WHERE clg_user.id = {$enrollee_moodle_id} AND clg_enrol.enrol = 'manual'
                                     
                                
                        ";

                        $query=<<<END
                            SELECT
                            clg_course.shortname AS course_name,  
                            clg_course.category AS category,
                            clg_course_categories.name AS category_name,
                            clg_quiz_grades.grade AS grade,
                            clg_quiz.name AS quiz_name,
                            FROM_UNIXTIME(clg_quiz.timeopen, '%d.%m.%Y') timeopen,
                            FROM_UNIXTIME(clg_quiz.timeclose, '%d.%m.%Y') timeclose

                            FROM
                                asu_enrollee

                            LEFT JOIN asu_groups
                                ON asu_groups.group_id=asu_enrollee.enrollee_group_id

                            LEFT JOIN asu_academic_plan
                                ON asu_academic_plan.academic_plan_id=asu_groups.group_ac_plan_id

                            LEFT JOIN asu_content_discipline
                                ON asu_content_discipline.content_discipline_ac_plan_id=asu_academic_plan.academic_plan_id

                            LEFT JOIN clg_quiz_grades
                                ON asu_enrollee.moodle_id = clg_quiz_grades.userid

                            LEFT JOIN clg_quiz
                                ON clg_quiz_grades.quiz = clg_quiz.id AND asu_content_discipline.moodle_id = clg_quiz.course

                            LEFT JOIN clg_course
                                ON clg_quiz.course = clg_course.id

                            LEFT JOIN clg_course_sections
                                ON clg_course.id = clg_course_sections.course
                            
                            LEFT JOIN clg_course_categories
                                ON clg_course.category = clg_course_categories.id

                            WHERE
                                clg_course_sections.section = 0
                                AND
                                clg_quiz_grades.userid = {$enrollee_moodle_id}
END;
            
                $select_all_students = mysqli_query($connection, $query);
                
        
    }
    
?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-calendar fa-fw text-muted" aria-hidden="true"></i>&nbsp;Результаты тестирования
        </h1>
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="well">
            <p><b>Ф.И.О.: </b><?php echo $enrollee; ?></p>
            <p><b>Текущий семестр: </b><?php echo $current_sem; ?></p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
        <table class="table table-hover table-bordered">
        <thead>
            <tr class="active">
                <th>№</th>
                <th>Период обучения</th>
                <th>Дисциплина</th>
                <th>Вид контроля</th>
                <th>Балл</th>
                <th>Тест открывается</th>
                <th>Тест закрывается</th>
            </tr>
        </thead>
        <tbody>
           
            <?php
                            
                if(!$select_all_students) {
        
                    die("QUERY FAILED ." . mysqli_error($connection));
        
                }
            
                while($row = mysqli_fetch_assoc($select_all_students)) {
                    
                    $number++;
                    $category_name = $row['category_name'];
                    $quiz_name = $row['quiz_name'];
                    $course_name = $row['course_name'];
                    $grade = round($row['grade'],2);
                    $timeopen = $row['timeopen'];
                    $timeclose = $row['timeclose'];
                                         
                    echo "<tr>";
                    echo "<td>{$number}</td>";
                    echo "<td>{$category_name}</td>";
                    echo "<td>{$course_name}</td>";
                    echo "<td>{$quiz_name}</td>";
                    
                    echo "<td>{$grade}</td>";
                    echo "<td>{$timeopen}</td>";
                    echo "<td>{$timeclose}</td>";

                    
                    echo "</tr>";
                    
                }
                
                
            
                
            ?>

        </tbody>
        </table>
    </div>
</div>

