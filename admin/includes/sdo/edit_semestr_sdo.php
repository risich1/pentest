<?php
require_once("../includes/db.php");

if($_SESSION['user_role_id'] == 1 && $_GET['e_id']) {
    
    $the_enrollee_id = $_GET['e_id'];
    
    $query =    "   SELECT
                        
                        CONCAT(asu_enrollee.enrollee_surname,' ',asu_enrollee.enrollee_name,' ',asu_enrollee.enrollee_patronymic) enrollee,
                        asu_enrollee.current_sem,
                        asu_enrollee.enrollee_session_id,
                        asu_enrollee.moodle_id,
                        
                        asu_groups.group_ac_plan_id AS ac_plan_id
                        
                        FROM asu_enrollee 
                        INNER JOIN asu_groups
                            ON asu_enrollee.enrollee_group_id = asu_groups.group_id
                        WHERE enrollee_id = {$the_enrollee_id}
    
                ";
    
    $select_enrollee_by_id = mysqli_query($connection,$query);
    $row = mysqli_fetch_assoc($select_enrollee_by_id);
    
    $enrollee = $row['enrollee'];
    $current_sem = $row['current_sem'];
    $enrollee_session_id = $row['enrollee_session_id'];
    $enrollee_ac_plan_id = $row['ac_plan_id'];
    
    
    // save data
    if(isset($_POST['save_data'])) {
    
        $current_sem = $_POST['current_sem'];
        $enrollee_session_id = $_POST['enrollee_session_id'];

        $query = "UPDATE asu_enrollee SET ";
        $query .= "current_sem = {$current_sem}, ";      
        $query .= "enrollee_session_id = {$enrollee_session_id} ";
        
        $query .= "WHERE enrollee_id = {$the_enrollee_id} ";
        
        $save_data = mysqli_query($connection,$query);

        if(!$save_data) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }
        
        $query =    "   
                        SELECT 
                        
                            asu_content_discipline.moodle_id AS course_id, 
                            clg_course.fullname

                            FROM asu_groups 
                            INNER JOIN asu_content_discipline
                                ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
                            INNER JOIN clg_course 
                                ON clg_course.id = asu_content_discipline.moodle_id
                            WHERE group_ac_plan_id = {$enrollee_ac_plan_id}
                            AND asu_content_discipline.content_discipline_semester = {$current_sem}
                    ";
        
        $select_course_by_id = mysqli_query($connection,$query);
        
        if(!$select_course_by_id) {
        
            die("QUERY FAILED ." . mysqli_error($connection));
        
        }
        
        while($row = mysqli_fetch_assoc($select_course_by_id)) {
            
            $course_id = $row['course_id'];
            $fullname = $row['fullname'];
            
//            echo "$fullname $course_id";
//            echo "<br>";
//            echo "$the_enrollee_id";
//            echo "<br>";
            
            file_get_contents($prefixsdo."/my/insert_student_enrol.php?student_id={$the_enrollee_id}&course_id={$course_id}");
        }
        
        
        $message = "<br><div class='alert alert-success'><i class='fa fa-refresh fa-spin fa-fw'></i> Данные сохранены.</div>";
        
        header("refresh: 1; url=./sdo.php");
    }
    

} else {

    header("refresh: 0; url=./sdo.php");
}



?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h1 class="page-header">
            <i class="fa fa-calendar-check-o fa-fw text-muted" aria-hidden="true"></i>&nbsp;Назначить семестр и период обучения
        </h1>
    </div>
</div>
<?php echo $message; ?>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">                         
        <p><?php echo $enrollee; ?></p>  
    </div>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">  
        <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <div class="col-sm-6">
                    <label for="current_sem">Семестр</label>            

                    <select class="form-control" name="current_sem">
                    <?php  
                            $query = "SELECT semester_id, semester_title FROM asu_semesters";
                            $select_sem = mysqli_query($connection,$query);
                            
                            while($row = mysqli_fetch_assoc($select_sem)) {
                                
                                $semester_id = $row['semester_id'];
                                $semestr_title = $row['semester_title'];
                            
                                if($current_sem == $semester_id) {
                                    echo "<option value='{$semester_id}' selected>{$semestr_title}</option>"; 
                                } else {
                                    echo "<option value='{$semester_id}'>{$semestr_title}</option>";
                                }

                            }

                        ?>

                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <div class="col-sm-6">
                    <label for="enrollee_session_id">Период обучения</label>            

                    <select class="form-control" name="enrollee_session_id">

                        <?php
                            
                            $date = date('d.m.Y');
                            $query =    "   SELECT 
                                                session_id, 
                                                CONCAT(session_period,' ',session_time) session, 
                                                DATE_FORMAT(session_open, '%d.%m.%Y') session_start,
                                                DATE_FORMAT(session_end, '%d.%m.%Y') session_end
                                                FROM asu_session
                                        ";

                            $select_all_session = mysqli_query($connection,$query);
                            
                            while($row = mysqli_fetch_assoc($select_all_session)) {
                                
                                $session_id = $row['session_id'];
                                $session = $row['session'];
                                $session_open  = $row['session_open'];
                                $session_end  = $row['session_end'];
                                
                                if(strtotime($date) > strtotime($session_open) && strtotime($date) < strtotime($session_end)) {
                                    
                                        echo "<option value='{$session_id}'>{$session}</option>";    

                                }
                            }
                        ?>

                    </select>
                    
                </div>
            </div>
            
            
            
            
            <div class="form-group">
                <div class="col-sm-12">
                    <div class="page-header"></div>
                    <input class="btn btn-primary" type="submit" name="save_data" value="Сохранить">
                </div>
            </div>
        </form>
    </div>
</div>



























