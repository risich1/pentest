<?php

    $query = "
                SELECT
                    clg_user.id AS user_id,
                    CONCAT(enrollee_surname,' ',enrollee_name,' ',enrollee_patronymic) enrollee,
                    asu_enrollee.enrollee_id AS enrollee_id,
                    asu_enrollee.enrollee_phone AS phone,
                    asu_enrollee.current_sem AS current_sem,
                    asu_semesters.semester_title AS semester,
                    asu_region.region_title AS region,

                    CONCAT(asu_session.session_period,' ',asu_session.session_time) session,

                    FROM_UNIXTIME(clg_user.lastaccess, '%d.%m.%Y %H:%i:%s') lastaccess,
                    clg_user.email AS email,
                    
                    asu_payment.payment_status AS payment_status,
                    asu_payment.payment_number AS payment_number,
                    DATE_FORMAT(asu_payment.payment_create_date, '%d.%m.%Y') payment_create_date,
                    asu_payment.payment_cost AS payment_cost

                    FROM asu_enrollee
                    LEFT JOIN clg_user
                        ON asu_enrollee.moodle_id = clg_user.id
                    LEFT JOIN asu_session
                        ON asu_enrollee.enrollee_session_id = asu_session.session_id
                    LEFT JOIN asu_region
                        ON asu_enrollee.enrollee_region_id = asu_region.region_id
                    LEFT JOIN asu_semesters
                        ON  asu_enrollee.current_sem = asu_semesters.semester_id
                        
                    LEFT JOIN asu_payment
                        ON  asu_enrollee.current_sem = asu_payment.payment_semester_id 
                        AND asu_enrollee.enrollee_id = asu_payment.payment_enrollee_id

                    WHERE asu_enrollee.enrollee_region_id = {$region_id} AND asu_enrollee.enrollee_status = 'Студент'

            ";

?>

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 table-responsive>" id="result">                         
    <table class="table table-hover table-bordered table-condensed table-filter">
    <thead>
        <tr class="active">
            <th>№</th>
            <th>
                Ф.И.О.<br><small>Личное дело, контакты</small>
            </th>
            <th class="text-center">Последний вход в СДО</th>
            <th class="text-center">Текущий семестр<br>(Период обучения)</th>
            <th class="text-center">Регион</th>
            <th class="text-center">Статус оплаты<br>(Текущий семестр)</th>
            <th class="text-center">Статус оплаты<br>(Следующий семестр)</th>
            
            <th class="text-center">Средний балл по тестам<br><small>Результаты тестирования</small></th>
            
            <th class="text-center">ID</th>
        </tr>
    </thead>
    <tbody>

        <?php

            $select_all_students = mysqli_query($connection, $query);

            if(!$select_all_students) {

                die("QUERY FAILED ." . mysqli_error($connection));

            }
            // current date
            $date = date('d.m.Y');

            while($row = mysqli_fetch_assoc($select_all_students)) {

                $number++;
                $user_id = $row['user_id'];
                $enrollee = $row['enrollee'];
                $enrollee_id = $row['enrollee_id'];
                
                $lastaccess = $row['lastaccess'];
                
                $current_sem = $row['current_sem'];
                $semester = $row['semester'];
                $session = $row['session'];
                
                $region = $row['region'];

                $phone = $row['phone'];
                $email = $row['email'];

                $interval = intval(abs(strtotime($date) - strtotime($lastaccess)));
                
                $payment_status = $row['payment_status'];
                $payment_number = $row['payment_number'];
                $payment_create_date = $row['payment_create_date'];
                $payment_cost = $row['payment_cost'];

                // amount of days
                $interval = round($interval / (3600 * 24));
                
                            
                // count test

                $query =    "   SELECT 

                                    COUNT(clg_quiz.name) AS count_test

                                    FROM clg_user_enrolments
                                    LEFT JOIN clg_enrol
                                        ON clg_user_enrolments.enrolid = clg_enrol.id
                                    LEFT JOIN clg_course
                                        ON clg_enrol.courseid = clg_course.id
                                    LEFT JOIN clg_quiz
                                        ON clg_course.id = clg_quiz.course
                                    WHERE clg_enrol.enrol='manual' AND clg_user_enrolments.userid = {$user_id}
                            ";

                $count_test_for_user = mysqli_query($connection, $query);
                $row = mysqli_fetch_assoc($count_test_for_user);

                $count_test = $row['count_test'];
                
                // average greade
                $query = "SELECT SUM(clg_quiz_grades.grade) AS sum_grade FROM clg_quiz_grades WHERE clg_quiz_grades.userid = {$user_id}";

                $avg_grade_by_id = mysqli_query($connection, $query);
                $row = mysqli_fetch_assoc($avg_grade_by_id);

                $sum_grade = $row['sum_grade'];
                
                $avg_grade = $sum_grade / $count_test;
                
                $avg_grade = round($avg_grade,2);
                
                

                echo "<tr>";
                echo "<td>{$number}</td>";
                echo "  <td>
                            <div class ='pull-left'>{$enrollee}</div>
                            <div class='pull-right'>
                                
                                <a class='text-muted' href='enrollee.php?source=view_enrollee&e_id={$enrollee_id}'><i class='fa fa-address-book' aria-hidden='true' title = 'Личное дело'> </i></a>
                                <a href='#' class='text-muted' rel='popover' data-content='{$phone}<br>{$email}' data-original-title='Контакты'>
                                    <i class='fa fa-phone-square' aria-hidden='true' title = 'Контакты'></i>
                                </a>
                            </div>

                        </td>";

                if(isset($lastaccess) AND $lastaccess != '01.01.1970 03:00:00') {
                    if($interval == 0) {
                        echo "<td class='text-center'>$lastaccess</td>";
                    } else if($interval > 7) {
                        echo "<td class='text-center'>
                                <strong class='text-danger'>
                                    $lastaccess<br>($interval дн.)
                                </strong>
                            </td>";
                    } else {
                        echo "<td class='text-center'>
                                {$lastaccess}<br><span class='text-success'>({$interval} дн.)</span>
                            </td>";
                    }
                } else {
                    echo "<td class='text-center'>Никогда</td>";
                }

                echo "<td>{$semester}<br>({$session})</td>";

                echo "<td>{$region}</td>";
                
                
                
                if($payment_status) {  
                    echo "  <td>
                                {$payment_status}
                                <a href='#' class='text-muted' rel='popover' data-content='№ {$payment_number} от $payment_create_date<br>Сумма: $payment_cost руб.' data-original-title='Документ об оплате'>
                                    <i class='fa fa-file-text' aria-hidden='true' title = 'Документ об оплате'></i>
                                </a>
                            </td>";
                } else {
                     echo "<td class='text-danger'><b>Не оплачен</b></td>";
                }
                
                
                $current_next = $current_sem + 1;
                
                $query =    "   
                                SELECT 
                                    payment_number, 
                                    payment_create_date,
                                    DATE_FORMAT(payment_create_date, '%d.%m.%Y') payment_create_date,
                                    payment_cost, 
                                    payment_status 
                                FROM asu_payment 
                                WHERE payment_semester_id = {$current_next} 
                                AND payment_enrollee_id = {$enrollee_id}
                            ";
                
                $select_payment_by_id = mysqli_query($connection,$query);
                
                $row = mysqli_fetch_assoc($select_payment_by_id);
                $payment_status_next = $row['payment_status'];
                $payment_number_next = $row['payment_number'];
                $payment_create_date_next = $row['payment_create_date'];
                $payment_cost_next = $row['payment_cost'];
                
                if($payment_status_next) {
                    
                    echo "  <td>
                                $payment_status_next
                                <a href='#' class='text-muted' rel='popover' data-content='№ {$payment_number_next} от $payment_create_date_next<br>Сумма: $payment_cost_next руб.' data-original-title='Документ об оплате'>
                                    <i class='fa fa-file-text' aria-hidden='true' title = 'Документ об оплате'></i>
                                </a>
                            </td>"; 
                    
                } else {
                    echo "<td class='text-danger'><b>Не оплачен</b></td>";
                }
                
                
                
                echo "  <td>
                            <div class ='pull-left'>{$avg_grade}</div>
                            <div class='pull-right'>
                                <a href='sdo.php?source=student_progress&e_id={$enrollee_id}'>
                                    <i class='fa fa-calendar' aria-hidden='true' title = 'Результаты тестирования'> </i>
                                </a>
                            </div>
                        </td>";
                
                echo "<td>{$enrollee_id}</td>";
                
                echo "</tr>";

            }


        ?>

    </tbody>
</table>

    </div>
</div>

