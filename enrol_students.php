<?php
session_start(); 

include "includes/db.php";

if(!isset($_SESSION['user_role_id']) || $_SESSION['user_role_id'] != 1) {
    header('HTTP/1.0 403 Forbidden');
    exit("Доступ закрыт");
}

$query_students = "SELECT moodle_enrolid AS enrolid,
                          moodle_student_id AS userid,
                          enrollee_id,
                          student_surname,
                          group_number,
                          academic_plan_name,
                          moodle_course_id,
                          moodle_course_name,
                          payment_id
                   FROM v_required_students_enrollments";
$select_students = mysqli_query( $connection, $query_students );
$students = mysqli_fetch_all( $select_students , MYSQLI_ASSOC );
$insert = mysqli_num_rows( $select_students );
mysqli_free_result( $select_students );
$fn = 'enrol_students_'.date('Y-m-d_h-i-s');
file_put_contents( "admin/file/enrol/$fn.json", json_encode( $students ) );

$delim = ";";
$bom =( chr(0xEF) . chr(0xBB) . chr(0xBF) );
$errors = [];

if ( $insert > 0 ) {
    $roles = "INSERT IGNORE INTO clg_role_assignments (roleid, contextid, userid, timemodified)
              SELECT DISTINCT
                     5 as roleid,
                     clg_context.id AS contextid,
                     moodle_student_id AS userid,
                     UNIX_TIMESTAMP() as timemodified
              FROM v_required_students_enrollments
              LEFT JOIN clg_context ON clg_context.instanceid = v_required_students_enrollments.moodle_course_id AND clg_context.contextlevel = 50";
    $insert_roles = mysqli_query( $connection, $roles );
    if( !$insert_roles ) {
        $errors[] = 'QUERY FAILED' . mysqli_error( $connection );
    }

    $enrol = "INSERT IGNORE INTO clg_user_enrolments (enrolid, userid, timecreated, timemodified)
              SELECT DISTINCT
                     moodle_enrolid AS enrolid,
                     moodle_student_id AS userid,
                     UNIX_TIMESTAMP() as timecreated,
                     UNIX_TIMESTAMP() as timemodified
              FROM v_required_students_enrollments";
    $insert_enrol = mysqli_query( $connection, $enrol );
    if( !$insert_enrol ) {
        $errors[] = 'QUERY FAILED' . mysqli_error( $connection );
    }

    header( 'Content-Type: text/csv; charset=utf-8' );
    header( "Content-Disposition: attachment;filename=$fn.csv");
    $fp = fopen('php://output', 'w');
    fputs( $fp, $bom );
    fputcsv( $fp, array_keys( $students[0] ), $delim );
    foreach( $students as $student ) {
        fputcsv( $fp, $student, $delim );
    }
    fputs( $fp, "\n\n".implode( "\n", $errors ) ) . "\n";

    fclose( $fp );
}
else {
    echo "ALL IS GOOD";
}