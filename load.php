<?php
include "includes/db.php";

if(!isset($_SESSION['user_role_id']) || $_SESSION['user_role_id'] != 1) {
    header('HTTP/1.0 403 Forbidden');
    exit("Доступ закрыт");
}


$select_load_teacher = mysqli_query($connection, "SELECT * FROM asu_load_teacher");

$same = 0;
$updated = 0;

while ($row_load_teacher = mysqli_fetch_assoc($select_load_teacher)) {
    $load_teacher_id = $row_load_teacher['load_teacher_id'];
    $discipline_moodle = $row_load_teacher['discipline_moodle_id'];
    $load_teacher = $row_load_teacher['load_teacher'];

    $query_students = "SELECT COUNT(asu_enrollee.enrollee_id) AS count_students_all
                       FROM asu_content_discipline
                       LEFT JOIN asu_groups ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
                       LEFT JOIN asu_enrollee ON asu_enrollee.enrollee_group_id = asu_groups.group_id AND enrollee_status='Студент'
                       WHERE asu_content_discipline.moodle_id = {$discipline_moodle}";
    $select_students = mysqli_query($connection, $query_students);
    $row_students = mysqli_fetch_assoc($select_students);
    $count_students_all = $row_students['count_students_all'];
    
    $query_audience = "SELECT MAX(1*asu_content_discipline.content_discipline_hour_audience) AS max_hour_audience
                       FROM asu_content_discipline
                       WHERE asu_content_discipline.moodle_id = {$discipline_moodle}";
    $select_audience = mysqli_query($connection, $query_audience);
    $row_audience = mysqli_fetch_assoc($select_audience);
    $max_hour_audience = $row_audience['max_hour_audience'];

    $query_exam = "SELECT COUNT(asu_enrollee.enrollee_id) AS sum_students_exam
                   FROM asu_content_discipline
                   LEFT JOIN asu_groups ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
                   LEFT JOIN asu_enrollee ON asu_enrollee.enrollee_group_id = asu_groups.group_id AND enrollee_status='Студент'
                   WHERE asu_content_discipline.moodle_id = {$discipline_moodle} AND asu_content_discipline.content_discipline_control IN ('Экзамен', 'Диф. зачёт')";
    $select_exam = mysqli_query($connection, $query_exam);
    $row_exam = mysqli_fetch_assoc($select_exam);
    $sum_students_exam = $row_exam['sum_students_exam'];

    $query_course_work = "SELECT COUNT(asu_enrollee.enrollee_id) AS sum_students_course_work
                          FROM asu_content_discipline
                          LEFT JOIN asu_groups ON asu_groups.group_ac_plan_id = asu_content_discipline.content_discipline_ac_plan_id
                          LEFT JOIN asu_enrollee ON asu_enrollee.enrollee_group_id = asu_groups.group_id AND enrollee_status='Студент'
                          WHERE asu_content_discipline.moodle_id = {$discipline_moodle} AND asu_content_discipline.content_discipline_course_work = 'Есть'";
    $select_course_work = mysqli_query($connection, $query_course_work);
    $row_course_work = mysqli_fetch_assoc($select_course_work);
    $sum_students_course_work = $row_course_work['sum_students_course_work'];

    $calculation = $max_hour_audience + ($sum_students_course_work * 1) + ($sum_students_exam * 0.25) + ($count_students_all * 0.25);

    /*$formula = "<b>Формула</b>&nbsp;
                Аудит. часы($max_hour_audience) + 
                Курсовая работа($sum_students_course_work * 1) + 
                Экзамен($sum_students_exam * 0.25) + 
                Проверка контрольных работ($count_students_all * 0.25) = 
                $calculation";
    echo "$formula<br>";*/

    if ( $load_teacher != $calculation ) {
        $updated++;
        $query_update_load_teacher = "UPDATE asu_load_teacher SET load_teacher={$calculation}, load_teacher_date=now() WHERE load_teacher_id={$load_teacher_id}";
        $update_load_teacher = mysqli_query($connection,$query_update_load_teacher);
        if(!$update_load_teacher) {
            echo "<br>";
            echo $query_update_load_teacher;
            echo "<br>";

            die('QUERY FAILED' . mysqli_error($connection));

        }
    }
    else {
        $same++;
    }
}

echo "updated $updated, same $same";